<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.12.1/dist/quagga.min.js"></script>
    <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
    <style>
        /* æ–‡å­—ã‚’æŠ˜ã‚Šè¿”ã™ */
        .cell-wrap {
            white-space: normal !important;
            word-wrap: break-word;
            word-break: break-all;
            line-height: 1.3;
            text-align: left;
            padding: 0.375rem 0.75rem;
        }

        /* å•†å“åã®åˆ—å¹…ã‚’åºƒã’ã‚‹ */
        .product-name-td {
            min-width: 120px;
            width: 50%;
        }

        /* äºˆå®šæ—¥è¶…éã‚«ãƒ¼ãƒ‰ï¼ˆå—æ³¨ä¸€è¦§ã¨åŒæ§˜ï¼‰ */
        .order-card.overdue-row {
            background-color: #ffebee !important;
            border-left: 4px solid #f44336;
        }
        .order-card.overdue-row .order-card-title,
        .order-card.overdue-row .order-card-customer {
            color: #c62828;
        }
        /* åç©«å¾…ã¡ä¸€è¦§ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨å½¢å¼ï¼ˆPCãƒ»ã‚¹ãƒãƒ›ä¸¡å¯¾å¿œï¼‰ */
        .harvest-waiting-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .harvest-waiting-row {
            display: flex; flex-wrap: wrap; align-items: flex-start; gap: 0.5rem 1rem;
            padding: 0.6rem 0.75rem; background: #fffef8; border: 1px solid #fef3c7; border-radius: 8px;
            font-size: 0.875rem;
        }
        .harvest-waiting-left {
            flex: 0 1 auto; min-width: 0; display: flex; flex-wrap: wrap; align-items: center; gap: 0.35rem 0.75rem;
        }
        .harvest-waiting-name { font-weight: 600; color: #1e293b; }
        .harvest-waiting-client { font-size: 0.8rem; color: #64748b; }
        .harvest-waiting-cool { flex-shrink: 0; }
        .harvest-waiting-right {
            flex: 1 1 200px; min-width: 0; color: #475569; word-break: break-all; line-height: 1.4;
        }
        @media (min-width: 576px) {
            .harvest-waiting-row { flex-wrap: nowrap; }
            .harvest-waiting-left { flex: 0 0 220px; }
            .harvest-waiting-right { flex: 1; min-width: 180px; }
        }
        /* åç©«å¾…ã¡ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç™ºé€å•†å“è©³ç´°ãŒå°‘ã—ç‹­ã¾ã£ãŸç¨‹åº¦ã®æ¨ªå¹…ã¾ã§åºƒã’ã‚‹ */
        .harvest-waiting-modal {
            width: 96vw;
            max-width: 1120px;
        }
        .harvest-waiting-modal #harvestWaitingDialogBody {
            max-height: 60vh;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="text-center m-4">é¦¬å ´åœ’èŠ¸</h2>
        <form class="mb-5" method="POST" action="<?= deployURL ?>">
            <div class="text-center" id="cntRes">
            </div>
            <div class="text-center" id="invoiceTodayRes">
            </div>
            <div class="text-center" id="todayRes">
            </div>
            <div class="text-center" id="invoiceTommorrowRes">
            </div>
            <div class="text-center" id="tommorrowRes">
            </div>
            <div class="text-center" id="invoiceDayAfter2Res">
            </div>
            <div class="text-center" id="dayAfter2Res">
            </div>
            <div class="text-center" id="invoiceDayAfter3Res">
            </div>
            <div class="text-center" id="dayAfter3Res">
            </div>
            <div id="overlay"></div>
            <div id="detailDialog">
                <p><strong>é¡§å®¢å:</strong> <span id="dialogCustName"></span></p>
                <p><strong>ç™ºé€å…ˆå:</strong> <span id="dialogShippingTo"></span></p>
                <p><strong>å•†å“å:</strong> <span id="dialogProduct"></span></p>
                <p><strong>å€‹æ•°:</strong> <span id="dialogCount"></span></p>
                <p><strong>ãƒ¡ãƒ¢:</strong> <span id="dialogMemo"></span></p>
                <button type="button" class="btn" id="closeDialogButton">é–‰ã˜ã‚‹</button>
            </div>
            <div id="harvestWaitingOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1050; align-items:center; justify-content:center;"></div>
            <div id="harvestWaitingDialog" class="harvest-waiting-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.2); z-index:1051; max-height:85vh; overflow:hidden; flex-direction:column;">
                <div class="p-3 border-bottom bg-warning bg-opacity-25">
                    <h5 class="mb-0"><i class="bi bi-flower1 me-1"></i>åç©«å¾…ã¡ä¸€è¦§</h5>
                </div>
                <div id="harvestWaitingDialogBody" class="p-3 overflow-auto" style="max-height:60vh;"></div>
                <div class="p-3 border-top">
                    <button type="button" class="btn btn-secondary" id="closeHarvestWaitingDialogBtn">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        function sendFail() {
            alert("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
        function sendSuccess(url) {
            window.open(url);
        }
        function setRes() {
            $("#cntRes").html('<div style="padding: 20px; text-align: center;"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">èª­ã¿è¾¼ã¿ä¸­...</div></div>');
            google.script.run.withSuccessHandler(setTable).withFailureHandler(setTableFail).selectShippingDate();
        }
        function setTable(datas) {
            var res = JSON.parse(datas);
            window.harvestWaitingList = (res[12] != null) ? res[12] : [];
            $("#cntRes").html("");
            let cntHtml = `<table class="table table-bordered text-center" style="table-layout: fixed;">`;
            cntHtml += `<thead><tr>`;

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ - ä»Šæ—¥ã¯ç·‘ã€ä»–ã¯ãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ç³»
            cntHtml += `<th class="today_color" scope="col">${res[0]['ä»Šæ—¥']}</th>`;
            cntHtml += `<th style="background-color: #B0E0E6;" scope="col">${res[0]['æ˜æ—¥']}</th>`;
            cntHtml += `<th style="background-color: #B0E0E6;" scope="col">${res[0]['æ˜å¾Œæ—¥']}</th>`;
            cntHtml += `<th style="background-color: #B0E0E6;" scope="col">${res[0]['æ˜ã€…å¾Œæ—¥']}</th>`;
            cntHtml += `</tr></thead><tbody><tr>`;

            // ä»¶æ•°è¡Œ
            cntHtml += `<td scope="col">${res[1]['ä»Šæ—¥']}ä»¶</td>`;
            cntHtml += `<td scope="col">${res[1]['æ˜æ—¥']}ä»¶</td>`;
            cntHtml += `<td scope="col">${res[1]['æ˜å¾Œæ—¥']}ä»¶</td>`;
            cntHtml += `<td scope="col">${res[1]['æ˜ã€…å¾Œæ—¥']}ä»¶</td>`;
            cntHtml += `</tr></tbody></table>`;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸‹ã«è¡¨ç¤ºï¼‰
            let statusBadges = '';
            const overdueCount = res[1]['è¶…é'] || 0;
            const harvestWaitingCount = res[1]['åç©«å¾…ã¡'] || 0;

            if (overdueCount > 0) {
                statusBadges += `<span class="badge bg-danger me-2" style="font-size:0.85rem;">
                    <i class="bi bi-exclamation-circle-fill me-1"></i>ç™ºé€æ—¥è¶…é: ${overdueCount}ä»¶
                </span>`;
            }

            if (harvestWaitingCount > 0) {
                statusBadges += `<span class="badge bg-warning text-dark me-2" style="font-size:0.85rem; cursor:pointer;" role="button" tabindex="0" onclick="showHarvestWaitingDialog()" onkeydown="if(event.key==='Enter')showHarvestWaitingDialog()" title="ã‚¯ãƒªãƒƒã‚¯ã§åç©«å¾…ã¡ä¸€è¦§ã‚’è¡¨ç¤º">
                    <i class="bi bi-flower1 me-1"></i>åç©«å¾…ã¡: ${harvestWaitingCount}ä»¶
                </span>`;
            }

            if (statusBadges) {
                statusBadges = `<div class="mt-2 text-center">${statusBadges}</div>`;
            }

            $("#cntRes").html(cntHtml + statusBadges);

            if (res[4]) {
                createInvoiceHtml(res[4], res[0]['ä»Šæ—¥'], "#invoiceTodayRes", true);
            } else {
                $("#invoiceTodayRes").html('');
            }
            if (res[5]) {
                createProductHtml(res[5], res[0]['ä»Šæ—¥'], "#todayRes", true);
            } else {
                $("#todayRes").html('');
            }
            if (res[6]) {
                createInvoiceHtml(res[6], res[0]['æ˜æ—¥'], "#invoiceTommorrowRes");
            } else {
                $("#invoiceTommorrowRes").html('');
            }
            if (res[7]) {
                createProductHtml(res[7], res[0]['æ˜æ—¥'], "#tommorrowRes");
            } else {
                $("#tommorrowRes").html('');
            }
            if (res[8]) {
                createInvoiceHtml(res[8], res[0]['æ˜å¾Œæ—¥'], "#invoiceDayAfter2Res");
            } else {
                $("#invoiceDayAfter2Res").html('');
            }
            if (res[9]) {
                createProductHtml(res[9], res[0]['æ˜å¾Œæ—¥'], "#dayAfter2Res");
            } else {
                $("#dayAfter2Res").html('');
            }
            if (res[10]) {
                createInvoiceHtml(res[10], res[0]['æ˜ã€…å¾Œæ—¥'], "#invoiceDayAfter3Res");
            } else {
                $("#invoiceDayAfter3Res").html('');
            }
            if (res[11]) {
                createProductHtml(res[11], res[0]['æ˜ã€…å¾Œæ—¥'], "#dayAfter3Res");
            } else {
                $("#dayAfter3Res").html('');
            }
        }
        function setTableFail() {
            alert("å—æ³¨ãƒ‡ãƒ¼ã‚¿é›†è¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }

        function showHarvestWaitingDialog() {
            const list = window.harvestWaitingList || [];
            const body = document.getElementById('harvestWaitingDialogBody');
            if (!body) return;
            if (!list.length) {
                body.innerHTML = '<p class="text-muted mb-0">åç©«å¾…ã¡ã®å—æ³¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
                let html = '<div class="dashboard-grid">';
                for (let i = 0; i < list.length; i++) {
                    const order = list[i];
                    const coolCls = order['ã‚¯ãƒ¼ãƒ«åŒºåˆ†'] || '';
                    let coolBadge = '';
                    if (coolCls.includes('å†·è”µ')) coolBadge = '<span class="cool-badge cool-badge-reizo">å†·è”µ</span>';
                    else if (coolCls.includes('å†·å‡')) coolBadge = '<span class="cool-badge cool-badge-reito">å†·å‡</span>';
                    else if (coolCls && coolCls !== 'ãªã—' && coolCls !== 'å¸¸æ¸©') coolBadge = '<span class="cool-badge bg-warning text-dark" style="font-size:0.6rem">' + escapeHtml(coolCls) + '</span>';
                    const statusBadgeHtml = getStatusBadge('åç©«å¾…ã¡');
                    const escapedOrderId = escapeHtml(order.orderId);
                    const escapedRecipientName = escapeHtml(order['ç™ºé€å…ˆå'] || '');
                    const escapedDeliveryMethod = escapeHtml(order.deliveryMethod || '');
                    const actionsHtml = `
                        <div class="order-card-actions" style="flex-direction: column; gap: 5px; align-items: stretch;">
                            <select class="form-select form-select-sm status-select" data-order-id="${escapedOrderId}" style="font-size: 0.65rem; padding: 1px 2px; width: 100%; min-width: 70px; text-align: center;">
                                <option value="ç™ºé€å‰">ç™ºé€å‰</option>
                                <option value="åç©«å¾…ã¡" selected>ğŸŒ±å¾…ã¡</option>
                                <option value="å‡ºè·æ¸ˆã¿">âœ“æ¸ˆ</option>
                            </select>
                            <button type="button" class="btn btn-sm scan-btn-mini" data-order-id="${escapedOrderId}" data-recipient-name="${escapedRecipientName}" data-delivery-method="${escapedDeliveryMethod}" title="ä¼ç¥¨ã‚¹ã‚­ãƒ£ãƒ³" style="width: 100%;">
                                <i class="bi bi-upc-scan"></i>
                            </button>
                            ${statusBadgeHtml}
                        </div>
                    `;
                    html += `<div class="order-card shadow-sm border-warning border-opacity-50">`;
                    html += `<div class="order-card-header"><div class="order-card-info-main">`;
                    html += `<h4 class="order-card-title">${escapeHtml(order['ç™ºé€å…ˆå'] || '')} æ§˜</h4>`;
                    html += `<span class="order-card-customer">ä¾é ¼ä¸»: ${escapeHtml(order['é¡§å®¢å'] || '')}</span>`;
                    if (coolBadge) html += `<div class="mt-1">${coolBadge}</div>`;
                    html += `</div>`;
                    html += actionsHtml;
                    html += `</div>`;
                    html += `<div class="order-card-body">`;
                    let combinedMemo = order['aggregatedMemos'] && Array.isArray(order['aggregatedMemos']) ? order['aggregatedMemos'] : [];
                    if (combinedMemo.length === 0) {
                        const seenMemos = new Set();
                        for (let j = 0; j < (order['å•†å“'] || []).length; j++) {
                            const p = order['å•†å“'][j];
                            if (p['ãƒ¡ãƒ¢']) {
                                const rawMemo = String(p['ãƒ¡ãƒ¢']).trim();
                                if (rawMemo && !seenMemos.has(rawMemo)) { seenMemos.add(rawMemo); combinedMemo.push(escapeHtml(p['ãƒ¡ãƒ¢'])); }
                            }
                        }
                    }
                    for (let j = 0; j < (order['å•†å“'] || []).length; j++) {
                        const p = order['å•†å“'][j];
                        const unit = p['å˜ä½'] || 'æš';
                        html += `<div class="product-list-item">`;
                        html += `<span class="product-name">${escapeHtml(p['å•†å“å'] || '')}</span>`;
                        html += `<span class="product-quantity">${escapeHtml(String(p['å—æ³¨æ•°'] || ''))} ${escapeHtml(unit)}</span>`;
                        html += `</div>`;
                    }
                    if (combinedMemo.length > 0) {
                        html += `<div class="memo-box"><span class="memo-icon">ğŸ“Œ</span><div>${combinedMemo.join('<br>')}</div></div>`;
                    }
                    html += `</div></div>`;
                }
                html += '</div>';
                body.innerHTML = html;
            }
            document.getElementById('harvestWaitingOverlay').style.display = 'flex';
            document.getElementById('harvestWaitingDialog').style.display = 'flex';
        }
        function closeHarvestWaitingDialog() {
            const overlay = document.getElementById('harvestWaitingOverlay');
            const dialog = document.getElementById('harvestWaitingDialog');
            if (overlay) overlay.style.display = 'none';
            if (dialog) dialog.style.display = 'none';
        }

        // è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showDetailDialog(details) {
            document.getElementById('dialogCustName').textContent = details.custName;
            document.getElementById('dialogShippingTo').textContent = details.shippingTo;
            document.getElementById('dialogProduct').textContent = details.product;
            document.getElementById('dialogCount').textContent = details.count;
            document.getElementById('dialogMemo').textContent = details.memo;

            document.getElementById('overlay').style.display = 'block';
            document.getElementById('detailDialog').style.display = 'block';
        }

        window.onload = function () {
            setRes();
        };

        function createInvoiceHtml(res, dateVal, idName, colorFlg) {
            if (!res || res.length === 0) {
                $(idName).empty();
                return;
            }

            var html = '';

            // ç´å“æ–¹æ³•ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const grouped = {};
            res.forEach(item => {
                if (!grouped[item['ç´å“æ–¹æ³•']]) {
                    grouped[item['ç´å“æ–¹æ³•']] = [];
                }
                grouped[item['ç´å“æ–¹æ³•']].push(item);
            });

            if (colorFlg) {
                html += `<p class="info_table today_color">${dateVal} ç™ºé€</p>`;
            } else {
                html += `<p class="info_table">${dateVal} ç™ºé€</p>`;
            }

            html += `<table class="table table-bordered">`;
            html += `<thead><tr class="${colorFlg ? 'today_color' : 'table-primary'}">`;

            // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
            Object.entries(grouped).forEach(([method, items]) => {
                const escapedMethod = escapeHtml(method);
                if (method === 'ãƒ¤ãƒãƒˆ' || method === 'ä½å·') {
                    html += `<th colspan="${items.length}" class="${colorFlg ? 'today_color' : ''}" scope="col">${escapedMethod}</th>`;
                } else {
                    html += `<th rowspan="2" class="${colorFlg ? 'today_color' : ''}" scope="col" style="vertical-align: middle;">${escapedMethod}</th>`;
                }
            });

            html += `</tr>`;

            // ã‚¯ãƒ¼ãƒ«åŒºåˆ†ã®è¡Œï¼ˆãƒ¤ãƒãƒˆãƒ»ä½å·ã®ã¿ï¼‰
            html += `<tr class="${colorFlg ? 'today_color' : 'table-primary'}">`;
            Object.entries(grouped).forEach(([method, items]) => {
                if (method === 'ãƒ¤ãƒãƒˆ' || method === 'ä½å·') {
                    items.forEach(item => {
                        const coolType = escapeHtml(item['ã‚¯ãƒ¼ãƒ«åŒºåˆ†'] || 'å¸¸æ¸©');
                        html += `<th class="${colorFlg ? 'today_color' : ''}" scope="col">${coolType}</th>`;
                    });
                }
            });
            html += `</tr></thead>`;

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            html += `<tbody class="table-group-divider"><tr>`;
            Object.entries(grouped).forEach(([method, items]) => {
                items.forEach(item => {
                    const count = escapeHtml(String(item['å€‹æ•°'] || ''));
                    html += `<td scope="col" class="text-center fw-bold text-primary">${count}ä»¶</td>`;
                });
            });

            html += `</tr></tbody></table>`;
            $(idName).html(html);
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ã‚«ãƒ¼ãƒ‰å½¢å¼ã®å•†å“è¡¨ç¤ºï¼ˆã‚¹ã‚­ãƒ£ãƒ³ãƒ»å‡ºè·æ¸ˆãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
        function createProductHtml(res, dateVal, idName, colorFlg) {
            if (!res || res.length === 0) {
                $(idName).html('<div class="alert alert-light text-center py-4 border-dashed" style="border: 2px dashed #e5e7eb; color: #94a3b8; border-radius: 12px;"><i class="bi bi-info-circle me-2"></i>' + dateVal + 'ã®ç™ºé€äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>');
                return;
            }

            let html = '';
            if (colorFlg) {
                html += `<p class="info_table today_color">${dateVal} ç™ºé€å•†å“è©³ç´°</p>`;
            } else {
                html += `<p class="info_table">${dateVal} ç™ºé€å•†å“è©³ç´°</p>`;
            }

            html += `<div class="dashboard-grid">`;

            for (let i = 0; i < res.length; i++) {
                const order = res[i];
                const coolCls = order['ã‚¯ãƒ¼ãƒ«åŒºåˆ†'] || '';

                // ã‚¯ãƒ¼ãƒ«åŒºåˆ†ãƒãƒƒã‚¸
                let coolBadge = '';
                if (coolCls.includes('å†·è”µ')) {
                    coolBadge = '<span class="cool-badge cool-badge-reizo">å†·è”µ</span>';
                } else if (coolCls.includes('å†·å‡')) {
                    coolBadge = '<span class="cool-badge cool-badge-reito">å†·å‡</span>';
                } else if (coolCls && coolCls !== 'ãªã—' && coolCls !== 'å¸¸æ¸©') {
                    coolBadge = '<span class="cool-badge bg-warning text-dark" style="font-size:0.6rem">' + coolCls + '</span>';
                }

                const isShipped = order['shipped'] === true || order['shipped'] === 'â—‹';
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const shipDate = order.shippingDate ? new Date(order.shippingDate) : null;
                if (shipDate) shipDate.setHours(0, 0, 0, 0);
                const isOverdue = !isShipped && shipDate && shipDate.getTime() < todayStart.getTime();
                html += `<div class="order-card shadow-sm ${isShipped ? 'shipped' : ''} ${isOverdue ? 'overdue-row' : ''}">`;

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã‚’ç”Ÿæˆ
                const statusBadgeHtml = order.status ? getStatusBadge(order.status) : '';

                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ç·¨é›†ï¼‰
                const escapedOrderId = escapeHtml(order.orderId);
                const escapedRecipientName = escapeHtml(order['ç™ºé€å…ˆå'] || '');
                const escapedDeliveryMethod = escapeHtml(order.deliveryMethod || '');

                const currentStatus = order.status || (isShipped ? 'å‡ºè·æ¸ˆã¿' : 'ç™ºé€å‰');

                const actionsHtml = `
                    <div class="order-card-actions" style="flex-direction: column; gap: 5px; align-items: stretch;">
                        <select class="form-select form-select-sm status-select" data-order-id="${escapedOrderId}" style="font-size: 0.65rem; padding: 1px 2px; width: 100%; min-width: 70px; text-align: center;">
                            <option value="ç™ºé€å‰" ${currentStatus === 'ç™ºé€å‰' ? 'selected' : ''}>ç™ºé€å‰</option>
                            <option value="åç©«å¾…ã¡" ${currentStatus === 'åç©«å¾…ã¡' ? 'selected' : ''}>ğŸŒ±å¾…ã¡</option>
                            <option value="å‡ºè·æ¸ˆã¿" ${currentStatus === 'å‡ºè·æ¸ˆã¿' ? 'selected' : ''}>âœ“æ¸ˆ</option>
                        </select>
                        <button type="button" class="btn btn-sm scan-btn-mini" data-order-id="${escapedOrderId}" data-recipient-name="${escapedRecipientName}" data-delivery-method="${escapedDeliveryMethod}" title="ä¼ç¥¨ã‚¹ã‚­ãƒ£ãƒ³" style="width: 100%;">
                            <i class="bi bi-upc-scan"></i>
                        </button>
                        ${statusBadgeHtml}
                    </div>
                `;

                // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç™ºé€å…ˆæƒ…å ±ï¼‰
                html += `<div class="order-card-header">`;
                html += `<div class="order-card-info-main">`;
                html += `<h4 class="order-card-title">${escapeHtml(order['ç™ºé€å…ˆå'] || '')} æ§˜</h4>`;
                if (isOverdue) {
                    html += `<span class="badge bg-danger ms-1" style="font-size:0.65rem">äºˆå®šæ—¥è¶…é</span>`;
                }
                html += `<span class="order-card-customer">ä¾é ¼ä¸»: ${escapeHtml(order['é¡§å®¢å'] || '')}</span>`;

                // ã‚¯ãƒ¼ãƒ«åŒºåˆ†ãƒãƒƒã‚¸
                if (coolBadge) {
                    html += `<div class="mt-1">${coolBadge}</div>`;
                }

                html += `</div>`; // info-main
                html += actionsHtml;
                html += `</div>`; // header

                // å•†å“ãƒªã‚¹ãƒˆ
                html += `<div class="order-card-body">`;
                let combinedMemo = [];

                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã™ã§ã«é›†ç´„æ¸ˆã¿ã®ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
                if (order['aggregatedMemos'] && Array.isArray(order['aggregatedMemos'])) {
                    combinedMemo = order['aggregatedMemos'];
                } else {
                    const seenMemos = new Set();
                    for (let j = 0; j < order['å•†å“'].length; j++) {
                        const p = order['å•†å“'][j];
                        if (p['ãƒ¡ãƒ¢']) {
                            const rawMemo = String(p['ãƒ¡ãƒ¢']).trim();
                            if (rawMemo && !seenMemos.has(rawMemo)) {
                                seenMemos.add(rawMemo);
                                combinedMemo.push(escapeHtml(p['ãƒ¡ãƒ¢']));
                            }
                        }
                    }
                }

                for (let j = 0; j < order['å•†å“'].length; j++) {
                    const p = order['å•†å“'][j];
                    const unit = escapeHtml(p['å˜ä½'] || 'æš');
                    const productName = escapeHtml(p['å•†å“å'] || '');
                    const quantity = escapeHtml(String(p['å—æ³¨æ•°'] || ''));
                    html += `<div class="product-list-item">`;
                    html += `<span class="product-name">${productName}</span>`;
                    html += `<span class="product-quantity">${quantity} ${unit}</span>`;
                    html += `</div>`;
                }

                // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¡¨ç¤º
                if (combinedMemo.length > 0) {
                    html += `<div class="memo-box">`;
                    html += `<span class="memo-icon">ğŸ“Œ</span>`;
                    html += `<div>${combinedMemo.join('<br>')}</div>`;
                    html += `</div>`;
                }

                html += `</div>`; // body
                html += `</div>`; // card
            }

            html += `</div>`; // grid
            $(idName).html(html);
        }

        // é…é€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
        function getStatusBadge(status) {
            if (!status) return '';
            const escapedStatus = escapeHtml(status);
            let badgeClass = 'bg-secondary';
            if (status === 'é…é”å®Œäº†' || status === 'å‡ºè·æ¸ˆã¿') badgeClass = 'bg-success';
            else if (status === 'ç™ºé€æ¸ˆ' || status === 'é…é”ä¸­') badgeClass = 'bg-primary';
            else if (status === 'ä¸åœ¨/æŒæˆ»' || status === 'åç©«å¾…ã¡') badgeClass = 'bg-warning text-dark';
            else if (status.includes('ã‚¨ãƒ©ãƒ¼')) badgeClass = 'bg-danger';

            return `<span class="badge ${badgeClass} mt-1" style="font-size: 0.65rem;">${escapedStatus}</span>`;
        }

        // å‡ºè·æ¸ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
        function updateShippedStatus(orderId, isChecked) {
            const shippedValue = isChecked ? 'â—‹' : '';
            google.script.run
                .withSuccessHandler(function () {
                    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                    google.script.run.withSuccessHandler(setTable).selectShippingDate();
                })
                .withFailureHandler(function (error) {
                    alert('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    google.script.run.withSuccessHandler(setTable).selectShippingDate();
                })
                .updateOrderShippedStatus(orderId, shippedValue);
        }

        // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼é–¢é€£ã®å¤‰æ•°
        let currentScanOrderId = null;
        let currentScanCustomerName = '';
        let currentScanDeliveryMethod = '';
        let isScannerProcessing = false;

        // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
        function openScannerDialog(orderId, customerName, deliveryMethod) {
            currentScanOrderId = orderId;
            currentScanCustomerName = customerName;
            currentScanDeliveryMethod = deliveryMethod || '';
            document.getElementById('scannerTargetName').innerText = customerName + " æ§˜ã®ä¼ç¥¨ã‚¹ã‚­ãƒ£ãƒ³";
            const modal = new bootstrap.Modal(document.getElementById('scannerModal'));
            modal.show();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§ã‚¹ã‚­ãƒ£ãƒŠãƒ¼åˆ¶å¾¡
        document.addEventListener('DOMContentLoaded', function () {
            const scannerModalEl = document.getElementById('scannerModal');
            if (scannerModalEl) {
                scannerModalEl.addEventListener('shown.bs.modal', initQuagga);
                scannerModalEl.addEventListener('hidden.bs.modal', () => {
                    Quagga.stop();
                    toggleModalManual(false);
                    const scannerSuccessOverlay = document.getElementById('scannerSuccessOverlay');
                    const scannerErrorOverlay = document.getElementById('scannerErrorOverlay');
                    if (scannerSuccessOverlay) scannerSuccessOverlay.style.display = 'none';
                    if (scannerErrorOverlay) scannerErrorOverlay.style.display = 'none';
                });
            }

            // è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            const closeDialogButton = document.getElementById('closeDialogButton');
            if (closeDialogButton) {
                closeDialogButton.addEventListener('click', function () {
                    const detailDialog = document.getElementById('detailDialog');
                    const overlay = document.getElementById('overlay');
                    if (detailDialog) detailDialog.style.display = 'none';
                    if (overlay) overlay.style.display = 'none';
                });
            }
            const closeHarvestBtn = document.getElementById('closeHarvestWaitingDialogBtn');
            if (closeHarvestBtn) closeHarvestBtn.addEventListener('click', closeHarvestWaitingDialog);
            const harvestOverlay = document.getElementById('harvestWaitingOverlay');
            if (harvestOverlay) harvestOverlay.addEventListener('click', closeHarvestWaitingDialog);

            // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²: å‡ºè·æ¸ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            document.addEventListener('change', function(e) {
                if (e.target && e.target.classList.contains('shipped-check')) {
                    const orderId = e.target.getAttribute('data-order-id');
                    const isChecked = e.target.checked;
                    if (orderId) {
                        updateShippedStatus(orderId, isChecked);
                    }
                }
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²: ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³
            document.addEventListener('click', function(e) {
                if (e.target && e.target.closest('.scan-btn-mini')) {
                    const button = e.target.closest('.scan-btn-mini');
                    const orderId = button.getAttribute('data-order-id');
                    const recipientName = button.getAttribute('data-recipient-name') || '';
                    const deliveryMethod = button.getAttribute('data-delivery-method') || '';
                    if (orderId) {
                        openScannerDialog(orderId, recipientName, deliveryMethod);
                    }
                }
            });
        });

        function initQuagga() {
            isScannerProcessing = false;
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scannerView'),
                    constraints: { facingMode: "environment" },
                },
                decoder: {
                    readers: ["code_128_reader", "codabar_reader", "code_39_reader"]
                },
                locate: true
            }, function (err) {
                if (err) {
                    showScannerError("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    return;
                }
                Quagga.start();
            });
            Quagga.onDetected(onQuaggaDetected);
        }

        function onQuaggaDetected(data) {
            if (isScannerProcessing) return;
            const code = data.codeResult.code;

            // ç´å“æ–¹æ³•ã«å¿œã˜ãŸæ¡æ•°ãƒã‚§ãƒƒã‚¯
            const deliveryMethod = currentScanDeliveryMethod || '';
            let expectedLength = 0;
            let carrierName = '';

            if (deliveryMethod.includes('ãƒ¤ãƒãƒˆ')) {
                expectedLength = 12;
                carrierName = 'ãƒ¤ãƒãƒˆ';
            } else if (deliveryMethod.includes('ä½å·')) {
                expectedLength = 12;
                carrierName = 'ä½å·';
            } else if (deliveryMethod.includes('è¥¿æ¿ƒ')) {
                expectedLength = 10;
                carrierName = 'è¥¿æ¿ƒé‹è¼¸';
            }

            // æ¡æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆç´å“æ–¹æ³•ãŒç‰¹å®šã§ãã‚‹å ´åˆï¼‰
            if (expectedLength > 0 && code && code.length !== expectedLength) {
                document.getElementById('scannerStatus').innerText =
                    `${carrierName}ã®é€ã‚ŠçŠ¶ç•ªå·ã¯${expectedLength}æ¡ã§ã™ã€‚å†åº¦èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚(ç¾åœ¨: ${code.length}æ¡)`;
                setTimeout(() => {
                    document.getElementById('scannerStatus').innerText = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åã‚ã¦ãã ã•ã„";
                }, 3000);
                return;
            }

            // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: 10-12æ¡
            if (code && (code.length >= 10 && code.length <= 12)) {
                // æ—¥æœ¬ã®é›»è©±ç•ªå·ï¼ˆ0ã‹ã‚‰å§‹ã¾ã‚‹10æ¡/11æ¡ï¼‰ã‚’èª¤æ¤œçŸ¥ã—ãªã„ãŸã‚ã®å¯¾ç­–
                if ((code.length === 10 || code.length === 11) && code.startsWith('0')) {
                    return;
                }
                isScannerProcessing = true;
                handleScannerSuccess(code);
            }
        }

        function handleScannerSuccess(code) {
            document.getElementById('scannerBeepSound').play();
            document.getElementById('modalScannedNo').innerText = code;
            document.getElementById('scannerSuccessOverlay').style.display = 'flex';

            google.script.run
                .withSuccessHandler(res => {
                    if (res.success) {
                        setTimeout(() => {
                            bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide();
                            // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                            setRes();
                        }, 1000);
                    } else showScannerError(res.message);
                })
                .updateOrderTrackingStatus(currentScanOrderId, code);
        }

        async function captureAndOcrModal() {
            if (isScannerProcessing) return;
            isScannerProcessing = true;
            document.getElementById('scannerStatus').innerText = "ç”»åƒã‚’è§£æä¸­...";
            try {
                const video = document.querySelector('#scannerView video');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const base64Data = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

                google.script.run
                    .withSuccessHandler(res => {
                        if (res.success) handleScannerSuccess(res.code);
                        else {
                            isScannerProcessing = false;
                            alert("èªè­˜ä¸å¯: " + res.message);
                            document.getElementById('scannerStatus').innerText = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åã‚ã¦ãã ã•ã„";
                        }
                    })
                    .withFailureHandler(() => {
                        isScannerProcessing = false;
                        alert("OCRã‚¨ãƒ©ãƒ¼");
                    })
                    .recognizeTrackingNumber(base64Data);
            } catch (e) {
                isScannerProcessing = false;
                alert("ã‚­ãƒ£ãƒ—ãƒãƒ£å¤±æ•—");
            }
        }

        function showScannerError(msg) {
            isScannerProcessing = true;
            document.getElementById('scannerErrorMsg').innerText = msg;
            document.getElementById('scannerErrorOverlay').style.display = 'flex';
        }

        function retryScanner() {
            isScannerProcessing = false;
            document.getElementById('scannerErrorOverlay').style.display = 'none';
            document.getElementById('scannerSuccessOverlay').style.display = 'none';
            initQuagga();
        }

        function toggleModalManual(show) {
            const area = document.getElementById('modalManualInputArea');
            if (show) {
                area.style.display = 'flex';
                document.getElementById('modalManualNo').focus();
            } else {
                area.style.display = 'none';
            }
        }

        function submitModalManual() {
            const code = document.getElementById('modalManualNo').value.trim().replace(/-/g, '');
            if (code) handleScannerSuccess(code);
        }
    </script>

    <audio id="scannerBeepSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- é…é€ä¼ç¥¨ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="scannerModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-black text-white">
                <div class="info py-2 bg-primary text-center fw-bold">
                    <span id="scannerTargetName">ä¼ç¥¨ã‚¹ã‚­ãƒ£ãƒ³</span>
                </div>
                <div class="modal-body p-0 position-relative overflow-hidden" style="flex: 1;">
                    <div id="scannerView" class="w-100 h-100"></div>
                    <div class="scanner-overlay">
                        <div class="scanner-region"></div>
                    </div>
                    <!-- æ‰‹å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                    <div id="modalManualInputArea" class="manual-input-area p-4">
                        <h3 class="text-center mb-4">é€ã‚ŠçŠ¶ç•ªå·ã‚’å…¥åŠ›</h3>
                        <div class="input-group input-group-lg mb-4">
                            <input type="tel" id="modalManualNo" class="form-control text-center"
                                placeholder="123456789012" maxlength="12">
                        </div>
                        <div class="d-grid gap-3">
                            <button onclick="submitModalManual()" class="btn btn-primary py-3">æ±ºå®š</button>
                            <button onclick="toggleModalManual(false)" class="btn btn-outline-light">ã‚¹ã‚­ãƒ£ãƒ³ã«æˆ»ã‚‹</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex-column bg-black border-0 p-3">
                    <div id="scannerStatus" class="mb-3">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«åã‚ã¦ãã ã•ã„</div>
                    <div class="d-flex gap-2 w-100 mb-2">
                        <button onclick="captureAndOcrModal()" class="btn btn-warning flex-grow-1 py-3 text-dark">
                            <i class="bi bi-camera"></i> å†™çœŸã§èª­ã¿å–ã‚‹
                        </button>
                    </div>
                    <div class="d-flex gap-2 w-100">
                        <button onclick="toggleModalManual(true)" class="btn btn-primary flex-grow-1 py-3">
                            <i class="bi bi-keyboard"></i> æ‰‹å…¥åŠ›
                        </button>
                        <button type="button" class="btn btn-outline-light py-3 px-4"
                            data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="scannerSuccessOverlay" class="scanner-result-overlay">
        <h2 class="mb-3">ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸï¼</h2>
        <div id="modalScannedNo" class="h1 mb-4"></div>
        <div class="spinner-border text-light mb-3" role="status"></div>
        <div>ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°ä¸­...</div>
    </div>
    <div id="scannerErrorOverlay" class="scanner-error-overlay">
        <h2 class="mb-3">ã‚¨ãƒ©ãƒ¼</h2>
        <div id="scannerErrorMsg" class="mb-4"></div>
        <button onclick="retryScanner()" class="btn btn-light px-5">å†è©¦è¡Œ</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    <script>
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°UI
        function updateOrderStatusUI(orderId, newStatus) {
            const selectElem = document.querySelector(`.status-select[data-order-id="${orderId}"]`);
            if (selectElem) selectElem.disabled = true;

            toggleLoading(true);

            google.script.run
                .withSuccessHandler(function () {
                    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ (executeSearchã‚’ä½¿ã‚ãšç›´æ¥ãƒ­ãƒ¼ãƒ‰ã—ã¦Spinneråˆ¶å¾¡)
                    google.script.run.withSuccessHandler(function (res) {
                        setTable(res);
                        toggleLoading(false);
                    }).selectShippingDate();
                })
                .withFailureHandler(function (error) {
                    alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    if (selectElem) selectElem.disabled = false;
                    toggleLoading(false);
                    executeSearch();
                })
                .updateOrderStatus(orderId, newStatus);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²
        document.body.addEventListener('change', function (e) {
            if (e.target.classList.contains('status-select')) {
                const orderId = e.target.getAttribute('data-order-id');
                const newStatus = e.target.value;
                updateOrderStatusUI(orderId, newStatus);
            }
        });

        // æ¤œç´¢å®Ÿè¡Œ
        function executeSearch() {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('cntRes').innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            google.script.run
                .withSuccessHandler(setTable)
                .withFailureHandler(function (e) {
                    document.getElementById('cntRes').innerHTML = '<div class="alert alert-danger">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message + '</div>';
                })
                .selectShippingDate();
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        window.onload = function () {
            executeSearch();
        };

        // Modalé–¢é€£ã¯å‰Šé™¤
    </script>
    <div id="loadingOverlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2 text-white fw-bold">å‡¦ç†ä¸­...</div>
    </div>
</body>

</html>