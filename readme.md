# README

## 農家用受注管理システム

本システムは、農家向けの受注管理を効率化するために設計されたGoogle App Script（GAS）と連携したテンプレートです。スプレッドシートをDB、GASファイルをバックエンド、HTMLをフロントエンドとして扱い、WEBアプリを実現しています。

以下では、各画面の機能、各シートの役割を説明します。

---

## 画面一覧

### ログイン画面
- **紐づくシート**: pass
- **主な機能**:
  - 画面から入力したIDとPassをもとにシート「pass」と比較し、正しい場合ホーム画面に遷移します。

---

### ホーム画面（アコーディオンメニュー）
- **紐づくシート**: 受注
- **主な機能**:
  - **表示機能**:
    - シート「受注」から最大5日分（昨日、今日、明日、明後日、明々後日）の発注日に紐づくデータを抽出し、以下の情報を表示します。
      - 納品方法ごとの件数
      - 対象の顧客名、商品名、個数
  - **メニュー構成**:

#### 📝 受注管理セクション
| ボタン名 | 遷移先 | 説明 |
|---------|--------|------|
| 📝 受注入力 | 受注登録画面 | 通常の受注入力（AI機能付き） |
| 📞 電話受注 | 電話受注モード | 電話対応中の簡易入力（3タップ完結） |
| 📥 CSV取込 | 受注CSV取込画面 | 食べチョク/ポケマル/ふるさと納税 CSV取込 |

#### 📊 閲覧・編集セクション
| ボタン名 | 遷移先 | 説明 |
|---------|--------|------|
| 📊 発注一覧 | ヒートマップ発注一覧 | 商品×日付のヒートマップ表示 |
| 📑 受注一覧 | 受注一覧画面 | 受注データの検索・編集 |
| 🤖 AI取込一覧 | AI取込一覧画面 | AI解析済み注文の確認・処理（未処理件数バッジ表示） |

#### 💼 帳票作成セクション
| ボタン名 | 遷移先 | 説明 |
|---------|--------|------|
| 📦 送り状作成 | 発送伝票作成画面 | ヤマト/佐川のCSVファイル生成 |
| 💰 請求書作成 | 請求書作成画面 | 期間指定で請求書PDF一括生成 |
| 📋 見積書作成 | 見積書作成画面 | 見積書データ登録とPDF生成 |

#### 📂 データ参照セクション
| ボタン名 | 遷移先 | 説明 |
|---------|--------|------|
| 🛍️ 商品情報 | スプレッドシート「商品」 | 商品マスタを開く |
| 👥 顧客情報 | スプレッドシート「顧客情報」 | 顧客マスタを開く |
| 📑 受注シート | スプレッドシート「受注」 | 受注データを開く |
| 📋 見積書 | 見積書フォルダ | 見積書PDFフォルダを開く |
| 💰 請求書 | 請求書フォルダ | 請求書PDFフォルダを開く |
| 📄 納品書 | 納品書フォルダ | 納品書PDFフォルダを開く |
| 🚚 ヤマト送り状 | ヤマト送り状フォルダ | ヤマト運輸CSVフォルダを開く |
| 🚛 佐川送り状 | 佐川送り状フォルダ | 佐川急便CSVフォルダを開く |

#### 🛠️ ユーティリティセクション
| ボタン名 | 機能 | 説明 |
|---------|------|------|
| 🔄 キャッシュ更新 | マスタキャッシュ更新 | 商品・顧客マスタのキャッシュを手動更新 |

---

### 受注登録画面（受注入力）
- **紐づくシート**: クール区分、ヤマトCSV、佐川CSV、受付方法、受注、商品、商品分類、担当者、発送先情報、納品方法、荷扱い、送り状種別、配送時間帯、顧客情報
- **主な機能**:
  - **AI入力アシスタント**（モーダル）:
    - テキスト解析: 注文内容を自動抽出
    - ファイル解析: PDF/画像（Gemini Vision API）から注文情報を抽出
    - マスタ照合: 顧客・発送先・商品マスタとの自動照合
    - 商品マッピング学習: 顧客ごとの商品名表記を学習
    - 確認・修正機能: AI解析結果を確認してフォームに反映
  - **顧客情報**:
    - 検索機能（会社名・氏名・電話番号・住所）
    - 新規登録機能
    - 前回受注内容の反映
    - 見積書情報の反映
  - **発送先情報**:
    - 検索機能
    - 新規登録機能
    - 顧客情報からのコピー
  - **発送元情報**: シート「会社名」を参照可能
  - **複数日程対応**: 最大10日程の同時登録が可能
  - **商品入力**: 最大10商品まで入力可能
  - **チェックリスト**: 納品書/請求書/領収書/パンフ/レシピ
  - **PDF自動生成**: 納品書・領収書のPDF自動作成
  - **CSV自動登録**: ヤマト/佐川のCSVデータ自動登録（お客様管理番号に受注ID設定）

---

### 電話受注モード
- **紐づくシート**: 受注、顧客情報、発送先情報、商品、商品分類
- **主な機能**:
  - **4ステップ画面遷移**:
    1. 顧客選択（既存顧客/新規顧客）
    2. 商品選択・数量入力
    3. 配送設定（発送元、チェックリスト）
    4. 確認・送信
  - **新規顧客登録**:
    - 会社名と氏名を分離して入力
    - 顧客情報・発送先情報マスタに自動登録
    - 重複チェック（会社名AND氏名で判定）
  - **前回と同じ注文**:
    - ボタン1つで前回注文を呼び出し
    - 数量のみ変更可能
  - **過去注文比較チェック**:
    - 直近3回の注文と自動比較
    - 数量が±50%以上異なれば警告
    - いつも注文している商品が欠けていれば警告
  - **発送先選択**:
    - 最終注文日でソート表示
    - インクリメンタル検索機能
  - **モバイル最適化**: スマホ・タブレットでの操作を想定したUI

---

### 受注一覧画面
- **紐づくシート**: 受注、発送先情報、顧客情報
- **主な機能**:
  - **検索・フィルター**:
    - 発送日範囲指定（先月、今月、前日、本日、明日など）
    - 発送先名検索
    - 顧客名検索
    - 出荷状態フィルター（すべて、未出荷、出荷済み、予定日超過、キャンセル済み）
    - **検索条件の引き継ぎ**: 各画面への遷移および戻り時に検索条件を自動で維持
  - **一覧表示**:
    - 受注ID、受注日、発送日、納品日
    - 顧客名、発送先名、品名
    - 商品数、合計金額
    - **視認性向上**: ステータスに応じた行の色分け（出荷済：緑、予定日超過：赤、キャンセル：オレンジ）、ホバーエフェクト、選択行のハイライト
    - **スティッキーヘッダー**: スクロール時に見出しを上部に固定
  - **編集・操作機能**:
    - **詳細モーダル**: 行クリックで全項目を確認。詳細画面から「伝票スキャン」「コピー」「修正」が可能。
    - 一覧から受注IDを選択して編集（修正画面へ遷移）
    - データのコピー（新規受注登録に引き継ぎ）
    - **配送伝票スキャン**: スマホカメラで伝票バーコードを読み取り、追跡番号を自動登録＆出荷済みに更新。OCRによる番号読み取り・手入力もサポート。
    - **一括操作**: 複数選択した受注を一括で「出荷済み」「キャンセル」「削除」「キャンセル解除」
    - **整合性維持**: 削除時はヤマト/佐川CSVの関連データも自動削除

---

### AI取込一覧画面
- **紐づくシート**: 仮受注（LINE Bot用スプレッドシート）
- **主な機能**:
  - **サマリー表示**: 未処理/処理済み/却下件数
  - **カード形式一覧**: 仮受注データをカード表示
  - **フィルター機能**: ステータス別の絞り込み
  - **詳細モーダル**: 解析結果の詳細表示
  - **アクション**:
    - 受注処理: AI解析結果を受注登録画面に引き継ぎ
    - 却下: 仮受注をステータス「却下」に変更
    - 削除: 仮受注データを完全削除
  - **自動解析**:
    - Google DriveフォルダにPDF/画像を配置すると自動解析
    - マスタ照合（商品・顧客・発送先）
    - LINE通知（まとめ通知/定期リマインド）

---

### ヒートマップ発注一覧画面
- **紐づくシート**: 受注、商品
- **主な機能**:
  - **ヒートマップ表示**: 商品×日付のマトリクス表示
  - **商品名略称**: 長い商品名を自動短縮表示
  - **色分け**: 数量に応じた色分け（視認性向上）
  - **日付範囲指定**: 表示期間の指定

---

### 発送伝票作成画面
- **紐づくシート**: ヤマトCSV、佐川CSV
- **主な機能**:
  - シート「ヤマトCSV」「佐川CSV」から指定された発送日に紐づくデータを抽出し、発送伝票フォルダにCSVファイルを生成。
  - ヤマト運輸・佐川急便の送り状システムに取り込み可能なフォーマット。

---

### 請求書作成画面
- **紐づくシート**: 受注
- **主な機能**:
  - 指定期間に紐づく受注データを抽出し、請求書フォルダに顧客ごとのPDF請求書を生成。
  - 注意:
    - 顧客名を指定した場合：指定された顧客のデータのみ抽出。
    - 顧客名を指定しない場合：期間内の全顧客データを抽出。

---

### 受注CSV取込画面
- **紐づくシート**: 受注、食べチョク商品、ポケマル商品、ふるさと納税商品
- **主な機能**:
  - 各プラットフォーム（食べチョク、ポケマル、ふるさと納税）のCSVファイルをシート「受注」に取り込み可能。
  - 商品名や数量を変換して対応。
  - 商品マッピングテーブルによる自動変換。

---

### 見積書作成画面
- **紐づくシート**: 保存温度帯、単位、商品、商品分類、見積書、見積書データ、見積納品方法
- **主な機能**:
  - 見積書のデータ登録とPDF生成。
  - 登録データは受注管理画面で利用可能。

---

## シートごとの概要と機能

### 1. 商品
- **目的**: 商品情報の登録、編集、管理。
- **データ項目**: 商品分類、商品名、価格、原価、在庫数、税率。
- **主な機能**:
  - 新しい商品を登録。
  - 商品の原価や粗利を自動計算。
  - 受注管理画面の商品情報として参照。
  - AI解析時のマスタ照合に使用。

---

### 2. 受注
- **目的**: 受注データを一元管理。
- **データ項目**: 受注ID、受注日、発送日、商品名、受注数、顧客情報、納品方法、発送先情報、出荷済、追跡番号、ステータス。
- **主な機能**:
  - 受注の新規登録および編集。
  - 受注IDによる一意管理（8桁英数字）。
  - 発送情報を基にCSVファイルを生成。
  - ホーム画面の発送件数情報、作業指示書として活用。
  - **自動追跡同期**: 定期トリガーにより、運送会社のサイトから配送状況を自動取得しステータスを更新（配達完了など）。

---

### 3. ヤマトCSV / 佐川CSV
- **目的**: 配送業者向けの送り状データを自動生成。
- **データ項目**:
  - 配送日、送り状種別、品名、クール区分、配送先住所、連絡先
  - **お客様管理番号**（受注IDを設定、13桁以内）
- **主な機能**:
  - ヤマト運輸または佐川急便向けのCSVデータ生成。
  - **受注IDとの紐付け**: お客様管理番号に受注IDを自動設定。
  - **受注編集時の自動更新**:
    - 編集時は古いCSVデータを自動削除
    - 新しいデータを再登録
    - 納品方法変更時も対応
  - **データ整合性**: 受注シートとCSVシートの一貫性を保証。

---

### 4. 顧客情報
- **目的**: 顧客情報を管理。
- **データ項目**: 顧客分類、表示名、フリガナ、**会社名**、部署、役職、**氏名**、郵便番号、住所、TEL、携帯電話、FAX、メールアドレス、請求書有無、入金期日、備考。
- **主な機能**:
  - 顧客の新規登録と編集。
  - 顧客リストからの検索機能（会社名・氏名・電話番号・住所）。
  - 電話受注モードからの自動登録。
  - **会社名と氏名を分離管理**（同姓同名別会社対応）。
  - AI解析時のマスタ照合に使用。

---

### 5. 発送先情報
- **目的**: 発送先情報を管理。
- **データ項目**: **会社名**、部署、**氏名**、郵便番号、住所１、住所２、TEL、メールアドレス、備考。
- **主な機能**:
  - 発送先の登録と更新。
  - 顧客情報と連動したデータ参照。
  - 電話受注モードからの自動登録。
  - **会社名と氏名を分離管理**。
  - AI解析時のマスタ照合に使用。

---

### 6. 仮受注（LINE Bot用スプレッドシート）
- **目的**: AI解析した注文情報を一時保管。
- **データ項目**: 仮受注ID、登録日時、ステータス、顧客名、発送先名、商品データJSON、原文、解析結果JSON、ファイルURL、処理日時。
- **主な機能**:
  - Driveトリガーによる自動AI解析結果を保存。
  - AI取込一覧画面で確認・処理。
  - LINE通知の送信元データ。
  - 受注登録完了時に自動削除。

---

### 7. 利益管理表
- **目的**: 月ごとの利益を視覚的に確認。
- **データ項目**: 商品名、月別利益額。
- **主な機能**:
  - 受注データをもとに売上データから利益を自動集計。
  - グラフなどを使用した可視化。

---

## 技術スタック

### フロントエンド
- HTML5 + CSS3 + JavaScript
- Bootstrap 5（レスポンシブデザイン）
- jQuery

### バックエンド
- Google Apps Script (GAS)
- TypeScript型定義あり

### データベース
- Google Spreadsheet（マスタデータ・トランザクションデータ）

### AI・外部API
- Google Gemini API（テキスト解析）
- Gemini Vision API（PDF/画像解析）
- LINE Messaging API（通知）

### トリガー
- 時間主導型トリガー（5分間隔、毎日17時）
- Driveトリガー（フォルダ監視）
- 配送状況同期トリガー（1時間間隔、追跡番号の自動更新用）

---

## セットアップ手順

### 1. スプレッドシートの準備
1. [スプレッドシートテンプレート](https://docs.google.com/spreadsheets/d/1FpMhNnld3DgZ2IhpofV4YSqqT4Tk0oxUWuVQTcwIAbM/edit?usp=drive_link)をコピー
2. 必要なシート（商品、顧客情報、受注など）に基本データを入力

### 2. Apps Scriptのデプロイ
1. src/ 内のファイルを gas/ にコピー
2. clasp push でGASにデプロイ
3. ウェブアプリとして公開

### 3. スクリプトプロパティの設定
| プロパティ名 | 説明 | 必須 |
|-------------|------|------|
| `GEMINI_API_KEY` | Gemini APIキー | ✅ |
| `MASTER_SPREADSHEET_ID` | マスタスプレッドシートID | ✅ |
| `LINE_BOT_SPREADSHEET_ID` | LINE Bot用スプレッドシートID | ✅ |
| `LINE_CHANNEL_ACCESS_TOKEN` | LINEチャネルアクセストークン | ⚪ |
| `LINE_USER_IDS` | 通知先LINEユーザーID（カンマ区切り） | ⚪ |

### 4. トリガーの設定（オプション）
```javascript
// GASエディタで実行
setupDriveTrigger();              // Driveフォルダ監視（5分ごと）
setupBatchNotificationTrigger();  // LINEまとめ通知（5分ごと）
setupDailyReminderTrigger();      // LINE定期リマインド（毎日17時）
setupSyncTrigger();               // 配送状況同期（1時間ごと）
```

---

## 使用方法

### 基本フロー
1. **初期設定**: 必要なシートに基本データ（商品、顧客情報など）を入力。
2. **受注登録**:
   - 通常入力: 受注登録画面で手入力またはAI解析を使用
   - 電話受注: 電話受注モードで3タップで完結
   - CSV取込: 食べチョク/ポケマル等のCSVを一括取込
   - AI自動取込: DriveフォルダにPDF/画像を配置すると自動解析
3. **帳票作成**:
   - 送り状: ヤマト/佐川のCSVファイルを生成
   - 請求書: 期間指定で顧客別PDF一括生成
   - 見積書: 見積書データ登録とPDF生成
4. **データ確認**:
   - 受注一覧: 検索・編集
   - ヒートマップ: 商品×日付の視覚的確認
   - 利益管理表: 月別利益の確認

### AI機能の使い方
1. **テキスト解析**: 受注登録画面でAI入力アシスタントを開き、注文内容をコピペ
2. **ファイル解析**: PDF/画像をアップロード
3. **自動解析**: DriveフォルダにファイルをドラッグAndドロップ→AI取込一覧で確認

---

## サンプル画面
- [サンプル画面リンク](https://script.google.com/macros/s/AKfycbz0iqzBlnOSffijkMLhDuJz7d6B80R0Fa-mwxs4RqRB_JMSkWEhKur2fAdfjSVVQQvYuA/exec)
  - Google App Scriptによる画面例。実際の操作感を体験できます。
  - ID: test
  - pass: test

---

## テンプレート
- [スプレッドシートテンプレートリンク](https://docs.google.com/spreadsheets/d/1FpMhNnld3DgZ2IhpofV4YSqqT4Tk0oxUWuVQTcwIAbM/edit?usp=drive_link)
  - 本システムで使用するGoogleスプレッドシートのテンプレート。
