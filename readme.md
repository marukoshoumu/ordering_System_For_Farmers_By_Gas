# README

## 農家用受注管理システム

本システムは、農家向けの受注管理を効率化するために設計されたGoogle App Script（GAS）と連携したテンプレートです。スプレッドシートをDB、GASファイルをバックエンド、HTMLをフロントエンドとして扱い、WEBアプリを実現しています。

以下では、各画面の機能、各シートの役割を説明します。

---

## 画面一覧

### ログイン画面
- **紐づくシート**: pass
- **主な機能**:
  - 画面から入力したIDとPassをもとにシート「pass」と比較し、正しい場合ホーム画面に遷移します。

---

### ホーム画面（アコーディオンメニュー）
- **紐づくシート**: 受注
- **主な機能**:
  - **表示機能**:
    - シート「受注」から最大5日分（昨日、今日、明日、明後日、明々後日）の発送日に紐づくデータを抽出し、以下の情報を表示します。
      - 納品方法ごとの件数
      - 対象の顧客名、商品名、個数
    - 各日付の詳細をクリックすると詳細ダイアログが表示（顧客名、発送先名、商品名、個数、メモ）
  - **スキャン機能**: viewer権限でも利用可能。伝票バーコードをスキャンして追跡番号を登録・出荷済みに更新。
  - **発送状況確認**: 各受注の出荷状況をバッジで表示（出荷済み/未出荷/予定日超過/キャンセル済み）。
  - **メニュー構成**:

#### 📝 受注管理セクション
| ボタン名 | 遷移先 | 説明 |
|---------|--------|------|
| 📝 受注入力 | 受注登録画面 | 通常の受注入力。AI入力アシスタント（テキスト解析・ファイル解析）、顧客・発送先検索（60倍高速化）、商品入力、PDF自動生成、CSV自動登録機能あり。 |
| 📞 電話受注 | 電話受注モード | 電話対応中の簡易入力。4ステップ画面遷移、新規顧客自動登録、前回注文呼び出し、過去注文比較チェック、モバイル最適化UI。 |
| 📥 CSV取込 | 受注CSV取込画面 | 食べチョク/ポケマル/ふるさと納税のCSVファイルを一括取込。商品マッピングテーブルによる自動変換。 |

#### 📊 一覧セクション
| ボタン名 | 遷移先 | 説明 |
|---------|--------|------|
| 📈 売上ダッシュボード | 売上ダッシュボード画面 | 売上データの可視化（admin専用）。月次サマリー（売上高・受注件数・販売商品数・総販売数）、商品分類別構成比、商品別売上ランキングTOP10、顧客別売上ランキングTOP10、年間売上推移、顧客リテンション分析、季節パターン分析、顧客傾向分析。 |
| 📊 製造数一覧 | 製造数一覧画面 | 商品×日付のヒートマップ表示。期間フィルタ（今週/来週/今月/来月/期間指定）、発送先・顧客検索、商品分類マルチセレクト、商品名は「送り状品名」（略称）を表示。 |
| 📑 受注一覧 | 受注一覧画面 | 受注データの検索・編集。発送日範囲指定、発送先名・顧客名検索（60倍高速化）、出荷状態フィルター、詳細モーダル、配送伝票スキャン、一括操作、検索条件の引き継ぎ。 |
| 🔄 定期便一覧 | 定期便一覧画面 | 定期便の管理・編集。ステータスフィルター、顧客名検索、間隔変更、次回発送日自動計算、詳細表示、編集・削除機能。 |
| 🤖 AI取込一覧 | AI取込一覧画面 | AI解析済み注文の確認・処理。未処理件数バッジ表示、カードデザイン、データ完遂度バー、ステータスフィルター、詳細モーダル、受注処理・却下・削除機能。 |
| 🛍️ 商品マスタ | 商品マスタ一覧画面 | 商品情報の一覧・編集・登録（admin専用）。商品分類・キーワードフィルター、モーダルでの登録・編集、商品削除、商品分類追加機能。 |
| 👥 顧客マスタ | 顧客情報マスタ一覧画面 | 顧客情報の一覧・編集・登録（admin専用）。顧客分類・キーワードフィルター、モーダルでの登録・編集、「発送先同上」機能、顧客削除機能。 |
| 📦 発送先マスタ | 発送先情報マスタ一覧画面 | 発送先情報の一覧・編集・登録（admin専用）。発送先分類・キーワードフィルター、モーダルでの登録・編集、発送先削除機能。 |

#### 🛠️ 作成セクション
| ボタン名 | 遷移先 | 説明 |
|---------|--------|------|
| 📦 送り状作成 | 発送伝票作成画面 | 発送日を指定してヤマト運輸・佐川急便のCSVファイルを生成。シート「ヤマトCSV」「佐川CSV」から該当日のデータを抽出し、送り状フォルダに保存。 |
| 💰 請求書作成 | 請求書作成画面 | 対象期間・顧客名・請求日を指定して請求書PDFを一括生成。顧客名を指定しない場合は期間内の全顧客データを抽出。顧客ごとにPDFファイルを生成。 |
| 📊 freee納品書CSV | freee納品書CSV作成画面 | freee会計ソフト連携用の納品書CSVファイルを生成。発送日範囲・顧客名を指定。商品マスタから単位・税率・勘定科目・税区分・部門・品目を取得。UTF-8 BOM付きCSV形式。 |
| 📋 見積書作成 | 見積書作成画面 | 見積書データの登録とPDF生成。顧客・発送先検索機能、商品入力、見積書データをシートに保存し、PDFファイルを生成。登録データは受注登録画面で参照可能。 |

#### 🔍 参照セクション
| ボタン名 | 遷移先 | 説明 |
|---------|--------|------|
| 🛍️ 商品情報 | スプレッドシート「商品」 | 商品マスタスプレッドシートを新しいタブで直接開く。スプレッドシート上で直接編集可能。 |
| 👥 顧客情報 | スプレッドシート「顧客情報」 | 顧客情報スプレッドシートを新しいタブで直接開く。スプレッドシート上で直接編集可能。 |
| 📑 受注シート | スプレッドシート「受注」 | 受注データスプレッドシートを新しいタブで直接開く。スプレッドシート上で直接確認・編集可能。 |
| 📋 見積書 | 見積書フォルダ | 見積書PDFファイルが保存されているGoogle Driveフォルダを新しいタブで開く。 |
| 💰 請求書 | 請求書フォルダ | 請求書PDFファイルが保存されているGoogle Driveフォルダを新しいタブで開く。 |
| 📊 freee納品書CSV | freee納品書CSVフォルダ | freee納品書CSVファイルが保存されているGoogle Driveフォルダを新しいタブで開く。 |
| 📄 納品書 | 納品書フォルダ | 納品書PDFファイルが保存されているGoogle Driveフォルダを新しいタブで開く。 |
| 🚚 ヤマト送り状 | ヤマト送り状フォルダ | ヤマト運輸のCSVファイルが保存されているGoogle Driveフォルダを新しいタブで開く。 |
| 🚛 佐川送り状 | 佐川送り状フォルダ | 佐川急便のCSVファイルが保存されているGoogle Driveフォルダを新しいタブで開く。 |

#### ⚙️ その他セクション
| ボタン名 | 機能 | 説明 |
|---------|------|------|
| 🔄 キャッシュ更新 | マスタキャッシュ更新 | 商品・顧客マスタのキャッシュを手動更新。更新完了時に商品数を表示。 |
| 🎨 デザインシステムテスト | デザインシステムテスト | UIコンポーネントのテスト画面を新しいタブで開く。デザインシステムの確認・テスト用。 |

---

### 受注登録画面（受注入力）
- **紐づくシート**: クール区分、ヤマトCSV、佐川CSV、受付方法、受注、商品、商品分類、担当者、発送先情報、納品方法、荷扱い、送り状種別、配送時間帯、顧客情報
- **主な機能**:
  - **AI入力アシスタント**（モーダル、開閉可能）:
    - **テキスト解析**: メール、チャット、FAXの内容をそのまま貼り付けて注文内容を自動抽出（Gemini API）
    - **ファイル解析**: PDF/画像ファイルをアップロードして注文情報を抽出（Gemini Vision API）
    - **マスタ照合**: 顧客・発送先・商品マスタとの自動照合
    - **信頼度表示**: 解析結果の信頼度をバッジで表示
    - **アラート表示**: マスタ照合で見つからない項目を警告表示
    - **商品マッピング学習**: 顧客ごとの商品名表記を学習
    - **確認・修正機能**: AI解析結果を確認してフォームに反映（一部項目のみ反映も可能）
    - **AI解析済みインジケーター**: フォーム上部にAI解析済みであることを表示
  - **顧客情報**:
    - 検索機能（会社名・氏名・電話番号・住所、高速化: クライアントサイドキャッシュによる60倍高速化）
    - 新規登録機能（モーダル）
    - 前回受注内容の反映（ボタン1つで前回注文を呼び出し）
    - 見積書情報の反映（見積書データから情報を自動入力）
  - **発送先情報**:
    - 検索機能（高速化: クライアントサイドキャッシュによる60倍高速化）
    - 新規登録機能（モーダル）
    - 顧客情報からのコピー（ボタン1つで顧客情報を発送先にコピー）
  - **発送元情報**: シート「会社名」を参照可能（ドロップダウンで選択）
  - **複数日程対応**: 最大10日程の同時登録が可能（発送日・納品日を複数設定）
  - **商品入力**: 最大10商品まで入力可能（商品分類・商品名・数量・単価）
  - **商品行個別クリア**: 各商品行に個別クリアボタンを配置し、不要な行を即座にクリア可能
  - **チェックリスト**: 納品書/請求書/領収書/パンフ/レシピのチェックボックス
  - **PDF自動生成**: 納品書・領収書のPDF自動作成（登録時に自動生成）
  - **CSV自動登録**: ヤマト/佐川のCSVデータ自動登録（お客様管理番号に受注ID設定）
  - **検索条件引き継ぎ**: 受注一覧画面から遷移した場合、検索条件を引き継ぎ

---

### 電話受注モード
- **紐づくシート**: 受注、顧客情報、発送先情報、商品、商品分類
- **主な機能**:
  - **4ステップ画面遷移**（進捗インジケーター表示）:
    1. **顧客選択**: 既存顧客を検索して選択、または新規顧客を登録
    2. **商品選択・数量入力**: 商品を検索して選択、数量を入力（複数商品対応）
    3. **配送設定**: 発送元を選択、チェックリスト（納品書/請求書/領収書/パンフ/レシピ）を設定
    4. **確認・送信**: 入力内容を確認して送信
  - **新規顧客登録**:
    - 会社名と氏名を分離して入力
    - 顧客情報・発送先情報マスタに自動登録
    - 重複チェック（会社名AND氏名で判定）
  - **前回と同じ注文**:
    - ボタン1つで前回注文を呼び出し
    - 数量のみ変更可能
  - **過去注文比較チェック**:
    - 直近3回の注文と自動比較
    - 数量が±50%以上異なれば警告表示
    - いつも注文している商品が欠けていれば警告表示
  - **発送先選択**:
    - 最終注文日でソート表示（最新のものが上に）
    - インクリメンタル検索機能（入力と同時にフィルタリング）
  - **商品選択**:
    - 商品分類で絞り込み
    - 商品名で検索
    - タップで選択
  - **モバイル最適化**: スマホ・タブレットでの操作を想定したUI（大きなボタン、タップしやすい設計）

---

### 受注一覧画面
- **紐づくシート**: 受注、発送先情報、顧客情報
- **主な機能**:
  - **検索・フィルター**:
    - 発送日範囲指定（先月、今月、前日、本日、明日、今週、来週、期間指定など）
    - 発送先名検索（高速化: クライアントサイドキャッシュによる60倍高速化）
    - 顧客名検索（高速化: クライアントサイドキャッシュによる60倍高速化）
    - 出荷状態フィルター（すべて、未出荷、出荷済み、予定日超過、キャンセル済み）
    - **予定日超過を含む**: チェックボックスで予定日超過の受注も含めて表示可能
    - **検索条件の引き継ぎ**: 各画面への遷移および戻り時に検索条件を自動で維持
  - **一覧表示**:
    - 発送日、納品日、発送先名、商品名、個数、出荷済チェックボックス、操作ボタン、受注日
    - **PC用テーブル表示**: 全項目を一覧表示
    - **スマホ用カード表示**: レスポンシブ対応でカード形式で表示
    - **視認性向上**: ステータスに応じた行の色分け（出荷済：緑、予定日超過：赤、キャンセル：オレンジ）、ホバーエフェクト、選択行のハイライト
    - **スティッキーヘッダー**: スクロール時に見出しを上部に固定
    - **ページング**: 大量データをページ分割して表示
  - **編集・操作機能**:
    - **詳細モーダル**: 行クリックで全項目を確認。詳細画面から「伝票スキャン」「コピー」「修正」が可能。
    - **修正**: 受注IDを選択して編集画面へ遷移
    - **コピー**: データを新規受注登録に引き継ぎ（発送日・納品日・個数を除外）
    - **配送伝票スキャン**:
      - スマホカメラで伝票バーコードを読み取り、追跡番号を自動登録＆出荷済みに更新
      - OCR機能による番号自動読み取り（画像認識）
      - バリデーション機能で運送会社別の番号形式チェック（ヤマト/佐川/西濃）
      - 手入力もサポート
    - **出荷済み更新**: チェックボックスで個別に更新可能
    - **一括操作**: 複数選択した受注を一括で「出荷済み」「キャンセル」「削除」「キャンセル解除」
    - **整合性維持**: 削除時はヤマト/佐川CSVの関連データも自動削除
  - **ホーム画面連携**:
    - ホーム画面からもスキャン機能と発送状況確認が可能（viewer権限でも利用可能）

---

### 売上ダッシュボード画面（admin専用）
- **紐づくシート**: 受注、商品、顧客情報
- **主な機能**:
  - **対象月選択**: 月を選択してデータを表示（デフォルトは今月）
  - **月次サマリー**: 
    - 売上高（前月比の増減率表示）
    - 受注件数（前月比の増減率表示）
    - 販売商品数
    - 総販売数
  - **商品分類別構成比**: Google Chartsの円グラフで商品分類別の売上構成比を表示
  - **商品別売上ランキングTOP10**: Google Chartsの横棒グラフで商品別売上ランキングを表示
  - **商品別売上ランキングTOP20**: テーブル形式で商品別売上ランキングTOP20を表示（ランク、商品名、商品分類、売上高、受注数合計、受注回数）
  - **顧客別売上ランキングTOP10**: Google Chartsの横棒グラフで顧客別売上ランキングを表示
  - **年間売上推移**: 
    - 対象年を選択（過去5年分）
    - 商品選択（個別推移、全商品合計）
    - 月別の売上推移を折れ線グラフで表示
    - 前年同月比をテーブルで表示
    - 年間データCSV出力機能
  - **分析タブ**:
    - **顧客リテンション分析**: 顧客をセグメント別（アクティブ(30日以内)/要注意(31-60日)/リスク(61-90日)/離脱(91日以上)）に分類して表示。離脱リスク上位10社をテーブル表示。
    - **季節パターン分析**: 季節ごとの売上パターンを分析
    - **顧客傾向分析**: 顧客の購買傾向を分析
  - **全分析実行**: すべての分析を一括実行するボタン
  - **更新ボタン**: データを手動で更新
  - **最終更新時刻**: データの最終更新時刻を表示

---

### AI取込一覧画面
- **紐づくシート**: 仮受注（LINE Bot用スプレッドシート）
- **主な機能**:
  - **サマリー表示**: 未処理/処理済み/却下件数をカード形式で表示、全体の進捗バー表示
  - **未処理件数バッジ**: ホーム画面のボタンに未処理件数をバッジ表示（アニメーション付き）
  - **カードデザイン**: 仮受注データを視覚的に分かりやすいカード形式で表示
  - **データ完遂度**: 各カードに進捗バー表示（顧客・商品・発送先情報の入力状況を可視化）
  - **フィルター機能**: ステータス別の絞り込み（すべて/未処理/処理済み/却下）
  - **詳細モーダル**: 解析結果の詳細表示（原文、解析結果JSON、ファイルURL、登録日時、処理日時など）
  - **アクション**:
    - **受注処理**: AI解析結果を受注登録画面に引き継ぎ。受注登録完了時に仮受注データを自動削除。
    - **却下**: 仮受注をステータス「却下」に変更
    - **削除**: 仮受注データを完全削除
  - **自動解析**:
    - Google DriveフォルダにPDF/画像を配置すると自動解析（Driveトリガー）
    - マスタ照合（商品・顧客・発送先）
    - LINE通知（まとめ通知/定期リマインド）

---

### 製造数一覧画面（ヒートマップ発注一覧）
- **紐づくシート**: 受注、商品
- **主な機能**:
  - **ヒートマップ表示**: 商品×日付のマトリクス表示で発送予定数量を視覚化
  - **期間フィルタ**: 今週/来週/今月/来月/期間指定（最大1ヶ月）
  - **発送先・顧客検索**: マスタからキーワード検索
  - **商品分類フィルタ**: マルチセレクトで複数分類を選択可能
  - **商品名略称**: 「送り状品名」（略称）を表示
  - **色分け**: 数量に応じた色分け（視認性向上）
  - **スティッキーヘッダー**: スクロール時に商品名列を固定

---

### 定期便一覧画面
- **紐づくシート**: 定期便
- **主な機能**:
  - **定期便の一覧表示**: すべての定期便を一覧表示（顧客名、発送先名、間隔、次回発送日、ステータス、最終実行日）
  - **フィルター機能**: ステータス（すべて/有効/停止）、顧客名検索
  - **間隔設定**: 毎週〜12週、毎月〜3ヶ月の間隔設定
  - **週単位の曜日選択**: 週次定期便の場合、発送曜日を選択可能
  - **月単位の日付選択**: 月次定期便の場合、発送日を選択可能
  - **次回発送日自動計算**: 
    - 週次は最低7日後を自動計算
    - UIで自動連動
  - **詳細表示**: 行クリックで定期受注ID、登録日、顧客名、発送先、納品方法、更新間隔、次回発送日、次回納品日、ステータス、最終実行日、合計金額、商品一覧を表示
  - **間隔変更**: 間隔変更ボタンで更新間隔を変更可能
  - **編集・削除機能**: 定期便の編集・削除が可能
  - **レスポンシブデザイン**: PC用テーブル表示とスマホ用カード表示

---

### 商品マスタ一覧画面
- **紐づくシート**: 商品、商品分類
- **主な機能**:
  - **商品一覧表示**: 商品情報を一覧表示（商品分類、商品名、価格、原価、在庫数、更新日など）
  - **フィルター機能**: 商品分類ドロップダウン、キーワード検索（商品名・略称で検索）
  - **商品登録・編集**: モーダルで商品の新規登録・編集が可能。商品分類、商品名、略称、価格、原価、在庫数、税率などを入力。
  - **商品削除**: 商品の削除機能（確認ダイアログ付き）
  - **商品分類管理**: 商品分類の追加機能（モーダルで追加）
  - **行クリック**: 商品行をクリックすると編集モーダルが開く
  - **スピナー表示**: 初期表示、商品読み込み、分類登録、商品登録・編集、削除処理時にローディングスピナーを表示
  - **レスポンシブデザイン**: モバイル対応、スティッキーヘッダー

---

### 顧客情報マスタ一覧画面
- **紐づくシート**: 顧客情報、発送先情報
- **主な機能**:
  - **顧客一覧表示**: 顧客情報を一覧表示（会社名、氏名、住所（住所１＋住所２を結合表示）、操作）。4列構成でシンプルに表示。
  - **フィルター機能**: 顧客分類ドロップダウン、キーワード検索
  - **顧客登録・編集**: モーダルで顧客の新規登録・編集が可能。顧客分類、表示名、フリガナ、会社名、部署、役職、氏名、郵便番号、住所、TEL、携帯電話、FAX、メールアドレス、請求書有無、入金期日、備考などを入力。
  - **「発送先同上」機能**: 新規登録・編集時にチェックボックスで発送先情報も同時に登録/更新可能。会社名・氏名・住所・TEL・メールアドレスを自動コピー。
  - **顧客削除**: 顧客の削除機能（確認ダイアログ付き）
  - **行クリック**: 顧客行をクリックすると編集モーダルが開く
  - **スピナー表示**: 初期表示、顧客読み込み、顧客登録・編集、削除処理時にローディングスピナーを表示
  - **レスポンシブデザイン**: モバイル対応、スティッキーヘッダー

---

### 発送先情報マスタ一覧画面
- **紐づくシート**: 発送先情報
- **主な機能**:
  - **発送先一覧表示**: 発送先情報を一覧表示（会社名、氏名、住所（住所１＋住所２を結合表示）、操作）。4列構成でシンプルに表示。
  - **フィルター機能**: 発送先分類ドロップダウン、キーワード検索
  - **発送先登録・編集**: モーダルで発送先の新規登録・編集が可能。会社名、部署、氏名、郵便番号、住所１、住所２、TEL、メールアドレス、備考などを入力。
  - **発送先削除**: 発送先の削除機能（確認ダイアログ付き）
  - **行クリック**: 発送先行をクリックすると編集モーダルが開く
  - **スピナー表示**: 初期表示、発送先読み込み、発送先登録・編集、削除処理時にローディングスピナーを表示
  - **レスポンシブデザイン**: モバイル対応、スティッキーヘッダー

---

### 発送伝票作成画面
- **紐づくシート**: ヤマトCSV、佐川CSV
- **主な機能**:
  - **発送日指定**: 発送日を選択（デフォルトは本日）
  - **CSVファイル生成**: シート「ヤマトCSV」「佐川CSV」から指定された発送日に紐づくデータを抽出し、発送伝票フォルダにCSVファイルを生成
  - **フォーマット**: ヤマト運輸・佐川急便の送り状システムに取り込み可能なフォーマット
  - **ファイル名**: 生成されたCSVファイル名を表示（例: `yamato_20240201.csv`、`sagawa_20240201.csv`）
  - **参照ボタン**: 生成されたCSVファイルが保存されているフォルダを直接開く

---

### 請求書作成画面
- **紐づくシート**: 受注
- **主な機能**:
  - **顧客検索**: 顧客分類・キーワード（会社名・氏名・表示名・フリガナ）で顧客を検索して選択
  - **対象期間指定**: 対象日の開始日・終了日を指定
  - **請求日指定**: 請求書に記載する請求日を指定
  - **PDF生成**: 指定期間に紐づく受注データを抽出し、請求書フォルダに顧客ごとのPDF請求書を生成
  - **注意**:
    - 顧客名を指定した場合：指定された顧客のデータのみ抽出
    - 顧客名を指定しない場合：期間内の全顧客データを抽出
  - **参照ボタン**: 生成された請求書PDFが保存されているフォルダを直接開く

---

### freee納品書CSV作成画面
- **紐づくシート**: 受注、商品
- **主な機能**:
  - **事前準備**: freee側で取引先（顧客）、品目（商品）、勘定科目の登録が必要
  - **顧客検索**: 顧客分類・キーワード（会社名・氏名・表示名・フリガナ）で顧客を検索して選択
  - **発送日範囲指定**: 発送日の開始日・終了日を指定（デフォルトは本日）
  - **CSV生成**: 指定期間・顧客の受注データを取得し、freee形式のCSVファイルを生成
  - **データ取得**: 商品マスタから単位・税率・勘定科目・税区分・部門・品目・メモを取得
  - **フォーマット**: UTF-8 BOM付きCSV形式（freee会計ソフトのインポート形式に対応）
  - **ファイル保存**: freee納品書CSVフォルダに保存
  - **ファイル名表示**: 生成されたCSVファイル名を表示
  - **参照ボタン**: 生成されたCSVファイルが保存されているフォルダを直接開く

---

### 受注CSV取込画面
- **紐づくシート**: 受注、食べチョク商品、ポケマル商品、ふるさと納税商品
- **主な機能**:
  - **CSVファイル選択**: ローカルファイルからCSVファイルを選択（Shift-JIS形式に対応）
  - **プラットフォーム選択**: 食べチョク、ふるさと納税、ポケマルのいずれかを選択
  - **CSV解析**: HTML5 File APIでCSVファイルを読み込み、カンマ区切りで配列に加工
  - **データ変換**: 各プラットフォームのCSV形式をシステムの受注データ形式に変換
  - **商品マッピング**: 商品マッピングテーブル（食べチョク商品、ポケマル商品、ふるさと納税商品シート）による自動変換
  - **一括取込**: 変換されたデータをシート「受注」に一括登録
  - **エラーハンドリング**: 取り込めないデータが含まれている場合はエラーメッセージを表示

---

### 見積書作成画面
- **紐づくシート**: 保存温度帯、単位、商品、商品分類、見積書、見積書データ、見積納品方法
- **主な機能**:
  - **顧客検索**: 顧客分類・キーワード（会社名・氏名・表示名・フリガナ）で顧客を検索して選択
  - **発送先検索**: キーワード（会社名・氏名）で発送先を検索して選択
  - **顧客情報入力**: 顧客分類、会社名、表示名、フリガナ、部署、役職、氏名、郵便番号、住所、TEL、FAX、メールアドレスなどを入力
  - **発送先情報入力**: 会社名、部署、氏名、郵便番号、住所１、住所２、TEL、メールアドレスなどを入力
  - **商品入力**: 商品分類・商品名・数量・単価を入力（複数商品対応）
  - **見積書データ登録**: 入力した情報をシート「見積書」「見積書データ」に保存
  - **PDF生成**: 見積書PDFファイルを生成して見積書フォルダに保存
  - **受注登録画面連携**: 登録データは受注登録画面で参照可能（見積書情報の反映機能）

---

## シートごとの概要と機能

### 1. 商品
- **目的**: 商品情報の登録、編集、管理。
- **データ項目**: 商品分類、商品名、価格、原価、在庫数、税率。
- **主な機能**:
  - 新しい商品を登録。
  - 商品の原価や粗利を自動計算。
  - 受注管理画面の商品情報として参照。
  - AI解析時のマスタ照合に使用。

---

### 2. 受注
- **目的**: 受注データを一元管理。
- **データ項目**: 受注ID、受注日、発送日、商品名、受注数、顧客情報、納品方法、発送先情報、出荷済、追跡番号、ステータス。
- **主な機能**:
  - 受注の新規登録および編集。
  - 受注IDによる一意管理（8桁英数字）。
  - 発送情報を基にCSVファイルを生成。
  - ホーム画面の発送件数情報、作業指示書として活用。
  - **自動追跡同期**:
    - 1時間間隔の定期トリガーで運送会社のサイトから配送状況を自動取得
    - ステータスを自動更新（配達完了など）
    - ヤマト運輸・佐川急便・西濃運輸の最新API仕様に対応
    - HTMLエンティティのデコード処理による正確なステータス判定

---

### 3. ヤマトCSV / 佐川CSV
- **目的**: 配送業者向けの送り状データを自動生成。
- **データ項目**:
  - 配送日、送り状種別、品名、クール区分、配送先住所、連絡先
  - **お客様管理番号**（受注IDを設定、13桁以内）
- **主な機能**:
  - ヤマト運輸または佐川急便向けのCSVデータ生成。
  - **受注IDとの紐付け**: お客様管理番号に受注IDを自動設定。
  - **受注編集時の自動更新**:
    - 編集時は古いCSVデータを自動削除
    - 新しいデータを再登録
    - 納品方法変更時も対応
  - **データ整合性**: 受注シートとCSVシートの一貫性を保証。

---

### 4. 顧客情報
- **目的**: 顧客情報を管理。
- **データ項目**: 顧客分類、表示名、フリガナ、**会社名**、部署、役職、**氏名**、郵便番号、住所、TEL、携帯電話、FAX、メールアドレス、請求書有無、入金期日、備考、更新日。
- **主な機能**:
  - 顧客の新規登録と編集（顧客情報マスタ一覧画面から）。
  - 顧客リストからの検索機能（会社名・氏名・電話番号・住所、高速化: クライアントサイドキャッシュによる60倍高速化）。
  - 電話受注モードからの自動登録。
  - **会社名と氏名を分離管理**（同姓同名別会社対応）。
  - **「発送先同上」機能**: 新規登録・編集時に発送先情報も同時に登録/更新可能。
  - AI解析時のマスタ照合に使用。
  - 顧客情報マスタ一覧画面で一括管理（admin専用）。

---

### 5. 発送先情報
- **目的**: 発送先情報を管理。
- **データ項目**: **会社名**、部署、**氏名**、郵便番号、住所１、住所２、TEL、メールアドレス、備考、更新日。
- **主な機能**:
  - 発送先の登録と更新（発送先情報マスタ一覧画面から）。
  - 顧客情報と連動したデータ参照。
  - 電話受注モードからの自動登録。
  - **会社名と氏名を分離管理**。
  - AI解析時のマスタ照合に使用。
  - 発送先情報マスタ一覧画面で一括管理（admin専用）。

---

### 6. 定期便
- **目的**: 定期便の設定と管理。
- **データ項目**: 定期便ID、顧客情報、商品情報、間隔（毎週〜12週、毎月〜3ヶ月）、発送曜日（週次）、発送日（月次）、次回発送日、最終発送日、ステータス。
- **主な機能**:
  - 定期便の新規登録・編集・削除。
  - 次回発送日の自動計算（週次は最低7日後）。
  - 定期便一覧画面で一括管理。

---

### 7. 仮受注（LINE Bot用スプレッドシート）
- **目的**: AI解析した注文情報を一時保管。
- **データ項目**: 仮受注ID、登録日時、ステータス、顧客名、発送先名、商品データJSON、原文、解析結果JSON、ファイルURL、処理日時。
- **主な機能**:
  - Driveトリガーによる自動AI解析結果を保存。
  - AI取込一覧画面で確認・処理。
  - LINE通知の送信元データ。
  - 受注登録完了時に自動削除。

---

### 8. 利益管理表
- **目的**: 月ごとの利益を視覚的に確認。
- **データ項目**: 商品名、月別利益額。
- **主な機能**:
  - 受注データをもとに売上データから利益を自動集計。
  - グラフなどを使用した可視化。

---

## 技術スタック

### フロントエンド
- HTML5 + CSS3 + JavaScript
- Bootstrap 5（レスポンシブデザイン）
- jQuery

### バックエンド
- Google Apps Script (GAS)
- TypeScript型定義あり

### データベース
- Google Spreadsheet（マスタデータ・トランザクションデータ）

### AI・外部API
- Google Gemini API（テキスト解析）
- Gemini Vision API（PDF/画像解析）
- LINE Messaging API（通知）

### トリガー
- 時間主導型トリガー（5分間隔、毎日17時）
- Driveトリガー（フォルダ監視）
- 配送状況同期トリガー（1時間間隔、ヤマト/佐川/西濃の追跡情報を自動取得・ステータス更新）

---

## セットアップ手順

### 1. スプレッドシートの準備
1. [スプレッドシートテンプレート](https://docs.google.com/spreadsheets/d/1FpMhNnld3DgZ2IhpofV4YSqqT4Tk0oxUWuVQTcwIAbM/edit?usp=drive_link)をコピー
2. 必要なシート（商品、顧客情報、受注など）に基本データを入力

### 2. Apps Scriptのデプロイ
1. src/ 内のファイルを gas/ にコピー
2. clasp push でGASにデプロイ
3. ウェブアプリとして公開

### 2-1. AllUser版のデプロイ（別プロジェクト）
AllUser版を別のGoogle Apps Scriptプロジェクトとしてデプロイする場合：

1. **共通コードの同期**
   ```bash
   ./sync-shared.sh
   ```
   - メインシステムの`sharedLib.js`をAllUserにコピー

2. **AllUser用プロジェクトの作成**
   - Google Apps Scriptで新しいプロジェクトを作成
   - `AllUser/src/`内のファイルをアップロード：
     - `code.js`
     - `sharedLib.js`
     - `index.html`
     - `css.html`
     - `appsscript.json`（重要：権限設定を含む）

3. **マニフェストファイルの設定（重要）**
   - プロジェクト設定で「マニフェストファイルをエディタで表示する」にチェック
   - `appsscript.json`に以下の権限が含まれていることを確認：
     ```json
     "oauthScopes": [
       "https://www.googleapis.com/auth/spreadsheets",
       "https://www.googleapis.com/auth/script.external_request"
     ]
     ```
   - 保存

4. **権限の承認（重要）**
   - エディタでテスト関数を実行して権限を承認：
     ```javascript
     function testAuth() {
       const response = UrlFetchApp.fetch('https://www.google.com');
       Logger.log('権限確認完了');
     }
     ```
   - 「実行」→ 権限承認ダイアログで「許可」をクリック
   - **これを行わないとスキャン機能が動作しません**

5. **ウェブアプリとして公開**
   - 「デプロイ」→「新しいデプロイ」→「ウェブアプリ」
   - 設定：
     - 次のユーザーとして実行: 「自分」
     - アクセスできるユーザー: 「全員」（または適切な設定）
   - デプロイしてURLを取得

詳細はナレッジベースの `docs/alluser-deployment-guide.md` を参照してください。
（プロジェクト内の `AllUser/デプロイ手順.md` は簡易版です）

### 3. スクリプトプロパティの設定

#### メインシステム用
| プロパティ名 | 説明 | 必須 |
|-------------|------|------|
| `GEMINI_API_KEY` | Gemini APIキー | ✅ |
| `MASTER_SPREADSHEET_ID` | マスタスプレッドシートID | ✅ |
| `LINE_BOT_SPREADSHEET_ID` | LINE Bot用スプレッドシートID | ✅ |
| `LINE_CHANNEL_ACCESS_TOKEN` | LINEチャネルアクセストークン | ⚪ |
| `LINE_USER_IDS` | 通知先LINEユーザーID（カンマ区切り） | ⚪ |

#### AllUser版用
| プロパティ名 | 説明 | 必須 |
|-------------|------|------|
| `MASTER_SPREADSHEET_ID` | 受注管理スプレッドシートのID | ✅ |
| `VISION_API_KEY` | OCR機能用（Cloud Vision APIキー） | ⚪ |

### 4. トリガーの設定（オプション）
```javascript
// GASエディタで実行
setupDriveTrigger();              // Driveフォルダ監視（5分ごと）
setupBatchNotificationTrigger();  // LINEまとめ通知（5分ごと）
setupDailyReminderTrigger();      // LINE定期リマインド（毎日17時）
setupSyncTrigger();               // 配送状況同期（1時間ごと、ヤマト/佐川/西濃の追跡情報を自動更新）
```

---

## 使用方法

### 基本フロー
1. **初期設定**: 必要なシートに基本データ（商品、顧客情報など）を入力。
2. **マスタ管理**（admin専用）:
   - 商品マスタ: 商品情報の一覧・登録・編集
   - 顧客マスタ: 顧客情報の一覧・登録・編集（「発送先同上」機能あり）
   - 発送先マスタ: 発送先情報の一覧・登録・編集
3. **受注登録**:
   - 通常入力: 受注登録画面で手入力またはAI解析を使用
   - 電話受注: 電話受注モードで3タップで完結
   - CSV取込: 食べチョク/ポケマル等のCSVを一括取込
   - AI自動取込: DriveフォルダにPDF/画像を配置すると自動解析
   - 定期便: 定期便一覧から定期便を管理
4. **帳票作成**:
   - 送り状: ヤマト/佐川のCSVファイルを生成
   - 請求書: 期間指定で顧客別PDF一括生成
   - freee納品書CSV: freee連携用納品書CSV生成
   - 見積書: 見積書データ登録とPDF生成
5. **データ確認**:
   - 受注一覧: 検索・編集（高速検索対応）
   - ヒートマップ: 商品×日付の視覚的確認
   - 定期便一覧: 定期便の管理
   - 利益管理表: 月別利益の確認

### AI機能の使い方
1. **テキスト解析**: 受注登録画面でAI入力アシスタントを開き、注文内容をコピペ
2. **ファイル解析**: PDF/画像をアップロード
3. **自動解析**: DriveフォルダにファイルをドラッグAndドロップ→AI取込一覧で確認

---

## サンプル画面
- [サンプル画面リンク](https://script.google.com/macros/s/AKfycbz0iqzBlnOSffijkMLhDuJz7d6B80R0Fa-mwxs4RqRB_JMSkWEhKur2fAdfjSVVQQvYuA/exec)
  - Google App Scriptによる画面例。実際の操作感を体験できます。
  - ID: test
  - pass: test

---

## テンプレート
- [スプレッドシートテンプレートリンク](https://docs.google.com/spreadsheets/d/1FpMhNnld3DgZ2IhpofV4YSqqT4Tk0oxUWuVQTcwIAbM/edit?usp=drive_link)
  - 本システムで使用するGoogleスプレッドシートのテンプレート。
