# 定期便機能 要件レビュー

## 対象要件

### 要件1: 間隔の柔軟な設定
- 現状の「1〜3ヶ月」のみでは使いづらい
- **毎週・毎月・2週〜12週・2ヶ月・3ヶ月**のセレクトを用意
- **週**を選んだ場合: 月曜〜日曜のセレクトを表示し、「毎週○曜日」のように次回発送日を設定
- **毎月**を選んだ場合: 毎月1日〜31日・月初・月末のセレクトを表示し、「毎月○日」のように次回発送日を設定

### 要件2: 発送日→納品日の間隔を次回以降に反映
- 初回登録時の「発送日〜納品日」の日数差を、次回以降も同じ日数で維持する
- 例: 発送 2/3・納品 2/5（2日差）→ 間隔「毎月3日」→ 次回発送 3/3・次回納品 3/5（2日差を維持）

---

## レビュー結果サマリ

| 要件 | 充足 | 備考 |
|------|------|------|
| 要件1 間隔の柔軟な設定 | ✅ 充足 | 毎週/毎月/2週〜12週/2ヶ月/3ヶ月＋曜日・日付サブ選択が実装済み |
| 要件2 発送→納品の間隔維持 | ✅ 充足 | 初回登録・次回更新・再開・間隔変更モーダルで一貫して維持 |

---

## 要件1の詳細確認

### 受注画面（shipping.html）

- **定期タイプのセレクト**（379〜395行）
  - `毎月` / `毎週` / `2週ごと`〜`12週ごと` / `2ヶ月ごと` / `3ヶ月ごと` が用意されている ✅
- **週系を選択したとき**
  - `onRecurringTypeChange()` で `recurringSubOptions` に「毎週月曜日」〜「毎週日曜日」のセレクトを動的生成 ✅
  - `recurringWeekday` として送信され、次回発送日は `calcNextRecurringDate(baseDate, type, subValue)` で計算 ✅
- **毎月を選択したとき**
  - 「毎月1日」〜「毎月31日」＋「毎月初日」「毎月末日」のセレクトを動的生成 ✅
  - `recurringMonthDay` として送信 ✅
- **2ヶ月・3ヶ月**
  - サブオプションなしで、基準日から2/3ヶ月後を次回発送日として計算 ✅

### 確認画面・サーバ側（orderCode.js）

- **間隔オブジェクトの構築**（1538〜1558行）
  - `recurringType` / `recurringWeekday` / `recurringMonthDay` から `intervalObj` を組み立て、JSON で `recurringInterval` として隠しフィールドにセット ✅
  - 週系: `type: 'nweek'`, `value`: 週数, `weekday`: 曜日（1〜7） ✅
  - 毎月: `type: 'monthly'`, `value`: 日付 or `'first'`/`'last'` ✅
  - 2/3ヶ月: `type: 'nmonth'`, `value`: 2 or 3 ✅

### 定期受注ロジック（recurringOrderCode.js）

- **calcNextShippingDateFlexible**（38〜96行）
  - `weekly` / `nweek`(biweekly, triweekly) / `monthly` / `nmonth`(2month, 3month) をすべて扱い、次回発送日を算出 ✅
  - 毎月の月末調整（例: 毎月31日 → 2月は28/29日）も実施 ✅

**結論: 要件1は満たしています。**

---

## 要件2の詳細確認

### 初回登録時（recurringOrderCode.js createRecurringOrder）

- 255〜259行: `baseShippingDate` / `baseDeliveryDate` から `daysDiff` を算出し、`nextShippingDate` に `daysDiff` を足して `nextDeliveryDate` を設定 ✅
- 例: 発送 2/3・納品 2/5 → 2日差が次回以降も維持される ✅

### トリガーで次回作成時（processRecurringOrders）

- 594〜598行: 現在の「次回発送日」「次回納品日」から `daysDiff` を取得し、新しい `newNextShippingDate` に同じ `daysDiff` を足して `newNextDeliveryDate` を更新 ✅

### 再開時（resumeRecurringOrder）

- 530〜541行: 現在の次回発送日・納品日の差を `daysDiff` として維持し、再計算後の次回発送日に同じ日数を加算 ✅

### 定期便一覧の間隔変更モーダル（recurringOrderList.html）

- 938〜946行: モーダル表示時に「次回発送日」「次回納品日」から `originalDaysInterval` を計算 ✅
- 960〜973行: 「次回発送日」変更時に `updateDeliveryDateFromShipping()` で、同じ日数差になるよう「次回納品日」を自動更新 ✅

**結論: 要件2も満たしています。**

---

## 軽微な指摘・改善提案

1. **確認画面での「次回発送日」の表示**
   - 現在、確認画面には「定期便として登録」「間隔の表示」のみで、計算された「次回発送日・次回納品日」は表示されていません。ユーザーが「いつが次回になるか」を確認したい場合は、確認画面に次回発送日・次回納品日を表示すると親切です。

2. **2ヶ月・3ヶ月の「次回発送日」の基準**
   - 2ヶ月/3ヶ月は「初回の発送日」から2/3ヶ月後が次回発送日になります。月末日（例: 1/31 → 3/31）は `addMonthsWithAdjustment` で正しく調整されています ✅

3. **納品日が発送日より前の場合**
   - 誤って納品日を発送日より前にした場合でも、`daysDiff` が負のまま次回納品日が計算されます。業務上あり得ない場合は、登録時や間隔変更時に `daysDiff < 0` をチェックして警告を出すと安全です。

---

## 総合評価

- **要件1（間隔の柔軟な設定）**: 毎週・毎月・2週〜12週・2ヶ月・3ヶ月と、曜日・日付のサブ選択が一通り実装され、次回発送日も正しく計算されています。
- **要件2（発送→納品の間隔維持）**: 初回登録・自動次回更新・再開・間隔変更のいずれでも、発送日と納品日の日数差が維持されています。

**両要件とも実装で満たされています。**
