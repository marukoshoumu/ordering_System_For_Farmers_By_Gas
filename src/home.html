<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
    <!-- CSSã«è¿½åŠ  -->
  <style>
    /* æ–‡å­—ã‚’æŠ˜ã‚Šè¿”ã™ */
    .cell-wrap {
      white-space: normal !important;
      word-wrap: break-word;
      word-break: break-all;
      line-height: 1.3;
      text-align: left;
      padding: 0.375rem 0.75rem;
    }

    /* å•†å“åã®åˆ—å¹…ã‚’åºƒã’ã‚‹ */
    .product-name-td {
      min-width: 120px;
      width: 50%; /* ãƒ†ãƒ¼ãƒ–ãƒ«å¹…ã®50% */
    }

    /* ã‚¹ãƒãƒ›ç”¨ */
    @media (max-width: 768px) {
      .table {
        font-size: 0.85rem; /* å°‘ã—æ–‡å­—ã‚’å°ã•ã */
      }
      
      .cell-wrap {
        padding: 0.25rem 0.5rem; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h2 class="text-center m-4"><?= getCompanyDisplayName() ?></h2>
    <form class="mb-5" method="POST" action="<?= deployURL ?>">
      <div class="text-center">
        <button type="submit" class="btn main_btn" name="shipping" value="true">å—æ³¨</button>
        <button type="submit" class="btn main_btn" name="createShippingSlips" value="true">é€ã‚ŠçŠ¶<br>ä½œæˆ</button>
        <button type="submit" class="btn main_btn" name="createBill" value="true">è«‹æ±‚æ›¸<br>ä½œæˆ</button>
        <br>
        <button type="submit" class="btn main_btn" name="csvImport" value="true">å—æ³¨CSV<br>å–è¾¼</button>
        <button type="submit" class="btn main_btn" name="quotation" value="true">è¦‹ç©æ›¸<br>ä½œæˆ</button>
        <button type="submit" class="btn main_btn" name="orderList" value="true" >ç™ºæ³¨<br>ä¸€è¦§</button>
        <br>
        <button type="submit" class="btn main_btn" name="orderListPage" value="true" >å—æ³¨<br>ä¸€è¦§</button>
        <button type="submit" class="btn main_btn" name="aiImportList" value="true" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: relative;">
          ğŸ¤– AIå–è¾¼<br>ä¸€è¦§
          <span id="pendingImportBadge" class="badge bg-danger" style="position: absolute; top: -5px; right: -5px; font-size: 0.7rem;">0</span>
        </button>
        <br>
        <button type="button" class="btn second_btn" name="openQuotaion" value="true" onclick="openUrlQuotaion()">è¦‹ç©æ›¸<br>å‚ç…§</button>
        <button type="button" class="btn second_btn" name="openProduct" value="true" onclick="openUrlProduct()">å•†å“æƒ…å ±<br>å‚ç…§</button>
        <button type="button" class="btn second_btn" name="openCustomer" value="true" onclick="openUrlCustomer()">é¡§å®¢æƒ…å ±<br>å‚ç…§</button>
        <br>
        <button type="button" class="btn second_btn" name="openBill" value="true" onclick="openUrlBill()">è«‹æ±‚æ›¸<br>å‚ç…§</button>
        <button type="button" class="btn second_btn" name="openDelivered" value="true" onclick="openUrlDelivered()">ç´å“æ›¸<br>å‚ç…§</button>
        <button type="button" class="btn second_btn" name="openYamato" value="true" onclick="openUrlYamato()">é€ã‚ŠçŠ¶<br>ãƒ¤ãƒãƒˆå‚ç…§</button>
        <br>
        <button type="button" class="btn second_btn" name="openSagawa" value="true" onclick="openUrlSagawa()">é€ã‚ŠçŠ¶<br>ä½å·å‚ç…§</button>
        <button type="button" class="btn second_btn" name="openShipp" value="true" onclick="openUrlShipp()">å—æ³¨<br>ä¸€è¦§</button>
      </div>
      <br>
      <div class="text-center" id="cntRes">
      </div>
      <!-- <div class="text-center" id="invoiceYesterdayRes">
      </div>
      <div class="text-center" id="yesterdayRes">
      </div> -->
      <div class="text-center" id="invoiceTodayRes">
      </div>
      <div class="text-center" id="todayRes">
      </div>
      <div class="text-center" id="invoiceTommorrowRes">
      </div>
      <div class="text-center" id="tommorrowRes">
      </div>
      <div class="text-center" id="invoiceDayAfter2Res">
      </div>
      <div class="text-center" id="dayAfter2Res">
      </div>
      <div class="text-center" id="invoiceDayAfter3Res">
      </div>
      <div class="text-center" id="dayAfter3Res">
      </div>
      <div id="overlay"></div>
      <div id="detailDialog">
        <p><strong>é¡§å®¢å:</strong> <span id="dialogCustName"></span></p>
        <p><strong>ç™ºé€å…ˆå:</strong> <span id="dialogShippingTo"></span></p>
        <p><strong>å•†å“å:</strong> <span id="dialogProduct"></span></p>
        <p><strong>å€‹æ•°:</strong> <span id="dialogCount"></span></p>
        <p><strong>ãƒ¡ãƒ¢:</strong> <span id="dialogMemo"></span></p>
        <button type="button" class="btn" id="closeDialogButton">é–‰ã˜ã‚‹</button>
      </div>
    </form>
  </div>
  <script>
    function openUrlQuotaion() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('è¦‹ç©æ›¸'); 
    }
    function openUrlProduct() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrl('å•†å“'); 
    }
    function openUrlCustomer() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrl('é¡§å®¢æƒ…å ±'); 
    }
    function openUrlBill() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('è«‹æ±‚æ›¸'); 
    }
    function openUrlDelivered() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('ç´å“æ›¸'); 
    }
    function openUrlYamato() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('ãƒ¤ãƒãƒˆ'); 
    }
    function openUrlSagawa() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('ä½å·'); 
    }
    function openUrlShipp() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrl('å—æ³¨'); 
    }
    function sendFail() {
      alert("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");  
    }
    function sendSucces(url) {
      window.open(url);
    }
    function setRes() {
      $("#cntRes").html('èª­ã¿è¾¼ã¿ä¸­...');
      google.script.run.withSuccessHandler(setTable).withFailureHandler(setTableFail).selectShippingDate();
      // æœªå‡¦ç†ã®AIå–è¾¼ä»¶æ•°ã‚’å–å¾—
      google.script.run.withSuccessHandler(function(count) {
        const badge = document.getElementById('pendingImportBadge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
          } else {
            badge.style.display = 'none';
          }
        }
      }).withFailureHandler(function(e) {
        console.error('AIå–è¾¼ä»¶æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }).getPendingImportCount();
    }
    function setTable(datas) {
      var res = JSON.parse(datas);
      var cntHtml = `<p class="info_table">ç™ºé€ä»¶æ•°</p>`;
      cntHtml += `<table class="table table-bordered">
      <thead>
        <tr class="table-primary">
      `;
      // cntHtml += `<th scope="col">${res[0]['æ˜¨æ—¥']}</th>`;
      cntHtml += `<th style="background-color: #B0E3A4;" scope="col">${res[0]['ä»Šæ—¥']}</th>`;
      cntHtml += `<th scope="col">${res[0]['æ˜æ—¥']}</th>`;
      cntHtml += `<th scope="col">${res[0]['æ˜å¾Œæ—¥']}</th>`;
      cntHtml += `<th scope="col">${res[0]['æ˜ã€…å¾Œæ—¥']}</th>`;
      cntHtml += `</tr>
      </thead>`;
      cntHtml += `<tbody class="table-group-divider">
            <tr>`;
      // cntHtml += `<td scope="col">${res[1]['æ˜¨æ—¥']}ä»¶</td>`;
      cntHtml += `<td scope="col">${res[1]['ä»Šæ—¥']}ä»¶</td>`;
      cntHtml += `<td scope="col">${res[1]['æ˜æ—¥']}ä»¶</td>`;
      cntHtml += `<td scope="col">${res[1]['æ˜å¾Œæ—¥']}ä»¶</td>`;
      cntHtml += `<td scope="col">${res[1]['æ˜ã€…å¾Œæ—¥']}ä»¶</td>`;
      cntHtml += `</tr>
      </tbody>
      </table>
      `;
      $("#cntRes").html(cntHtml);
      // if (res[2]) {
      //   createInvoiceHtml(res[2], res[0]['æ˜¨æ—¥'], "#invoiceYesterdayRes");
      // }
      // else {
      //   $("#invoiceYesterdayRes").html('');
      // }
      // if (res[3]) {
      //   createProductHtml(res[3], res[0]['æ˜¨æ—¥'], "#yesterdayRes");
      // }
      // else {
      //   $("#yesterdayRes").html('');
      // }
      if (res[4]) {
        createInvoiceHtml(res[4], res[0]['ä»Šæ—¥'], "#invoiceTodayRes", true);
      }
      else {
        $("#invoiceTodayRes").html('');
      }
      if (res[5]) {
        createProductHtml(res[5], res[0]['ä»Šæ—¥'], "#todayRes", true);
      }
      else {
        $("#todayRes").html('');
      }
      if (res[6]) {
        createInvoiceHtml(res[6], res[0]['æ˜æ—¥'], "#invoiceTommorrowRes");
      }
      else {
        $("#invoiceTommorrowRes").html('');
      }
      if (res[7]) {
        createProductHtml(res[7], res[0]['æ˜æ—¥'], "#tommorrowRes");
      }
      else {
        $("#tommorrowRes").html('');
      }
      if (res[8]) {
        createInvoiceHtml(res[8], res[0]['æ˜å¾Œæ—¥'], "#invoiceDayAfter2Res");
      }
      else {
        $("#invoiceDayAfter2Res").html('');
      }
      if (res[9]) {
        createProductHtml(res[9], res[0]['æ˜å¾Œæ—¥'], "#dayAfter2Res");
      }
      else {
        $("#dayAfter2Res").html('');
      }
      if (res[10]) {
        createInvoiceHtml(res[10], res[0]['æ˜ã€…å¾Œæ—¥'], "#invoiceDayAfter3Res");
      }
      else {
        $("#invoiceDayAfter3Res").html('');
      }
      if (res[11]) {
        createProductHtml(res[11], res[0]['æ˜ã€…å¾Œæ—¥'], "#dayAfter3Res");
      }
      else {
        $("#dayAfter3Res").html('');
      }
    }
    function setTableFail() {
      alert("å—æ³¨ãƒ‡ãƒ¼ã‚¿é›†è¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");  
    }
    // è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showDetailDialog(details) {
        document.getElementById('dialogCustName').textContent = details.custName;
        document.getElementById('dialogShippingTo').textContent = details.shippingTo;
        document.getElementById('dialogProduct').textContent = details.product;
        document.getElementById('dialogCount').textContent = details.count;
        document.getElementById('dialogMemo').textContent = details.memo;

        document.getElementById('overlay').style.display = 'block'; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        document.getElementById('detailDialog').style.display = 'block'; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    }

    // è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('closeDialogButton').addEventListener('click', function() {
        document.getElementById('detailDialog').style.display = 'none'; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’éè¡¨ç¤º
        document.getElementById('overlay').style.display = 'none'; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
    });
    window.onload = function(){
      setRes();
    };
    function createInvoiceHtml(res, dateVal, idName, colorFlg) {
      var html = '';
      
      // ç´å“æ–¹æ³•ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const grouped = {};
      res.forEach(item => {
        if (!grouped[item['ç´å“æ–¹æ³•']]) {
          grouped[item['ç´å“æ–¹æ³•']] = [];
        }
        grouped[item['ç´å“æ–¹æ³•']].push(item);
      });
      
      if (colorFlg) {
        html += `<p class="info_table today_color">${dateVal} ç™ºé€</p>`;
      } else {
        html += `<p class="info_table">${dateVal} ç™ºé€</p>`;
      }
      
      html += `<table class="table table-bordered">`;
      html += `<thead><tr class="${colorFlg ? 'today_color' : 'table-primary'}">`;
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
      Object.entries(grouped).forEach(([method, items]) => {
        if (method === 'ãƒ¤ãƒãƒˆ' || method === 'ä½å·') {
          html += `<th colspan="${items.length}" class="${colorFlg ? 'today_color' : ''}" scope="col">${method}</th>`;
        } else {
          html += `<th rowspan="2" class="${colorFlg ? 'today_color' : ''}" scope="col">${method}</th>`;
        }
      });
      
      html += `</tr>`;
      
      // ã‚¯ãƒ¼ãƒ«åŒºåˆ†ã®è¡Œï¼ˆãƒ¤ãƒãƒˆãƒ»ä½å·ã®ã¿ï¼‰
      html += `<tr class="${colorFlg ? 'today_color' : 'table-primary'}">`;
      Object.entries(grouped).forEach(([method, items]) => {
        if (method === 'ãƒ¤ãƒãƒˆ' || method === 'ä½å·') {
          items.forEach(item => {
            html += `<th class="${colorFlg ? 'today_color' : ''}" scope="col">${item['ã‚¯ãƒ¼ãƒ«åŒºåˆ†']}</th>`;
          });
        }
      });
      html += `</tr></thead>`;
      
      // ãƒ‡ãƒ¼ã‚¿è¡Œ
      html += `<tbody class="table-group-divider"><tr>`;
      Object.entries(grouped).forEach(([method, items]) => {
        items.forEach(item => {
          html += `<td scope="col">${item['å€‹æ•°']}å€‹</td>`;
        });
      });
      
      html += `</tr></tbody></table>`;
      $(idName).html(html);
    }
    function createProductHtml(res, dateVal, idName, colorFlg) {
      var html = '';
      if (colorFlg) {
        // html += `<p class="info_table today_color">${dateVal} å•†å“</p>`;
        html += `<table class="table table-bordered">
        <thead>
          <tr class="today_color">`;
        html += `<th class="today_color" scope="col" rowspan="2">`;
        html += "ç™ºé€å…ˆå";
        html += `</th>`;
        html += `<th class="today_color" scope="col">`;
        html += 'å•†å“å';
        html += `</th>`;
        html += `<th class="today_color" scope="col">`;
        html += 'å€‹æ•°';
        html += `</th>`;
        html += `</tr>`;
        html += `<tr class="today_color">`;
        html += `<th class="today_color" scope="col" colspan="2">`;
        html += "ãƒ¡ãƒ¢";
        html += `</th>`;
      }
      else {
        // html += `<p class="info_table">${dateVal} å•†å“</p>`;
        html += `<table class="table table-bordered">
        <thead>
          <tr class="table-primary">`;
        html += `<th scope="col" rowspan="2">`;
        html += "ç™ºé€å…ˆå";
        html += `</th>`;
        html += `<th scope="col">`;
        html += 'å•†å“å';
        html += `</th>`;
        html += `<th scope="col">`;
        html += 'å€‹æ•°';
        html += `</th>`;
        html += `</tr>`;
        html += `<tr class="table-primary">`;
        html += `<th scope="col" colspan="2">`;
        html += "ãƒ¡ãƒ¢";
        html += `</th>`;
      }
      html += `</tr>`;
      html += `</thead>`;
      html += `<tbody class="table-group-divider">
            <tr>`;
      for (let i = 0; i < res.length; i++) {
        html += `<td scope="col" rowspan=`+ res[i]['å•†å“'].length * 2 +`>`;
        html += `<div class="cell-wrap">` + res[i]['ç™ºé€å…ˆå'] + `</div>`;
        html += `</td>`;
        html += `<td scope="col" class="product-name-td">`;
        html += `<div class="cell-wrap">` + res[i]['å•†å“'][0]['å•†å“å'] + `</div>`;
        html += `</td>`;
        html += `<td scope="col">`;
        html += `<div class="cell-wrap" style="width: 40px;">` + res[i]['å•†å“'][0]['å—æ³¨æ•°'] + "å€‹" + `</div>`;
        html += `</td>`;
        html += `</tr>`;
        const memo0 = res[i]['å•†å“'][0]['ãƒ¡ãƒ¢'] || '';
        const style0 = memo0 ? 'style="color: red; background-color: #FFFFCC;"' : ''; // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨

        html += `<td scope="col" colspan="2">`;
        html += `<div class="cell-wrap" ${style0}>` + memo0 + `</div>`; // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
        html += `</td>`;
        
        for (let j = 1; j < res[i]['å•†å“'].length; j++) {
          html += `</tr>`;
          html += `<td scope="col" class="product-name-td">`;
          html += `<div class="cell-wrap">` + res[i]['å•†å“'][j]['å•†å“å'] + `</div>`;
          html += `</td>`;
          html += `<td scope="col">`;
          html += `<div class="cell-wrap" style="width: 40px;">` + res[i]['å•†å“'][j]['å—æ³¨æ•°'] + "å€‹" + `</div>`;
          html += `</td>`;
          html += `</tr>`;
          const memoJ = res[i]['å•†å“'][j]['ãƒ¡ãƒ¢'] || '';
          const styleJ = memoJ ? 'style="color: red; background-color: #FFFFCC;"' : ''; // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
          
          html += `<td scope="col" colspan="2">`;
          html += `<div class="cell-wrap" ${styleJ}>` + memoJ + `</div>`; // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
          html += `</td>`;
        }
        html += `</tr>`;
      }
      html += `</tbody>
      </table>
      `;
      $(idName).html(html);
    }
  </script>
</body>

</html>