<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
  <style>
    /* æ–‡å­—ã‚’æŠ˜ã‚Šè¿”ã™ */
    .cell-wrap {
      white-space: normal !important;
      word-wrap: break-word;
      word-break: break-all;
      line-height: 1.3;
      text-align: left;
      padding: 0.375rem 0.75rem;
    }

    /* å•†å“åã®åˆ—å¹…ã‚’åºƒã’ã‚‹ */
    .product-name-td {
      min-width: 120px;
      width: 50%; /* ãƒ†ãƒ¼ãƒ–ãƒ«å¹…ã®50% */
    }

    /* ã‚¹ãƒãƒ›ç”¨ */
    @media (max-width: 768px) {
      .table {
        font-size: 0.85rem; /* å°‘ã—æ–‡å­—ã‚’å°ã•ã */
      }
      
      .cell-wrap {
        padding: 0.25rem 0.5rem; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
      }
    }
    
    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .menu-accordion {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .menu-section {
      margin-bottom: 8px;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: linear-gradient(135deg, #4a90a4 0%, #3d7a8c 100%);
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    
    .menu-header:hover {
      background: linear-gradient(135deg, #3d7a8c 0%, #2d6a7c 100%);
    }
    
    .menu-header-util {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }
    
    .menu-header-util:hover {
      background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
    }
    
    .menu-arrow {
      font-size: 0.7rem;
      transition: transform 0.3s ease;
    }
    
    .menu-header.collapsed .menu-arrow {
      transform: rotate(-90deg);
    }
    
    .menu-content {
      max-height: 0;
      overflow: hidden;
      padding: 0 8px;
      background: #f8fafc;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }
    
    .menu-content.show {
      max-height: 1000px;
      padding: 8px;
    }
    
    .menu-btn {
      display: block;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 6px;
      background: #fff;
      color: #374151;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      text-align: left;
      transition: all 0.2s;
    }
    
    .menu-btn:last-child {
      margin-bottom: 0;
    }
    
    .menu-btn:hover {
      background: #4a90a4;
      color: #fff;
      border-color: #4a90a4;
      transform: translateX(4px);
    }
    
    .menu-btn-sub {
      display: block;
      width: 100%;
      padding: 10px 16px;
      margin-bottom: 4px;
      background: #fff;
      color: #6b7280;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      text-align: left;
      transition: all 0.2s;
    }
    
    .menu-btn-sub:last-child {
      margin-bottom: 0;
    }
    
    .menu-btn-sub:hover {
      background: #7c9a6e;
      color: #fff;
      border-color: #7c9a6e;
    }
    
    .menu-btn-util {
      display: block;
      width: 100%;
      padding: 10px 16px;
      background: #f3f4f6;
      color: #6b7280;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      text-align: left;
      transition: all 0.2s;
    }
    
    .menu-btn-util:hover {
      background: #6b7280;
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2 class="text-center m-4"><?= getCompanyDisplayName() ?></h2>
    <form class="mb-5" method="POST" action="<?= deployURL ?>">
      <!-- æ¨©é™æƒ…å ±ã‚’å¼•ãç¶™ã -->
      <input type="hidden" name="userRole" value="<?= userRole || 'admin' ?>">

      <!-- ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <div class="menu-accordion">

        <? if (userRole !== 'viewer') { ?>
        <!-- å—æ³¨ç³» -->
        <div class="menu-section">
          <div class="menu-header" onclick="toggleSection(this)">
            <span>ğŸ“ å—æ³¨</span>
            <span class="menu-arrow">â–¼</span>
          </div>
          <div class="menu-content show">
            <button type="submit" class="btn menu-btn" name="shipping" value="true">ğŸ“ å—æ³¨å…¥åŠ›</button>
            <button type="submit" class="btn menu-btn" name="phoneOrder" value="true">ğŸ“ é›»è©±å—æ³¨</button>
            <button type="submit" class="btn menu-btn" name="csvImport" value="true">ğŸ“¥ CSVå–è¾¼</button>
          </div>
        </div>
        <? } ?>

        <!-- ä¸€è¦§ç³» -->
        <div class="menu-section">
          <div class="menu-header" onclick="toggleSection(this)">
            <span>ğŸ“Š ä¸€è¦§</span>
            <span class="menu-arrow">â–¼</span>
          </div>
          <div class="menu-content show">
            <? if (userRole === 'admin') { ?>
            <button type="submit" class="btn menu-btn" name="salesDashboard" value="true">ğŸ“ˆ å£²ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
            <? } ?>
            <button type="submit" class="btn menu-btn" name="orderList" value="true">ğŸ“Š è£½é€ æ•°ä¸€è¦§</button>
            <button type="submit" class="btn menu-btn" name="orderListPage" value="true">ğŸ“‘ å—æ³¨ä¸€è¦§</button>
            <? if (userRole !== 'viewer') { ?>
            <button type="submit" class="btn menu-btn" name="aiImportList" value="true" style="position: relative;">
              ğŸ¤– AIå–è¾¼ä¸€è¦§
              <span id="pendingImportBadge" class="badge bg-danger" style="position: absolute; top: 5px; right: 10px; font-size: 0.65rem; padding: 2px 5px;">0</span>
            </button>
            <? } ?>
          </div>
        </div>

        <? if (userRole !== 'viewer') { ?>
        <!-- ä½œæˆç³» -->
        <div class="menu-section">
          <div class="menu-header" onclick="toggleSection(this)">
            <span>ğŸ› ï¸ ä½œæˆ</span>
            <span class="menu-arrow">â–¼</span>
          </div>
          <div class="menu-content">
            <button type="submit" class="btn menu-btn" name="createShippingSlips" value="true">ğŸ“¦ é€ã‚ŠçŠ¶ä½œæˆ</button>
            <button type="submit" class="btn menu-btn" name="createBill" value="true">ğŸ’° è«‹æ±‚æ›¸ä½œæˆ</button>
            <button type="submit" class="btn menu-btn" name="createFreeeDeliveryNote" value="true">ğŸ“Š freeeç´å“æ›¸CSV</button>
            <button type="submit" class="btn menu-btn" name="quotation" value="true">ğŸ“‹ è¦‹ç©æ›¸ä½œæˆ</button>
          </div>
        </div>

        <!-- å‚ç…§ç³» -->
        <div class="menu-section">
          <div class="menu-header" onclick="toggleSection(this)">
            <span>ğŸ” å‚ç…§</span>
            <span class="menu-arrow">â–¼</span>
          </div>
          <div class="menu-content">
            <button type="button" class="btn menu-btn-sub" onclick="openUrlProduct()">ğŸ›ï¸ å•†å“æƒ…å ±</button>
            <button type="button" class="btn menu-btn-sub" onclick="openUrlCustomer()">ğŸ‘¥ é¡§å®¢æƒ…å ±</button>
            <button type="button" class="btn menu-btn-sub" onclick="openUrlShipp()">ğŸ“‘ å—æ³¨ã‚·ãƒ¼ãƒˆ</button>
            <button type="button" class="btn menu-btn-sub" onclick="openUrlQuotaion()">ğŸ“‹ è¦‹ç©æ›¸</button>
            <button type="button" class="btn menu-btn-sub" onclick="openUrlBill()">ğŸ’° è«‹æ±‚æ›¸</button>
            <button type="button" class="btn menu-btn-sub" onclick="openUrlFreeeCSV()">ğŸ“Š freeeç´å“æ›¸CSV</button>
            <button type="button" class="btn menu-btn-sub" onclick="openUrlDelivered()">ğŸ“„ ç´å“æ›¸</button>
            <button type="button" class="btn menu-btn-sub" onclick="openUrlYamato()">ğŸšš ãƒ¤ãƒãƒˆé€ã‚ŠçŠ¶</button>
            <button type="button" class="btn menu-btn-sub" onclick="openUrlSagawa()">ğŸš› ä½å·é€ã‚ŠçŠ¶</button>
          </div>
        </div>

        <!-- ãã®ä»– -->
        <div class="menu-section">
          <div class="menu-header menu-header-util" onclick="toggleSection(this)">
            <span>âš™ï¸ ãã®ä»–</span>
            <span class="menu-arrow">â–¼</span>
          </div>
          <div class="menu-content">
            <button type="button" class="btn menu-btn-util" id="refreshCacheBtn" onclick="refreshMasterCache()">ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°</button>
            <button type="button" class="btn menu-btn-util" onclick="openTestComponents()">ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</button>
          </div>
        </div>
        <? } ?>

      </div>
      
      <br>
      <div class="text-center" id="cntRes">
      </div>
      <!-- <div class="text-center" id="invoiceYesterdayRes">
      </div>
      <div class="text-center" id="yesterdayRes">
      </div> -->
      <div class="text-center" id="invoiceTodayRes">
      </div>
      <div class="text-center" id="todayRes">
      </div>
      <div class="text-center" id="invoiceTommorrowRes">
      </div>
      <div class="text-center" id="tommorrowRes">
      </div>
      <div class="text-center" id="invoiceDayAfter2Res">
      </div>
      <div class="text-center" id="dayAfter2Res">
      </div>
      <div class="text-center" id="invoiceDayAfter3Res">
      </div>
      <div class="text-center" id="dayAfter3Res">
      </div>
      <div id="overlay"></div>
      <div id="detailDialog">
        <p><strong>é¡§å®¢å:</strong> <span id="dialogCustName"></span></p>
        <p><strong>ç™ºé€å…ˆå:</strong> <span id="dialogShippingTo"></span></p>
        <p><strong>å•†å“å:</strong> <span id="dialogProduct"></span></p>
        <p><strong>å€‹æ•°:</strong> <span id="dialogCount"></span></p>
        <p><strong>ãƒ¡ãƒ¢:</strong> <span id="dialogMemo"></span></p>
        <button type="button" class="btn" id="closeDialogButton">é–‰ã˜ã‚‹</button>
      </div>
    </form>
  </div>
  <script>
    function openUrlQuotaion() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('è¦‹ç©æ›¸');
    }
    function openUrlProduct() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrl('å•†å“');
    }
    function openUrlCustomer() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrl('é¡§å®¢æƒ…å ±');
    }
    function openUrlBill() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('è«‹æ±‚æ›¸');
    }
    function openUrlFreeeCSV() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('freeeç´å“æ›¸CSV');
    }
    function openUrlDelivered() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('ç´å“æ›¸');
    }
    function openUrlYamato() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('ãƒ¤ãƒãƒˆ');
    }
    function openUrlSagawa() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrlDrive('ä½å·');
    }
    function openUrlShipp() {
      google.script.run.withSuccessHandler(sendSucces).withFailureHandler(sendFail).getOpenUrl('å—æ³¨');
    }
    
    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    function toggleSection(header) {
      const content = header.nextElementSibling;
      const isOpen = content.classList.contains('show');
      
      if (isOpen) {
        content.classList.remove('show');
        header.classList.add('collapsed');
      } else {
        content.classList.add('show');
        header.classList.remove('collapsed');
      }
    }
    
    // ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ã
    function openTestComponents() {
      const currentUrl = window.location.href.split('?')[0];
      window.open(currentUrl + '?test=components', '_blank');
    }

    // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
    function refreshMasterCache() {
      const btn = document.getElementById('refreshCacheBtn');
      btn.disabled = true;
      btn.textContent = 'ğŸ”„ æ›´æ–°ä¸­...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          btn.disabled = false;
          btn.textContent = 'ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°';
          if (result.success) {
            showSuccessToast('âœ… ' + result.message + '\nå•†å“æ•°: ' + result.productCount + 'ä»¶');
          } else {
            showErrorToast('âŒ ' + result.message);
          }
        })
        .withFailureHandler(function(e) {
          btn.disabled = false;
          btn.textContent = 'ğŸ”„ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°';
          showErrorToast('âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        })
        .refreshMasterDataCache();
    }
    
    function sendFail() {
      showErrorToast("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");  
    }
    function sendSucces(url) {
      window.open(url);
    }
    function setRes() {
      $("#cntRes").html('<div class="inline-spinner" style="padding: 20px; text-align: center;"><div class="mini-spinner"></div><span>èª­ã¿è¾¼ã¿ä¸­...</span></div>');
      google.script.run.withSuccessHandler(setTable).withFailureHandler(setTableFail).selectShippingDate();
      // æœªå‡¦ç†ã®AIå–è¾¼ä»¶æ•°ã‚’å–å¾—
      google.script.run.withSuccessHandler(function(count) {
        const badge = document.getElementById('pendingImportBadge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
          } else {
            badge.style.display = 'none';
          }
        }
      }).withFailureHandler(function(e) {
        console.error('AIå–è¾¼ä»¶æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }).getPendingImportCount();
    }
    function setTable(datas) {
      var res = JSON.parse(datas);
      var cntHtml = `<p class="info_table">ç™ºé€ä»¶æ•°</p>`;
      cntHtml += `<table class="table table-bordered">
      <thead>
        <tr class="table-primary">
      `;
      // cntHtml += `<th scope="col">${res[0]['æ˜¨æ—¥']}</th>`;
      cntHtml += `<th style="background-color: #B0E3A4;" scope="col">${res[0]['ä»Šæ—¥']}</th>`;
      cntHtml += `<th scope="col">${res[0]['æ˜æ—¥']}</th>`;
      cntHtml += `<th scope="col">${res[0]['æ˜å¾Œæ—¥']}</th>`;
      cntHtml += `<th scope="col">${res[0]['æ˜ã€…å¾Œæ—¥']}</th>`;
      cntHtml += `</tr>
      </thead>`;
      cntHtml += `<tbody class="table-group-divider">
            <tr>`;
      // cntHtml += `<td scope="col">${res[1]['æ˜¨æ—¥']}ä»¶</td>`;
      cntHtml += `<td scope="col">${res[1]['ä»Šæ—¥']}ä»¶</td>`;
      cntHtml += `<td scope="col">${res[1]['æ˜æ—¥']}ä»¶</td>`;
      cntHtml += `<td scope="col">${res[1]['æ˜å¾Œæ—¥']}ä»¶</td>`;
      cntHtml += `<td scope="col">${res[1]['æ˜ã€…å¾Œæ—¥']}ä»¶</td>`;
      cntHtml += `</tr>
      </tbody>
      </table>
      `;
      $("#cntRes").html(cntHtml);
      // if (res[2]) {
      //   createInvoiceHtml(res[2], res[0]['æ˜¨æ—¥'], "#invoiceYesterdayRes");
      // }
      // else {
      //   $("#invoiceYesterdayRes").html('');
      // }
      // if (res[3]) {
      //   createProductHtml(res[3], res[0]['æ˜¨æ—¥'], "#yesterdayRes");
      // }
      // else {
      //   $("#yesterdayRes").html('');
      // }
      if (res[4]) {
        createInvoiceHtml(res[4], res[0]['ä»Šæ—¥'], "#invoiceTodayRes", true);
      }
      else {
        $("#invoiceTodayRes").html('');
      }
      if (res[5]) {
        createProductHtml(res[5], res[0]['ä»Šæ—¥'], "#todayRes", true);
      }
      else {
        $("#todayRes").html('');
      }
      if (res[6]) {
        createInvoiceHtml(res[6], res[0]['æ˜æ—¥'], "#invoiceTommorrowRes");
      }
      else {
        $("#invoiceTommorrowRes").html('');
      }
      if (res[7]) {
        createProductHtml(res[7], res[0]['æ˜æ—¥'], "#tommorrowRes");
      }
      else {
        $("#tommorrowRes").html('');
      }
      if (res[8]) {
        createInvoiceHtml(res[8], res[0]['æ˜å¾Œæ—¥'], "#invoiceDayAfter2Res");
      }
      else {
        $("#invoiceDayAfter2Res").html('');
      }
      if (res[9]) {
        createProductHtml(res[9], res[0]['æ˜å¾Œæ—¥'], "#dayAfter2Res");
      }
      else {
        $("#dayAfter2Res").html('');
      }
      if (res[10]) {
        createInvoiceHtml(res[10], res[0]['æ˜ã€…å¾Œæ—¥'], "#invoiceDayAfter3Res");
      }
      else {
        $("#invoiceDayAfter3Res").html('');
      }
      if (res[11]) {
        createProductHtml(res[11], res[0]['æ˜ã€…å¾Œæ—¥'], "#dayAfter3Res");
      }
      else {
        $("#dayAfter3Res").html('');
      }
    }
    function setTableFail() {
      showErrorToast("å—æ³¨ãƒ‡ãƒ¼ã‚¿é›†è¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");  
    }
    // è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showDetailDialog(details) {
        document.getElementById('dialogCustName').textContent = details.custName;
        document.getElementById('dialogShippingTo').textContent = details.shippingTo;
        document.getElementById('dialogProduct').textContent = details.product;
        document.getElementById('dialogCount').textContent = details.count;
        document.getElementById('dialogMemo').textContent = details.memo;

        document.getElementById('overlay').style.display = 'block'; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        document.getElementById('detailDialog').style.display = 'block'; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    }

    // è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('closeDialogButton').addEventListener('click', function() {
        document.getElementById('detailDialog').style.display = 'none'; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’éè¡¨ç¤º
        document.getElementById('overlay').style.display = 'none'; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
    });
    window.onload = function(){
      setRes();
    };
    function createInvoiceHtml(res, dateVal, idName, colorFlg) {
      var html = '';
      
      // ç´å“æ–¹æ³•ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const grouped = {};
      res.forEach(item => {
        if (!grouped[item['ç´å“æ–¹æ³•']]) {
          grouped[item['ç´å“æ–¹æ³•']] = [];
        }
        grouped[item['ç´å“æ–¹æ³•']].push(item);
      });
      
      if (colorFlg) {
        html += `<p class="info_table today_color">${dateVal} ç™ºé€</p>`;
      } else {
        html += `<p class="info_table">${dateVal} ç™ºé€</p>`;
      }
      
      html += `<table class="table table-bordered">`;
      html += `<thead><tr class="${colorFlg ? 'today_color' : 'table-primary'}">`;
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
      Object.entries(grouped).forEach(([method, items]) => {
        if (method === 'ãƒ¤ãƒãƒˆ' || method === 'ä½å·') {
          html += `<th colspan="${items.length}" class="${colorFlg ? 'today_color' : ''}" scope="col">${method}</th>`;
        } else {
          html += `<th rowspan="2" class="${colorFlg ? 'today_color' : ''}" scope="col">${method}</th>`;
        }
      });
      
      html += `</tr>`;
      
      // ã‚¯ãƒ¼ãƒ«åŒºåˆ†ã®è¡Œï¼ˆãƒ¤ãƒãƒˆãƒ»ä½å·ã®ã¿ï¼‰
      html += `<tr class="${colorFlg ? 'today_color' : 'table-primary'}">`;
      Object.entries(grouped).forEach(([method, items]) => {
        if (method === 'ãƒ¤ãƒãƒˆ' || method === 'ä½å·') {
          items.forEach(item => {
            html += `<th class="${colorFlg ? 'today_color' : ''}" scope="col">${item['ã‚¯ãƒ¼ãƒ«åŒºåˆ†']}</th>`;
          });
        }
      });
      html += `</tr></thead>`;
      
      // ãƒ‡ãƒ¼ã‚¿è¡Œ
      html += `<tbody class="table-group-divider"><tr>`;
      Object.entries(grouped).forEach(([method, items]) => {
        items.forEach(item => {
          html += `<td scope="col">${item['å€‹æ•°']}å€‹</td>`;
        });
      });
      
      html += `</tr></tbody></table>`;
      $(idName).html(html);
    }
    function createProductHtml(res, dateVal, idName, colorFlg) {
      var html = '';
      if (colorFlg) {
        // html += `<p class="info_table today_color">${dateVal} å•†å“</p>`;
        html += `<table class="table table-bordered">
        <thead>
          <tr class="today_color">`;
        html += `<th class="today_color" scope="col" rowspan="2">`;
        html += "ç™ºé€å…ˆå";
        html += `</th>`;
        html += `<th class="today_color" scope="col">`;
        html += 'å•†å“å';
        html += `</th>`;
        html += `<th class="today_color" scope="col">`;
        html += 'å€‹æ•°';
        html += `</th>`;
        html += `</tr>`;
        html += `<tr class="today_color">`;
        html += `<th class="today_color" scope="col" colspan="2">`;
        html += "ãƒ¡ãƒ¢";
        html += `</th>`;
      }
      else {
        // html += `<p class="info_table">${dateVal} å•†å“</p>`;
        html += `<table class="table table-bordered">
        <thead>
          <tr class="table-primary">`;
        html += `<th scope="col" rowspan="2">`;
        html += "ç™ºé€å…ˆå";
        html += `</th>`;
        html += `<th scope="col">`;
        html += 'å•†å“å';
        html += `</th>`;
        html += `<th scope="col">`;
        html += 'å€‹æ•°';
        html += `</th>`;
        html += `</tr>`;
        html += `<tr class="table-primary">`;
        html += `<th scope="col" colspan="2">`;
        html += "ãƒ¡ãƒ¢";
        html += `</th>`;
      }
      html += `</tr>`;
      html += `</thead>`;
      html += `<tbody class="table-group-divider">
            <tr>`;
      for (let i = 0; i < res.length; i++) {
        html += `<td scope="col" rowspan=`+ res[i]['å•†å“'].length * 2 +`>`;
        html += `<div class="cell-wrap">` + res[i]['ç™ºé€å…ˆå'] + `</div>`;
        html += `</td>`;
        html += `<td scope="col" class="product-name-td">`;
        html += `<div class="cell-wrap">` + res[i]['å•†å“'][0]['å•†å“å'] + `</div>`;
        html += `</td>`;
        html += `<td scope="col">`;
        html += `<div class="cell-wrap" style="width: 40px;">` + res[i]['å•†å“'][0]['å—æ³¨æ•°'] + "å€‹" + `</div>`;
        html += `</td>`;
        html += `</tr>`;
        const memo0 = res[i]['å•†å“'][0]['ãƒ¡ãƒ¢'] || '';
        const style0 = memo0 ? 'style="color: red; background-color: #FFFFCC;"' : ''; // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨

        html += `<td scope="col" colspan="2">`;
        html += `<div class="cell-wrap" ${style0}>` + memo0 + `</div>`; // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
        html += `</td>`;
        
        for (let j = 1; j < res[i]['å•†å“'].length; j++) {
          html += `</tr>`;
          html += `<td scope="col" class="product-name-td">`;
          html += `<div class="cell-wrap">` + res[i]['å•†å“'][j]['å•†å“å'] + `</div>`;
          html += `</td>`;
          html += `<td scope="col">`;
          html += `<div class="cell-wrap" style="width: 40px;">` + res[i]['å•†å“'][j]['å—æ³¨æ•°'] + "å€‹" + `</div>`;
          html += `</td>`;
          html += `</tr>`;
          const memoJ = res[i]['å•†å“'][j]['ãƒ¡ãƒ¢'] || '';
          const styleJ = memoJ ? 'style="color: red; background-color: #FFFFCC;"' : ''; // ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
          
          html += `<td scope="col" colspan="2">`;
          html += `<div class="cell-wrap" ${styleJ}>` + memoJ + `</div>`; // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
          html += `</td>`;
        }
        html += `</tr>`;
      }
      html += `</tbody>
      </table>
      `;
      $(idName).html(html);
    }
  </script>
</body>

</html>