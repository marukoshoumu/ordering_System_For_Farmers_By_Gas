<!-- 
  shipping.html から分離した過去注文反映機能のJavaScript
  - 受注履歴の取得
  - 受注データのフォーム反映
-->
<script>
    // ============================================
    // 過去注文反映機能
    // ============================================

    // グローバル変数
    let orderHistoryData = [];
    let selectedOrderId = null;

    /**
     * 受注ID取得ボタン押下時の処理
     */
    function getOrderHistory() {
      const shippingToName = document.getElementById('shippingToName').value.trim();
      
      if (!shippingToName) {
        showWarningToast('発送先名を入力してください');
        return;
      }
      
      const btn = document.getElementById('getOrderHistoryBtn');
      const originalText = btn.textContent;
      btn.textContent = '取得中...';
      btn.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(result) {
          btn.textContent = originalText;
          btn.disabled = false;
          
          const orders = JSON.parse(result);
          orderHistoryData = orders;
          
          if (orders.length === 0) {
            showInfoToast('過去の受注データが見つかりませんでした');
            document.getElementById('orderHistorySelect').style.display = 'none';
            document.getElementById('applyOrderHistoryBtn').style.display = 'none';
            return;
          }
          
          const select = document.getElementById('orderHistorySelect');
          select.innerHTML = '<option value="">発送日を選択...</option>';
          
          orders.forEach(function(order) {
            const option = document.createElement('option');
            option.value = order.orderId;
            let label = order.shippingDate || '日付なし';
            if (order.productSummary) {
              label += ' (' + order.productSummary + ')';
            }
            option.textContent = label;
            select.appendChild(option);
          });
          
          select.style.display = 'inline-block';
          document.getElementById('applyOrderHistoryBtn').style.display = 'inline-block';
        })
        .withFailureHandler(function(error) {
          btn.textContent = originalText;
          btn.disabled = false;
          showErrorToast('受注履歴の取得に失敗しました: ' + error.message);
        })
        .getOrderHistoryByShippingTo(shippingToName);
    }

    /**
     * 発送日セレクトボックス変更時の処理
     */
    function onOrderHistorySelect() {
      const select = document.getElementById('orderHistorySelect');
      selectedOrderId = select.value;
    }

    /**
     * 反映ボタン押下時の処理
     */
    function applyOrderHistory() {
      if (!selectedOrderId) {
        showWarningToast('発送日を選択してください');
        return;
      }
      
      const btn = document.getElementById('applyOrderHistoryBtn');
      const originalText = btn.textContent;
      btn.textContent = '反映中...';
      btn.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(result) {
          btn.textContent = originalText;
          btn.disabled = false;
          
          const data = JSON.parse(result);
          
          if (!data) {
            showErrorToast('受注データの取得に失敗しました');
            return;
          }
          
          applyOrderDataToForm(data);
          
          showSuccessToast('受注データを反映しました（発送日・納品日・個数は除外）');
        })
        .withFailureHandler(function(error) {
          btn.textContent = originalText;
          btn.disabled = false;
          showErrorToast('受注データの取得に失敗しました: ' + error.message);
        })
        .getOrderDataForInherit(selectedOrderId);
    }

    /**
     * 商品行をクリアする
     */
    function clearProductRows() {
      for (let rowNum = 1; rowNum <= 10; rowNum++) {
        const bunruiEl = document.getElementById('bunrui' + rowNum);
        if (bunruiEl) bunruiEl.selectedIndex = 0;
        
        const productEl = document.getElementById('product' + rowNum);
        if (productEl) productEl.selectedIndex = 0;
        
        const priceEl = document.getElementById('price' + rowNum);
        if (priceEl) priceEl.value = '';
        
        const quantityEl = document.getElementById('quantity' + rowNum);
        if (quantityEl) quantityEl.value = '';
      }
    }

    /**
     * 受注データをフォームに反映
     */
    function applyOrderDataToForm(data) {
      // 最初に商品行をクリア
      clearProductRows();
      
      // 発送先情報（発送先名は変更しない）
      document.getElementById('shippingToZipcode').value = data.shippingToZipcode || '';
      document.getElementById('shippingToAddress').value = data.shippingToAddress || '';
      document.getElementById('shippingToTel').value = data.shippingToTel || '';
      
      // 顧客情報
      document.getElementById('customerName').value = data.customerName || '';
      document.getElementById('customerZipcode').value = data.customerZipcode || '';
      document.getElementById('customerAddress').value = data.customerAddress || '';
      document.getElementById('customerTel').value = data.customerTel || '';
      
      // 発送元情報
      document.getElementById('shippingFromName').value = data.shippingFromName || '';
      document.getElementById('shippingFromZipcode').value = data.shippingFromZipcode || '';
      document.getElementById('shippingFromAddress').value = data.shippingFromAddress || '';
      document.getElementById('shippingFromTel').value = data.shippingFromTel || '';
      
      // 受付情報
      if (data.receiptWay) {
        const receiptWayEl = document.getElementById('receiptWay');
        if (receiptWayEl) {
          for (let i = 0; i < receiptWayEl.options.length; i++) {
            if (receiptWayEl.options[i].value === data.receiptWay) {
              receiptWayEl.selectedIndex = i;
              break;
            }
          }
        }
      }
      
      if (data.recipient) {
        const recipientEl = document.getElementById('recipient');
        if (recipientEl) {
          for (let i = 0; i < recipientEl.options.length; i++) {
            if (recipientEl.options[i].value === data.recipient) {
              recipientEl.selectedIndex = i;
              break;
            }
          }
        }
      }
      
      // 納品方法
      if (data.deliveryMethod) {
        const deliveryMethodEl = document.getElementById('deliveryMethod');
        if (deliveryMethodEl) {
          for (let i = 0; i < deliveryMethodEl.options.length; i++) {
            if (deliveryMethodEl.options[i].value === data.deliveryMethod) {
              deliveryMethodEl.selectedIndex = i;
              if (typeof deliveryMethodChange === 'function') {
                deliveryMethodChange();
              }
              break;
            }
          }
        }
      }
      
      // 配達時間帯
      if (data.deliveryTime) {
        setTimeout(function() {
          const deliveryTimeEl = document.getElementById('deliveryTime');
          if (deliveryTimeEl) {
            for (let i = 0; i < deliveryTimeEl.options.length; i++) {
              if (deliveryTimeEl.options[i].value === data.deliveryTime) {
                deliveryTimeEl.selectedIndex = i;
                break;
              }
            }
          }
        }, 100);
      }
      
      // チェックリスト
      if (data.checklist) {
        const deliveryChk = document.getElementById('deliveryChk');
        const billChk = document.getElementById('billChk');
        const receiptChk = document.getElementById('receiptChk');
        const pamphletChk = document.getElementById('pamphletChk');
        const recipeChk = document.getElementById('recipeChk');
        
        if (deliveryChk) deliveryChk.checked = data.checklist.deliverySlip || false;
        if (billChk) billChk.checked = data.checklist.bill || false;
        if (receiptChk) receiptChk.checked = data.checklist.receipt || false;
        if (pamphletChk) pamphletChk.checked = data.checklist.pamphlet || false;
        if (recipeChk) recipeChk.checked = data.checklist.recipe || false;
      }
      
      // その他添付
      const otherAttachEl = document.getElementById('otherAttach');
      if (otherAttachEl) {
        otherAttachEl.value = data.otherAttach || '';
      }
      
      // 商品情報（個数は空）
      if (data.items && data.items.length > 0) {
        data.items.forEach(function(item, index) {
          const rowNum = index + 1;
          if (rowNum > 10) return;
          
          const bunruiEl = document.getElementById('bunrui' + rowNum);
          if (bunruiEl && item.bunrui) {
            for (let i = 0; i < bunruiEl.options.length; i++) {
              if (bunruiEl.options[i].value === item.bunrui) {
                bunruiEl.selectedIndex = i;
                if (typeof bunruiChange === 'function') {
                  bunruiChange(rowNum);
                }
                break;
              }
            }
          }
          
          setTimeout(function() {
            const productEl = document.getElementById('product' + rowNum);
            if (productEl && item.product) {
              for (let i = 0; i < productEl.options.length; i++) {
                if (productEl.options[i].value === item.product) {
                  productEl.selectedIndex = i;
                  if (typeof productChange === 'function') {
                    productChange(rowNum);
                  }
                  break;
                }
              }
            }
            
            const priceEl = document.getElementById('price' + rowNum);
            if (priceEl && item.price) {
              priceEl.value = item.price;
            }
            
            const quantityEl = document.getElementById('quantity' + rowNum);
            if (quantityEl) {
              quantityEl.value = '';
            }
          }, 100 * rowNum);
        });
      }
      
      // 発送情報
      const sendProductEl = document.getElementById('sendProduct');
      if (sendProductEl) {
        sendProductEl.value = data.sendProduct || '';
      }
      
      // 送り状種別
      if (data.invoiceType) {
        setTimeout(function() {
          const invoiceTypeEl = document.getElementById('invoiceType');
          if (invoiceTypeEl) {
            for (let i = 0; i < invoiceTypeEl.options.length; i++) {
              if (invoiceTypeEl.options[i].value === data.invoiceType) {
                invoiceTypeEl.selectedIndex = i;
                break;
              }
            }
          }
        }, 150);
      }
      
      // クール区分
      if (data.coolCls) {
        setTimeout(function() {
          const coolClsEl = document.getElementById('coolCls');
          if (coolClsEl) {
            for (let i = 0; i < coolClsEl.options.length; i++) {
              if (coolClsEl.options[i].value === data.coolCls) {
                coolClsEl.selectedIndex = i;
                break;
              }
            }
          }
        }, 150);
      }
      
      // 荷扱い１
      if (data.cargo1) {
        setTimeout(function() {
          const cargo1El = document.getElementById('cargo1');
          if (cargo1El) {
            for (let i = 0; i < cargo1El.options.length; i++) {
              if (cargo1El.options[i].value === data.cargo1) {
                cargo1El.selectedIndex = i;
                break;
              }
            }
          }
        }, 150);
      }
      
      // 荷扱い２
      if (data.cargo2) {
        setTimeout(function() {
          const cargo2El = document.getElementById('cargo2');
          if (cargo2El) {
            for (let i = 0; i < cargo2El.options.length; i++) {
              if (cargo2El.options[i].value === data.cargo2) {
                cargo2El.selectedIndex = i;
                break;
              }
            }
          }
        }, 150);
      }
      
      // 代引総額・代引内税・発行枚数
      const cashOnDeliveryEl = document.getElementById('cashOnDelivery');
      if (cashOnDeliveryEl) {
        cashOnDeliveryEl.value = data.cashOnDelivery || '';
      }
      
      const cashOnDeliTaxEl = document.getElementById('cashOnDeliTax');
      if (cashOnDeliTaxEl) {
        cashOnDeliTaxEl.value = data.cashOnDeliTax || '';
      }
      
      const copiePrintEl = document.getElementById('copiePrint');
      if (copiePrintEl) {
        copiePrintEl.value = data.copiePrint || '';
      }
      
      // 備考欄
      const csvmemoEl = document.getElementById('csvmemo');
      if (csvmemoEl) {
        csvmemoEl.value = data.csvmemo || '';
      }
      
      const deliveryMemoEl = document.getElementById('deliveryMemo');
      if (deliveryMemoEl) {
        deliveryMemoEl.value = data.deliveryMemo || '';
      }
      
      const memoEl = document.getElementById('memo');
      if (memoEl) {
        memoEl.value = data.memo || '';
      }
    }
</script>
