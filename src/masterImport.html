<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
</head>

<body>
  <div class="container">
    <h2 class="text-center m-4">一括マスタ登録</h2>
    <form class="mb-5" method="POST" action="<?= deployURL ?>">
      <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
      <div class="row mb-3 align-items-center justify-content-center">
        <div class="col-auto">
          <label for="csvFile" class="text-center form-label">CSVファイル</label>
        </div>
        <div class="col-auto">
          <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv">
        </div>
      </div>
      <div class="row mb-3 align-items-center justify-content-center">
        <div class="col-auto">
          <label for="masterType" class="text-center form-label">マスタ種別</label>
        </div>
        <div class="col-auto">
          <select class="form-select" id="masterType" name="masterType">
            <option value="product">商品</option>
            <option value="customer">顧客情報</option>
            <option value="shippingTo">発送先情報</option>
            <option value="company">会社名</option>
          </select>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-outline-primary me-2" id="downloadTemplateBtn" name="downloadTemplateBtn" onclick="downloadTemplate()">テンプレートダウンロード</button>
          <button type="button" class="btn btn-primary me-3" id="importBtn" name="importBtn" value="true" onclick="importCSV()">取込</button>
        </div>
      </div>
      <div id="resultMessage" class="row mb-3 justify-content-center" style="display: none;">
        <div class="col-auto">
          <div id="resultContent" class="alert" role="alert"></div>
        </div>
      </div>
      <div class="text-center">
        <button type="submit" formnovalidate class="btn btn-outline-secondary me-3" name="main" value="true">ホーム画面に戻る</button>
      </div>
    </form>
  </div>
  <script>
    var file = document.getElementById('csvFile');
    var records = [];
    
    // HTML5 のFile APIに対応している場合
    if (window.File && window.FileReader && window.FileList && window.Blob) {
      function loadLocalCsv(e) {
        // ファイルデータ取得
        var fileData = e.target.files[0];
        if (!fileData) {
          return;
        }
        
        // CSVファイルチェック
        if (!fileData.name.match('.csv$')) {
          showWarningToast('CSVファイルを選択してください');
          return;
        }
        
        // ファイル読み込み
        var reader = new FileReader();
        // ファイル読み込みに成功時、カンマ区切りを配列に加工
        reader.onload = function () {
          records = [];
          var lines = reader.result.replaceAll(/\"/g, '').split('\n').filter(function(line) {
            return line.trim().length > 0;
          });
          
          if (lines.length === 0) {
            showWarningToast('CSVファイルが空です');
            return;
          }
          
          var labels = lines.shift().split(",").map(function(label) {
            return label.trim();
          });
          
          for (const line of lines) {
            var cols = line.split(',');
            const record = {};
            labels.forEach((label, index) => {
              const lab = label.trim();
              let tVal = cols[index];
              if (typeof tVal === 'undefined' || tVal == null) {
                record[lab] = '';
              } else {
                record[lab] = cols[index].trim();
              }
            });
            records.push(record);
          }
          
          // ファイル選択時に件数を表示
          var masterType = $("select[id='masterType']").val();
          var typeName = getMasterTypeName(masterType);
          showInfoToast('CSVファイルを読み込みました。' + records.length + '件のデータが検出されました。');
        };
        
        // ファイル読み込みを実行
        reader.readAsText(fileData, 'Shift-JIS');
      }
      
      file.addEventListener('change', loadLocalCsv, false);
    }
    
    function getMasterTypeName(masterType) {
      var names = {
        'product': '商品',
        'customer': '顧客情報',
        'shippingTo': '発送先情報',
        'company': '会社名'
      };
      return names[masterType] || '';
    }
    
    function importCSV() {
      if (!records || records.length === 0) {
        showWarningToast('CSVファイルを選択してください');
        return;
      }
      
      var masterType = $("select[id='masterType']").val();
      var typeName = getMasterTypeName(masterType);
      
      // 会社名の場合は確認メッセージを変更
      var confirmMessage = masterType === 'company' 
        ? '会社名シートのデータを上書きします。よろしいですか？'
        : typeName + 'マスタに' + records.length + '件のデータをインポートしてもよろしいですか？';
      
      const checkAddFlg = window.confirm(confirmMessage);
      if (checkAddFlg) {
        $("button[id='importBtn']").text('インポート中...');
        $("button[id='importBtn']").prop('disabled', true);
        $("#resultMessage").hide();
        
        var functionName = '';
        switch (masterType) {
          case 'product':
            functionName = 'importProductDataFromCSV';
            break;
          case 'customer':
            functionName = 'importCustomerDataFromCSV';
            break;
          case 'shippingTo':
            functionName = 'importShippingToDataFromCSV';
            break;
          case 'company':
            functionName = 'importCompanyDataFromCSV';
            break;
          default:
            showErrorToast('不正なマスタ種別です');
            $("button[id='importBtn']").text('取込');
            $("button[id='importBtn']").prop('disabled', false);
            return;
        }
        
        google.script.run
          .withSuccessHandler(function(result) {
            handleImportSuccess(result, masterType, typeName);
          })
          .withFailureHandler(function(error) {
            handleImportFailure(error);
          })[functionName](JSON.stringify(records));
      }
    }
    
    function handleImportSuccess(result, masterType, typeName) {
      $("button[id='importBtn']").text('取込');
      $("button[id='importBtn']").prop('disabled', false);
      
      if (result.success) {
        var message = '';
        if (masterType === 'company') {
          message = '会社名シートのデータを上書きしました。';
        } else {
          message = typeName + 'マスタに' + result.importedCount + '件のデータをインポートしました。';
          if (result.skippedCount && result.skippedCount > 0) {
            message += '（重複により' + result.skippedCount + '件をスキップしました）';
          }
        }
        
        showSuccessToast(message);
        
        // 結果を詳細表示
        var resultHtml = '<div class="alert alert-success" role="alert">';
        resultHtml += '<strong>インポート完了</strong><br>';
        resultHtml += message;
        if (result.details) {
          resultHtml += '<br><small>' + result.details + '</small>';
        }
        resultHtml += '</div>';
        $("#resultContent").html(resultHtml);
        $("#resultMessage").show();
      } else {
        showErrorToast(result.message || 'インポートに失敗しました');
        var resultHtml = '<div class="alert alert-danger" role="alert">';
        resultHtml += '<strong>エラー</strong><br>';
        resultHtml += result.message || 'インポートに失敗しました';
        resultHtml += '</div>';
        $("#resultContent").html(resultHtml);
        $("#resultMessage").show();
      }
    }
    
    function handleImportFailure(error) {
      $("button[id='importBtn']").text('取込');
      $("button[id='importBtn']").prop('disabled', false);
      showErrorToast('インポート中にエラーが発生しました: ' + error.toString());
      
      var resultHtml = '<div class="alert alert-danger" role="alert">';
      resultHtml += '<strong>エラー</strong><br>';
      resultHtml += 'インポート中にエラーが発生しました: ' + error.toString();
      resultHtml += '</div>';
      $("#resultContent").html(resultHtml);
      $("#resultMessage").show();
    }
    
    function downloadTemplate() {
      var masterType = $("select[id='masterType']").val();
      var typeName = getMasterTypeName(masterType);
      
      // GAS関数からヘッダーを取得
      var functionName = '';
      switch (masterType) {
        case 'product':
          functionName = 'getProductSheetHeaders';
          break;
        case 'customer':
          functionName = 'getCustomerSheetHeaders';
          break;
        case 'shippingTo':
          functionName = 'getShippingToSheetHeaders';
          break;
        case 'company':
          functionName = 'getCompanySheetHeaders';
          break;
        default:
          showErrorToast('不正なマスタ種別です');
          return;
      }
      
      google.script.run
        .withSuccessHandler(function(headers) {
          // CSV文字列を生成（ヘッダーのみ）
          var csv = headers.join(',');
          
          // UTF-8 BOM追加（Excel文字化け対策）
          var bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
          var blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
          var link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = typeName + '_テンプレート.csv';
          link.click();
          
          showSuccessToast('テンプレートファイルをダウンロードしました');
        })
        .withFailureHandler(function(error) {
          showErrorToast('テンプレートの取得に失敗しました: ' + error.toString());
        })[functionName]();
    }
  </script>
</body>

</html>
