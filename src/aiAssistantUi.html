<!-- 
  AIå…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆv7 - å®Œå…¨ç‰ˆï¼‰
  - v6ã®å…¨æ©Ÿèƒ½ã‚’ç¶­æŒï¼ˆç™ºé€å…ˆ/é¡§å®¢ãƒã‚¹ã‚¿ç…§åˆã€å•†å“ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’ã€ä¿®æ­£æ©Ÿèƒ½ï¼‰
  - sessionStorageã§ãƒ‡ãƒ¼ã‚¿ä¿æŒ
  - ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆå—æ³¨ç¢ºèªå‰ï¼‰
  - ä¾¡æ ¼å¯¾å¿œï¼ˆé¡§å®¢æŒ‡å®š or ãƒã‚¹ã‚¿ä¾¡æ ¼ï¼‰
-->

<?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>

<!-- AIå…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯css.htmlã«çµ±åˆæ¸ˆã¿ -->

<div class="ai-analyzed-indicator" id="aiAnalyzedIndicator">
  <span>ğŸ¤– AIè§£ææ¸ˆã¿</span>
  <span class="time" id="aiAnalyzedTime"></span>
</div>

<div class="ai-assistant-container">
  <div class="ai-assistant-header" onclick="toggleAIAssistant()">
    <h3>ğŸ¤– AIå…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆç¢ºèªãƒ»ä¿®æ­£ã—ã¦å­¦ç¿’ï¼‰</h3>
    <button type="button" class="ai-assistant-toggle" id="aiToggleBtn">é–‹ã</button>
  </div>
  
  <div class="ai-assistant-body" id="aiAssistantBody">
    <div class="ai-input-tabs">
      <button type="button" class="ai-tab-btn active" onclick="switchTab('text')">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ</button>
      <button type="button" class="ai-tab-btn" onclick="switchTab('file')">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«</button>
    </div>

    <div class="ai-tab-content active" id="textTab">
      <div class="ai-input-area">
        <textarea id="aiInputText" placeholder="ãƒ¡ãƒ¼ãƒ«ã€ãƒãƒ£ãƒƒãƒˆã€FAXã®å†…å®¹ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
      </div>
    </div>
    
    <div class="ai-tab-content" id="fileTab">
      <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('orderFile').click()">
        <input type="file" id="orderFile" accept=".pdf,image/*" onchange="handleFileSelect(event)">
        <div class="icon">ğŸ“„</div>
        <div class="text">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <div class="hint">PDFã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</div>
      </div>
      <div id="filePreview"></div>
    </div>
    
    <button type="button" class="ai-analyze-btn" id="aiAnalyzeBtn" onclick="analyzeWithAI()">
      <span class="spinner"></span>
      <span class="btn-text">ğŸ” AIã§è§£æã™ã‚‹</span>
    </button>
    
    <div class="ai-result-area" id="aiResultArea">
      <div class="ai-result-header">
        ğŸ“‹ è§£æçµæœ
        <span class="confidence-badge" id="overallConfidence"></span>
      </div>
      
      <div class="ai-result-body">
        <div class="ai-alerts" id="aiAlerts"></div>
        
        <div class="ai-result-section">
          <div class="ai-result-section-header">ğŸ“… æ—¥ç¨‹</div>
          <div class="ai-result-section-body">
            <div class="raw-data-info">
              <div class="row"><span class="label">ç™ºé€æ—¥ï¼š</span><span id="aiResultShippingDate">-</span></div>
              <div class="row"><span class="label">ç´å“æ—¥ï¼š</span><span id="aiResultDeliveryDate">-</span></div>
              <div class="row"><span class="label">æ™‚é–“æŒ‡å®šï¼š</span><span id="aiResultDeliveryTime">-</span></div>
            </div>
          </div>
        </div>
        
        <div class="ai-result-section">
          <div class="ai-result-section-header">ğŸ“¦ ç™ºé€å…ˆ <span id="shippingToMatchBadge"></span></div>
          <div class="ai-result-section-body">
            <div class="raw-data-info" id="aiResultShippingToRaw"></div>
            <div class="master-data-info" id="aiResultShippingToMaster" style="display:none;"></div>
            <div class="source-select-group" id="shippingToSourceSelect" style="display:none;"></div>
          </div>
        </div>
        
        <div class="ai-result-section">
          <div class="ai-result-section-header">ğŸ‘¤ é¡§å®¢ <span id="customerMatchBadge"></span></div>
          <div class="ai-result-section-body">
            <div class="raw-data-info" id="aiResultCustomerRaw"></div>
            <div class="master-data-info" id="aiResultCustomerMaster" style="display:none;"></div>
            <div class="source-select-group" id="customerSourceSelect" style="display:none;"></div>
          </div>
        </div>
        
        <div class="ai-result-section">
          <div class="ai-result-section-header">ğŸ›’ å•†å“</div>
          <div class="ai-result-section-body" id="aiResultItems"></div>
        </div>
        
        <div class="learn-summary" id="learnSummary" style="display:none;">
          <div class="learn-summary-title">ğŸ“š å­¦ç¿’äºˆå®šã®ãƒãƒƒãƒ”ãƒ³ã‚°</div>
          <div id="learnSummaryItems"></div>
        </div>
        
        <div class="ai-result-section" id="memoSection" style="display:none;">
          <div class="ai-result-section-header">ğŸ“ å‚™è€ƒ</div>
          <div class="ai-result-section-body" id="aiResultMemo"></div>
        </div>
        
        <div class="ai-error" id="aiError" style="display:none;"></div>
        
        <div class="ai-action-buttons">
          <button type="button" class="ai-cancel-btn" onclick="clearAIResult()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="ai-apply-btn" onclick="applyAIResult()">âœ… ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼†å­¦ç¿’</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="ai-warning-modal-overlay" id="aiWarningModal">
  <div class="ai-warning-modal">
    <div class="ai-warning-modal-header">âš ï¸ å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
    <div class="ai-warning-modal-body" id="aiWarningBody"></div>
    <div class="ai-warning-modal-footer">
      <button type="button" class="ai-warning-modify-btn" onclick="closeWarningModal()">ä¿®æ­£ã™ã‚‹</button>
      <button type="button" class="ai-warning-proceed-btn" onclick="proceedWithWarnings()">ã“ã®ã¾ã¾é€²ã‚€</button>
    </div>
  </div>
</div>

<script>
  let aiAnalysisResult = null;
  let useShippingToMaster = false;
  let useCustomerMaster = false;
  let selectedFile = null;
  let selectedFileBase64 = null;
  let currentTab = 'text';
  let productMaster = {};
  let categoryList = [];
  let productPrices = {};
  let itemEdits = {};
  
  const AI_SESSION_KEY = 'aiSessionData';
  const AI_EXCLUDE_CATEGORIES = ['é€æ–™', 'æ‰‹æ•°æ–™', 'è¿½åŠ æ–™é‡‘'];
  const AI_EXCLUDE_PRODUCTS = ['é€æ–™', 'ã‚¯ãƒ¼ãƒ«ä¾¿è¿½åŠ ', 'ä»£å¼•æ‰‹æ•°æ–™', 'æ¢±åŒ…æ–™'];
  
  document.addEventListener('DOMContentLoaded', function() {
    loadAISessionData();
    setupFileDragDrop();
  });
  
  function toggleAIAssistant() {
    const body = document.getElementById('aiAssistantBody');
    const btn = document.getElementById('aiToggleBtn');
    body.classList.toggle('open');
    btn.textContent = body.classList.contains('open') ? 'é–‰ã˜ã‚‹' : 'é–‹ã';
    if (body.classList.contains('open') && categoryList.length === 0) {
      loadProductMaster();
    }
  }
  
  function loadProductMaster() {
    google.script.run
      .withSuccessHandler(function(data) {
        productMaster = data.productsByCategory || {};
        productPrices = data.productPrices || {};
        categoryList = Object.keys(productMaster);
      })
      .withFailureHandler(function(error) {
        console.error('å•†å“ãƒã‚¹ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      })
      .getProductMasterForUI();
  }
  
  function loadAISessionData() {
    const saved = sessionStorage.getItem(AI_SESSION_KEY);
    if (!saved) return;
    try {
      const data = JSON.parse(saved);
      const diffMinutes = (new Date() - new Date(data.analyzedAt)) / 1000 / 60;
      if (diffMinutes > 30) {
        sessionStorage.removeItem(AI_SESSION_KEY);
        return;
      }
      showAIAnalyzedIndicator(data.analyzedAt);
    } catch (e) {
      sessionStorage.removeItem(AI_SESSION_KEY);
    }
  }
  
  function saveAISessionData() {
    if (!aiAnalysisResult) return;
    const sessionData = {
      analyzedAt: new Date().toISOString(),
      analysisResult: aiAnalysisResult,
      items: [],
      totalAmount: 0
    };
    Object.keys(itemEdits).forEach(index => {
      const edit = itemEdits[index];
      if (edit.productName) {
        const amount = (edit.price || 0) * (edit.quantity || 0);
        if (!AI_EXCLUDE_CATEGORIES.includes(edit.category) && !AI_EXCLUDE_PRODUCTS.includes(edit.productName)) {
          sessionData.totalAmount += amount;
        }
        sessionData.items.push({
          originalText: edit.originalText,
          productName: edit.productName,
          category: edit.category,
          price: edit.price,
          quantity: edit.quantity
        });
      }
    });
    sessionStorage.setItem(AI_SESSION_KEY, JSON.stringify(sessionData));
  }
  
  function showAIAnalyzedIndicator(analyzedAt) {
    const indicator = document.getElementById('aiAnalyzedIndicator');
    const timeEl = document.getElementById('aiAnalyzedTime');
    if (indicator && analyzedAt) {
      const time = new Date(analyzedAt);
      timeEl.textContent = 'ï¼ˆ' + time.getHours() + ':' + String(time.getMinutes()).padStart(2,'0') + ' è§£æï¼‰';
      indicator.classList.add('show');
    }
  }
  
  function clearAISession() {
    sessionStorage.removeItem(AI_SESSION_KEY);
  }
  
  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.ai-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.ai-tab-content').forEach(content => content.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tab + 'Tab').classList.add('active');
  }
  
  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = function(e) {
      selectedFileBase64 = e.target.result.split(',')[1];
      showFilePreview(file);
    };
    reader.readAsDataURL(file);
  }
  
  function showFilePreview(file) {
    const preview = document.getElementById('filePreview');
    const icon = file.type.includes('pdf') ? 'ğŸ“„' : 'ğŸ–¼ï¸';
    const size = (file.size / 1024).toFixed(1) + ' KB';
    preview.innerHTML = '<div class="file-preview"><span class="file-icon">' + icon + '</span><div class="file-info"><div class="file-name">' + file.name + '</div><div class="file-size">' + size + '</div></div><button type="button" class="remove-btn" onclick="removeFile()">Ã—</button></div>';
  }
  
  function removeFile() {
    selectedFile = null;
    selectedFileBase64 = null;
    document.getElementById('orderFile').value = '';
    document.getElementById('filePreview').innerHTML = '';
  }
  
  function setupFileDragDrop() {
    const uploadArea = document.getElementById('fileUploadArea');
    if (!uploadArea) return;
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        document.getElementById('orderFile').files = e.dataTransfer.files;
        handleFileSelect({ target: { files: [file] } });
      }
    });
  }
  
  function analyzeWithAI() {
    const btn = document.getElementById('aiAnalyzeBtn');
    btn.classList.add('loading');
    btn.disabled = true;
    if (currentTab === 'text') {
      const text = document.getElementById('aiInputText').value.trim();
      if (!text) { showWarningToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); btn.classList.remove('loading'); btn.disabled = false; return; }
      google.script.run.withSuccessHandler(handleAnalysisSuccess).withFailureHandler(handleAnalysisError).analyzeOrderText(text);
    } else {
      if (!selectedFile || !selectedFileBase64) { showWarningToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); btn.classList.remove('loading'); btn.disabled = false; return; }
      google.script.run.withSuccessHandler(handleAnalysisSuccess).withFailureHandler(handleAnalysisError).analyzeOrderFileBase64(selectedFileBase64, selectedFile.type, selectedFile.name);
    }
  }
  
  function handleAnalysisSuccess(result) {
    const btn = document.getElementById('aiAnalyzeBtn');
    btn.classList.remove('loading');
    btn.disabled = false;
    try {
      aiAnalysisResult = JSON.parse(result);
      if (!aiAnalysisResult.success) { showError(aiAnalysisResult.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
      displayAnalysisResult(aiAnalysisResult);
    } catch (e) {
      showError('è§£æçµæœã®å‡¦ç†ã«å¤±æ•—: ' + e.message);
    }
  }
  
  function handleAnalysisError(error) {
    const btn = document.getElementById('aiAnalyzeBtn');
    btn.classList.remove('loading');
    btn.disabled = false;
    showError('è§£æã‚¨ãƒ©ãƒ¼: ' + error.message);
  }
  
  function displayAnalysisResult(result) {
    document.getElementById('aiResultArea').classList.add('show');
    itemEdits = {};
    setConfidenceBadge('overallConfidence', result.overallConfidence);
    displayAlerts(result.alerts || []);
    document.getElementById('aiResultShippingDate').textContent = result.shippingDate || 'æŒ‡å®šãªã—';
    document.getElementById('aiResultDeliveryDate').textContent = result.deliveryDate || 'æŒ‡å®šãªã—';
    document.getElementById('aiResultDeliveryTime').textContent = result.deliveryTime || 'æŒ‡å®šãªã—';
    displayShippingTo(result.shippingTo);
    displayCustomer(result.customer);
    displayItemsEditable(result.items, result.unknownItems);
    if (result.memo) {
      document.getElementById('memoSection').style.display = 'block';
      document.getElementById('aiResultMemo').textContent = result.memo;
    } else {
      document.getElementById('memoSection').style.display = 'none';
    }
    document.getElementById('aiError').style.display = 'none';
    updateLearnSummary();
  }
  
  function displayAlerts(alerts) {
    const container = document.getElementById('aiAlerts');
    container.innerHTML = alerts.map(a => '<div class="ai-alert-item ' + (a.includes('æ–°è¦') || a.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') ? 'ai-alert-warning' : 'ai-alert-info') + '">' + a + '</div>').join('');
  }
  
  function displayShippingTo(st) {
    if (!st) return;
    const badge = document.getElementById('shippingToMatchBadge');
    if (st.isNewShippingTo) {
      badge.innerHTML = '<span class="new-badge">æ–°è¦</span>';
    } else if (st.masterMatch === 'exact') {
      badge.innerHTML = '<span class="master-match-badge master-match-exact">âœ… ä¸€è‡´</span>';
    } else if (st.masterMatch === 'partial') {
      badge.innerHTML = '<span class="master-match-badge master-match-partial">âš ï¸ éƒ¨åˆ†ä¸€è‡´</span>';
    } else {
      badge.innerHTML = '';
    }
    document.getElementById('aiResultShippingToRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>' + (st.rawCompanyName || '-') + '</div><div class="row"><span class="label">å®›åï¼š</span>' + (st.rawPersonName || '-') + '</div><div class="row"><span class="label">ã€’ï¼š</span>' + (st.rawZipcode || '-') + '</div><div class="row"><span class="label">ä½æ‰€ï¼š</span>' + (st.rawAddress || '-') + '</div><div class="row"><span class="label">TELï¼š</span>' + (st.rawTel || '-') + '</div>';
    const masterDiv = document.getElementById('aiResultShippingToMaster');
    const selectDiv = document.getElementById('shippingToSourceSelect');
    if (st.masterData) {
      masterDiv.style.display = 'block';
      masterDiv.innerHTML = '<strong>ğŸ“ ãƒã‚¹ã‚¿ï¼ˆ' + st.matchedBy + 'ï¼‰</strong><br>' + (st.masterData.companyName || '') + ' ' + (st.masterData.personName || '') + '<br>ã€’' + (st.masterData.zipcode || '') + ' ' + (st.masterData.address || '') + '<br>TEL: ' + (st.masterData.tel || '-');
      selectDiv.style.display = 'flex';
      selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button><button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>';
      useShippingToMaster = true;
    } else {
      masterDiv.style.display = 'none';
      selectDiv.style.display = 'none';
      useShippingToMaster = false;
    }
  }
  
  function displayCustomer(cust) {
    if (!cust) return;
    const badge = document.getElementById('customerMatchBadge');
    if (cust.isNewCustomer) {
      badge.innerHTML = '<span class="new-badge">æ–°è¦</span>';
    } else if (cust.masterMatch === 'exact') {
      badge.innerHTML = '<span class="master-match-badge master-match-exact">âœ… ä¸€è‡´</span>';
    } else if (cust.masterMatch === 'partial') {
      badge.innerHTML = '<span class="master-match-badge master-match-partial">âš ï¸ éƒ¨åˆ†ä¸€è‡´</span>';
    } else {
      badge.innerHTML = '';
    }
    document.getElementById('aiResultCustomerRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>' + (cust.rawCompanyName || '-') + '</div><div class="row"><span class="label">æ‹…å½“ï¼š</span>' + (cust.rawPersonName || '-') + '</div><div class="row"><span class="label">TELï¼š</span>' + (cust.rawTel || '-') + '</div>';
    const masterDiv = document.getElementById('aiResultCustomerMaster');
    const selectDiv = document.getElementById('customerSourceSelect');
    if (cust.masterData) {
      masterDiv.style.display = 'block';
      masterDiv.innerHTML = '<strong>ğŸ“ ãƒã‚¹ã‚¿ï¼ˆ' + cust.matchedBy + 'ï¼‰</strong><br>' + (cust.masterData.displayName || cust.masterData.companyName || '') + '<br>TEL: ' + (cust.masterData.tel || '-');
      selectDiv.style.display = 'flex';
      selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button><button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>';
      useCustomerMaster = true;
    } else {
      masterDiv.style.display = 'none';
      selectDiv.style.display = 'none';
      useCustomerMaster = false;
    }
  }
  
  function displayItemsEditable(items, unknownItems) {
    const container = document.getElementById('aiResultItems');
    container.innerHTML = '';
    if (!items || items.length === 0) {
      container.innerHTML = '<p style="color:#999;">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
      return;
    }
    items.forEach((item, index) => {
      const mappingMatch = item.mappingMatch || {};
      const isLearned = mappingMatch.found && mappingMatch.matchType === 'exact';
      const canLearn = !isLearned && item.originalText;
      
      let price = 0;
      let priceSource = 'none';
      if (item.price && item.price > 0) {
        price = item.price;
        priceSource = item.priceSource || 'ai';
      } else if (item.productName && productPrices[item.productName]) {
        price = productPrices[item.productName];
        priceSource = 'master';
      }
      
      itemEdits[index] = {
        category: item.category || '',
        productName: item.productName || '',
        spec: item.spec || '',
        quantity: item.quantity || '',
        unit: item.unit || 'ã‚±ãƒ¼ã‚¹',
        price: price,
        priceSource: priceSource,
        learn: canLearn && item.confidence !== 'low',
        originalText: item.originalText || '',
        originalProductName: item.productName || ''
      };
      
      const cardClass = isLearned ? 'learned' : '';
      let categoryOptions = '<option value="">é¸æŠ...</option>';
      categoryList.forEach(cat => {
        categoryOptions += '<option value="' + cat + '" ' + (cat === item.category ? 'selected' : '') + '>' + cat + '</option>';
      });
      let productOptions = buildProductOptions(item.category, item.productName);
      
      let badgeHtml = '';
      if (isLearned) {
        badgeHtml = '<span class="mapping-badge">ğŸ“š å­¦ç¿’æ¸ˆã¿ï¼ˆ' + mappingMatch.usageCount + 'å›ä½¿ç”¨ï¼‰</span>';
      } else {
        badgeHtml = '<span class="confidence-badge confidence-' + item.confidence + '">' + getConfidenceLabel(item.confidence) + '</span>';
      }
      
      let priceBadgeHtml = '';
      if (priceSource === 'ai') {
        priceBadgeHtml = '<span class="price-badge ai">é¡§å®¢æŒ‡å®š</span>';
      } else if (priceSource === 'master') {
        priceBadgeHtml = '<span class="price-badge master">ãƒã‚¹ã‚¿</span>';
      }
      
      let learnHtml = '';
      if (canLearn) {
        const checked = itemEdits[index].learn ? 'checked' : '';
        learnHtml = '<div class="item-learn-row ' + (itemEdits[index].learn ? 'will-learn' : '') + '" id="learnRow_' + index + '"><input type="checkbox" id="learn_' + index + '" ' + checked + ' onchange="toggleLearn(' + index + ')"><label for="learn_' + index + '">ã“ã®å¯¾å¿œã‚’è¨˜æ†¶ã™ã‚‹</label><span class="learn-preview" id="learnPreview_' + index + '" style="' + (itemEdits[index].learn ? '' : 'display:none') + '">â†’ ' + (item.productName || 'æœªé¸æŠ') + '</span></div>';
      }
      
      container.innerHTML += '<div class="item-card ' + cardClass + '" id="itemCard_' + index + '"><div class="item-card-header"><span class="item-original-text">ğŸ“ ' + (item.originalText || '(åŸæ–‡ãªã—)') + '</span>' + badgeHtml + '</div><div class="item-card-body"><div class="item-edit-row"><label>åˆ†é¡:</label><select id="category_' + index + '" onchange="onCategoryChange(' + index + ')">' + categoryOptions + '</select></div><div class="item-edit-row"><label>å•†å“:</label><select id="product_' + index + '" onchange="onProductChange(' + index + ')">' + productOptions + '</select></div><div class="item-edit-row"><label>è¦æ ¼:</label><input type="text" id="spec_' + index + '" value="' + (item.spec || '') + '" onchange="onSpecChange(' + index + ')"></div><div class="item-edit-row"><label>ä¾¡æ ¼:</label><div class="price-group"><input type="number" id="price_' + index + '" value="' + price + '" onchange="onPriceChange(' + index + ')"><span class="unit">å††</span>' + priceBadgeHtml + '</div></div><div class="item-edit-row"><label>æ•°é‡:</label><div class="quantity-group"><input type="number" id="quantity_' + index + '" value="' + (item.quantity || '') + '" step="0.1" onchange="onQuantityChange(' + index + ')"><select id="unit_' + index + '" onchange="onUnitChange(' + index + ')"><option value="ã‚±ãƒ¼ã‚¹" ' + (item.unit === 'ã‚±ãƒ¼ã‚¹' ? 'selected' : '') + '>ã‚±ãƒ¼ã‚¹</option><option value="æœ¬" ' + (item.unit === 'æœ¬' ? 'selected' : '') + '>æœ¬</option><option value="è¢‹" ' + (item.unit === 'è¢‹' ? 'selected' : '') + '>è¢‹</option><option value="kg" ' + (item.unit === 'kg' ? 'selected' : '') + '>kg</option><option value="å€‹" ' + (item.unit === 'å€‹' ? 'selected' : '') + '>å€‹</option></select></div></div>' + learnHtml + '</div></div>';
    });
  }
  
  function buildProductOptions(category, selectedProduct) {
    let options = '<option value="">é¸æŠ...</option>';
    if (category && productMaster[category]) {
      productMaster[category].forEach(prod => {
        options += '<option value="' + prod + '" ' + (prod === selectedProduct ? 'selected' : '') + '>' + prod + '</option>';
      });
    }
    categoryList.forEach(cat => {
      if (cat !== category && productMaster[cat]) {
        options += '<optgroup label="â”€â”€ ' + cat + ' â”€â”€">';
        productMaster[cat].forEach(prod => {
          options += '<option value="' + prod + '" ' + (prod === selectedProduct ? 'selected' : '') + '>' + prod + '</option>';
        });
        options += '</optgroup>';
      }
    });
    return options;
  }
  
  function onCategoryChange(index) {
    const category = document.getElementById('category_' + index).value;
    itemEdits[index].category = category;
    const productSelect = document.getElementById('product_' + index);
    productSelect.innerHTML = buildProductOptions(category, '');
    itemEdits[index].productName = '';
    itemEdits[index].price = 0;
    document.getElementById('price_' + index).value = 0;
    checkModified(index);
    updateLearnSummary();
  }
  
  function onProductChange(index) {
    const productName = document.getElementById('product_' + index).value;
    itemEdits[index].productName = productName;
    if (productName && productPrices[productName] && itemEdits[index].priceSource !== 'ai') {
      itemEdits[index].price = productPrices[productName];
      itemEdits[index].priceSource = 'master';
      document.getElementById('price_' + index).value = productPrices[productName];
    }
    const preview = document.getElementById('learnPreview_' + index);
    if (preview) preview.textContent = 'â†’ ' + (productName || 'æœªé¸æŠ');
    checkModified(index);
    updateLearnSummary();
  }
  
  function onSpecChange(index) {
    itemEdits[index].spec = document.getElementById('spec_' + index).value;
    checkModified(index);
  }
  
  function onPriceChange(index) {
    itemEdits[index].price = Number(document.getElementById('price_' + index).value) || 0;
    itemEdits[index].priceSource = 'manual';
    checkModified(index);
  }
  
  function onQuantityChange(index) {
    itemEdits[index].quantity = document.getElementById('quantity_' + index).value;
    checkModified(index);
  }
  
  function onUnitChange(index) {
    itemEdits[index].unit = document.getElementById('unit_' + index).value;
    checkModified(index);
  }
  
  function toggleLearn(index) {
    const checked = document.getElementById('learn_' + index).checked;
    itemEdits[index].learn = checked;
    const row = document.getElementById('learnRow_' + index);
    const preview = document.getElementById('learnPreview_' + index);
    if (checked) { row.classList.add('will-learn'); preview.style.display = ''; }
    else { row.classList.remove('will-learn'); preview.style.display = 'none'; }
    updateLearnSummary();
  }
  
  function checkModified(index) {
    const card = document.getElementById('itemCard_' + index);
    const edit = itemEdits[index];
    if (edit.productName !== edit.originalProductName) { card.classList.add('modified'); }
    else { card.classList.remove('modified'); }
  }
  
  function updateLearnSummary() {
    const summaryDiv = document.getElementById('learnSummary');
    const itemsDiv = document.getElementById('learnSummaryItems');
    const learnList = [];
    Object.keys(itemEdits).forEach(index => {
      const edit = itemEdits[index];
      if (edit.learn && edit.originalText && edit.productName) {
        learnList.push({ originalText: edit.originalText, productName: edit.productName, isModified: edit.productName !== edit.originalProductName });
      }
    });
    if (learnList.length === 0) { summaryDiv.style.display = 'none'; return; }
    summaryDiv.style.display = 'block';
    itemsDiv.innerHTML = learnList.map(l => '<div class="learn-summary-item"><span class="original">ã€Œ' + l.originalText + 'ã€</span><span class="arrow">â†’</span><span class="product">' + l.productName + '</span>' + (l.isModified ? '<span class="modified-badge">ä¿®æ­£æ¸ˆ</span>' : '') + '</div>').join('');
  }
  
  function selectSource(type, source) {
    if (type === 'shippingTo') { useShippingToMaster = (source === 'master'); }
    else { useCustomerMaster = (source === 'master'); }
    const btns = document.querySelectorAll('#' + type + 'SourceSelect .source-select-btn');
    btns[0].classList.toggle('selected', source === 'raw');
    btns[1].classList.toggle('selected', source === 'master');
  }
  
  function setConfidenceBadge(id, conf) {
    const el = document.getElementById(id);
    if (!el) return;
    el.className = 'confidence-badge confidence-' + (conf || 'low');
    el.textContent = getConfidenceLabel(conf);
  }
  
  function getConfidenceLabel(conf) {
    return { high: 'âœ… é«˜', medium: 'âš ï¸ ä¸­', low: 'â“ ä½' }[conf] || 'â“';
  }
  
  function showError(msg) {
    document.getElementById('aiResultArea').classList.add('show');
    document.getElementById('aiError').style.display = 'block';
    document.getElementById('aiError').textContent = msg;
  }
  
  function clearAIResult() {
    aiAnalysisResult = null;
    useShippingToMaster = useCustomerMaster = false;
    itemEdits = {};
    document.getElementById('aiResultArea').classList.remove('show');
    document.getElementById('aiInputText').value = '';
    removeFile();
  }
  
  function applyAIResult() {
    if (!aiAnalysisResult) { showWarningToast('è§£æçµæœãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    
    const mappingsToLearn = [];
    const customerName = aiAnalysisResult.customer?.rawCompanyName || '';
    Object.keys(itemEdits).forEach(index => {
      const edit = itemEdits[index];
      if (edit.learn && edit.originalText && edit.productName) {
        mappingsToLearn.push({ originalText: edit.originalText, productName: edit.productName, customerName: customerName, spec: edit.spec || '' });
      }
    });
    
    if (mappingsToLearn.length > 0) {
      google.script.run.withSuccessHandler(function(results) { console.log('ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’çµæœ:', results); }).withFailureHandler(function(error) { console.error('ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’ã‚¨ãƒ©ãƒ¼:', error); }).registerProductMappingBulk(mappingsToLearn);
    }
    
    if (aiAnalysisResult.shippingDate) { setFormValue('shippingDate', aiAnalysisResult.shippingDate); }
    if (aiAnalysisResult.deliveryDate) { setFormValue('deliveryDate', aiAnalysisResult.deliveryDate); }
    
    const st = aiAnalysisResult.shippingTo;
    if (st) {
      const data = useShippingToMaster && st.masterData ? st.masterData : st;
      setFormValue('shippingToName', useShippingToMaster ? [data.companyName, data.personName].filter(Boolean).join('ã€€') : [st.rawCompanyName, st.rawPersonName].filter(Boolean).join('ã€€'));
      setFormValue('shippingToZipcode', (useShippingToMaster ? data.zipcode : st.rawZipcode) || '');
      setFormValue('shippingToAddress', (useShippingToMaster ? data.address : st.rawAddress) || '');
      setFormValue('shippingToTel', (useShippingToMaster ? data.tel : st.rawTel) || '');
    }
    
    const cust = aiAnalysisResult.customer;
    if (cust) {
      const data = useCustomerMaster && cust.masterData ? cust.masterData : cust;
      setFormValue('customerName', useCustomerMaster ? (data.displayName || [data.companyName, data.personName].filter(Boolean).join('ã€€')) : [cust.rawCompanyName, cust.rawPersonName].filter(Boolean).join('ã€€'));
      setFormValue('customerZipcode', (useCustomerMaster ? data.zipcode : cust.rawZipcode) || '');
      setFormValue('customerAddress', (useCustomerMaster ? data.address : cust.rawAddress) || '');
      setFormValue('customerTel', (useCustomerMaster ? data.tel : cust.rawTel) || '');
    }
    
    Object.keys(itemEdits).forEach((index, i) => {
      const row = i + 1;
      if (row > 10) return;
      const edit = itemEdits[index];
      if (edit.category) {
        const bunrui = document.getElementById('bunrui' + row);
        if (bunrui) { bunrui.value = edit.category; if (typeof bunruiChange === 'function') bunruiChange(row); }
      }
      if (edit.productName) {
        setTimeout(() => {
          const prod = document.getElementById('product' + row);
          if (prod) {
            for (let j = 0; j < prod.options.length; j++) {
              if (prod.options[j].value === edit.productName) {
                prod.selectedIndex = j;
                if (typeof productChange === 'function') productChange(row);
                break;
              }
            }
          }
        }, 100 * i);
      }
      if (edit.price) {
        setTimeout(() => {
          const priceEl = document.getElementById('price' + row);
          if (priceEl) priceEl.value = edit.price;
        }, 100 * i + 30);
      }
      if (edit.quantity) {
        setTimeout(() => {
          const qty = document.getElementById('quantity' + row);
          if (qty) qty.value = edit.quantity;
        }, 100 * i + 50);
      }
    });
    
    saveAISessionData();
    showAIAnalyzedIndicator(new Date().toISOString());
    
    let message = 'ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã—ã¾ã—ãŸã€‚';
    if (mappingsToLearn.length > 0) { message += '\n\nğŸ“š ' + mappingsToLearn.length + 'ä»¶ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å­¦ç¿’ã—ã¾ã—ãŸã€‚'; }
    if (aiAnalysisResult.alerts?.length) { message += '\n\nâš ï¸ ' + aiAnalysisResult.alerts.join('\n'); }
    showInfoToast(message);
    toggleAIAssistant();
  }
  
  function setFormValue(id, value) {
    const el = document.getElementById(id);
    if (el) el.value = value;
  }
  
  function validateBeforeSubmit() {
    const warnings = performLocalCheck();
    if (warnings.length === 0) { return true; }
    showWarningModal(warnings);
    return false;
  }
  
  function performLocalCheck() {
    const warnings = [];
    const savedData = sessionStorage.getItem(AI_SESSION_KEY);
    if (!savedData) {
      warnings.push(...checkBasicValidation());
      return warnings;
    }
    const aiData = JSON.parse(savedData);
    const inputTotal = calculateInputTotal();
    if (aiData.totalAmount && Math.abs(aiData.totalAmount - inputTotal) > 1) {
      const diff = inputTotal - aiData.totalAmount;
      warnings.push({ type: 'critical', icon: 'ğŸ”´', title: 'åˆè¨ˆé‡‘é¡ãŒç•°ãªã‚Šã¾ã™', detail: 'AIè§£æ: Â¥' + aiData.totalAmount.toLocaleString() + ' â†’ å…¥åŠ›: Â¥' + inputTotal.toLocaleString() + 'ï¼ˆå·®é¡: ' + (diff >= 0 ? '+' : '') + 'Â¥' + diff.toLocaleString() + 'ï¼‰' });
    }
    if (aiData.items) {
      aiData.items.forEach(aiItem => {
        if (AI_EXCLUDE_CATEGORIES.includes(aiItem.category) || AI_EXCLUDE_PRODUCTS.includes(aiItem.productName)) return;
        const inputItem = findInputItem(aiItem.productName);
        if (!inputItem) {
          warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: aiItem.productName + ' ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“', detail: 'AIè§£æ: ' + aiItem.quantity + 'å€‹' });
        } else {
          if (inputItem.quantity != aiItem.quantity) {
            warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: aiItem.productName + ' ã®æ•°é‡ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™', detail: 'AIè§£æ: ' + aiItem.quantity + 'å€‹ â†’ å…¥åŠ›: ' + inputItem.quantity + 'å€‹' });
          }
          if (inputItem.price != aiItem.price) {
            warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: aiItem.productName + ' ã®ä¾¡æ ¼ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™', detail: 'AIè§£æ: Â¥' + (aiItem.price || 0).toLocaleString() + ' â†’ å…¥åŠ›: Â¥' + (inputItem.price || 0).toLocaleString() });
          }
        }
      });
    }
    warnings.push(...checkBasicValidation());
    return warnings;
  }
  
  function calculateInputTotal() {
    let total = 0;
    for (let i = 1; i <= 10; i++) {
      const product = document.getElementById('product' + i)?.value || '';
      const category = document.getElementById('bunrui' + i)?.value || '';
      const price = Number(document.getElementById('price' + i)?.value) || 0;
      const quantity = Number(document.getElementById('quantity' + i)?.value) || 0;
      if (AI_EXCLUDE_CATEGORIES.includes(category) || AI_EXCLUDE_PRODUCTS.includes(product)) continue;
      total += price * quantity;
    }
    return total;
  }
  
  function findInputItem(productName) {
    for (let i = 1; i <= 10; i++) {
      const product = document.getElementById('product' + i)?.value || '';
      if (product === productName) {
        return { productName: product, price: Number(document.getElementById('price' + i)?.value) || 0, quantity: Number(document.getElementById('quantity' + i)?.value) || 0 };
      }
    }
    return null;
  }
  
  function checkBasicValidation() {
    const warnings = [];
    const products = [];
    for (let i = 1; i <= 10; i++) {
      const product = document.getElementById('product' + i)?.value || '';
      if (product && products.includes(product)) {
        warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: product + ' ãŒé‡è¤‡ã—ã¦ã„ã¾ã™', detail: 'åŒã˜å•†å“ãŒè¤‡æ•°è¡Œã‚ã‚Šã¾ã™' });
      }
      if (product) products.push(product);
    }
    for (let i = 1; i <= 10; i++) {
      const product = document.getElementById('product' + i)?.value || '';
      const quantity = Number(document.getElementById('quantity' + i)?.value) || 0;
      if (product && quantity >= 100) {
        warnings.push({ type: 'info', icon: 'ğŸ’¡', title: product + ' ã®æ•°é‡ãŒå¤šã„ã§ã™', detail: quantity + 'å€‹ - å…¥åŠ›ãƒŸã‚¹ã§ã¯ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„' });
      }
    }
    return warnings;
  }
  
  function showWarningModal(warnings) {
    const body = document.getElementById('aiWarningBody');
    body.innerHTML = warnings.map(w => '<div class="ai-warning-item ' + w.type + '"><span class="icon">' + w.icon + '</span><div class="content"><div class="title">' + w.title + '</div><div class="detail">' + w.detail + '</div></div></div>').join('');
    document.getElementById('aiWarningModal').classList.add('show');
  }
  
  function closeWarningModal() {
    document.getElementById('aiWarningModal').classList.remove('show');
  }
  
  function proceedWithWarnings() {
    closeWarningModal();
    const form = document.querySelector('form');
    if (form) {
      const btn = document.querySelector('[name="shippingComfirm"]');
      if (btn) {
        btn.removeAttribute('onclick');
        btn.click();
      }
    }
  }
</script>