<!DOCTYPE html>
<html lang="ja">

<head>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>発送先マスタ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <style>
    body {
      background-color: var(--bg-body, #f5f7fa);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .page-hero-header {
      background: var(--brand-primary, #4a90a4);
      color: white;
      border-radius: 12px 12px 0 0 !important;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-hero-header h1 {
      font-size: 1.25rem;
      margin: 0;
      font-weight: 600;
    }

    .filter-section {
      padding: 16px 20px;
      background: #fff;
      border-bottom: 1px solid #e9ecef;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 0.875rem;
      color: #666;
      white-space: nowrap;
    }

    .table-section {
      padding: 16px 20px;
      background: #fff;
      overflow-x: auto;
    }

    .shippingto-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .shippingto-table thead th {
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      padding: 12px 8px;
      text-align: left;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .shippingto-table tbody tr {
      border-bottom: 1px solid #e9ecef;
      transition: background 0.2s;
      cursor: pointer;
    }

    .shippingto-table tbody tr:hover {
      background: #e3f2fd;
    }

    .shippingto-table tbody td {
      padding: 10px 8px;
      vertical-align: middle;
    }

    .shippingto-table .col-company {
      min-width: 150px;
    }

    .shippingto-table .col-name {
      width: 120px;
    }

    .shippingto-table .col-address {
      min-width: 300px;
    }

    .shippingto-table .col-action {
      width: 100px;
      text-align: center;
    }

    .shippingto-cards {
      display: none;
    }

    .shippingto-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .shippingto-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .shippingto-card-title {
      font-weight: 600;
      font-size: 1rem;
      margin: 0;
      color: #333;
    }

    .shippingto-card-body {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      font-size: 0.85rem;
    }

    .shippingto-card-item {
      display: flex;
      flex-direction: column;
    }

    .shippingto-card-label {
      font-size: 0.7rem;
      color: #999;
    }

    .shippingto-card-value {
      color: #333;
      font-weight: 500;
    }

    .shippingto-card-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }

    .shippingto-card-buttons button {
      flex: 1;
    }

    .result-count {
      padding: 8px 0;
      font-size: 0.875rem;
      color: #666;
    }

    .result-count strong {
      color: var(--brand-primary, #4a90a4);
      font-size: 1.1rem;
    }

    .modal-header {
      background: var(--brand-primary, #4a90a4);
      color: white;
    }

    .modal-section {
      margin-bottom: 20px;
    }

    .modal-section-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: #333;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--brand-primary, #4a90a4);
    }

    .form-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: #555;
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 8px;
      }

      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        width: 100%;
      }

      .filter-group .form-control {
        flex: 1;
      }

      .shippingto-table-wrapper {
        display: none;
      }

      .shippingto-cards {
        display: block;
      }

      .page-hero-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .page-hero-header h1 {
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <?!= includeSidebar(deployURL, sessionId, typeof userRole !== 'undefined' ? userRole : 'viewer') ?>
  <div class="main-container">
    <form id="navForm" method="POST" action="<?= deployURL ?>">
      <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
      <input type="hidden" name="userRole" value="<?= userRole ?>">
    </form>

    <div class="card">
      <div class="page-hero-header d-flex justify-content-center align-items-center">
        <h1 class="m-0"><i class="bi bi-box-seam me-2"></i>発送先マスタ</h1>
        <div class="d-flex gap-2" style="position: absolute; right: 16px;">
          <button type="button" class="btn btn-success btn-sm" onclick="openAddModal()">
            <i class="bi bi-plus-lg"></i> 新規登録
          </button>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-row">
          <div class="filter-group flex-grow-1">
            <label class="filter-label">検索:</label>
            <input type="text" class="form-control form-control-sm" id="filterKeyword" placeholder="会社名・氏名で検索">
          </div>
          <button type="button" class="btn btn-primary btn-sm" onclick="searchShippingTos()">
            <i class="bi bi-search"></i> 検索
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilter()">
            <i class="bi bi-x-lg"></i> クリア
          </button>
        </div>
      </div>

      <div class="table-section">
        <div class="result-count">
          <span id="resultCount">検索結果: <strong>0</strong> 件</span>
        </div>

        <div class="shippingto-table-wrapper">
          <table class="shippingto-table">
            <thead>
              <tr>
                <th class="col-company">会社名</th>
                <th class="col-name">氏名</th>
                <th class="col-address">住所</th>
                <th class="col-action">操作</th>
              </tr>
            </thead>
            <tbody id="shippingToTableBody">
            </tbody>
          </table>
        </div>

        <div class="shippingto-cards" id="shippingToCards">
        </div>
      </div>
    </div>
  </div>

  <!-- 発送先登録/編集モーダル -->
  <div class="modal fade" id="shippingToModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="shippingToModalTitle">発送先登録</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editRowIndex">

          <div class="modal-section">
            <div class="modal-section-title">基本情報</div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">会社名</label>
                <input type="text" class="form-control" id="shippingToCompanyName">
              </div>
              <div class="col-md-3">
                <label class="form-label">部署</label>
                <input type="text" class="form-control" id="shippingToDepartment">
              </div>
              <div class="col-md-3">
                <label class="form-label">氏名</label>
                <input type="text" class="form-control" id="shippingToPersonName">
              </div>
            </div>
          </div>

          <div class="modal-section">
            <div class="modal-section-title">連絡先</div>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">郵便番号 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="shippingToZipcode" maxlength="7" placeholder="1234567"
                  onchange="getShippingToAddress()">
              </div>
              <div class="col-md-8">
                <label class="form-label">住所１ <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="shippingToAddress1">
              </div>
              <div class="col-12">
                <label class="form-label">住所２</label>
                <input type="text" class="form-control" id="shippingToAddress2">
              </div>
              <div class="col-md-6">
                <label class="form-label">TEL <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="shippingToTel" maxlength="11" placeholder="09012345678">
              </div>
              <div class="col-md-6">
                <label class="form-label">メールアドレス</label>
                <input type="email" class="form-control" id="shippingToEmail">
              </div>
            </div>
          </div>

          <div class="modal-section">
            <div class="modal-section-title">その他</div>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">備考</label>
                <textarea class="form-control" id="shippingToMemo" rows="2"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" onclick="saveShippingTo()">
            <i class="bi bi-check-lg"></i> 保存
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 削除確認モーダル -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">削除確認</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>この発送先を削除しますか？</p>
          <p class="fw-bold" id="deleteShippingToName"></p>
          <input type="hidden" id="deleteRowIndex">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete()">
            <i class="bi bi-trash"></i> 削除
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let shippingTos = [];
    let shippingToModal, deleteModal;

    document.addEventListener('DOMContentLoaded', function () {
      shippingToModal = new bootstrap.Modal(document.getElementById('shippingToModal'));
      deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

      loadShippingTos();

      document.getElementById('filterKeyword').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          searchShippingTos();
        }
      });
    });

    function goHome() {
      const form = document.getElementById('navForm');
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'main';
      input.value = 'true';
      form.appendChild(input);
      form.submit();
    }

    function loadShippingTos() {
      showLoading('発送先を読み込み中...');

      const filters = {
        keyword: document.getElementById('filterKeyword').value
      };

      google.script.run
        .withSuccessHandler(function (data) {
          shippingTos = JSON.parse(data);
          renderShippingTos();
          hideLoading();
        })
        .withFailureHandler(function (e) {
          console.error('発送先取得エラー:', e);
          hideLoading();
          showErrorToast('発送先の読み込みに失敗しました');
        })
        .getShippingToListData(filters);
    }

    function searchShippingTos() {
      loadShippingTos();
    }

    function clearFilter() {
      document.getElementById('filterKeyword').value = '';
      loadShippingTos();
    }

    function renderShippingTos() {
      const tbody = document.getElementById('shippingToTableBody');
      const cards = document.getElementById('shippingToCards');
      const countEl = document.getElementById('resultCount');

      countEl.textContent = '';
      countEl.appendChild(document.createTextNode('検索結果: '));
      const strong = document.createElement('strong');
      strong.textContent = shippingTos.length;
      countEl.appendChild(strong);
      countEl.appendChild(document.createTextNode(' 件'));

      tbody.textContent = '';
      cards.textContent = '';

      shippingTos.forEach(function (s) {
        const tr = document.createElement('tr');
        tr.addEventListener('click', function () { openEditModal(s.rowIndex); });

        const tdCompany = document.createElement('td');
        tdCompany.className = 'col-company';
        tdCompany.textContent = s.companyName || '';
        tr.appendChild(tdCompany);

        const tdName = document.createElement('td');
        tdName.className = 'col-name';
        tdName.textContent = s.personName || '';
        tr.appendChild(tdName);

        const tdAddress = document.createElement('td');
        tdAddress.className = 'col-address';
        const address = (s.address1 || '') + (s.address2 || '');
        tdAddress.textContent = address;
        tr.appendChild(tdAddress);

        const tdAction = document.createElement('td');
        tdAction.className = 'col-action';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-outline-primary btn-sm me-1';
        const editIcon = document.createElement('i');
        editIcon.className = 'bi bi-pencil';
        editBtn.appendChild(editIcon);
        editBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          openEditModal(s.rowIndex);
        });
        tdAction.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-outline-danger btn-sm';
        const deleteIcon = document.createElement('i');
        deleteIcon.className = 'bi bi-trash';
        deleteBtn.appendChild(deleteIcon);
        deleteBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          openDeleteModal(s.rowIndex, s.companyName || s.personName);
        });
        tdAction.appendChild(deleteBtn);

        tr.appendChild(tdAction);
        tbody.appendChild(tr);
      });

      shippingTos.forEach(function (s) {
        const card = document.createElement('div');
        card.className = 'shippingto-card';

        const header = document.createElement('div');
        header.className = 'shippingto-card-header';

        const headerContent = document.createElement('div');
        const title = document.createElement('h3');
        title.className = 'shippingto-card-title';
        title.textContent = s.companyName || s.personName || '';
        headerContent.appendChild(title);

        header.appendChild(headerContent);
        card.appendChild(header);

        const body = document.createElement('div');
        body.className = 'shippingto-card-body';

        const address = (s.address1 || '') + (s.address2 || '');
        const items = [
          { label: '氏名', value: s.personName || '-' },
          { label: 'TEL', value: s.tel || '-' },
          { label: '住所', value: address || '-' },
          { label: 'メール', value: s.email || '-' }
        ];

        items.forEach(function (item) {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'shippingto-card-item';

          const label = document.createElement('span');
          label.className = 'shippingto-card-label';
          label.textContent = item.label;
          itemDiv.appendChild(label);

          const value = document.createElement('span');
          value.className = 'shippingto-card-value';
          value.textContent = item.value;
          itemDiv.appendChild(value);

          body.appendChild(itemDiv);
        });

        card.appendChild(body);

        const buttons = document.createElement('div');
        buttons.className = 'shippingto-card-buttons';

        const editBtnMobile = document.createElement('button');
        editBtnMobile.className = 'btn btn-outline-primary btn-sm';
        const editIconMobile = document.createElement('i');
        editIconMobile.className = 'bi bi-pencil';
        editBtnMobile.appendChild(editIconMobile);
        editBtnMobile.appendChild(document.createTextNode(' 編集'));
        editBtnMobile.addEventListener('click', function () { openEditModal(s.rowIndex); });
        buttons.appendChild(editBtnMobile);

        const deleteBtnMobile = document.createElement('button');
        deleteBtnMobile.className = 'btn btn-outline-danger btn-sm';
        const deleteIconMobile = document.createElement('i');
        deleteIconMobile.className = 'bi bi-trash';
        deleteBtnMobile.appendChild(deleteIconMobile);
        deleteBtnMobile.appendChild(document.createTextNode(' 削除'));
        deleteBtnMobile.addEventListener('click', function () { openDeleteModal(s.rowIndex, s.companyName || s.personName); });
        buttons.appendChild(deleteBtnMobile);

        card.appendChild(buttons);
        cards.appendChild(card);
      });
    }

    function openAddModal() {
      document.getElementById('shippingToModalTitle').textContent = '発送先登録';
      document.getElementById('editRowIndex').value = '';
      clearModalForm();
      shippingToModal.show();
    }

    function openEditModal(rowIndex) {
      document.getElementById('shippingToModalTitle').textContent = '発送先編集';
      showLoading('発送先情報を取得中...');

      google.script.run
        .withSuccessHandler(function (shippingTo) {
          if (shippingTo) {
            var s = {
              rowIndex: shippingTo.rowIndex,
              companyName: shippingTo['会社名'] ?? shippingTo.companyName,
              department: shippingTo['部署'] ?? shippingTo.department,
              personName: shippingTo['氏名'] ?? shippingTo.personName,
              zipcode: shippingTo['郵便番号'] ?? shippingTo.zipcode,
              address1: shippingTo['住所１'] ?? shippingTo.address1,
              address2: shippingTo['住所２'] ?? shippingTo.address2,
              tel: shippingTo['TEL'] ?? shippingTo.tel,
              email: shippingTo['メールアドレス'] ?? shippingTo.email,
              memo: shippingTo['備考'] ?? shippingTo.memo
            };
            document.getElementById('editRowIndex').value = s.rowIndex;
            document.getElementById('shippingToCompanyName').value = s.companyName ?? '';
            document.getElementById('shippingToDepartment').value = s.department ?? '';
            document.getElementById('shippingToPersonName').value = s.personName ?? '';
            document.getElementById('shippingToZipcode').value = s.zipcode ?? '';
            document.getElementById('shippingToAddress1').value = s.address1 ?? '';
            document.getElementById('shippingToAddress2').value = s.address2 ?? '';
            document.getElementById('shippingToTel').value = s.tel ?? '';
            document.getElementById('shippingToEmail').value = s.email ?? '';
            document.getElementById('shippingToMemo').value = s.memo ?? '';
            shippingToModal.show();
          } else {
            showErrorToast('発送先情報の取得に失敗しました');
          }
          hideLoading();
        })
        .withFailureHandler(function (e) {
          console.error('発送先詳細取得エラー:', e);
          hideLoading();
          showErrorToast('発送先情報の取得に失敗しました');
        })
        .getShippingToDetail(rowIndex);
    }

    function clearModalForm() {
      document.getElementById('shippingToCompanyName').value = '';
      document.getElementById('shippingToDepartment').value = '';
      document.getElementById('shippingToPersonName').value = '';
      document.getElementById('shippingToZipcode').value = '';
      document.getElementById('shippingToAddress1').value = '';
      document.getElementById('shippingToAddress2').value = '';
      document.getElementById('shippingToTel').value = '';
      document.getElementById('shippingToEmail').value = '';
      document.getElementById('shippingToMemo').value = '';
    }

    function getShippingToAddress() {
      const zipcode = document.getElementById('shippingToZipcode').value.trim();
      if (!/^\d{7}$/.test(zipcode)) return;

      google.script.run
        .withSuccessHandler(function (result) {
          if (result) {
            const addr = JSON.parse(result);
            document.getElementById('shippingToAddress1').value =
              (addr.address1 || '') + (addr.address2 || '') + (addr.address3 || '');
          }
        })
        .withFailureHandler(function (error) {
          console.error('住所取得エラー:', error);
        })
        .getAddressFromPostalCode(JSON.stringify({ postalCode: zipcode }));
    }

    function saveShippingTo() {
      const companyName = document.getElementById('shippingToCompanyName').value.trim();
      const personName = document.getElementById('shippingToPersonName').value.trim();

      if (!companyName && !personName) {
        showErrorToast('会社名または氏名を入力してください');
        return;
      }

      const zipcode = document.getElementById('shippingToZipcode').value.trim();
      if (!zipcode) {
        showErrorToast('郵便番号を入力してください');
        return;
      }
      if (!/^\d{7}$/.test(zipcode)) {
        showErrorToast('郵便番号は7桁の数字で入力してください');
        return;
      }

      const address1 = document.getElementById('shippingToAddress1').value.trim();
      if (!address1) {
        showErrorToast('住所１を入力してください');
        return;
      }

      const tel = document.getElementById('shippingToTel').value.trim();
      if (!tel) {
        showErrorToast('電話番号を入力してください');
        return;
      }
      if (!/^0\d{9,10}$/.test(tel)) {
        showErrorToast('電話番号は10〜11桁の数字で入力してください');
        return;
      }

      const email = document.getElementById('shippingToEmail').value.trim();
      if (email && !/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/.test(email)) {
        showErrorToast('メールアドレスは正しい形式で入力してください');
        return;
      }

      const data = {
        companyName: companyName,
        department: document.getElementById('shippingToDepartment').value,
        personName: personName,
        zipcode: zipcode,
        address1: address1,
        address2: document.getElementById('shippingToAddress2').value,
        tel: tel,
        email: email,
        memo: document.getElementById('shippingToMemo').value
      };

      const rowIndex = document.getElementById('editRowIndex').value;

      showLoading('発送先を保存中...');

      if (rowIndex) {
        google.script.run
          .withSuccessHandler(function (result) {
            hideLoading();
            if (result.success) {
              showSuccessToast(result.message);
              shippingToModal.hide();
              loadShippingTos();
            } else {
              showErrorToast(result.message);
            }
          })
          .withFailureHandler(function (e) {
            hideLoading();
            showErrorToast('更新に失敗しました');
          })
          .updateShippingTo(Number(rowIndex), data);
      } else {
        google.script.run
          .withSuccessHandler(function (result) {
            hideLoading();
            if (result.success) {
              showSuccessToast(result.message);
              shippingToModal.hide();
              loadShippingTos();
            } else {
              showErrorToast(result.message);
            }
          })
          .withFailureHandler(function (e) {
            hideLoading();
            showErrorToast('登録に失敗しました');
          })
          .addShippingToFromList(data);
      }
    }

    function openDeleteModal(rowIndex, shippingToName) {
      document.getElementById('deleteRowIndex').value = rowIndex;
      document.getElementById('deleteShippingToName').textContent = shippingToName;
      deleteModal.show();
    }

    function confirmDelete() {
      const rowIndex = document.getElementById('deleteRowIndex').value;

      showLoading('削除中...');

      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          if (result.success) {
            showSuccessToast(result.message);
            deleteModal.hide();
            loadShippingTos();
          } else {
            showErrorToast(result.message);
          }
        })
        .withFailureHandler(function (e) {
          hideLoading();
          showErrorToast('削除に失敗しました');
        })
        .deleteShippingTo(Number(rowIndex));
    }

  </script>
</body>

</html>