<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>

  <style>
    .dashboard-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .summary-card {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-bottom: 15px;
    }

    .summary-card h3 {
      font-size: 2rem;
      margin: 10px 0;
      font-weight: bold;
    }

    .summary-card p {
      margin: 5px 0;
      opacity: 0.9;
    }

    .growth-positive {
      color: #10b981;
      font-weight: bold;
    }

    .growth-negative {
      color: #ef4444;
      font-weight: bold;
    }

    .chart-container {
      min-height: 400px;
      position: relative;
    }

    .table-responsive {
      max-height: 600px;
      overflow-y: auto;
    }

    .rank-badge {
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      border-radius: 50%;
      font-weight: bold;
      color: white;
      margin-right: 10px;
    }

    .rank-1 { background: #ffd700; }
    .rank-2 { background: #c0c0c0; }
    .rank-3 { background: #cd7f32; }
    .rank-other { background: #94a3b8; }

    .segment-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: bold;
    }

    .segment-active { background: #10b981; color: white; }
    .segment-warning { background: #f59e0b; color: white; }
    .segment-risk { background: #ef4444; color: white; }
    .segment-churned { background: #6b7280; color: white; }

    .alert-custom {
      border-left: 4px solid #ef4444;
      background: #fef2f2;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="container-fluid py-4">
    <form method="POST" action="<?= deployURL ?>">
      <div class="mb-3">
        <button type="submit" formnovalidate class="btn btn-outline-secondary" name="mainTop" value="true">
          â† ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
        </button>
      </div>
    </form>

    <h2 class="text-center mb-4">ğŸ“Š å£²ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>

    <div class="dashboard-card">
      <div class="row align-items-center">
        <div class="col-md-6">
          <label for="targetMonth" class="form-label">ğŸ“… å¯¾è±¡æœˆ</label>
          <input type="month" class="form-control" id="targetMonth" value="">
        </div>
        <div class="col-md-6 text-end">
          <button class="btn btn-primary" onclick="loadDashboardData()">ğŸ”„ æ›´æ–°</button>
          <button class="btn btn-success" onclick="runAllAnalyses()">âš¡ å…¨åˆ†æå®Ÿè¡Œ</button>
        </div>
      </div>
      <p class="text-muted mt-2 mb-0">æœ€çµ‚æ›´æ–°: <span id="lastUpdate">-</span></p>
    </div>

    <div class="row" id="summaryCards">
      <div class="col-md-3">
        <div class="summary-card">
          <p>å£²ä¸Šé«˜</p>
          <h3 id="totalSales">Â¥0</h3>
          <p id="salesGrowth">-</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="summary-card">
          <p>å—æ³¨ä»¶æ•°</p>
          <h3 id="totalOrders">0ä»¶</h3>
          <p id="ordersGrowth">-</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="summary-card">
          <p>è²©å£²å•†å“æ•°</p>
          <h3 id="productCount">0ç¨®é¡</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="summary-card">
          <p>ç·è²©å£²æ•°</p>
          <h3 id="totalQuantity">0å€‹</h3>
        </div>
      </div>
    </div>

    <div id="churnAlert" style="display: none;">
      <div class="alert-custom">
        <h5>âš ï¸ é›¢è„±ãƒªã‚¹ã‚¯é¡§å®¢ï¼ˆ91æ—¥ä»¥ä¸Šæ³¨æ–‡ãªã—ï¼‰</h5>
        <div id="churnCustomerList"></div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="dashboard-card">
          <h5>ğŸ“ˆ å•†å“åˆ†é¡åˆ¥æ§‹æˆæ¯”</h5>
          <div id="categoryChart" class="chart-container"></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="dashboard-card">
          <h5>ğŸ“Š å•†å“åˆ¥å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10</h5>
          <div id="top10Chart" class="chart-container"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="dashboard-card">
          <h5>ğŸ‘¥ é¡§å®¢åˆ¥å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10</h5>
          <div id="customerTop10Chart" class="chart-container"></div>
        </div>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>ğŸ† å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP20</h5>
        <button class="btn btn-sm btn-outline-primary" onclick="exportToCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover" id="rankingTable">
          <thead class="table-light">
            <tr>
              <th>é †ä½</th>
              <th>å•†å“å</th>
              <th>å•†å“åˆ†é¡</th>
              <th class="text-end">å£²ä¸Šé«˜</th>
              <th class="text-end">æ•°é‡</th>
              <th class="text-end">å—æ³¨å›æ•°</th>
            </tr>
          </thead>
          <tbody id="rankingTableBody">
            <tr>
              <td colspan="6" class="text-center">èª­ã¿è¾¼ã¿ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="dashboard-card">
      <h5>ğŸ“… å¹´é–“å£²ä¸Šæ¨ç§»</h5>
      <div class="row align-items-center mb-3">
        <div class="col-md-4">
          <label for="yearSelect" class="form-label">å¯¾è±¡å¹´</label>
          <select class="form-select" id="yearSelect" onchange="loadYearlyData()">
          </select>
        </div>
        <div class="col-md-4">
          <label for="productSelect" class="form-label">å•†å“é¸æŠï¼ˆå€‹åˆ¥æ¨ç§»ï¼‰</label>
          <select class="form-select" id="productSelect" onchange="updateProductYearlyChart()">
            <option value="">å…¨å•†å“åˆè¨ˆ</option>
          </select>
        </div>
        <div class="col-md-4 text-end align-self-end">
          <button class="btn btn-outline-primary" onclick="exportYearlyCSV()">ğŸ“¥ å¹´é–“ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›</button>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div id="yearlyChart" class="chart-container"></div>
        </div>
      </div>
      <div class="table-responsive mt-3">
        <table class="table table-hover" id="yearlyTable">
          <thead class="table-light">
            <tr>
              <th>æœˆ</th>
              <th class="text-end">å£²ä¸Šé«˜</th>
              <th class="text-end">å—æ³¨ä»¶æ•°</th>
              <th class="text-end">è²©å£²æ•°é‡</th>
              <th class="text-end">å‰å¹´åŒæœˆæ¯”</th>
            </tr>
          </thead>
          <tbody id="yearlyTableBody">
            <tr>
              <td colspan="5" class="text-center">å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="dashboard-card">
      <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="retention-tab" data-bs-toggle="tab" data-bs-target="#retention" type="button">
            ğŸ‘¥ é¡§å®¢ãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³åˆ†æ
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="seasonal-tab" data-bs-toggle="tab" data-bs-target="#seasonal" type="button">
            ğŸŒ¸ å­£ç¯€ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button">
            ğŸ“ˆ é¡§å®¢å‚¾å‘åˆ†æ
          </button>
        </li>
      </ul>
      <div class="tab-content p-3" id="analysisTabContent">
        <div class="tab-pane fade show active" id="retention" role="tabpanel">
          <p class="text-muted">é¡§å®¢ã‚’æœ€çµ‚æ³¨æ–‡æ—¥ã‹ã‚‰ã®çµŒéæ—¥æ•°ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåŒ–ã—ã¦ã„ã¾ã™ã€‚</p>
          <div id="retentionContent">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        <div class="tab-pane fade" id="seasonal" role="tabpanel">
          <p class="text-muted">éå»2å¹´é–“ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å•†å“ã”ã¨ã®å­£ç¯€ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’åˆ†æã—ã¦ã„ã¾ã™ã€‚</p>
          <div id="seasonalContent">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
        <div class="tab-pane fade" id="trends" role="tabpanel">
          <p class="text-muted">RFMåˆ†æã¨å•†å“è¦ªå’Œæ€§ã§é¡§å®¢ã®è³¼è²·ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¯è¦–åŒ–ã—ã¦ã„ã¾ã™ã€‚</p>
          <div id="trendsContent">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= HtmlService.createHtmlOutputFromFile('salesDashboardScript').getContent(); ?>
</body>

</html>
