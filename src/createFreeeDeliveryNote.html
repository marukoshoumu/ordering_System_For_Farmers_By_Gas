<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
</head>

<body>
  <div class="container">
    <h2 class="text-center m-4">freeeç´å“æ›¸CSVä½œæˆ</h2>
    <div class="alert alert-info" role="alert">
      <strong>ğŸ“‹ freeeå´ã®äº‹å‰æº–å‚™ãŒå¿…è¦ã§ã™:</strong>
      <ul class="mb-0 mt-2">
        <li>å–å¼•å…ˆï¼ˆé¡§å®¢ï¼‰ã‚’freeeã«ç™»éŒ²ã—ã€<strong>å–å¼•å…ˆåã¯freeeã®ç™»éŒ²åã¨åŒä¸€ã«</strong></li>
        <li>å“ç›®ï¼ˆå•†å“ï¼‰ã‚’freeeã«ç™»éŒ²ï¼ˆä»»æ„ã ãŒæ¨å¥¨ï¼‰</li>
        <li>å‹˜å®šç§‘ç›®ã‚’freeeã«ç™»éŒ²ï¼ˆä¾‹: å£²ä¸Šé«˜ï¼‰</li>
      </ul>
    </div>
    <form class="mb-5" method="POST" action="<?= deployURL ?>">
      <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
      <div class="customerSearch_dg">
        <div>
          <label for="customerSearchBunruiDg" class="text-left form-label">é¡§å®¢</label>
          <select class="form-select" id="customerSearchBunruiDg" name="customerSearchBunruiDg" >
            <option value="1">ä¼šç¤¾å</option>
            <option value="2">æ°å</option>
            <option value="3">è¡¨ç¤ºå</option>
            <option value="4">ãƒ•ãƒªã‚¬ãƒŠ</option>
          </select>
        </div>
        <div>
          <label for="customerSearchClassDg" class="text-left form-label">é¡§å®¢åˆ†é¡</label>
          <select class="form-select" id="customerSearchClassDg" name="customerSearchClassDg" >
            <option value=""></option>
            <option value="1">ä¸€æ¬¡å¸ã—ãƒ»å¤§å£</option>
            <option value="2">å°å£²åº—</option>
            <option value="3">é£²é£Ÿåº—ãƒ»ãƒ›ãƒ†ãƒ«</option>
            <option value="4">åœ°å…ƒé£²é£Ÿåº—</option>
            <option value="5">é€šä¿¡è²©å£²</option>
            <option value="6">ä¸€èˆ¬è²©å£²</option>
            <option value="7">ãã®ä»–</option>
            <option value="8">è·åŸŸ</option>
          </select>
        </div>
        <div>
          <label for="customerSearchKeyDg" class="text-left form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" class="form-control" id="customerSearchKeyDg" name="customerSearchKeyDg">
        </div>
        <div id="resCustArea" class="mt-2 resTable">
        </div>
      </div>
      <div class="row mb-3 align-items-center justify-content-center">
        <div class="col-auto">
          <label for="customerName" class="text-center form-label">é¡§å®¢å</label>
        </div>
        <div class="col-auto">
          <input type="text" class="form-control" id="customerName" name="customerName" placeholder="ç©ºæ¬„=å…¨é¡§å®¢">
        </div>
        <div class="col-auto">
          <button type='button' class="customerSearchBtn_open" title="é¡§å®¢æ¤œç´¢">ğŸ” æ¤œç´¢</button>
        </div>
      </div>
      <div class="row mb-3 align-items-center justify-content-center">
        <div class="col-auto">
          <label for="targetDateFrom" class="text-center form-label">ç™ºé€æ—¥</label>
        </div>
        <div class="col-auto">
          <input type="date" class="form-control" id="targetDateFrom" name="targetDateFrom">
        </div>
        <div class="col-auto">
          <label for="targetDateTo" class="text-center form-label">ï½</label>
        </div>
        <div class="col-auto">
          <input type="date" class="form-control" id="targetDateTo" name="targetDateTo">
        </div>
        <div class="col-auto">
          <button type='button' id="createFreeeCSV" class="btn btn-primary me-3">CSVä½œæˆ</button>
        </div>
      </div>
  </div>
  <p id="res" style="text-align: center;"></p>
  <div class="text-center">
    <button type="submit" formnovalidate class="btn btn-outline-secondary me-3" name="main" value="true">ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹</button>
  </div>
  <br>
  <div class="text-center">
    <button type="button" class="btn btn-outline-secondary" id="openFreeeCSV" name="openFreeeCSV" value="true">CSVå‚ç…§</button>
  </div>
  </form>
  </div>
  <script>
    // ========================================
    // æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    // ========================================
    var cachedCustomers = [];
    var masterDataLoaded = false;

    function openUrlFreeeCSV() {
      google.script.run.withSuccessHandler(sendSuccess).withFailureHandler(sendFail).getOpenUrlDrive('freeeç´å“æ›¸CSV');
    }
    function sendFail() {
      showErrorToast("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
    function sendSuccess(url) {
      window.open(url);
    }
    function setTodayDate() {
      const nowDate = new Date();
      var yyyy = nowDate.getFullYear();
      var mm = ("0"+(nowDate.getMonth()+1)).slice(-2);
      var dd = ("0"+nowDate.getDate()).slice(-2);
      var today = yyyy + '-' + mm + '-' + dd;
      document.getElementById("targetDateFrom").value = today;
      document.getElementById("targetDateTo").value = today;
    }
    setTodayDate();
    function createFreeeCSV() {
      const checkAddFlg = window.confirm('freeeç´å“æ›¸CSVã‚’ä½œæˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
      if(checkAddFlg) {
        $("button[id='createFreeeCSV']").text('ä½œæˆä¸­...');
        var customerName = $('input[id="customerName"]').val();
        var targetDateFrom = $('input[id="targetDateFrom"]').val();
        var targetDateTo = $('input[id="targetDateTo"]').val();
        var record = {};
        record['customerName'] = customerName;
        record['targetDateFrom'] = targetDateFrom;
        record['targetDateTo'] = targetDateTo;
        google.script.run.withSuccessHandler(createList).withFailureHandler(createFail).createFreeeDeliveryNote(JSON.stringify(record));
      }
    }
    function createFail() {
      showErrorToast("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      $("button[id='createFreeeCSV']").text('CSVä½œæˆ');
    }
    function createList(data) {
      if (data) {
        var res = JSON.parse(data);
        showSuccessToast("freeeç´å“æ›¸CSVã‚’ä½œæˆã—ã¾ã—ãŸã€‚");
        $("button[id='createFreeeCSV']").text('CSVä½œæˆ');
        var html = "â—†ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«â—†<br>";
        for (var ele of res) {
          html += escapeHtml(String(ele)) + ".csv" + "<br>";
        }
        $("p[id='res']").html(html);
      }
      else {
        showInfoToast("è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        $("button[id='createFreeeCSV']").text('CSVä½œæˆ');
      }
    }
    // é¡§å®¢æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã§å‹•çš„è¦ç´ ã«å¯¾å¿œï¼‰
    $(document).on("click", ".customerSearchBtn_open", function(){
        $(".customerSearch_dg").dialog({
            title:"é¡§å®¢æ¤œç´¢",
            width:"400",
            height:"500",
            modal:true,
            buttons:{
                "ã‚­ãƒ£ãƒ³ã‚»ãƒ«":function(){
                  $(this).dialog("close");
                },
                "æ¤œç´¢":function(){
                  customerSearch();
                },
           },
        });
    });
    function customerSearch() {
      if (!$('input[id="customerSearchKeyDg"]').val()) {
        showWarningToast('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        return false;
      }

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯æ—§æ–¹å¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (!masterDataLoaded) {
        console.warn('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰ - æ—§æ–¹å¼ã§æ¤œç´¢ã—ã¾ã™');
        $("#resCustArea").html('<div class="inline-spinner"><div class="mini-spinner"></div><span>æ¤œç´¢ä¸­...</span></div>');
        var record = {};
        record['customerSearchBunruiDg'] = $('select[id="customerSearchBunruiDg"]').val();
        record['customerSearchClassDg'] = $('select[id="customerSearchClassDg"]').val();
        record['customerSearchKeyDg'] = $('input[id="customerSearchKeyDg"]').val();
        google.script.run.withSuccessHandler(dataSearchSuccess).withFailureHandler(dataAddFail).customerSearch(JSON.stringify(record));
        return;
      }

      // ãƒ¡ãƒ¢ãƒªå†…ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆé«˜é€Ÿæ¤œç´¢ï¼‰
      var bunrui = $('select[id="customerSearchBunruiDg"]').val();
      var searchClass = $('select[id="customerSearchClassDg"]').val();
      var key = $('input[id="customerSearchKeyDg"]').val();

      var results = cachedCustomers.filter(function(customer) {
        // é¡§å®¢åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿
        if (searchClass && customer['é¡§å®¢åˆ†é¡'] !== searchClass) {
          return false;
        }

        // æ¤œç´¢å¯¾è±¡ã‚«ãƒ©ãƒ ã‚’æ±ºå®š
        var targetValue = '';
        if (bunrui == "1") {
          targetValue = customer['ä¼šç¤¾å'] || '';
        } else if (bunrui == "2") {
          targetValue = customer['æ°å'] || '';
        } else if (bunrui == "3") {
          targetValue = customer['è¡¨ç¤ºå'] || '';
        } else if (bunrui == "4") {
          targetValue = customer['ãƒ•ãƒªã‚¬ãƒŠ'] || '';
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
        return String(targetValue).includes(key);
      });

      // çµæœã‚’è¡¨ç¤º
      dataSearchSuccess(JSON.stringify(results));
    }

    /**
     * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
     */
    function escapeHtml(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function dataSearchSuccess(datas) {
      var res = JSON.parse(datas);
      if (res && res.length > 0) {
        var container = document.getElementById('resCustArea');
        container.innerHTML = '';

        var table = document.createElement('table');
        var headerRow = document.createElement('tr');
        ['', 'ä¼šç¤¾å', 'æ°å'].forEach(function(text) {
          var th = document.createElement('th');
          th.textContent = text;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        for (let i = 0; i < res.length; i++) {
          var companyName = res[i]["ä¼šç¤¾å"] || '';
          var personName = res[i]["æ°å"] || '';
          var zipcode = res[i]["éƒµä¾¿ç•ªå·"] || '';
          var address1 = res[i]["ä½æ‰€ï¼‘"] || '';
          var address2 = res[i]["ä½æ‰€ï¼’"] || '';
          var tel = res[i]["TEL"] || '';

          var datVal = companyName + "|" + personName + "|" + zipcode + "|" + address1 + address2 + "|" + tel;

          var tr = document.createElement('tr');

          // é¸æŠãƒœã‚¿ãƒ³ã‚»ãƒ«
          var tdBtn = document.createElement('td');
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.id = 'nameCust' + i;
          btn.dataset.val = datVal;
          btn.textContent = 'é¸æŠ';
          btn.onclick = (function(index) {
            return function() { applyName(index); };
          })(i);
          tdBtn.appendChild(btn);
          tr.appendChild(tdBtn);

          // ä¼šç¤¾åã‚»ãƒ«
          var tdCompany = document.createElement('td');
          var inputCompany = document.createElement('input');
          inputCompany.style.width = '120px';
          inputCompany.type = 'text';
          inputCompany.id = 'cust' + i;
          inputCompany.value = companyName;
          inputCompany.readOnly = true;
          tdCompany.appendChild(inputCompany);
          tr.appendChild(tdCompany);

          // æ°åã‚»ãƒ«
          var tdPerson = document.createElement('td');
          var inputPerson = document.createElement('input');
          inputPerson.style.width = '120px';
          inputPerson.type = 'text';
          inputPerson.id = 'ident' + i;
          inputPerson.value = personName;
          inputPerson.readOnly = true;
          tdPerson.appendChild(inputPerson);
          tr.appendChild(tdPerson);

          table.appendChild(tr);
        }

        container.appendChild(table);
      }
      else {
        showInfoToast('è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        $("#resCustArea").html('');
      }
    }
    function applyName(num) {
      var nameVal = 'nameCust' + num;
      var dataVal = $('button[id="'+ nameVal+ '"]').data('val');
      var dataSp = dataVal.split('|');
      $(".customerSearch_dg").dialog("close");
      if (dataSp[0]) {
        $('input[id="customerName"]').val(dataSp[0] + "ã€€" + dataSp[1]);
      }
      else {
        $('input[id="customerName"]').val(dataSp[1]);
      }
    }
    function dataAddFail() {
      showErrorToast("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }

    // ========================================
    // æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    // ========================================
    function loadMasterDataForSearch() {
      console.log('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');
      google.script.run
        .withSuccessHandler(function(data) {
          try {
            const masterData = JSON.parse(data);
            cachedCustomers = masterData.customers || [];
            masterDataLoaded = true;
            console.log('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å®Œäº†:', cachedCustomers.length + 'ä»¶ã®é¡§å®¢');
          } catch (e) {
            console.error('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
          }
        })
        .withFailureHandler(function(e) {
          console.error('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—:', e);
        })
        .getAllMasterDataForSearch();
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
    loadMasterDataForSearch();

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç™»éŒ²ï¼ˆDOMãƒ­ãƒ¼ãƒ‰å¾Œï¼‰
    $(document).ready(function() {
      $('#createFreeeCSV').on('click', function() {
        createFreeeCSV();
      });

      $('#openFreeeCSV').on('click', function() {
        openUrlFreeeCSV();
      });
    });
  </script>
</body>

</html>
