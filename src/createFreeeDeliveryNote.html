<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
</head>

<body>
  <style>
    body {
      background-color: var(--bg-body);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .card-header {
      background: var(--brand-primary);
      color: white;
      border-radius: 12px 12px 0 0 !important;
      padding: 16px 20px;
    }

    .card-header h1 {
      font-size: 1.25rem;
      margin: 0;
      font-weight: 600;
    }

    .filter-section {
      padding: 16px 20px;
      background: #fff;
      border-bottom: 1px solid #e9ecef;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 24px;
      align-items: center;
      margin-bottom: 12px;
    }

    .filter-row:last-child {
      margin-bottom: 0;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 0.875rem;
      color: #666;
      white-space: nowrap;
      min-width: 70px;
    }

    .table-section {
      padding: 16px 20px;
      background: #fff;
    }

    .freee-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .freee-table thead th {
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      padding: 12px 8px;
      text-align: left;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .freee-table tbody tr {
      border-bottom: 1px solid #e9ecef;
      transition: background 0.2s;
    }

    .freee-table tbody tr:hover {
      background: #e3f2fd;
    }

    .freee-table tbody td {
      padding: 10px 8px;
      vertical-align: top;
    }

    .freee-table .col-check {
      width: 40px;
      text-align: center;
    }

    /* スマホカード */
    .freee-cards {
      display: none;
    }

    .freee-card {
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: box-shadow 0.2s;
    }

    .freee-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .freee-card-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .freee-card-row:last-child {
      border-bottom: none;
    }

    .freee-card-icon {
      color: var(--brand-primary);
      min-width: 20px;
      text-align: center;
      padding-top: 2px;
    }

    .freee-card-value {
      flex: 1;
      font-size: 0.875rem;
    }

    .freee-card-label {
      font-size: 0.75rem;
      color: #999;
      margin-bottom: 2px;
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 8px;
      }

      .filter-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .filter-group {
        width: 100%;
      }

      .freee-pc-table {
        display: none;
      }

      .freee-cards {
        display: block;
      }
    }
  </style>

  <?!= HtmlService.createHtmlOutputFromFile('sidebar').getContent(); ?>

  <div class="main-container">
    <div class="card">
      <!-- ヘッダー -->
      <div class="card-header d-flex justify-content-between align-items-center">
        <h1><i class="bi bi-file-earmark-spreadsheet me-2"></i>freee納品書CSV作成</h1>
        <div class="d-flex gap-2">
          <form method="POST" action="<?= deployURL ?>" style="margin: 0;">
            <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
            <button type="submit" class="btn btn-outline-light btn-sm" name="main" value="true">
              <i class="bi bi-house"></i> ホーム
            </button>
          </form>
        </div>
      </div>

      <!-- 注意事項 -->
      <div style="padding: 16px 20px; background: #fff; border-bottom: 1px solid #e9ecef;">
        <div class="alert alert-info mb-0" role="alert">
          <strong>freee側の事前準備が必要です:</strong>
          <ul class="mb-0 mt-2">
            <li>取引先（顧客）をfreeeに登録し、<strong>取引先名はfreeeの登録名と同一に</strong></li>
            <li>品目（商品）をfreeeに登録（任意だが推奨）</li>
            <li>勘定科目をfreeeに登録（例: 売上高）</li>
          </ul>
        </div>
      </div>

      <!-- フィルター -->
      <form class="mb-0" method="POST" action="<?= deployURL ?>">
        <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
        <div class="customerSearch_dg">
          <div>
            <label for="customerSearchBunruiDg" class="text-left form-label">顧客</label>
            <select class="form-select" id="customerSearchBunruiDg" name="customerSearchBunruiDg" >
              <option value="1">会社名</option>
              <option value="2">氏名</option>
              <option value="3">表示名</option>
              <option value="4">フリガナ</option>
            </select>
          </div>
          <div>
            <label for="customerSearchClassDg" class="text-left form-label">顧客分類</label>
            <select class="form-select" id="customerSearchClassDg" name="customerSearchClassDg" >
              <option value=""></option>
              <option value="1">一次卸し・大口</option>
              <option value="2">小売店</option>
              <option value="3">飲食店・ホテル</option>
              <option value="4">地元飲食店</option>
              <option value="5">通信販売</option>
              <option value="6">一般販売</option>
              <option value="7">その他</option>
              <option value="8">職域</option>
            </select>
          </div>
          <div>
            <label for="customerSearchKeyDg" class="text-left form-label">キーワード</label>
            <input type="text" class="form-control" id="customerSearchKeyDg" name="customerSearchKeyDg">
          </div>
          <div id="resCustArea" class="mt-2 resTable">
          </div>
        </div>
        <div class="filter-section">
          <div class="filter-row">
            <div class="filter-group">
              <span class="filter-label">顧客名：</span>
              <input type="text" class="form-control form-control-sm" id="customerName" name="customerName" placeholder="空欄=全顧客" style="min-width: 180px;">
              <button type='button' class="btn btn-outline-secondary btn-sm customerSearchBtn_open" title="顧客検索">
                <i class="bi bi-search me-1"></i>検索
              </button>
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <span class="filter-label">発送日：</span>
              <input type="date" class="form-control form-control-sm" id="targetDateFrom" name="targetDateFrom" style="width: 150px;">
              <span style="color: #666;">〜</span>
              <input type="date" class="form-control form-control-sm" id="targetDateTo" name="targetDateTo" style="width: 150px;">
            </div>
            <button type='button' id="previewFreeeOrders" class="btn btn-secondary btn-sm">
              <i class="bi bi-eye me-1"></i>受注を確認
            </button>
            <button type='button' id="createFreeeCSV" class="btn btn-primary btn-sm">
              <i class="bi bi-download me-1"></i>CSV作成（全件）
            </button>
          </div>
        </div>

        <!-- 受注プレビュー -->
        <div class="table-section">
          <div id="orderPreviewArea" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <strong id="orderPreviewCount"></strong>
              <button type="button" id="createFreeeCSVSelected" class="btn btn-success btn-sm">
                <i class="bi bi-download me-1"></i>CSV生成（選択分）
              </button>
            </div>
            <!-- PC テーブル -->
            <div class="freee-pc-table">
              <table class="freee-table" id="orderPreviewTable">
                <thead>
                  <tr>
                    <th class="col-check"><input type="checkbox" id="selectAllOrders" title="全選択"></th>
                    <th>受注ID</th>
                    <th>顧客名</th>
                    <th>発送日</th>
                    <th>商品名</th>
                  </tr>
                </thead>
                <tbody id="orderPreviewBody">
                </tbody>
              </table>
            </div>
            <!-- スマホ カード -->
            <div class="freee-cards" id="orderPreviewCards">
            </div>
          </div>

          <p id="res" style="text-align: center; margin-top: 16px;"></p>

          <div class="text-center mt-3 mb-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="openFreeeCSV" name="openFreeeCSV" value="true">
              <i class="bi bi-folder2-open me-1"></i>CSV参照
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <script>
    // ========================================
    // 検索パフォーマンス改善: マスタデータキャッシュ
    // ========================================
    var cachedCustomers = [];
    var masterDataLoaded = false;

    function openUrlFreeeCSV() {
      google.script.run.withSuccessHandler(sendSuccess).withFailureHandler(sendFail).getOpenUrlDrive('freee納品書CSV');
    }
    function sendFail() {
      showErrorToast("処理に失敗しました。");
    }
    function sendSuccess(url) {
      window.open(url);
    }
    function setTodayDate() {
      const nowDate = new Date();
      var yyyy = nowDate.getFullYear();
      var mm = ("0"+(nowDate.getMonth()+1)).slice(-2);
      var dd = ("0"+nowDate.getDate()).slice(-2);
      var today = yyyy + '-' + mm + '-' + dd;
      document.getElementById("targetDateFrom").value = today;
      document.getElementById("targetDateTo").value = today;
    }
    setTodayDate();
    function createFreeeCSV() {
      const checkAddFlg = window.confirm('freee納品書CSVを作成してもよろしいですか？');
      if(checkAddFlg) {
        $("button[id='createFreeeCSV']").text('作成中...');
        var customerName = $('input[id="customerName"]').val();
        var targetDateFrom = $('input[id="targetDateFrom"]').val();
        var targetDateTo = $('input[id="targetDateTo"]').val();
        var record = {};
        record['customerName'] = customerName;
        record['targetDateFrom'] = targetDateFrom;
        record['targetDateTo'] = targetDateTo;
        google.script.run.withSuccessHandler(createList).withFailureHandler(createFail).createFreeeDeliveryNote(JSON.stringify(record));
      }
    }
    function createFail() {
      showErrorToast("エラーが発生しました。");
      $("button[id='createFreeeCSV']").text('CSV作成（全件）');
    }
    /**
     * 作成ファイル名をresパラグラフに表示する（DOM API使用、XSS安全）
     */
    function showFileResult(fileNames) {
      var resEl = document.getElementById('res');
      while (resEl.firstChild) {
        resEl.removeChild(resEl.firstChild);
      }
      resEl.appendChild(document.createTextNode('◆作成ファイル◆'));
      fileNames.forEach(function(name) {
        resEl.appendChild(document.createElement('br'));
        resEl.appendChild(document.createTextNode(String(name) + '.csv'));
      });
    }
    function createList(data) {
      if (data) {
        var res = JSON.parse(data);
        showSuccessToast("freee納品書CSVを作成しました。");
        $("button[id='createFreeeCSV']").text('CSV作成（全件）');
        showFileResult(res);
      }
      else {
        showInfoToast("該当データがありませんでした。");
        $("button[id='createFreeeCSV']").text('CSV作成（全件）');
      }
    }
    // 顧客検索ダイアログを開く（イベント委譲で動的要素に対応）
    $(document).on("click", ".customerSearchBtn_open", function(){
        $(".customerSearch_dg").dialog({
            title:"顧客検索",
            width:"400",
            height:"500",
            modal:true,
            buttons:{
                "キャンセル":function(){
                  $(this).dialog("close");
                },
                "検索":function(){
                  customerSearch();
                },
           },
        });
    });
    function customerSearch() {
      if (!$('input[id="customerSearchKeyDg"]').val()) {
        showWarningToast('キーワードが入力されていません。');
        return false;
      }

      // キャッシュが読み込まれていない場合は旧方式にフォールバック
      if (!masterDataLoaded) {
        console.warn('マスタデータ未ロード - 旧方式で検索します');
        $("#resCustArea").html('<div class="inline-spinner"><div class="mini-spinner"></div><span>検索中...</span></div>');
        var record = {};
        record['customerSearchBunruiDg'] = $('select[id="customerSearchBunruiDg"]').val();
        record['customerSearchClassDg'] = $('select[id="customerSearchClassDg"]').val();
        record['customerSearchKeyDg'] = $('input[id="customerSearchKeyDg"]').val();
        google.script.run.withSuccessHandler(dataSearchSuccess).withFailureHandler(dataAddFail).customerSearch(JSON.stringify(record));
        return;
      }

      // メモリ内フィルタリング（高速検索）
      var bunrui = $('select[id="customerSearchBunruiDg"]').val();
      var searchClass = $('select[id="customerSearchClassDg"]').val();
      var key = $('input[id="customerSearchKeyDg"]').val();

      var results = cachedCustomers.filter(function(customer) {
        // 顧客分類フィルタ
        if (searchClass && customer['顧客分類'] !== searchClass) {
          return false;
        }

        // 検索対象カラムを決定
        var targetValue = '';
        if (bunrui == "1") {
          targetValue = customer['会社名'] || '';
        } else if (bunrui == "2") {
          targetValue = customer['氏名'] || '';
        } else if (bunrui == "3") {
          targetValue = customer['表示名'] || '';
        } else if (bunrui == "4") {
          targetValue = customer['フリガナ'] || '';
        }

        // キーワード検索
        return String(targetValue).includes(key);
      });

      // 結果を表示
      dataSearchSuccess(JSON.stringify(results));
    }

    /**
     * HTMLエスケープ関数（XSS対策）
     */
    function escapeHtml(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function dataSearchSuccess(datas) {
      var res = JSON.parse(datas);
      if (res && res.length > 0) {
        var container = document.getElementById('resCustArea');
        container.innerHTML = '';

        var table = document.createElement('table');
        var headerRow = document.createElement('tr');
        ['', '会社名', '氏名'].forEach(function(text) {
          var th = document.createElement('th');
          th.textContent = text;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        for (let i = 0; i < res.length; i++) {
          var companyName = res[i]["会社名"] || '';
          var personName = res[i]["氏名"] || '';
          var zipcode = res[i]["郵便番号"] || '';
          var address1 = res[i]["住所１"] || '';
          var address2 = res[i]["住所２"] || '';
          var tel = res[i]["TEL"] || '';

          var datVal = companyName + "|" + personName + "|" + zipcode + "|" + address1 + address2 + "|" + tel;

          var tr = document.createElement('tr');

          // 選択ボタンセル
          var tdBtn = document.createElement('td');
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.id = 'nameCust' + i;
          btn.dataset.val = datVal;
          btn.textContent = '選択';
          btn.onclick = (function(index) {
            return function() { applyName(index); };
          })(i);
          tdBtn.appendChild(btn);
          tr.appendChild(tdBtn);

          // 会社名セル
          var tdCompany = document.createElement('td');
          var inputCompany = document.createElement('input');
          inputCompany.style.width = '120px';
          inputCompany.type = 'text';
          inputCompany.id = 'cust' + i;
          inputCompany.value = companyName;
          inputCompany.readOnly = true;
          tdCompany.appendChild(inputCompany);
          tr.appendChild(tdCompany);

          // 氏名セル
          var tdPerson = document.createElement('td');
          var inputPerson = document.createElement('input');
          inputPerson.style.width = '120px';
          inputPerson.type = 'text';
          inputPerson.id = 'ident' + i;
          inputPerson.value = personName;
          inputPerson.readOnly = true;
          tdPerson.appendChild(inputPerson);
          tr.appendChild(tdPerson);

          table.appendChild(tr);
        }

        container.appendChild(table);
      }
      else {
        showInfoToast('該当データがありませんでした。');
        $("#resCustArea").html('');
      }
    }
    function applyName(num) {
      var nameVal = 'nameCust' + num;
      var dataVal = $('button[id="'+ nameVal+ '"]').data('val');
      var dataSp = dataVal.split('|');
      $(".customerSearch_dg").dialog("close");
      if (dataSp[0]) {
        $('input[id="customerName"]').val(dataSp[0] + "　" + dataSp[1]);
      }
      else {
        $('input[id="customerName"]').val(dataSp[1]);
      }
    }
    function dataAddFail() {
      showErrorToast("エラーが発生しました。");
    }

    // ========================================
    // 検索パフォーマンス改善: マスタデータロード
    // ========================================
    function loadMasterDataForSearch() {
      console.log('マスタデータをロード中...');
      google.script.run
        .withSuccessHandler(function(data) {
          try {
            const masterData = JSON.parse(data);
            cachedCustomers = masterData.customers || [];
            masterDataLoaded = true;
            console.log('マスタデータロード完了:', cachedCustomers.length + '件の顧客');
          } catch (e) {
            console.error('マスタデータのパースに失敗:', e);
          }
        })
        .withFailureHandler(function(e) {
          console.error('マスタデータのロードに失敗:', e);
        })
        .getAllMasterDataForSearch();
    }

    // ページロード時に実行
    loadMasterDataForSearch();

    // ========================================
    // 受注プレビュー・選択CSV生成
    // ========================================
    function previewFreeeOrders() {
      var customerName = $('input[id="customerName"]').val();
      var targetDateFrom = $('input[id="targetDateFrom"]').val();
      var targetDateTo = $('input[id="targetDateTo"]').val();
      if (!targetDateFrom || !targetDateTo) {
        showWarningToast('発送日の期間を入力してください。');
        return;
      }
      $("button[id='previewFreeeOrders']").text('検索中...');
      var record = {
        customerName: customerName,
        targetDateFrom: targetDateFrom,
        targetDateTo: targetDateTo
      };
      google.script.run
        .withSuccessHandler(renderOrderPreview)
        .withFailureHandler(previewFail)
        .getFreeeDeliveryNoteOrderList(JSON.stringify(record));
    }

    function previewFail() {
      showErrorToast("受注一覧の取得に失敗しました。");
      $("button[id='previewFreeeOrders']").text('受注を確認');
    }

    function renderOrderPreview(data) {
      $("button[id='previewFreeeOrders']").text('受注を確認');
      var orders = JSON.parse(data);
      var tbody = document.getElementById('orderPreviewBody');
      var cardsContainer = document.getElementById('orderPreviewCards');

      while (tbody.firstChild) { tbody.removeChild(tbody.firstChild); }
      cardsContainer.innerHTML = '';

      if (!orders || orders.length === 0) {
        showInfoToast("該当する受注がありませんでした。");
        document.getElementById('orderPreviewArea').style.display = 'none';
        return;
      }

      var cardsHtml = '';

      orders.forEach(function(order) {
        // PC テーブル行
        var tr = document.createElement('tr');

        var tdCheck = document.createElement('td');
        tdCheck.className = 'col-check';
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'order-row-checkbox';
        cb.value = order.orderId;
        tdCheck.appendChild(cb);
        tr.appendChild(tdCheck);

        var tdId = document.createElement('td');
        tdId.textContent = order.orderId;
        tr.appendChild(tdId);

        var tdCustomer = document.createElement('td');
        tdCustomer.textContent = order.customerName;
        tr.appendChild(tdCustomer);

        var tdDate = document.createElement('td');
        tdDate.textContent = order.shippingDate;
        tr.appendChild(tdDate);

        var tdProduct = document.createElement('td');
        tdProduct.textContent = order.productName;
        tr.appendChild(tdProduct);

        tbody.appendChild(tr);

        // スマホカード
        cardsHtml += '<div class="freee-card">';
        cardsHtml += '<div class="freee-card-row">';
        cardsHtml += '  <input type="checkbox" class="form-check-input order-row-checkbox-card" value="' + escapeHtml(order.orderId) + '" style="margin-right: 8px;">';
        cardsHtml += '  <div class="freee-card-value" style="font-weight: 600;">' + escapeHtml(order.orderId) + '</div>';
        cardsHtml += '  <span style="font-size: 0.8rem; color: #666;">' + escapeHtml(order.shippingDate) + '</span>';
        cardsHtml += '</div>';
        cardsHtml += '<div class="freee-card-row">';
        cardsHtml += '  <span class="freee-card-icon"><i class="bi bi-person"></i></span>';
        cardsHtml += '  <div class="freee-card-value">';
        cardsHtml += '    <div class="freee-card-label">顧客名</div>' + escapeHtml(order.customerName);
        cardsHtml += '  </div>';
        cardsHtml += '</div>';
        cardsHtml += '<div class="freee-card-row">';
        cardsHtml += '  <span class="freee-card-icon"><i class="bi bi-box-seam"></i></span>';
        cardsHtml += '  <div class="freee-card-value">';
        cardsHtml += '    <div class="freee-card-label">商品名</div>' + escapeHtml(order.productName);
        cardsHtml += '  </div>';
        cardsHtml += '</div>';
        cardsHtml += '</div>';
      });

      cardsContainer.innerHTML = cardsHtml;

      document.getElementById('orderPreviewCount').textContent = '対象受注: ' + orders.length + '件';
      document.getElementById('orderPreviewArea').style.display = '';
      document.getElementById('selectAllOrders').checked = false;
    }

    function createFreeeCSVSelected() {
      var checkboxes = document.querySelectorAll('.order-row-checkbox:checked, .order-row-checkbox-card:checked');
      if (checkboxes.length === 0) {
        showWarningToast('受注を1件以上選択してください。');
        return;
      }
      var selectedIds = [];
      checkboxes.forEach(function(cb) {
        selectedIds.push(cb.value);
      });
      var confirmMsg = '選択した' + selectedIds.length + '件の受注でfreee納品書CSVを作成しますか？';
      if (!window.confirm(confirmMsg)) return;

      $("button[id='createFreeeCSVSelected']").text('作成中...');
      google.script.run
        .withSuccessHandler(createListSelected)
        .withFailureHandler(createFailSelected)
        .createFreeeDeliveryNoteByIds(JSON.stringify(selectedIds));
    }

    function createFailSelected() {
      showErrorToast("エラーが発生しました。");
      $("button[id='createFreeeCSVSelected']").text('CSV生成（選択分）');
    }

    function createListSelected(data) {
      $("button[id='createFreeeCSVSelected']").text('CSV生成（選択分）');
      if (data) {
        var res = JSON.parse(data);
        showSuccessToast("freee納品書CSVを作成しました。");
        showFileResult(res);
      } else {
        showInfoToast("該当データがありませんでした。");
      }
    }

    // イベントハンドラー登録（DOMロード後）
    $(document).ready(function() {
      $('#createFreeeCSV').on('click', function() {
        createFreeeCSV();
      });

      $('#previewFreeeOrders').on('click', function() {
        previewFreeeOrders();
      });

      $('#selectAllOrders').on('change', function() {
        var checked = this.checked;
        document.querySelectorAll('.order-row-checkbox, .order-row-checkbox-card').forEach(function(cb) {
          cb.checked = checked;
        });
      });

      $('#createFreeeCSVSelected').on('click', function() {
        createFreeeCSVSelected();
      });

      $('#openFreeeCSV').on('click', function() {
        openUrlFreeeCSV();
      });
    });
  </script>
</body>

</html>
