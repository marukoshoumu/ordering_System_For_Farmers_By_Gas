<!-- 
  受注一覧 - GAS統合版（完全版）
  
  修正内容:
  1. 今週/来週の日付計算を修正（今日起点で7日間）
  2. 受注ID単位でグループ化表示
  3. 品名（productName）を表示
  4. 引継ボタン追加（発送日・納品日・個数を除外して引継ぎ）
  5. 行クリックで詳細モーダル表示
  
  機能:
  - シート「受注」の情報を一覧表示
  - 検索条件: 期間（今週/来週/今月/来月/期間指定）、発送先、顧客
  - 表示項目: 受注日、発送先名、発送日、納品日、品名
  - 行クリックで全項目を詳細モーダルで表示
-->

<!DOCTYPE html>
<html lang="ja">

<head>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>受注一覧</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <style>
    body {
      background-color: var(--bg-body);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* フィルターセクション */
    .filter-section {
      padding: 16px 20px;
      background: #fff;
      border-bottom: 1px solid #e9ecef;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 24px;
      align-items: center;
      margin-bottom: 12px;
    }

    .filter-row:last-child {
      margin-bottom: 0;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 0.875rem;
      color: #666;
      white-space: nowrap;
      min-width: 70px;
    }

    /* 期間指定の日付入力 */
    .custom-date-inputs {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .custom-date-inputs input[type="date"] {
      width: 150px;
    }

    .date-separator {
      color: #666;
    }

    /* テーブル */
    .table-section {
      padding: 16px 20px;
      background: #fff;
      overflow-x: auto;
    }

    /* PCテーブル */
    .order-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .order-table thead th {
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      padding: 12px 8px;
      text-align: left;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .order-table tbody tr {
      border-bottom: 1px solid #e9ecef;
      transition: background 0.2s;
      cursor: pointer;
    }

    .order-table tbody tr:hover {
      background: #e3f2fd;
    }

    .order-table tbody td {
      padding: 10px 8px;
      vertical-align: top;
    }

    .order-table .col-date {
      white-space: nowrap;
      width: 70px;
    }

    .order-table .col-name,
    .order-table .col-product {
      max-width: 180px;
      min-width: 120px;
    }

    .order-table .col-quantity {
      text-align: right;
      width: 50px;
      white-space: nowrap;
    }

    .order-table .col-action {
      width: 150px;
      text-align: center;
    }

    .order-table .col-memo {
      min-width: 100px;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .scan-btn {
      padding: 4px 8px;
    }

    .edit-btn {
      padding: 4px 8px;
    }

    .inherit-btn {
      padding: 4px 8px;
    }

    /* 2行折り返し + ツールチップ */
    .cell-text {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
      max-height: 2.8em;
      cursor: default;
    }

    /* カスタムツールチップ */
    .cell-text[data-tooltip] {
      position: relative;
    }

    .cell-text[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 0;
      top: 100%;
      margin-top: 4px;
      padding: 8px 12px;
      background: #333;
      color: white;
      font-size: 0.8rem;
      border-radius: 6px;
      white-space: normal;
      max-width: 300px;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      line-height: 1.4;
    }

    /* スマホ用カード */
    .order-cards {
      display: none;
    }

    .order-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
    }

    .order-card:hover {
      background: #f8f9fa;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .order-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
    }

    .order-card-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .edit-btn-sp {
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    .inherit-btn-sp {
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    .order-card-dates {
      font-size: 0.8rem;
      color: #666;
    }

    .order-card-dates .date-label {
      color: #999;
      margin-right: 2px;
    }

    .order-card-dates .date-value {
      color: #333;
      font-weight: 500;
    }

    .order-card-dates .date-separator {
      margin: 0 6px;
      color: #ccc;
    }

    .order-card-quantity {
      background: var(--brand-primary);
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .order-card-row {
      display: flex;
      align-items: flex-start;
      margin-bottom: 6px;
      font-size: 0.875rem;
    }

    .order-card-row:last-child {
      margin-bottom: 0;
    }

    .order-card-icon {
      width: 24px;
      color: #666;
      flex-shrink: 0;
    }

    .order-card-value {
      flex: 1;
      color: #333;
      line-height: 1.4;
      word-break: break-word;
    }

    .order-card-label {
      font-size: 0.7rem;
      color: #999;
      margin-bottom: 2px;
    }

    /* スマホ用カードのボタン行 */
    .order-card-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
    }

    .order-card-buttons button {
      flex: 1;
    }

    /* 件数表示 */
    .result-count {
      padding: 8px 0;
      font-size: 0.875rem;
      color: #666;
    }

    .result-count strong {
      color: var(--brand-primary);
      font-size: 1.1rem;
    }

    /* 検索モーダル */
    .search-modal .modal-body {
      padding: 0;
    }

    .search-modal .search-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e9ecef;
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 10;
    }

    .search-modal .search-results {
      max-height: 400px;
      overflow-y: auto;
    }

    .search-modal .search-result-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .search-modal .search-result-item:hover {
      background: #f8f9fa;
    }

    .search-modal .result-main {
      font-weight: 500;
      color: #333;
    }

    .search-modal .result-sub {
      font-size: 0.75rem;
      color: #666;
      margin-top: 2px;
    }

    .search-modal .no-results {
      padding: 24px 16px;
      text-align: center;
      color: #666;
    }

    /* モーダルヘッダー */
    .modal-header {
      background: var(--brand-primary);
      color: white;
    }

    .modal-title {
      font-size: 1rem;
    }

    .btn-close {
      filter: invert(1);
    }

    /* ページング */
    .pagination-section {
      padding: 16px 20px;
      background: #fff;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    /* 空状態 */
    .empty-state {
      padding: 48px 20px;
      text-align: center;
      color: #666;
    }

    .empty-state i {
      font-size: 3rem;
      color: #ccc;
      margin-bottom: 16px;
    }

    /* 詳細モーダル */
    .detail-modal .modal-dialog {
      max-width: 700px;
    }

    .detail-modal .modal-body {
      padding: 0;
      max-height: 70vh;
      overflow-y: auto;
    }

    .detail-section {
      border-bottom: 1px solid #e9ecef;
    }

    .detail-section:last-child {
      border-bottom: none;
    }

    .detail-section-header {
      background: #f8f9fa;
      padding: 10px 16px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-section-header i {
      color: var(--brand-primary);
    }

    .detail-section-body {
      padding: 12px 16px;
    }

    .detail-row {
      display: flex;
      padding: 6px 0;
      font-size: 0.875rem;
      border-bottom: 1px dashed #f0f0f0;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      width: 120px;
      flex-shrink: 0;
      color: #666;
      font-size: 0.8rem;
    }

    .detail-value {
      flex: 1;
      color: #333;
      word-break: break-word;
    }

    .detail-value.empty {
      color: #999;
      font-style: italic;
    }

    /* 商品テーブル */
    .product-detail-table {
      width: 100%;
      font-size: 0.85rem;
      border-collapse: collapse;
    }

    .product-detail-table th {
      background: #f8f9fa;
      padding: 8px;
      text-align: left;
      font-weight: 500;
      border-bottom: 1px solid #dee2e6;
    }

    .product-detail-table td {
      padding: 8px;
      border-bottom: 1px solid #f0f0f0;
    }

    .product-detail-table .text-end {
      text-align: right;
    }

    .product-detail-table tfoot td {
      font-weight: 600;
      background: #f8f9fa;
    }

    /* チェックリストバッジ */
    .checklist-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .checklist-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
    }

    .checklist-badge.active {
      background: #d4edda;
      color: #155724;
    }

    .checklist-badge.inactive {
      background: #e9ecef;
      color: #6c757d;
      text-decoration: line-through;
    }

    /* レスポンシブ対応 */
    @media (max-width: 768px) {
      .main-container {
        padding: 8px;
      }

      .filter-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .filter-group {
        width: 100%;
      }

      .filter-label {
        min-width: 60px;
      }

      /* スマホでは期間指定を縦並び */
      .custom-date-inputs {
        flex-direction: column;
        align-items: stretch;
        gap: 4px;
        width: 100%;
      }

      .custom-date-inputs input[type="date"] {
        width: 100%;
      }

      .date-separator {
        text-align: center;
        padding: 2px 0;
      }

      /* スマホではテーブル非表示、カード表示 */
      .pc-table {
        display: none;
      }

      .order-cards {
        display: block;
      }

      .table-section {
        padding: 12px;
      }

      /* 詳細モーダル */
      .detail-label {
        width: 100px;
      }
    }

    @media (min-width: 769px) {

      /* PCではテーブル表示、カード非表示 */
      .pc-table {
        display: block;
      }

      .order-cards {
        display: none;
      }
    }

    /* 出荷済・予定日超過のスタイル */
    .shipped-row {
      background-color: #e8f5e9 !important;
      border-left: 4px solid #4caf50;
      opacity: 0.85;
    }

    .shipped-row:hover {
      background-color: #c8e6c9 !important;
    }

    .overdue-row {
      background-color: #ffebee !important;
      border-left: 4px solid #f44336;
      color: #c62828;
    }

    .overdue-row:hover {
      background-color: #ffcdd2 !important;
    }

    .col-shipped {
      width: 80px;
      text-align: center;
    }

    .shipped-checkbox {
      cursor: pointer;
      transform: scale(1.2);
    }

    /* チェックボックスのホバー/フォーカス視認性向上 */
    .shipped-checkbox:hover {
      transform: scale(1.4);
      box-shadow: 0 0 8px rgba(13, 110, 253, 0.6);
      outline: 2px solid #0d6efd;
      outline-offset: 2px;
    }

    .shipped-checkbox:focus {
      transform: scale(1.4);
      box-shadow: 0 0 12px rgba(13, 110, 253, 0.8);
      outline: 3px solid #0d6efd;
      outline-offset: 2px;
    }

    /* 一括選択用チェックボックス列 */
    .col-select {
      width: 40px;
      text-align: center;
    }

    .select-checkbox {
      cursor: pointer;
      transform: scale(1.2);
    }

    .select-checkbox:hover {
      transform: scale(1.4);
      box-shadow: 0 0 8px rgba(25, 135, 84, 0.6);
      outline: 2px solid #198754;
      outline-offset: 2px;
    }

    .select-checkbox:focus {
      transform: scale(1.4);
      box-shadow: 0 0 12px rgba(25, 135, 84, 0.8);
      outline: 3px solid #198754;
      outline-offset: 2px;
    }

    /* キャンセル済み行のスタイル */
    .cancelled-row {
      background-color: #fff3e0 !important;
      border-left: 4px solid #ff9800;
      opacity: 0.75;
      text-decoration: line-through;
      color: #6c757d;
    }

    .cancelled-row:hover {
      background-color: #ffe0b2 !important;
    }

    /* 一括操作ボタンエリア */
    .bulk-action-area {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .bulk-action-area .selected-count {
      font-size: 0.875rem;
      color: #666;
      margin-right: 8px;
    }

    /* キャンセル解除ボタンのスタイル強化 */
    .btn-outline-info {
      border-color: #0dcaf0 !important;
      color: #0dcaf0 !important;
      background-color: rgba(13, 202, 240, 0.1) !important;
    }

    .btn-outline-info:hover {
      background-color: #0dcaf0 !important;
      color: white !important;
    }

    /* キャンセル解除ボタンのスタイル強化 */
    .btn-outline-success {
      border-color: #56f127 !important;
      color: #56f127 !important;
      background-color: rgba(86, 241, 39, 0.1) !important;
    }

    .btn-outline-success:hover {
      background-color: #56f127 !important;
      color: white !important;
    }

    /* フィルターセクションのボタン強化 */
    .filter-section .btn-group {
      gap: 6px;
      display: flex;
      flex-wrap: wrap;
    }

    .filter-section .btn-group>.btn {
      border: 2px solid !important;
      border-radius: 6px !important;
      flex: none !important;
      margin-left: 0 !important;
      font-weight: 500;
      transition: all 0.2s;
    }

    .filter-section .btn-outline-primary {
      border-color: #0d6efd !important;
      color: #0d6efd !important;
    }

    .filter-section .btn-outline-secondary {
      border-color: #6c757d !important;
      color: #6c757d !important;
    }

    .filter-section .btn-outline-danger {
      border-color: #dc3545 !important;
      color: #dc3545 !important;
    }

    .filter-section .btn-outline-warning {
      border-color: #ffc107 !important;
      color: #ffc107 !important;
    }

    /* ホバー時の背景色設定 */
    .filter-section .btn-outline-primary:hover {
      background-color: #0d6efd !important;
      color: #fff !important;
    }

    .filter-section .btn-outline-secondary:hover {
      background-color: #6c757d !important;
      color: #fff !important;
    }

    .filter-section .btn-outline-danger:hover {
      background-color: #dc3545 !important;
      color: #fff !important;
    }

    .filter-section .btn-outline-warning:hover {
      background-color: #ffc107 !important;
      color: #212529 !important;
    }

    /* チェック（選択）時の背景色設定 */
    .filter-section .btn-check:checked+.btn-outline-primary {
      background-color: #0d6efd !important;
      color: #fff !important;
    }

    .filter-section .btn-check:checked+.btn-outline-secondary {
      background-color: #6c757d !important;
      color: #fff !important;
    }

    .filter-section .btn-check:checked+.btn-outline-danger {
      background-color: #dc3545 !important;
      color: #fff !important;
    }

    .filter-section .btn-check:checked+.btn-outline-warning {
      background-color: #ffc107 !important;
      color: #212529 !important;
    }

    /* 出荷状態ラジオボタンのチェック時スタイル強化 */
    .btn-check:checked+.btn-outline-secondary {
      background-color: #6c757d !important;
      color: white !important;
      border-color: #6c757d !important;
    }

    .btn-check:checked+.btn-outline-danger {
      background-color: #dc3545 !important;
      color: white !important;
      border-color: #dc3545 !important;
    }

    .btn-check:checked+.btn-outline-warning {
      background-color: #ffc107 !important;
      color: #212529 !important;
      border-color: #ffc107 !important;
    }

    /* 選択済み行のハイライト */
    .selected-row {
      background-color: #cfe2ff !important;
      border-left: 4px solid #0d6efd;
    }

    .selected-row:hover {
      background-color: #b6d4fe !important;
    }

    /* スマホカードの選択状態 */
    .order-card.selected-row {
      background-color: #cfe2ff !important;
      border-left: 4px solid #0d6efd;
      box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
    }

    /* テーブルヘッダーの視認性向上 */
    .order-table thead th {
      background: #343a40 !important;
      color: white !important;
      border-bottom: 3px solid #23272b !important;
      padding: 12px 8px;
      text-align: left;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .order-table thead th .form-check-input {
      border-color: white;
    }

    /* スキャナー関連スタイル */
    #scannerView {
      width: 100%;
      height: 100%;
      background-color: #000;
    }

    #scannerView video,
    #scannerView canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
      display: flex;
    }

    .scanner-region {
      border: 3px solid #0d6efd;
      width: 80%;
      height: 30%;
      margin: auto;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .scanner-region::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 2px;
      background: rgba(255, 0, 0, 0.5);
      box-shadow: 0 0 10px red;
      animation: scan-line 2s infinite ease-in-out;
    }

    @keyframes scan-line {

      0%,
      100% {
        transform: translateY(-50px);
      }

      50% {
        transform: translateY(50px);
      }
    }

    .scanner-result-overlay,
    .scanner-error-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
    }

    .scanner-result-overlay {
      background: rgba(25, 135, 84, 0.95);
    }

    .scanner-error-overlay {
      background: rgba(220, 53, 69, 0.95);
    }

    .manual-input-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 15;
      display: none;
      flex-direction: column;
      justify-content: center;
    }
  </style>
</head>

<body>
  <?!= includeSidebar(deployURL, sessionId, typeof userRole !== 'undefined' ? userRole : 'viewer') ?>

  <div class="main-container">
    <div class="card">
      <!-- ヘッダー -->
      <div class="page-hero-header d-flex justify-content-center align-items-center">
        <h1 class="m-0"><i class="bi bi-list-ul me-2"></i>受注一覧</h1>
        <div style="position: absolute; right: 16px;">
          <? if (userRole !== 'viewer') { ?>
          <form method="POST" action="<?= deployURL ?>" style="margin: 0;">
            <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
            <button type="submit" formnovalidate class="btn btn-light btn-sm" name="shipping" value="true">
              <i class="bi bi-plus-circle me-1"></i>注文新規登録
            </button>
          </form>
          <? } ?>
        </div>
      </div>

      <!-- フィルター -->
      <div class="filter-section">
        <!-- 1行目：期間 -->
        <div class="filter-row">
          <div class="filter-group">
            <span class="filter-label">期間：</span>
            <div class="btn-group btn-group-sm" role="group">
              <input type="radio" class="btn-check" name="period" id="periodNone" value="none">
              <label class="btn btn-outline-primary" for="periodNone">指定なし</label>
              <input type="radio" class="btn-check" name="period" id="periodYesterday" value="yesterday">
              <label class="btn btn-outline-primary" for="periodYesterday">前日</label>
              <input type="radio" class="btn-check" name="period" id="periodToday" value="today">
              <label class="btn btn-outline-primary" for="periodToday">今日</label>
              <input type="radio" class="btn-check" name="period" id="periodTomorrow" value="tomorrow">
              <label class="btn btn-outline-primary" for="periodTomorrow">明日</label>
              <input type="radio" class="btn-check" name="period" id="periodThisWeek" value="thisWeek" checked>
              <label class="btn btn-outline-primary" for="periodThisWeek">今週</label>
              <input type="radio" class="btn-check" name="period" id="periodNextWeek" value="nextWeek">
              <label class="btn btn-outline-primary" for="periodNextWeek">来週</label>
              <input type="radio" class="btn-check" name="period" id="periodLastMonth" value="lastMonth">
              <label class="btn btn-outline-primary" for="periodLastMonth">先月</label>
              <input type="radio" class="btn-check" name="period" id="periodThisMonth" value="thisMonth">
              <label class="btn btn-outline-primary" for="periodThisMonth">今月</label>
              <input type="radio" class="btn-check" name="period" id="periodNextMonth" value="nextMonth">
              <label class="btn btn-outline-primary" for="periodNextMonth">来月</label>
              <input type="radio" class="btn-check" name="period" id="periodCustom" value="custom">
              <label class="btn btn-outline-primary" for="periodCustom">期間指定</label>
            </div>
          </div>
        </div>

        <!-- 期間指定の日付範囲（別行で表示） -->
        <div id="customDateRangeRow" style="display: none;">
          <div class="filter-row">
            <div class="filter-group">
              <span class="filter-label"></span>
              <div class="custom-date-inputs">
                <input type="date" class="form-control form-control-sm" id="dateFrom">
                <span class="date-separator">〜</span>
                <input type="date" class="form-control form-control-sm" id="dateTo">
              </div>
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <span class="filter-label"></span>
              <span class="text-muted" style="font-size: 0.8rem;">※最大1ヶ月まで指定可能です</span>
            </div>
          </div>
        </div>

        <!-- 2行目：発送先・顧客 -->
        <div class="filter-row">
          <div class="filter-group">
            <span class="filter-label">発送先：</span>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="destinationBtn" data-bs-toggle="modal"
              data-bs-target="#destinationSearchModal">
              <i class="bi bi-search me-1"></i>指定なし
            </button>
          </div>
          <div class="filter-group">
            <span class="filter-label">顧客：</span>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="customerBtn" data-bs-toggle="modal"
              data-bs-target="#customerSearchModal">
              <i class="bi bi-search me-1"></i>指定なし
            </button>
          </div>
        </div>

        <!-- 3行目：出荷状態・検索ボタン -->
        <div class="filter-row">
          <div class="filter-group">
            <span class="filter-label">出荷状態：</span>
            <div class="btn-group btn-group-sm" role="group">
              <input type="radio" class="btn-check" name="shippingStatus" id="statusAll" value="all" checked>
              <label class="btn btn-outline-secondary" for="statusAll">全て</label>
              <input type="radio" class="btn-check" name="shippingStatus" id="statusNotShipped" value="notShipped">
              <label class="btn btn-outline-secondary" for="statusNotShipped">未出荷</label>
              <input type="radio" class="btn-check" name="shippingStatus" id="statusShipped" value="shipped">
              <label class="btn btn-outline-secondary" for="statusShipped">出荷済</label>
              <input type="radio" class="btn-check" name="shippingStatus" id="statusHarvestWaiting"
                value="harvestWaiting">
              <label class="btn btn-outline-secondary" for="statusHarvestWaiting">収穫待ち</label>
              <input type="radio" class="btn-check" name="shippingStatus" id="statusShippedToDelivering"
                value="shippedToDelivering">
              <label class="btn btn-outline-secondary" for="statusShippedToDelivering">出荷済〜配達中</label>
              <input type="radio" class="btn-check" name="shippingStatus" id="statusCancelled" value="cancelled">
              <label class="btn btn-outline-warning" for="statusCancelled">キャンセル済</label>
            </div>
          </div>
          <div class="filter-group">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeOverdue">
              <label class="form-check-label" for="includeOverdue" style="color: #dc3545; font-weight: 500;">
                予定日超過を含む
              </label>
            </div>
          </div>
          <button type="button" class="btn btn-primary btn-sm" onclick="executeSearch()">
            <i class="bi bi-search me-1"></i>検索
          </button>
        </div>
      </div>

      <!-- テーブル -->
      <div class="table-section position-relative">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
          <div class="result-count" id="resultCount">
            検索結果: <strong>0</strong> 件
          </div>
          <? if (userRole !== 'viewer') { ?>
          <div class="bulk-action-area" id="bulkActionArea" style="display: none;">
            <span class="selected-count" id="selectedCount">0件選択中</span>
            <button type="button" class="btn btn-success btn-sm" onclick="bulkUpdateShipped()">
              <i class="bi bi-check2-all me-1"></i>一括出荷済み
            </button>
            <button type="button" class="btn btn-warning btn-sm" onclick="bulkCancelOrders()">
              <i class="bi bi-x-circle me-1"></i>一括キャンセル
            </button>
            <button type="button" class="btn btn-outline-success btn-sm" onclick="bulkSetHarvestWaiting()">
              <i class="bi bi-flower1 me-1"></i>収穫待ち
            </button>
            <button type="button" class="btn btn-outline-info btn-sm" onclick="bulkUncancelOrders()">
              <i class="bi bi-arrow-counterclockwise me-1"></i>キャンセル解除
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="bulkDeleteOrders()">
              <i class="bi bi-trash me-1"></i>一括削除
            </button>
          </div>
          <? } ?>
        </div>

        <div id="tableContainer">
          <!-- PC用テーブル -->
          <div class="pc-table">
            <table class="order-table">
              <thead>
                <tr>
                  <? if (userRole !== 'viewer') { ?>
                  <th class="col-select">
                    <input type="checkbox" class="form-check-input select-checkbox" id="selectAllCheckbox"
                      onchange="toggleSelectAll(this.checked)" title="全選択">
                  </th>
                  <? } ?>
                  <th class="col-date">発送日</th>
                  <th class="col-date">納品日</th>
                  <th class="col-name">発送先名</th>
                  <th class="col-product">商品名</th>
                  <th class="col-quantity">個数</th>
                  <th class="col-shipped">出荷済</th>
                  <th class="col-action">操作</th>
                  <th class="col-date">受注日</th>
                  <th class="col-memo">メモ</th>
                </tr>
              </thead>
              <tbody id="orderTableBody">
                <!-- 動的に生成 -->
              </tbody>
            </table>
          </div>

          <!-- スマホ用カード -->
          <div class="order-cards" id="orderCardsContainer">
            <!-- 動的に生成 -->
          </div>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
          <i class="bi bi-inbox"></i>
          <p>該当するデータがありません</p>
        </div>
      </div>

      <!-- ページング -->
      <div class="pagination-section" id="paginationSection" style="display: none;">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="prevBtn" onclick="goToPage('prev')">
          <i class="bi bi-chevron-left"></i> 前へ
        </button>
        <span id="pageInfo">1 / 1</span>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="nextBtn" onclick="goToPage('next')">
          次へ <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- 発送先検索モーダル -->
  <div class="modal fade search-modal" id="destinationSearchModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-geo-alt me-2"></i>発送先検索</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="search-header">
            <input type="text" class="form-control" id="destinationSearchInput" placeholder="会社名、住所、電話番号で検索...">
          </div>
          <div class="search-results" id="destinationSearchResults">
            <div class="no-results">キーワードを入力して検索してください</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearDestination()">クリア</button>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 顧客検索モーダル -->
  <div class="modal fade search-modal" id="customerSearchModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person me-2"></i>顧客検索</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="search-header">
            <input type="text" class="form-control" id="customerSearchInput" placeholder="会社名、担当者名、電話番号で検索...">
          </div>
          <div class="search-results" id="customerSearchResults">
            <div class="no-results">キーワードを入力して検索してください</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearCustomer()">クリア</button>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 詳細モーダル -->
  <div class="modal fade detail-modal" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-text me-2"></i>受注詳細</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="orderDetailBody">
          <!-- 動的に生成 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">閉じる</button>

          <!-- 伝票スキャン: viewerも含めて全員利用可能 -->
          <button type="button" class="btn btn-info text-white" id="detailScanBtn" onclick="openScanner()" disabled>
            <i class="bi bi-upc-scan me-1"></i>伝票スキャン
          </button>

          <? if (userRole !== 'viewer') { ?>
          <button type="button" class="btn btn-success" id="detailInheritBtn" onclick="inheritFromDetail()" disabled>
            <i class="bi bi-copy me-1"></i>コピー
          </button>
          <button type="button" class="btn btn-primary" id="detailEditBtn" onclick="editFromDetail()" disabled>
            <i class="bi bi-pencil me-1"></i>修正
          </button>
          <? } ?>
        </div>
      </div>
    </div>
  </div>
  <!-- 配送伝票スキャナーモーダル -->
  <div class="modal fade" id="scannerModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content bg-black text-white">
        <div class="info py-2 bg-primary text-center fw-bold">
          <span id="scannerTargetName">伝票スキャン</span>
        </div>
        <div class="modal-body p-0 position-relative overflow-hidden" style="flex: 1;">
          <div id="scannerView" class="w-100 h-100"></div>
          <div class="scanner-overlay">
            <div class="scanner-region"></div>
          </div>
          <!-- 手入力エリア -->
          <div id="modalManualInputArea" class="manual-input-area p-4">
            <h3 class="text-center mb-4">送り状番号を入力</h3>
            <div class="input-group input-group-lg mb-4">
              <input type="tel" id="modalManualNo" class="form-control text-center" placeholder="123456789012"
                maxlength="12">
            </div>
            <div class="d-grid gap-3">
              <button onclick="submitModalManual()" class="btn btn-primary py-3">決定</button>
              <button onclick="toggleModalManual(false)" class="btn btn-outline-light">スキャンに戻る</button>
            </div>
          </div>
        </div>
        <div class="modal-footer flex-column bg-black border-0 p-3">
          <div id="scannerStatus" class="mb-3">バーコードを枠内に収めてください</div>
          <div class="d-flex gap-2 w-100 mb-2">
            <button onclick="captureAndOcrModal()" class="btn btn-warning flex-grow-1 py-3 text-dark">
              <i class="bi bi-camera"></i> 写真で読み取る
            </button>
          </div>
          <div class="d-flex gap-2 w-100">
            <button onclick="toggleModalManual(true)" class="btn btn-primary flex-grow-1 py-3">
              <i class="bi bi-keyboard"></i> 手入力
            </button>
            <button type="button" class="btn btn-outline-light py-3 px-4" data-bs-dismiss="modal">キャンセル</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 成功・エラー時のオーバーレイ（スキャナー用） -->
  <div id="scannerSuccessOverlay" class="scanner-result-overlay">
    <h2 class="mb-3">スキャン成功！</h2>
    <div id="modalScannedNo" class="h1 mb-4"></div>
    <div class="spinner-border text-light mb-3" role="status"></div>
    <div>システム更新中...</div>
  </div>
  <div id="scannerErrorOverlay" class="scanner-error-overlay">
    <h2 class="mb-3">エラー</h2>
    <div id="scannerErrorMsg" class="mb-4"></div>
    <button onclick="retryScanner()" class="btn btn-light px-5">再試行</button>
  </div>

  <audio id="scannerBeepSound" preload="auto">
    <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
  </audio>

  <!-- 操作用の隠しフォーム -->
  <form id="actionForm" method="POST" action="<?= deployURL ?>" style="display: none;">
    <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
    <input type="hidden" name="shipping" value="true">
    <input type="hidden" name="editOrderId" id="actionOrderIdInput" value="">
    <input type="hidden" name="editMode" id="actionEditModeInput" value="">
    <input type="hidden" name="actionMode" id="actionModeInput" value="">
    <!-- 検索条件引継用 -->
    <input type="hidden" name="prevPeriod" id="prevPeriodInput" value="">
    <input type="hidden" name="prevDateFrom" id="prevDateFromInput" value="">
    <input type="hidden" name="prevDateTo" id="prevDateToInput" value="">
    <input type="hidden" name="prevDestination" id="prevDestinationInput" value="">
    <input type="hidden" name="prevCustomer" id="prevCustomerInput" value="">
    <input type="hidden" name="prevStatus" id="prevStatusInput" value="">
    <input type="hidden" name="prevIncludeOverdue" id="prevIncludeOverdueInput" value="">
  </form>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

  <script>
    // グローバル変数
    const userRole = '<?= userRole || "viewer" ?>';  // ユーザー権限（表示用・最小権限でフォールバック）
    let selectedDestination = null;
    let selectedCustomer = null;
    let orderData = [];
    let currentPage = 1;
    const pageSize = 50;
    let currentDetailOrderId = null;
    let currentDetailCustomerName = '';
    let currentDetailDeliveryMethod = ''; // 納品方法を保存

    // 初期化
    document.addEventListener('DOMContentLoaded', function () {
      initializeDateInputs();
      setupEventListeners();
      applyInheritedFilters(); // 引継条件の適用
      executeSearch();
    });

    // 引継されたフィルター条件を適用
    function applyInheritedFilters() {
      const prevPeriod = '<?= typeof prevPeriod !== "undefined" ? prevPeriod : "" ?>';
      const prevDateFrom = '<?= typeof prevDateFrom !== "undefined" ? prevDateFrom : "" ?>';
      const prevDateTo = '<?= typeof prevDateTo !== "undefined" ? prevDateTo : "" ?>';
      const prevDestination = '<?= typeof prevDestination !== "undefined" ? prevDestination : "" ?>';
      const prevCustomer = '<?= typeof prevCustomer !== "undefined" ? prevCustomer : "" ?>';
      const prevStatus = '<?= typeof prevStatus !== "undefined" ? prevStatus : "" ?>';
      const prevIncludeOverdue = '<?= typeof prevIncludeOverdue !== "undefined" ? prevIncludeOverdue : "" ?>';

      if (prevPeriod) {
        const radio = document.querySelector(`input[name="period"][value="${prevPeriod}"]`);
        if (radio) {
          radio.checked = true;
          // 期間指定の場合は日付入力行を表示
          const customRow = document.getElementById('customDateRangeRow');
          if (customRow) customRow.style.display = prevPeriod === 'custom' ? 'block' : 'none';
        }
      }

      if (prevDateFrom) document.getElementById('dateFrom').value = prevDateFrom;
      if (prevDateTo) document.getElementById('dateTo').value = prevDateTo;

      if (prevDestination && prevDestination !== '指定なし' && prevDestination !== '') {
        selectedDestination = prevDestination;
        document.getElementById('destinationBtn').innerHTML = `<i class="bi bi-search me-1"></i>${prevDestination}`;
        document.getElementById('destinationBtn').classList.replace('btn-outline-secondary', 'btn-secondary');
      }

      if (prevCustomer && prevCustomer !== '指定なし' && prevCustomer !== '') {
        selectedCustomer = prevCustomer;
        document.getElementById('customerBtn').innerHTML = `<i class="bi bi-search me-1"></i>${prevCustomer}`;
        document.getElementById('customerBtn').classList.replace('btn-outline-secondary', 'btn-secondary');
      }

      if (prevStatus) {
        const radio = document.querySelector(`input[name="shippingStatus"][value="${prevStatus}"]`);
        if (radio) radio.checked = true;
      }

      // 予定日超過を含む：引き継ぎがある場合はその値、ない場合はデフォルトでON
      if (prevIncludeOverdue !== '') {
        document.getElementById('includeOverdue').checked = prevIncludeOverdue === 'true';
      } else {
        // 初回表示時はデフォルトでチェックON
        document.getElementById('includeOverdue').checked = true;
      }
    }

    // 日付入力の初期化
    function initializeDateInputs() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

      document.getElementById('dateFrom').value = formatDate(firstDay);
      document.getElementById('dateTo').value = formatDate(lastDay);
    }

    function formatDate(date) {
      // ローカル時間で日付文字列を生成（UTC時差の影響を避ける）
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDisplayDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return '-';
      return (d.getMonth() + 1) + '/' + d.getDate();
    }

    function formatFullDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return '-';
      return d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate();
    }

    // 過去の日付かどうか判定
    function isPastDate(dateString) {
      if (!dateString) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const targetDate = new Date(dateString);
      targetDate.setHours(0, 0, 0, 0);
      return targetDate < today;
    }

    // 出荷済ステータスを更新
    function updateShippedStatus(orderId, isChecked) {
      const shippedValue = isChecked ? '○' : '';

      showLoading('更新中...');
      google.script.run
        .withSuccessHandler(function () {
          hideLoading();
          // データを再描画
          const orderIndex = orderData.findIndex(o => o.orderId === orderId);
          if (orderIndex >= 0) {
            orderData[orderIndex].shipped = shippedValue;
            renderTable();
          }
        })
        .withFailureHandler(function (error) {
          hideLoading();
          alert('更新エラー: ' + error.message);
          // チェックボックスを元に戻す
          executeSearch();
        })
        .updateOrderShippedStatus(orderId, shippedValue);
    }

    // イベントリスナー設定
    function setupEventListeners() {
      // 期間ラジオボタン
      document.querySelectorAll('input[name="period"]').forEach(radio => {
        radio.addEventListener('change', function () {
          const customRow = document.getElementById('customDateRangeRow');
          customRow.style.display = this.value === 'custom' ? 'block' : 'none';
        });
      });

      // 発送先検索
      const destInput = document.getElementById('destinationSearchInput');
      let destTimeout;
      destInput.addEventListener('input', function () {
        clearTimeout(destTimeout);
        destTimeout = setTimeout(() => searchDestinations(this.value), 300);
      });

      // 顧客検索
      const custInput = document.getElementById('customerSearchInput');
      let custTimeout;
      custInput.addEventListener('input', function () {
        clearTimeout(custTimeout);
        custTimeout = setTimeout(() => searchCustomers(this.value), 300);
      });

      // モーダルが開いたときにフォーカス
      document.getElementById('destinationSearchModal').addEventListener('shown.bs.modal', function () {
        document.getElementById('destinationSearchInput').focus();
      });
      document.getElementById('customerSearchModal').addEventListener('shown.bs.modal', function () {
        document.getElementById('customerSearchInput').focus();
      });
    }

    // 発送先検索
    function searchDestinations(keyword) {
      const container = document.getElementById('destinationSearchResults');
      if (!keyword || keyword.length < 2) {
        container.innerHTML = '<div class="no-results">2文字以上入力してください</div>';
        return;
      }

      container.innerHTML = '<div class="no-results">検索中...</div>';

      google.script.run
        .withSuccessHandler(function (results) {
          if (!results || results.length === 0) {
            container.innerHTML = '<div class="no-results">該当する発送先がありません</div>';
            return;
          }
          container.innerHTML = results.map(r => `
          <div class="search-result-item" onclick="selectDestination('${escapeHtml(r.name)}')">
            <div class="result-main">${escapeHtml(r.name)}</div>
            <div class="result-sub">${escapeHtml(r.address || '')} ${escapeHtml(r.tel || '')}</div>
          </div>
        `).join('');
        })
        .withFailureHandler(function (error) {
          container.innerHTML = '<div class="no-results">検索エラー</div>';
        })
        .searchShippingTo(keyword);
    }

    // 顧客検索
    function searchCustomers(keyword) {
      const container = document.getElementById('customerSearchResults');
      if (!keyword || keyword.length < 2) {
        container.innerHTML = '<div class="no-results">2文字以上入力してください</div>';
        return;
      }

      container.innerHTML = '<div class="no-results">検索中...</div>';

      google.script.run
        .withSuccessHandler(function (results) {
          if (!results || results.length === 0) {
            container.innerHTML = '<div class="no-results">該当する顧客がありません</div>';
            return;
          }
          container.innerHTML = results.map(r => `
          <div class="search-result-item" onclick="selectCustomer('${escapeHtml(r.name)}')">
            <div class="result-main">${escapeHtml(r.name)}</div>
            <div class="result-sub">${escapeHtml(r.address || '')} ${escapeHtml(r.tel || '')}</div>
          </div>
        `).join('');
        })
        .withFailureHandler(function (error) {
          container.innerHTML = '<div class="no-results">検索エラー</div>';
        })
        .searchCustomer(keyword);
    }

    function selectDestination(name) {
      selectedDestination = name;
      document.getElementById('destinationBtn').innerHTML = '<i class="bi bi-geo-alt me-1"></i>' + name;
      document.getElementById('destinationBtn').classList.remove('btn-outline-secondary');
      document.getElementById('destinationBtn').classList.add('btn-primary');
      bootstrap.Modal.getInstance(document.getElementById('destinationSearchModal')).hide();
    }

    function selectCustomer(name) {
      selectedCustomer = name;
      document.getElementById('customerBtn').innerHTML = '<i class="bi bi-person me-1"></i>' + name;
      document.getElementById('customerBtn').classList.remove('btn-outline-secondary');
      document.getElementById('customerBtn').classList.add('btn-primary');
      bootstrap.Modal.getInstance(document.getElementById('customerSearchModal')).hide();
    }

    function clearDestination() {
      selectedDestination = null;
      document.getElementById('destinationBtn').innerHTML = '<i class="bi bi-search me-1"></i>指定なし';
      document.getElementById('destinationBtn').classList.remove('btn-primary');
      document.getElementById('destinationBtn').classList.add('btn-outline-secondary');
      document.getElementById('destinationSearchInput').value = '';
      document.getElementById('destinationSearchResults').innerHTML = '<div class="no-results">キーワードを入力して検索してください</div>';
    }

    function clearCustomer() {
      selectedCustomer = null;
      document.getElementById('customerBtn').innerHTML = '<i class="bi bi-search me-1"></i>指定なし';
      document.getElementById('customerBtn').classList.remove('btn-primary');
      document.getElementById('customerBtn').classList.add('btn-outline-secondary');
      document.getElementById('customerSearchInput').value = '';
      document.getElementById('customerSearchResults').innerHTML = '<div class="no-results">キーワードを入力して検索してください</div>';
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // <br>タグを許可するエスケープ関数
    function escapeHtmlWithBr(str) {
      if (!str) return '';
      return escapeHtml(str).replace(/&lt;br&gt;/g, '<br>');
    }

    // 日付範囲取得（修正版：今日起点）
    function getDateRange() {
      const period = document.querySelector('input[name="period"]:checked').value;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let dateFrom, dateTo;

      switch (period) {
        case 'yesterday':
          // 前日：前日のみ
          const yesterday = new Date(today);
          yesterday.setDate(today.getDate() - 1);
          dateFrom = formatDate(yesterday);
          dateTo = formatDate(yesterday);
          break;

        case 'today':
          // 今日：今日のみ
          dateFrom = formatDate(today);
          dateTo = formatDate(today);
          break;

        case 'tomorrow':
          // 明日：明日のみ
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);
          dateFrom = formatDate(tomorrow);
          dateTo = formatDate(tomorrow);
          break;

        case 'thisWeek':
          // 今週：今日から7日間（今日〜6日後）
          dateFrom = formatDate(today);
          const thisWeekEnd = new Date(today);
          thisWeekEnd.setDate(today.getDate() + 6);
          dateTo = formatDate(thisWeekEnd);
          break;

        case 'nextWeek':
          // 来週：7日後から7日間（7日後〜13日後）
          const nextWeekStart = new Date(today);
          nextWeekStart.setDate(today.getDate() + 7);
          dateFrom = formatDate(nextWeekStart);
          const nextWeekEnd = new Date(nextWeekStart);
          nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
          dateTo = formatDate(nextWeekEnd);
          break;

        case 'lastMonth':
          // 先月：先月1日〜先月末
          dateFrom = formatDate(new Date(today.getFullYear(), today.getMonth() - 1, 1));
          dateTo = formatDate(new Date(today.getFullYear(), today.getMonth(), 0));
          break;

        case 'thisMonth':
          // 今月：月初〜月末
          dateFrom = formatDate(new Date(today.getFullYear(), today.getMonth(), 1));
          dateTo = formatDate(new Date(today.getFullYear(), today.getMonth() + 1, 0));
          break;

        case 'nextMonth':
          // 来月：来月1日〜来月末
          dateFrom = formatDate(new Date(today.getFullYear(), today.getMonth() + 1, 1));
          dateTo = formatDate(new Date(today.getFullYear(), today.getMonth() + 2, 0));
          break;

        case 'custom':
          // 期間指定
          dateFrom = document.getElementById('dateFrom').value;
          dateTo = document.getElementById('dateTo').value;
          break;

        case 'none':
          // 指定なし：全期間
          if (!confirm('全期間のデータを取得します。処理に時間がかかる可能性がありますが、よろしいですか？')) {
            // キャンセルされた場合は今週に戻す
            document.getElementById('periodThisWeek').checked = true;
            return getDateRange(); // 再帰呼び出しで今週の日付を返す
          }
          dateFrom = '';
          dateTo = '';
          break;
      }

      return { dateFrom, dateTo };
    }

    // 検索実行
    function executeSearch() {
      const { dateFrom, dateTo } = getDateRange();

      // 出荷状態フィルター取得
      const shippingStatusElement = document.querySelector('input[name="shippingStatus"]:checked');
      const shippingStatus = shippingStatusElement ? shippingStatusElement.value : 'all';

      // 予定日超過を含むチェックボックスの状態取得
      const includeOverdue = document.getElementById('includeOverdue').checked;

      const params = {
        dateFrom: dateFrom,
        dateTo: dateTo,
        destination: selectedDestination || '',
        customer: selectedCustomer || '',
        shippingStatus: shippingStatus,
        includeOverdue: includeOverdue  // チェックボックスの状態を追加
      };

      showLoading('検索中...');
      document.getElementById('emptyState').style.display = 'none';

      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          const data = JSON.parse(result);
          orderData = data.orders || [];
          currentPage = 1;
          renderTable();
        })
        .withFailureHandler(function (error) {
          hideLoading();
          alert('データ取得エラー: ' + error.message);
        })
        .getOrderListData(params);
    }

    // ステータスに応じたバッジHTML生成
    // trackingCode.js の normalizeTrackingStatus が返す値:
    // - 配達完了, 発送済, 配達中, 不在/持戻
    function getStatusBadge(status) {
      if (!status) return '';

      let badgeClass = 'bg-secondary';
      if (status === '配達完了') {
        badgeClass = 'bg-success';
      } else if (status === '発送済' || status === '配達中') {
        badgeClass = 'bg-primary';
      } else if (status === '不在/持戻') {
        badgeClass = 'bg-warning text-dark';
      } else if (status.includes('エラー')) {
        badgeClass = 'bg-danger';
      }

      return `<span class="badge ${badgeClass} ms-1" style="font-size: 0.75rem;">${escapeHtml(status)}</span>`;
    }

    // テーブル描画
    function renderTable() {
      const tbody = document.getElementById('orderTableBody');
      const cardsContainer = document.getElementById('orderCardsContainer');
      const totalCount = orderData.length;

      document.getElementById('resultCount').innerHTML = '検索結果: <strong>' + totalCount + '</strong> 件';

      if (totalCount === 0) {
        tbody.innerHTML = '';
        cardsContainer.innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('paginationSection').style.display = 'none';
        return;
      }

      document.getElementById('emptyState').style.display = 'none';

      // ページング計算
      const totalPages = Math.ceil(totalCount / pageSize);
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, totalCount);
      const pageData = orderData.slice(startIndex, endIndex);

      // PC用テーブル描画（商品ごとに行を生成）
      let tableRows = '';
      pageData.forEach(order => {
        const itemCount = order.items ? order.items.length : 0;
        if (itemCount === 0) return;  // 商品がない場合はスキップ

        // 出荷済フラグ
        const isShipped = order.shipped === '○' || order.shipped === true;

        // キャンセル済みフラグ
        const isCancelled = order.status === 'キャンセル' || order.status === 'cancelled';

        // 予定日超過判定（発送日が過去かつ未出荷かつキャンセル済みでない）
        const isOverdue = !isShipped && !isCancelled && isPastDate(order.shippingDate);

        // 行のクラス
        let rowClass = '';
        if (isCancelled) rowClass = 'cancelled-row';
        else if (isShipped) rowClass = 'shipped-row';
        else if (isOverdue) rowClass = 'overdue-row';

        // 商品ごとに行を生成
        order.items.forEach((item, index) => {
          const isFirstRow = index === 0;
          tableRows += `<tr class="${rowClass}" onclick="showOrderDetail('${escapeHtml(order.orderId)}')" data-order-id="${escapeHtml(order.orderId)}">`;

          // 最初の行のみ選択チェックボックスと共通情報を表示（rowspanで結合）
          if (isFirstRow) {
            // viewerでなければ選択チェックボックスを表示
            if (userRole !== 'viewer') {
              tableRows += `
              <td class="col-select" rowspan="${itemCount}" onclick="event.stopPropagation();">
                <input type="checkbox" class="form-check-input select-checkbox order-select-checkbox"
                       data-order-id="${escapeHtml(order.orderId)}"
                       onchange="updateSelectedCount()" title="選択">
              </td>
            `;
            }
            tableRows += `
            <td class="col-date" rowspan="${itemCount}">${formatDisplayDate(order.shippingDate)}</td>
            <td class="col-date" rowspan="${itemCount}">${formatDisplayDate(order.deliveryDate)}</td>
            <td class="col-name" rowspan="${itemCount}">
              <div class="cell-text" data-tooltip="${escapeHtml(order.destinationName)}">${escapeHtml(order.destinationName)}</div>
            </td>
          `;
          }

          // 各行に商品情報を表示
          tableRows += `
          <td class="col-product">
            <div class="cell-text" data-tooltip="${escapeHtml(item.product)}">${escapeHtml(item.product)}</div>
          </td>
          <td class="col-quantity">${item.quantity}点</td>
        `;

          // 最初の行のみ出荷済チェックボックスを表示
          if (isFirstRow) {
            tableRows += `
            <td class="col-shipped" rowspan="${itemCount}" onclick="event.stopPropagation();">
              <div class="d-flex align-items-center justify-content-center">
                <input type="checkbox" class="form-check-input shipped-checkbox"
                       ${isShipped ? 'checked' : ''}
                       ${isCancelled ? 'disabled' : ''}
                       onchange="updateShippedStatus('${escapeHtml(order.orderId)}', this.checked)"
                       title="出荷済にチェック">
                ${getStatusBadge(order.status)}
              </div>
            </td>
          `;

            // アクションボタン列
            tableRows += `
              <td class="col-action" rowspan="${itemCount}" onclick="event.stopPropagation();">
                <button type="button" class="btn btn-sm btn-outline-info scan-btn" onclick="openScannerDialog('${escapeHtml(order.orderId)}', '${escapeHtml(order.destinationName || order.customerName)}', '${escapeHtml(order.deliveryMethod || '')}')" title="バーコード読み取り">
                  <i class="bi bi-camera"></i>
                </button>
            `;

            // viewerの場合は編集・コピーボタンを表示しない
            if (userRole !== 'viewer') {
              tableRows += `
                <button type="button" class="btn btn-sm btn-outline-primary edit-btn" onclick="editOrder('${escapeHtml(order.orderId)}')" title="修正" ${isCancelled ? 'disabled' : ''}>
                  <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-success inherit-btn" onclick="inheritOrder('${escapeHtml(order.orderId)}')" title="コピー">
                  <i class="bi bi-copy"></i>コピー
                </button>
              `;
            }

            tableRows += `
              </td>
            `;
            tableRows += `
            <td class="col-date" rowspan="${itemCount}">${formatDisplayDate(order.orderDate)}</td>
          `;
            tableRows += `
            <td class="col-memo" rowspan="${itemCount}">${escapeHtml(order.memo || '')}</td>
          `;
          }

          tableRows += '</tr>';
        });
      });
      tbody.innerHTML = tableRows;

      // スマホ用カード描画（カードクリックで詳細表示）
      let cardsHtml = '';
      pageData.forEach(order => {
        const itemCount = order.items ? order.items.length : 0;
        if (itemCount === 0) return;  // 商品がない場合はスキップ

        // 出荷済フラグ
        const isShipped = order.shipped === '○' || order.shipped === true;

        // キャンセル済みフラグ
        const isCancelled = order.status === 'キャンセル' || order.status === 'cancelled';

        // 予定日超過判定（発送日が過去かつ未出荷かつキャンセル済みでない）
        const isOverdue = !isShipped && !isCancelled && isPastDate(order.shippingDate);

        // カードのクラス
        let cardClass = 'order-card';
        if (isCancelled) cardClass += ' cancelled-row';
        else if (isShipped) cardClass += ' shipped-row';
        else if (isOverdue) cardClass += ' overdue-row';

        // 商品リストを生成
        const itemsHtml = order.items.map(item =>
          `<div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
          <strong>${escapeHtml(item.product)}</strong> - ${item.quantity}点
        </div>`
        ).join('');

        cardsHtml += `
        <div class="${cardClass}" onclick="showOrderDetail('${escapeHtml(order.orderId)}')" data-order-id="${escapeHtml(order.orderId)}">
          ${userRole !== 'viewer' ? `
          <div class="order-card-row" onclick="event.stopPropagation();" style="padding-bottom: 8px; border-bottom: 1px dashed #e0e0e0; margin-bottom: 8px;">
            <input type="checkbox" class="form-check-input select-checkbox order-select-checkbox"
                   data-order-id="${escapeHtml(order.orderId)}"
                   onchange="updateSelectedCount()" title="選択" style="margin-right: 8px;">
            <span style="font-size: 0.75rem; color: #999;">選択</span>
          </div>
          ` : ''}
          <div class="order-card-header">
            <div class="order-card-dates">
              <span class="date-label">発送</span>
              <span class="date-value">${formatDisplayDate(order.shippingDate)}</span>
              <span class="date-separator">→</span>
              <span class="date-label">納品</span>
              <span class="date-value">${formatDisplayDate(order.deliveryDate)}</span>
            </div>
            <span class="order-card-quantity">${itemCount}点</span>
          </div>
          <div class="order-card-row">
            <span class="order-card-icon"><i class="bi bi-geo-alt"></i></span>
            <div class="order-card-value">
              <div class="order-card-label">発送先</div>
              ${escapeHtml(order.destinationName)}
            </div>
          </div>
          <div class="order-card-row">
            <span class="order-card-icon"><i class="bi bi-box-seam"></i></span>
            <div class="order-card-value">
              <div class="order-card-label">商品</div>
              ${itemsHtml}
            </div>
          </div>
          ${order.memo ? `
          <div class="order-card-row">
            <span class="order-card-icon"><i class="bi bi-chat-left-text"></i></span>
            <div class="order-card-value">
              <div class="order-card-label">メモ</div>
              ${escapeHtml(order.memo)}
            </div>
          </div>` : ''}
            <div class="order-card-row" onclick="event.stopPropagation();">
              <span class="order-card-icon"><i class="bi bi-check2-square"></i></span>
              <div class="order-card-value" style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="form-check-input shipped-checkbox"
                       ${isShipped ? 'checked' : ''}
                       ${isCancelled ? 'disabled' : ''}
                       onchange="updateShippedStatus('${escapeHtml(order.orderId)}', this.checked)"
                       title="出荷済にチェック">
                <span style="font-size: 0.875rem; color: #666;">出荷済</span>
                ${getStatusBadge(order.status)}
              </div>
            </div>
          <div class="order-card-buttons" onclick="event.stopPropagation();">
            <button type="button" class="btn btn-sm btn-outline-info" onclick="openScannerDialog('${escapeHtml(order.orderId)}', '${escapeHtml(order.destinationName || order.customerName)}', '${escapeHtml(order.deliveryMethod || '')}')">
              <i class="bi bi-camera me-1"></i>スキャン
            </button>
            ${userRole !== 'viewer' ? `
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editOrder('${escapeHtml(order.orderId)}')" ${isCancelled ? 'disabled' : ''}>
              <i class="bi bi-pencil me-1"></i>修正
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" onclick="inheritOrder('${escapeHtml(order.orderId)}')">
              <i class="bi bi-copy me-1"></i>コピー
            </button>
            ` : ''}
          </div>
        </div>
      `;
      });
      cardsContainer.innerHTML = cardsHtml;

      // ページング表示
      if (totalPages > 1) {
        document.getElementById('paginationSection').style.display = 'flex';
        document.getElementById('pageInfo').textContent = currentPage + ' / ' + totalPages;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
      } else {
        document.getElementById('paginationSection').style.display = 'none';
      }
    }

    // ページ遷移
    function goToPage(direction) {
      const totalPages = Math.ceil(orderData.length / pageSize);

      if (direction === 'prev' && currentPage > 1) {
        currentPage--;
      } else if (direction === 'next' && currentPage < totalPages) {
        currentPage++;
      }

      renderTable();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 詳細モーダル表示
    // 詳細モーダル表示
    function showOrderDetail(orderId) {
      currentDetailOrderId = orderId;
      const body = document.getElementById('orderDetailBody');
      body.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">読み込み中...</p></div>';

      // ボタンを非活性化（読み込み開始時）
      setDetailButtonsState(false);

      const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
      modal.show();

      // GASから詳細データを取得
      google.script.run
        .withSuccessHandler(function (result) {
          if (!result) {
            body.innerHTML = '<div class="text-center py-4 text-danger">データが見つかりませんでした</div>';
            return;
          }
          currentDetailOrderId = result.orderId;
          currentDetailCustomerName = result.customerName; // 変数にセット

          renderOrderDetail(result);
          // 読み込み完了後にボタンを活性化
          setDetailButtonsState(true);
        })
        .withFailureHandler(function (error) {
          body.innerHTML = '<div class="text-center py-4 text-danger">エラー: ' + error.message + '</div>';
        })
        .getOrderByOrderId(orderId);
    }

    // 詳細モーダルの内容を描画
    function renderOrderDetail(data) {
      currentDetailCustomerName = data.customerName || '';
      currentDetailDeliveryMethod = data.deliveryMethod || ''; // 納品方法を保存
      const body = document.getElementById('orderDetailBody');

      // チェックリストのバッジ生成
      const checklistItems = ['納品書', '請求書', '領収書', 'パンフ', 'レシピ'];
      const checklistHtml = checklistItems.map(item => {
        const isActive = data.checklist && data.checklist[
          item === '納品書' ? 'deliverySlip' :
            item === '請求書' ? 'bill' :
              item === '領収書' ? 'receipt' :
                item === 'パンフ' ? 'pamphlet' : 'recipe'
        ];
        return `<span class="checklist-badge ${isActive ? 'active' : 'inactive'}">${item}</span>`;
      }).join('');

      // 商品テーブル生成
      let productsHtml = '';
      let totalAmount = 0;
      if (data.items && data.items.length > 0) {
        productsHtml = `
        <table class="product-detail-table">
          <thead>
            <tr>
              <th>分類</th>
              <th>商品名</th>
              <th class="text-end">単価</th>
              <th class="text-end">数量</th>
              <th class="text-end">金額</th>
            </tr>
          </thead>
          <tbody>
            ${data.items.map(item => {
          const subtotal = (item.price || 0) * (item.quantity || 0);
          totalAmount += subtotal;
          return `
                <tr>
                  <td>${escapeHtml(item.bunrui)}</td>
                  <td>${escapeHtml(item.product)}</td>
                  <td class="text-end">¥${(item.price || 0).toLocaleString()}</td>
                  <td class="text-end">${item.quantity || 0}</td>
                  <td class="text-end">¥${subtotal.toLocaleString()}</td>
                </tr>
              `;
        }).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-end">合計</td>
              <td class="text-end">¥${totalAmount.toLocaleString()}</td>
            </tr>
          </tfoot>
        </table>
      `;
      } else {
        productsHtml = '<p class="text-muted">商品情報がありません</p>';
      }

      body.innerHTML = `
      <!-- 基本情報 -->
      <div class="detail-section">
        <div class="detail-section-header">
          <i class="bi bi-info-circle"></i>基本情報
        </div>
        <div class="detail-section-body">
          <div class="detail-row">
            <span class="detail-label">受注ID</span>
            <span class="detail-value">${escapeHtml(data.orderId)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">受注日</span>
            <span class="detail-value">${formatFullDate(data.orderDate)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">発送日</span>
            <span class="detail-value">${formatFullDate(data.shippingDate)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">納品日</span>
            <span class="detail-value">${formatFullDate(data.deliveryDate)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">受付方法</span>
            <span class="detail-value">${escapeHtml(data.receiptWay) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">受付者</span>
            <span class="detail-value">${escapeHtml(data.recipient) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">納品方法</span>
            <span class="detail-value">${escapeHtml(data.deliveryMethod) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">配達時間帯</span>
            <span class="detail-value">${escapeHtml(data.deliveryTime ? data.deliveryTime.split(':')[1] : '') || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">追跡番号</span>
            <span class="detail-value" id="detailTrackingNo">${escapeHtml(data.trackingNumber) || '<span class="empty">-</span>'}</span>
          </div>
        </div>
      </div>
      
      <!-- 発送先情報 -->
      <div class="detail-section">
        <div class="detail-section-header">
          <i class="bi bi-geo-alt"></i>発送先情報
        </div>
        <div class="detail-section-body">
          <div class="detail-row">
            <span class="detail-label">発送先名</span>
            <span class="detail-value">${escapeHtml(data.shippingToName) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">郵便番号</span>
            <span class="detail-value">${escapeHtml(data.shippingToZipcode) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">住所</span>
            <span class="detail-value">${escapeHtml(data.shippingToAddress) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">電話番号</span>
            <span class="detail-value">${escapeHtml(data.shippingToTel) || '<span class="empty">-</span>'}</span>
          </div>
        </div>
      </div>
      
      <!-- 顧客情報 -->
      <div class="detail-section">
        <div class="detail-section-header">
          <i class="bi bi-person"></i>顧客情報
        </div>
        <div class="detail-section-body">
          <div class="detail-row">
            <span class="detail-label">顧客名</span>
            <span class="detail-value">${escapeHtml(data.customerName) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">郵便番号</span>
            <span class="detail-value">${escapeHtml(data.customerZipcode) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">住所</span>
            <span class="detail-value">${escapeHtml(data.customerAddress) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">電話番号</span>
            <span class="detail-value">${escapeHtml(data.customerTel) || '<span class="empty">-</span>'}</span>
          </div>
        </div>
      </div>
      
      <!-- 発送元情報 -->
      <div class="detail-section">
        <div class="detail-section-header">
          <i class="bi bi-building"></i>発送元情報
        </div>
        <div class="detail-section-body">
          <div class="detail-row">
            <span class="detail-label">発送元名</span>
            <span class="detail-value">${escapeHtml(data.shippingFromName) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">郵便番号</span>
            <span class="detail-value">${escapeHtml(data.shippingFromZipcode) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">住所</span>
            <span class="detail-value">${escapeHtml(data.shippingFromAddress) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">電話番号</span>
            <span class="detail-value">${escapeHtml(data.shippingFromTel) || '<span class="empty">-</span>'}</span>
          </div>
        </div>
      </div>
      
      <!-- 商品情報 -->
      <div class="detail-section">
        <div class="detail-section-header">
          <i class="bi bi-box-seam"></i>商品情報
        </div>
        <div class="detail-section-body">
          ${productsHtml}
        </div>
      </div>
      
      <!-- 発送情報 -->
      <div class="detail-section">
        <div class="detail-section-header">
          <i class="bi bi-truck"></i>発送情報
        </div>
        <div class="detail-section-body">
          <div class="detail-row">
            <span class="detail-label">品名</span>
            <span class="detail-value">${escapeHtml(data.sendProduct) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">送り状種別</span>
            <span class="detail-value">${escapeHtml(data.invoiceType ? data.invoiceType.split(':')[1] : '') || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">クール区分</span>
            <span class="detail-value">${escapeHtml(data.coolCls ? data.coolCls.split(':')[1] : '') || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">荷扱い１</span>
            <span class="detail-value">${escapeHtml(data.cargo1 ? data.cargo1.split(':')[1] : '') || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">荷扱い２</span>
            <span class="detail-value">${escapeHtml(data.cargo2 ? data.cargo2.split(':')[1] : '') || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">代引総額</span>
            <span class="detail-value">${data.cashOnDelivery ? '¥' + Number(data.cashOnDelivery).toLocaleString() : '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">代引内税</span>
            <span class="detail-value">${data.cashOnDeliTax ? '¥' + Number(data.cashOnDeliTax).toLocaleString() : '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">発行枚数</span>
            <span class="detail-value">${escapeHtml(data.copiePrint) || '<span class="empty">-</span>'}</span>
          </div>
        </div>
      </div>
      
      <!-- チェックリスト・添付 -->
      <div class="detail-section">
        <div class="detail-section-header">
          <i class="bi bi-check2-square"></i>チェックリスト・添付
        </div>
        <div class="detail-section-body">
          <div class="detail-row">
            <span class="detail-label">チェック項目</span>
            <div class="detail-value">
              <div class="checklist-badges">${checklistHtml}</div>
            </div>
          </div>
          <div class="detail-row">
            <span class="detail-label">その他添付</span>
            <span class="detail-value">${escapeHtml(data.otherAttach) || '<span class="empty">-</span>'}</span>
          </div>
        </div>
      </div>
      
      <!-- 備考 -->
      <div class="detail-section">
        <div class="detail-section-header">
          <i class="bi bi-chat-left-text"></i>備考
        </div>
        <div class="detail-section-body">
          <div class="detail-row">
            <span class="detail-label">送り状備考欄</span>
            <span class="detail-value">${escapeHtml(data.csvmemo) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">納品書備考欄</span>
            <span class="detail-value">${escapeHtml(data.deliveryMemo) || '<span class="empty">-</span>'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">メモ</span>
            <span class="detail-value">${escapeHtml(data.memo) || '<span class="empty">-</span>'}</span>
          </div>
        </div>
      </div>
    `;
    }

    // 詳細モーダルから修正
    function editFromDetail() {
      if (currentDetailOrderId) {
        bootstrap.Modal.getInstance(document.getElementById('orderDetailModal')).hide();
        editOrder(currentDetailOrderId);
      }
    }

    // 詳細モーダルから引継
    function inheritFromDetail() {
      if (currentDetailOrderId) {
        bootstrap.Modal.getInstance(document.getElementById('orderDetailModal')).hide();
        inheritOrder(currentDetailOrderId);
      }
    }

    // スキャン画面を開く
    function openScanner() {
      if (!currentDetailOrderId) return;
      openScannerDialog(currentDetailOrderId, currentDetailCustomerName, currentDetailDeliveryMethod);
    }

    function openScannerDialog(orderId, customerName, deliveryMethod) {
      currentDetailOrderId = orderId;
      currentDetailCustomerName = customerName;
      currentDetailDeliveryMethod = deliveryMethod || '';
      document.getElementById('scannerTargetName').innerText = customerName + " 様の伝票";
      const modal = new bootstrap.Modal(document.getElementById('scannerModal'));
      modal.show();
    }

    // モーダルが開いた時にスキャナー起動、閉じるときに停止
    // スキャナーモーダルを開くたびに手入力欄をクリア
    document.getElementById('scannerModal').addEventListener('show.bs.modal', function () {
      document.getElementById('modalManualNo').value = '';
    });
    document.getElementById('scannerModal').addEventListener('shown.bs.modal', initQuagga);
    document.getElementById('scannerModal').addEventListener('hidden.bs.modal', () => {
      Quagga.stop();
      toggleModalManual(false);
      document.getElementById('scannerSuccessOverlay').style.display = 'none';
      document.getElementById('scannerErrorOverlay').style.display = 'none';
    });

    let isScannerProcessing = false;
    function initQuagga() {
      isScannerProcessing = false;
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#scannerView'),
          constraints: { facingMode: "environment" },
        },
        decoder: {
          readers: ["code_128_reader", "codabar_reader", "code_39_reader"]
        },
        locate: true
      }, function (err) {
        if (err) {
          showScannerError("カメラの起動に失敗しました。");
          return;
        }
        Quagga.start();
      });
      Quagga.onDetected(onQuaggaDetected);
    }

    function onQuaggaDetected(data) {
      if (isScannerProcessing) return;
      const code = data.codeResult.code;

      // 納品方法に応じた桁数チェック
      const deliveryMethod = currentDetailDeliveryMethod || '';
      let expectedLength = 0;
      let carrierName = '';

      if (deliveryMethod.includes('ヤマト')) {
        expectedLength = 12;
        carrierName = 'ヤマト';
      } else if (deliveryMethod.includes('佐川')) {
        expectedLength = 12;
        carrierName = '佐川';
      } else if (deliveryMethod.includes('西濃')) {
        expectedLength = 10;
        carrierName = '西濃運輸';
      }

      // 桁数チェック（納品方法が特定できる場合）
      if (expectedLength > 0 && code && code.length !== expectedLength) {
        document.getElementById('scannerStatus').innerText =
          `${carrierName}の送り状番号は${expectedLength}桁です。再度読み取ってください。(現在: ${code.length}桁)`;
        setTimeout(() => {
          document.getElementById('scannerStatus').innerText = "バーコードを枠内に収めてください";
        }, 3000);
        return;
      }

      // 簡易バリデーション: 10-12桁
      if (code && (code.length >= 10 && code.length <= 12)) {
        // 日本の電話番号（0から始まる10桁/11桁）を誤検知しないための対策
        // 西濃運輸などの10桁追跡番号は通常0以外から始まります
        if ((code.length === 10 || code.length === 11) && code.startsWith('0')) {
          return;
        }
        isScannerProcessing = true;
        handleScannerSuccess(code);
      }
    }

    function toggleModalManual(show) {
      const area = document.getElementById('modalManualInputArea');
      if (show) {
        area.style.display = 'flex';
        document.getElementById('modalManualNo').focus();
      } else {
        area.style.display = 'none';
      }
    }

    function submitModalManual() {
      const code = document.getElementById('modalManualNo').value.trim().replace(/-/g, '');

      // 納品方法に応じた桁数チェック
      const deliveryMethod = currentDetailDeliveryMethod || '';
      let expectedLength = 0;
      let carrierName = '';

      if (deliveryMethod.includes('ヤマト')) {
        expectedLength = 12;
        carrierName = 'ヤマト';
      } else if (deliveryMethod.includes('佐川')) {
        expectedLength = 12;
        carrierName = '佐川';
      } else if (deliveryMethod.includes('西濃')) {
        expectedLength = 10;
        carrierName = '西濃運輸';
      }

      // 桁数チェック（納品方法が特定できる場合）
      if (expectedLength > 0 && code.length !== expectedLength) {
        return alert(`${carrierName}の送り状番号は${expectedLength}桁です。\n現在: ${code.length}桁\n\n正しい桁数で入力してください。`);
      }

      // 基本的な桁数チェック
      if (code.length < 10) {
        return alert("10桁以上で入力してください");
      }

      handleScannerSuccess(code);
    }

    async function captureAndOcrModal() {
      if (isScannerProcessing) return;
      isScannerProcessing = true;
      document.getElementById('scannerStatus').innerText = "画像を解析中...";
      try {
        const video = document.querySelector('#scannerView video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const base64Data = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

        google.script.run
          .withSuccessHandler(res => {
            if (res.success) handleScannerSuccess(res.code);
            else {
              isScannerProcessing = false;
              alert("認識不可: " + res.message);
              document.getElementById('scannerStatus').innerText = "バーコードを枠内に収めてください";
            }
          })
          .withFailureHandler(() => {
            isScannerProcessing = false;
            alert("OCRエラー");
          })
          .recognizeTrackingNumber(base64Data);
      } catch (e) {
        isScannerProcessing = false;
        alert("キャプチャ失敗");
      }
    }

    function handleScannerSuccess(code) {
      document.getElementById('scannerBeepSound').play();
      document.getElementById('modalScannedNo').innerText = code;
      document.getElementById('scannerSuccessOverlay').style.display = 'flex';

      google.script.run
        .withSuccessHandler(res => {
          if (res.success) {
            setTimeout(() => {
              bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide();
              onScanComplete();
            }, 1000);
          } else showScannerError(res.message);
        })
        .updateOrderTrackingStatus(currentDetailOrderId, code);
    }

    function showScannerError(msg) {
      isScannerProcessing = true;
      document.getElementById('scannerErrorMsg').innerText = msg;
      document.getElementById('scannerErrorOverlay').style.display = 'flex';
    }

    function retryScanner() {
      isScannerProcessing = false;
      document.getElementById('scannerErrorOverlay').style.display = 'none';
    }

    // スキャン完了時のコールバック（サーバー側から受注一覧を更新させる）
    function onScanComplete() {
      executeSearch();
      // 詳細モーダルを閉じる
      const detailModal = bootstrap.Modal.getInstance(document.getElementById('orderDetailModal'));
      if (detailModal) detailModal.hide();
      showSuccessToast('伝票番号を更新しました');
    }

    // ボタンの活性/非活性セット
    function setDetailButtonsState(enabled) {
      const scanBtn = document.getElementById('detailScanBtn');
      const inheritBtn = document.getElementById('detailInheritBtn');
      const editBtn = document.getElementById('detailEditBtn');

      if (scanBtn) scanBtn.disabled = !enabled;
      // inheritBtn, editBtn は権限によって存在しない場合がある
      if (inheritBtn) inheritBtn.disabled = !enabled;
      if (editBtn) editBtn.disabled = !enabled;
    }

    // 修正画面へ遷移
    function editOrder(orderId) {
      if (!orderId) {
        alert('受注IDが取得できませんでした');
        return;
      }
      setSearchConditionsToForm();
      document.getElementById('actionOrderIdInput').value = orderId;
      document.getElementById('actionEditModeInput').value = 'true';
      document.getElementById('actionModeInput').value = 'edit';
      document.getElementById('actionForm').submit();
    }

    // 引継画面へ遷移
    function inheritOrder(orderId) {
      if (!orderId) {
        alert('受注IDが取得できませんでした');
        return;
      }
      setSearchConditionsToForm();
      document.getElementById('actionOrderIdInput').value = orderId;
      document.getElementById('actionEditModeInput').value = 'false';
      document.getElementById('actionModeInput').value = 'inherit';
      document.getElementById('actionForm').submit();
    }

    // 現在の検索条件を隠しフォームにセット
    function setSearchConditionsToForm() {
      const period = document.querySelector('input[name="period"]:checked')?.value || 'thisWeek';
      const shippingStatus = document.querySelector('input[name="shippingStatus"]:checked')?.value || 'all';
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const includeOverdue = document.getElementById('includeOverdue').checked;

      // 発送先と顧客はボタンのテキストから取得（または変数から）
      const destination = document.getElementById('destinationBtn').textContent.replace('指定なし', '').trim();
      const customer = document.getElementById('customerBtn').textContent.replace('指定なし', '').trim();

      document.getElementById('prevPeriodInput').value = period;
      document.getElementById('prevStatusInput').value = shippingStatus;
      document.getElementById('prevDateFromInput').value = dateFrom;
      document.getElementById('prevDateToInput').value = dateTo;
      document.getElementById('prevDestinationInput').value = destination;
      document.getElementById('prevCustomerInput').value = customer;
      document.getElementById('prevIncludeOverdueInput').value = includeOverdue;
    }

    // ========================================
    // 一括操作関連
    // ========================================

    // 選択件数を更新
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.order-select-checkbox:checked');
      const count = checkboxes.length;
      const bulkArea = document.getElementById('bulkActionArea');
      const countSpan = document.getElementById('selectedCount');

      if (count > 0) {
        bulkArea.style.display = 'flex';
        countSpan.textContent = count + '件選択中';
      } else {
        bulkArea.style.display = 'none';
      }

      // 全選択チェックボックスの状態を更新
      const allCheckboxes = document.querySelectorAll('.order-select-checkbox');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
        selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
      }

      // 選択状態に応じて行のハイライトを更新
      updateRowHighlights();
    }

    // 行のハイライトを更新
    function updateRowHighlights() {
      // PC用テーブル: 全行のハイライトをクリア
      document.querySelectorAll('tr.selected-row').forEach(tr => {
        tr.classList.remove('selected-row');
      });

      // スマホ用カード: 全カードのハイライトをクリア
      document.querySelectorAll('.order-card.selected-row').forEach(card => {
        card.classList.remove('selected-row');
      });

      // チェックされている行にハイライトを追加
      document.querySelectorAll('.order-select-checkbox:checked').forEach(cb => {
        const orderId = cb.dataset.orderId;

        // PC用テーブル: 同じ受注IDを持つ全ての行にハイライト
        document.querySelectorAll(`tr[data-order-id="${orderId}"]`).forEach(tr => {
          tr.classList.add('selected-row');
        });

        // スマホ用カード
        document.querySelectorAll(`.order-card[data-order-id="${orderId}"]`).forEach(card => {
          card.classList.add('selected-row');
        });
      });
    }

    // 全選択トグル
    function toggleSelectAll(isChecked) {
      const checkboxes = document.querySelectorAll('.order-select-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = isChecked;
      });
      updateSelectedCount();
    }

    // 選択された受注IDを取得
    function getSelectedOrderIds() {
      const checkboxes = document.querySelectorAll('.order-select-checkbox:checked');
      return Array.from(checkboxes).map(cb => cb.dataset.orderId);
    }

    // 一括出荷済み
    function bulkUpdateShipped() {
      const orderIds = getSelectedOrderIds();
      if (orderIds.length === 0) {
        alert('受注を選択してください');
        return;
      }

      if (!confirm(orderIds.length + '件の受注を出荷済みにしますか？')) {
        return;
      }

      showLoading('一括更新中...');
      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          showSuccessToast(orderIds.length + '件を出荷済みに更新しました');
          executeSearch();
        })
        .withFailureHandler(function (error) {
          hideLoading();
          alert('更新エラー: ' + error.message);
        })
        .bulkUpdateOrderShippedStatus(orderIds, '○');
    }

    // 一括キャンセル
    function bulkCancelOrders() {
      const orderIds = getSelectedOrderIds();
      if (orderIds.length === 0) {
        alert('受注を選択してください');
        return;
      }

      if (!confirm(orderIds.length + '件の受注をキャンセルしますか？\n\n※キャンセルした受注はグレーアウト表示されますが、データは削除されません。')) {
        return;
      }

      showLoading('一括キャンセル中...');
      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          showSuccessToast(orderIds.length + '件をキャンセルしました');
          executeSearch();
        })
        .withFailureHandler(function (error) {
          hideLoading();
          alert('キャンセルエラー: ' + error.message);
        })
        .bulkCancelOrders(orderIds);
    }

    // 一括収穫待ち設定
    function bulkSetHarvestWaiting() {
      const orderIds = getSelectedOrderIds();
      if (orderIds.length === 0) {
        alert('受注を選択してください');
        return;
      }

      if (!confirm(orderIds.length + '件の受注を「収穫待ち」に設定しますか？\n\n※収穫待ちの注文は、収穫でき次第対応が必要です。')) {
        return;
      }

      showLoading('収穫待ち設定中...');
      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          showSuccessToast(orderIds.length + '件を収穫待ちに設定しました');
          executeSearch();
        })
        .withFailureHandler(function (error) {
          hideLoading();
          alert('収穫待ち設定エラー: ' + error.message);
        })
        .bulkUpdateOrderStatus(orderIds, '収穫待ち');
    }

    function bulkDeleteOrders() {
      const orderIds = getSelectedOrderIds();
      if (orderIds.length === 0) {
        alert('受注を選択してください');
        return;
      }

      if (!confirm('⚠️ ' + orderIds.length + '件の受注を完全に削除しますか？\n\n※この操作は取り消せません。\n※ヤマトCSV/佐川CSVのデータも同時に削除されます。')) {
        return;
      }

      // 二重確認
      if (!confirm('本当に削除してよろしいですか？\n\n削除対象: ' + orderIds.join(', '))) {
        return;
      }

      showLoading('一括削除中...');
      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          showSuccessToast(orderIds.length + '件を削除しました');
          executeSearch();
        })
        .withFailureHandler(function (error) {
          hideLoading();
          alert('削除エラー: ' + error.message);
        })
        .bulkDeleteOrders(orderIds);
    }

    // キャンセル解除
    function bulkUncancelOrders() {
      const orderIds = getSelectedOrderIds();
      if (orderIds.length === 0) {
        alert('受注を選択してください');
        return;
      }

      if (!confirm(orderIds.length + '件の受注のキャンセルを解除しますか？')) {
        return;
      }

      showLoading('キャンセル解除中...');
      google.script.run
        .withSuccessHandler(function (result) {
          hideLoading();
          showSuccessToast(orderIds.length + '件のキャンセルを解除しました');
          executeSearch();
        })
        .withFailureHandler(function (error) {
          hideLoading();
          alert('キャンセル解除エラー: ' + error.message);
        })
        .bulkUncancelOrders(orderIds);
    }

    // 成功トースト表示（utilities.htmlのshowToastを利用、なければalert）
    function showSuccessToast(message) {
      if (typeof showToast === 'function') {
        showToast(message, 'success');
      } else {
        alert(message);
      }
    }
  </script>

</body>

</html>