<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
  <style>
    /* é›»è©±å—æ³¨ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      background: var(--bg-body);
      -webkit-tap-highlight-color: transparent;
    }
    
    .phone-header {
      background: var(--gradient-purple);
      color: white;
      padding: var(--space-4) var(--space-5);
      margin-bottom: var(--space-5);
      border-radius: 0 0 var(--radius-xl) var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }
    
    .phone-header h4 {
      margin: 0;
      font-weight: 600;
    }
    
    .phone-header .subtitle {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    
    /* å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - .card-unifiedã‚’ä½¿ç”¨ */
    .card-unified {
      margin-bottom: var(--space-4);
    }

    .card-unified-header {
      display: flex;
      align-items: center;
      margin-bottom: var(--space-3);
    }
    
    .input-section-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      margin-right: 10px;
    }
    
    .input-section-icon.shipping {
      background: linear-gradient(135deg, #b8860b 0%, #daa520 100%);
      color: white;
    }
    
    .input-section-icon.customer {
      background: linear-gradient(135deg, #c71585 0%, #db7093 100%);
      color: white;
    }
    
    .input-section-title {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .input-section-subtitle {
      font-size: 0.8rem;
      color: #666;
    }
    
    /* ã‚µã‚¸ã‚§ã‚¹ãƒˆå…¥åŠ› */
    .suggest-input-wrapper {
      position: relative;
    }
    
    .suggest-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 1.1rem;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      transition: border-color 0.2s;
    }
    
    .suggest-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .suggest-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      max-height: 250px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    
    .suggest-list.show {
      display: block;
    }
    
    .suggest-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.1s;
    }
    
    .suggest-item:last-child {
      border-bottom: none;
    }
    
    .suggest-item:hover, .suggest-item:active {
      background: #f8f9fa;
    }
    
    .suggest-item .name {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .suggest-item .info {
      font-size: 0.85rem;
      color: #666;
    }
    
    .suggest-item .badge-new {
      background: #28a745;
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 6px;
    }
    
    /* é¸æŠæ¸ˆã¿è¡¨ç¤º */
    .selected-info {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
    }
    
    .selected-info .label {
      font-size: 0.8rem;
      color: #666;
    }
    
    .selected-info .value {
      font-weight: 500;
    }
    
    .selected-info .clear-btn {
      color: #dc3545;
      font-size: 0.85rem;
      cursor: pointer;
    }
    
    /* å¤§ããªãƒœã‚¿ãƒ³ */
    .btn-phone {
      width: 100%;
      padding: 18px 20px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 15px;
      margin-bottom: 12px;
      border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.1s, box-shadow 0.1s;
    }
    
    .btn-phone:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .btn-phone-primary {
      background: var(--gradient-purple);
      color: white;
    }
    
    .btn-phone-success {
      background: var(--gradient-success);
      color: white;
    }
    
    .btn-phone-warning {
      background: var(--gradient-red);
      color: white;
    }
    
    .btn-phone-outline {
      background: white;
      color: #333;
      border: 2px solid #ddd;
    }
    
    /* å•†å“ã‚«ãƒ¼ãƒ‰ */
    .product-card {
      background: white;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    /* é¸æŠæ¸ˆã¿å•†å“ã‚«ãƒ¼ãƒ‰ */
    .selected-product-card {
      background: #f8fff8;
      border: 2px solid #28a745;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 8px;
    }
    
    .selected-product-card .product-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .selected-product-card .product-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .selected-product-card .price-input {
      width: 90px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      text-align: right;
    }
    
    .selected-product-card .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 1rem;
      cursor: pointer;
    }
    
    /* è¿½åŠ ç”¨å•†å“ã‚«ãƒ¼ãƒ‰ */
    .add-product-card {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 14px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .add-product-card:hover {
      background: #e9ecef;
      border-color: #667eea;
    }
    
    .add-product-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .add-product-card .add-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .product-card .product-info {
      flex: 1;
    }
    
    .product-card .product-name {
      font-weight: 600;
      color: #333;
      font-size: 1rem;
    }
    
    .product-card .product-price {
      font-size: 0.85rem;
      color: #666;
    }
    
    .product-card .product-prev {
      font-size: 0.8rem;
      color: #999;
    }
    
    /* æ•°é‡å…¥åŠ› */
    .qty-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .qty-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.1s;
    }
    
    .qty-btn:active {
      transform: scale(0.9);
    }
    
    .qty-btn-minus {
      background: #f8f9fa;
      color: #dc3545;
    }
    
    .qty-btn-plus {
      background: #28a745;
      color: white;
    }
    
    .qty-input {
      width: 60px;
      height: 44px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      border: 2px solid #ddd;
      border-radius: 10px;
    }
    
    /* ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤º */
    .phase-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .phase-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ddd;
    }
    
    .phase-dot.active {
      background: #667eea;
    }
    
    .phase-dot.completed {
      background: #28a745;
    }
    
    /* å‰å›ã¨åŒã˜ãƒœã‚¿ãƒ³ */
    .btn-same-as-last {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 15px;
      border: none;
      margin-bottom: 16px;
      box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
    }
    
    /* åˆè¨ˆè¡¨ç¤º */
    .total-bar {
      background: var(--gradient-purple);
      color: white;
      padding: 16px 20px;
      border-radius: 15px;
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .total-bar .label {
      font-size: 1rem;
    }
    
    .total-bar .amount {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    /* ã‚¹ãƒ†ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠ */
    .step-container {
      display: none;
      animation: fadeIn 0.3s;
    }
    
    .step-container.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* æ—¥ç¨‹é¸æŠ */
    .date-section {
      background: white;
      border-radius: 15px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .date-section label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: block;
    }
    
    .date-section input[type="date"] {
      width: 100%;
      padding: 14px;
      font-size: 1.1rem;
      border: 2px solid #ddd;
      border-radius: 10px;
    }
    
    /* æ–°è¦é¡§å®¢ãƒ¢ãƒ¼ãƒ‰ */
    .new-customer-section {
      background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
      border: 2px solid #ff6b6b;
      border-radius: 15px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .new-customer-section h5 {
      color: #ee5a24;
      margin-bottom: 12px;
    }
    
    .new-customer-section .form-label {
      font-weight: 600;
      color: #333;
    }
    
    .new-customer-section .required {
      color: #dc3545;
    }
    
    .new-customer-section input {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: 2px solid #ddd;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    
    .new-customer-section input:focus {
      outline: none;
      border-color: #ff6b6b;
    }
    
    /* è¦ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
    .confirm-check {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #fff3cd;
      padding: 12px 16px;
      border-radius: 10px;
      margin-top: 12px;
    }
    
    .confirm-check input[type="checkbox"] {
      width: 24px;
      height: 24px;
    }
    
    .confirm-check label {
      font-weight: 500;
      color: #856404;
    }
    
    /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¿ãƒ– */
    .mode-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .mode-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mode-tab.existing {
      background: #e9ecef;
      color: #333;
    }
    
    .mode-tab.existing.active {
      background: var(--gradient-purple);
      color: white;
    }
    
    .mode-tab.new {
      background: #ffe0e0;
      color: #ee5a24;
    }
    
    .mode-tab.new.active {
      background: var(--gradient-red);
      color: white;
    }
  </style>
</head>

<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="phone-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h4>ğŸ“ é›»è©±å—æ³¨ãƒ¢ãƒ¼ãƒ‰</h4>
        <div class="subtitle">ç™ºé€å…ˆãƒ»é¡§å®¢ã‚’é¸æŠã—ã¦ç´ æ—©ãå…¥åŠ›</div>
      </div>
      <form method="POST" action="<?= deployURL ?>" style="display: inline;">
        <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
        <button type="submit" name="main" value="true" class="btn btn-light btn-sm" style="border-radius: 20px;">
          âœ• é–‰ã˜ã‚‹
        </button>
      </form>
    </div>
  </div>
  
  <div class="container">
    <!-- ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤º -->
    <div class="phase-indicator">
      <div class="phase-dot active" id="phase1"></div>
      <div class="phase-dot" id="phase2"></div>
      <div class="phase-dot" id="phase3"></div>
      <div class="phase-dot" id="phase4"></div>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ç™ºé€å…ˆãƒ»é¡§å®¢ã®é¸æŠ -->
    <div class="step-container active" id="step1">
      <h5 class="mb-3">ğŸ“ ç™ºé€å…ˆãƒ»é¡§å®¢ã‚’é¸æŠ</h5>
      
      <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
      <div class="mode-tabs">
        <div class="mode-tab existing active" onclick="switchMode('existing')">
          ğŸ”„ ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼
        </div>
        <div class="mode-tab new" onclick="switchMode('new')">
          â• æ–°è¦é¡§å®¢
        </div>
      </div>
      
      <!-- ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ -->
      <div id="existingMode">
        <!-- ç™ºé€å…ˆå…¥åŠ› -->
        <div class="card-unified">
          <div class="card-unified-header">
            <div class="input-section-icon shipping">ğŸ“¦</div>
            <div>
              <div class="input-section-title">ç™ºé€å…ˆ</div>
              <div class="input-section-subtitle">ã©ã“ã«å±Šã‘ã¾ã™ã‹ï¼Ÿ</div>
            </div>
          </div>
          <div class="suggest-input-wrapper">
            <input type="text" class="suggest-input" id="shippingToInput" 
                   placeholder="ç™ºé€å…ˆåã‚’å…¥åŠ›..." 
                   oninput="onShippingToInput()" 
                   onfocus="showShippingToSuggestions()">
            <div class="suggest-list" id="shippingToSuggestList"></div>
          </div>
          <div class="selected-info" id="shippingToSelected" style="display: none;">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="label">é¸æŠä¸­ã®ç™ºé€å…ˆ</div>
                <div class="value" id="shippingToSelectedName"></div>
                <div class="text-muted" style="font-size: 0.85rem;" id="shippingToSelectedInfo"></div>
              </div>
              <div class="clear-btn" onclick="clearShippingTo()">âœ• è§£é™¤</div>
            </div>
          </div>
        </div>
        
        <!-- é¡§å®¢å…¥åŠ› -->
        <div class="card-unified">
          <div class="card-unified-header">
            <div class="input-section-icon customer">ğŸ‘¤</div>
            <div>
              <div class="input-section-title">é¡§å®¢ï¼ˆä¾é ¼äººï¼‰</div>
              <div class="input-section-subtitle">ç™ºé€å…ˆé¸æŠæ™‚ã«è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™</div>
            </div>
          </div>
          <div class="suggest-input-wrapper">
            <input type="text" class="suggest-input" id="customerInput" 
                   placeholder="é¡§å®¢åã‚’å…¥åŠ›..." 
                   oninput="onCustomerInput()" 
                   onfocus="showCustomerSuggestions()">
            <div class="suggest-list" id="customerSuggestList"></div>
          </div>
          <div class="selected-info" id="customerSelected" style="display: none;">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="label">é¸æŠä¸­ã®é¡§å®¢</div>
                <div class="value" id="customerSelectedName"></div>
                <div class="text-muted" style="font-size: 0.85rem;" id="customerSelectedInfo"></div>
              </div>
              <div class="clear-btn" onclick="clearCustomer()">âœ• è§£é™¤</div>
            </div>
          </div>
        </div>
        
        <button class="btn-phone btn-phone-primary" onclick="proceedToStep2()" id="nextBtn" disabled>
          æ¬¡ã¸ â†’ å•†å“å…¥åŠ›
        </button>
      </div>
      
      <!-- æ–°è¦é¡§å®¢ãƒ¢ãƒ¼ãƒ‰ -->
      <div id="newCustomerMode" style="display: none;">
        <div class="new-customer-section">
          <h5>â• æ–°è¦é¡§å®¢å…¥åŠ›ï¼ˆç°¡æ˜“ãƒ¢ãƒ¼ãƒ‰ï¼‰</h5>
          <p class="text-muted" style="font-size: 0.85rem;">é›»è©±ä¸­ã¯æœ€ä½é™ã®æƒ…å ±ã ã‘ã§OKã€‚è©³ç´°ã¯å¾Œã‹ã‚‰å…¥åŠ›ã§ãã¾ã™ã€‚</p>
          
          <!-- ç™ºé€å…ˆæƒ…å ± -->
          <div class="mb-2" style="background: #f8f9fa; padding: 0.75rem; border-radius: 0.5rem; border-left: 3px solid #28a745;">
            <div style="font-weight: 600; color: #28a745; margin-bottom: 0.5rem;">ğŸ“¦ ç™ºé€å…ˆæƒ…å ±</div>
            
            <div class="mb-2">
              <label class="form-label small mb-1">ä¼šç¤¾å</label>
              <input type="text" id="newShippingToCompany" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ç››å²¡ã‚¹ãƒ¼ãƒ‘ãƒ¼" class="form-control form-control-sm">
            </div>
            
            <div class="mb-2">
              <label class="form-label small mb-1">æ°åï¼ˆç™ºé€å…ˆåï¼‰ <span class="required">*å¿…é ˆ</span></label>
              <input type="text" id="newShippingToName" placeholder="ä¾‹: ç››å²¡ã‚¹ãƒ¼ãƒ‘ãƒ¼â–³â–³åº—" class="form-control form-control-sm">
            </div>
            
            <div class="mb-2">
              <label class="form-label small mb-1">é›»è©±ç•ªå· <span class="required">*å¿…é ˆ</span></label>
              <input type="tel" id="newPhone" placeholder="ä¾‹: 0191234567" class="form-control form-control-sm">
            </div>
            
            <div class="mb-2">
              <label class="form-label small mb-1">éƒµä¾¿ç•ªå·</label>
              <div class="d-flex gap-2">
                <input type="text" id="newShippingToZipcode" placeholder="ä¾‹: 0200021" class="form-control form-control-sm" style="flex: 1;" maxlength="8">
                <button type="button" class="btn btn-outline-primary" onclick="searchAddressByZipcode('shippingTo')" style="white-space: nowrap; font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                  ğŸ” æ¤œç´¢
                </button>
              </div>
            </div>
            
            <div class="mb-0">
              <label class="form-label small mb-1">ä½æ‰€</label>
              <input type="text" id="newShippingToAddress" placeholder="éƒµä¾¿ç•ªå·ã‹ã‚‰è‡ªå‹•å…¥åŠ›" class="form-control form-control-sm">
            </div>
          </div>
          
          <!-- é¡§å®¢æƒ…å ±ï¼ˆç™ºé€å…ˆã¨ç•°ãªã‚‹å ´åˆï¼‰ -->
          <div class="mb-3">
            <div class="confirm-check" style="background: #e3f2fd; margin-top: 0;">
              <input type="checkbox" id="customerDifferent" onchange="toggleCustomerFields()">
              <label for="customerDifferent" style="color: #1565c0;">é¡§å®¢ï¼ˆä¾é ¼äººï¼‰ãŒç™ºé€å…ˆã¨ç•°ãªã‚‹</label>
            </div>
            
            <div id="customerFieldsArea" style="display: none; background: #fff8e1; padding: 0.75rem; border-radius: 0.5rem; border-left: 3px solid #ffc107; margin-top: 0.5rem;">
              <div style="font-weight: 600; color: #ffc107; margin-bottom: 0.5rem;">ğŸ‘¤ é¡§å®¢ï¼ˆä¾é ¼äººï¼‰æƒ…å ±</div>
              
              <div class="mb-2">
                <label class="form-label small mb-1">ä¼šç¤¾å</label>
                <input type="text" id="newCustomerCompany" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ç››å²¡ã‚¹ãƒ¼ãƒ‘ãƒ¼" class="form-control form-control-sm">
              </div>
              
              <div class="mb-2">
                <label class="form-label small mb-1">æ°åï¼ˆé¡§å®¢åï¼‰</label>
                <input type="text" id="newCustomerName" placeholder="ä¾‹: ç››å²¡ã‚¹ãƒ¼ãƒ‘ãƒ¼æœ¬ç¤¾" class="form-control form-control-sm">
              </div>
              
              <div class="mb-2">
                <label class="form-label small mb-1">é›»è©±ç•ªå·</label>
                <input type="tel" id="newCustomerPhone" placeholder="ä¾‹: 0191234567" class="form-control form-control-sm">
              </div>
              
              <div class="mb-2">
                <label class="form-label small mb-1">éƒµä¾¿ç•ªå·</label>
                <div class="d-flex gap-2">
                  <input type="text" id="newCustomerZipcode" placeholder="ä¾‹: 0200021" class="form-control form-control-sm" style="flex: 1;" maxlength="8">
                  <button type="button" class="btn btn-outline-warning" onclick="searchAddressByZipcode('customer')" style="white-space: nowrap; font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                    ğŸ” æ¤œç´¢
                  </button>
                </div>
              </div>
              
              <div class="mb-0">
                <label class="form-label small mb-1">ä½æ‰€</label>
                <input type="text" id="newCustomerAddress" placeholder="éƒµä¾¿ç•ªå·ã‹ã‚‰è‡ªå‹•å…¥åŠ›" class="form-control form-control-sm">
              </div>
            </div>
          </div>
          
          <div class="confirm-check">
            <input type="checkbox" id="needsConfirmation" checked>
            <label for="needsConfirmation">ã€Œè¦ç¢ºèªã€ãƒ•ãƒ©ã‚°ã‚’ä»˜ã‘ã‚‹ï¼ˆæ¨å¥¨ï¼‰</label>
          </div>
        </div>
        
        <button class="btn-phone btn-phone-warning" onclick="proceedToStep2NewCustomer()">
          æ¬¡ã¸ â†’ å•†å“å…¥åŠ›
        </button>
      </div>
      
      <div class="text-center mt-4">
        <form method="POST" action="<?= deployURL ?>" style="display: inline;">
          <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
          <button type="submit" name="shipping" value="true" class="btn-phone btn-phone-outline">
            ğŸ“ é€šå¸¸ã®å—æ³¨ç”»é¢ã¸
          </button>
        </form>
      </div>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒƒãƒ—2: å•†å“ãƒ»æ•°é‡å…¥åŠ› -->
    <div class="step-container" id="step2">
      <div class="card-unified">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-bold" id="step2ShippingTo">-</div>
            <div class="text-muted" style="font-size: 0.85rem;" id="step2Customer">-</div>
          </div>
          <div style="color: #667eea; cursor: pointer;" onclick="goToStep(1)">å¤‰æ›´</div>
        </div>
      </div>
      
      <h5 class="mb-3">ğŸ›’ å•†å“ãƒ»æ•°é‡ã‚’å…¥åŠ›</h5>
      
      <!-- å‰å›ã¨åŒã˜ãƒœã‚¿ãƒ³ -->
      <button class="btn-same-as-last" id="sameAsLastBtn" onclick="applySameAsLast()" style="display: none;">
        ğŸ”„ å‰å›ã¨åŒã˜æ³¨æ–‡
      </button>
      
      <!-- æ—¥ç¨‹é¸æŠ -->
      <div class="date-section">
        <label>ğŸ“… ç™ºé€æ—¥</label>
        <input type="date" id="shippingDateInput" onchange="updateDeliveryDate()">
        <label class="mt-3">ğŸ“¦ ç´å“æ—¥</label>
        <input type="date" id="deliveryDateInput">
      </div>
      
      <!-- é¸æŠæ¸ˆã¿å•†å“ã‚¨ãƒªã‚¢ -->
      <div class="card-unified">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label style="font-size: 0.9rem; color: #495057;">ğŸ“‹ é¸æŠæ¸ˆã¿å•†å“ <span id="selectedCount">(0/10)</span></label>
        </div>
        <div id="selectedProductList">
          <div class="text-center text-muted py-3" id="noProductsMessage">å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
        </div>
      </div>
      
      <!-- å•†å“è¿½åŠ ã‚¨ãƒªã‚¢ -->
      <div class="card-unified">
        <label style="font-size: 0.9rem; color: #495057;">â• å•†å“ã‚’è¿½åŠ </label>
        <input type="text" 
               id="productSearchInput" 
               class="form-control mb-2" 
               placeholder="å•†å“åã‚„åˆ†é¡ã§æ¤œç´¢..." 
               oninput="filterProducts()">
        <div class="mb-2" id="categoryFilterArea">
          <!-- åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
        <div id="productList" style="max-height: 300px; overflow-y: auto;">
          <!-- è¿½åŠ å¯èƒ½ãªå•†å“ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
      </div>
      
      <!-- ãƒ¡ãƒ¢æ¬„ -->
      <div class="card-unified">
        <label style="font-size: 0.9rem; color: #495057;">ğŸ“ ãƒ¡ãƒ¢</label>
        <textarea id="orderMemoInput" 
                  class="form-control" 
                  rows="3" 
                  placeholder="å‚™è€ƒã€ç‰¹è¨˜äº‹é …ãªã©..."
                  style="font-size: 1rem;"></textarea>
      </div>
      
      <!-- åˆè¨ˆ -->
      <div class="total-bar">
        <span class="label">åˆè¨ˆé‡‘é¡</span>
        <span class="amount" id="totalAmount">Â¥0</span>
      </div>
      
      <div class="mt-4">
        <button class="btn-phone btn-phone-success" onclick="goToStep(3)">
          ğŸšš ç™ºé€æƒ…å ±ã¸
        </button>
        <button class="btn-phone btn-phone-outline" onclick="goToStep(1)">
          â† æˆ»ã‚‹
        </button>
      </div>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ç™ºé€æƒ…å ± -->
    <div class="step-container" id="step3">
      <div class="card-unified">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-bold" id="step3ShippingTo">-</div>
            <div class="text-muted" style="font-size: 0.85rem;" id="step3Customer">-</div>
          </div>
          <div style="color: #667eea; cursor: pointer;" onclick="goToStep(1)">å¤‰æ›´</div>
        </div>
      </div>
      
      <h5 class="mb-3">ğŸšš ç™ºé€æƒ…å ±ã‚’å…¥åŠ›</h5>
      
      <!-- ç™ºé€å…ƒ -->
      <div class="card-unified">
        <label style="font-size: 0.9rem; color: #495057;">ğŸ“ ç™ºé€å…ƒ</label>
        <div class="d-flex gap-2 flex-wrap mb-2">
          <button type="button" class="btn btn-outline-success btn-sm" onclick="setShippingFromCompany()" id="shippingFromCompanyBtn">
            ğŸŒ¿ <span id="companyDisplayName">ä¼šç¤¾</span>
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setShippingFromCustomer()">
            ğŸ“‹ é¡§å®¢
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setShippingFromShippingTo()">
            ğŸ“‹ ç™ºé€å…ˆ
          </button>
        </div>
        <div id="shippingFromInfo" class="p-2 bg-light rounded" style="font-size: 0.85rem; color: #666;">
          <div id="shippingFromName">-</div>
          <div id="shippingFromDetail"></div>
        </div>
      </div>
      
      <!-- é…é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
      <div class="card-unified">
        <label style="font-size: 0.9rem; color: #495057;">ğŸ“¦ é…é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
        
        <!-- ç´å“æ–¹æ³• -->
        <div class="mb-2">
          <label class="form-label small mb-1">ç´å“æ–¹æ³•</label>
          <select class="form-select" id="deliveryMethodSelect" onchange="onDeliveryMethodChange()">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        
        <!-- é…é”æ™‚é–“å¸¯ -->
        <div class="mb-2">
          <label class="form-label small mb-1">é…é”æ™‚é–“å¸¯</label>
          <select class="form-select" id="deliveryTimeSelect">
            <option value="">æŒ‡å®šãªã—</option>
          </select>
        </div>
        
        <!-- é€ã‚ŠçŠ¶ç¨®åˆ¥ -->
        <div class="mb-2">
          <label class="form-label small mb-1">é€ã‚ŠçŠ¶ç¨®åˆ¥</label>
          <select class="form-select" id="invoiceTypeSelect" onchange="updateCargoByConditions()">
            <option value="">æŒ‡å®šãªã—</option>
          </select>
        </div>
        
        <!-- ã‚¯ãƒ¼ãƒ«åŒºåˆ† -->
        <div class="mb-2">
          <label class="form-label small mb-1">ã‚¯ãƒ¼ãƒ«åŒºåˆ†</label>
          <select class="form-select" id="coolClsSelect" onchange="updateCargoByConditions()">
            <option value="">æŒ‡å®šãªã—</option>
          </select>
        </div>
        
        <!-- è·æ‰±ã„ï¼‘ -->
        <div class="mb-2">
          <label class="form-label small mb-1">è·æ‰±ã„ï¼‘</label>
          <select class="form-select" id="cargo1Select">
            <option value="">æŒ‡å®šãªã—</option>
          </select>
        </div>
        
        <!-- è·æ‰±ã„ï¼’ -->
        <div class="mb-2">
          <label class="form-label small mb-1">è·æ‰±ã„ï¼’</label>
          <select class="form-select" id="cargo2Select">
            <option value="">æŒ‡å®šãªã—</option>
          </select>
        </div>

        <!-- è·æ‰±ã„ï¼“ï¼ˆä½å·ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
        <div class="mb-2" id="cargo3Container" style="display:none;">
          <label class="form-label small mb-1">è·æ‰±ã„ï¼“</label>
          <select class="form-select" id="cargo3Select">
            <option value="">æŒ‡å®šãªã—</option>
          </select>
        </div>
      </div>

      <!-- å¸³ç¥¨ãƒ»åŒæ¢±ç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
      <div class="card-unified">
        <label style="font-size: 0.9rem; color: #495057;">ğŸ“‹ å¸³ç¥¨ãƒ»åŒæ¢±ç‰©</label>
        <div class="row g-2 mt-1">
          <div class="col-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checkDeliverySlip" value="ç´å“æ›¸">
              <label class="form-check-label" for="checkDeliverySlip">ç´å“æ›¸</label>
            </div>
          </div>
          <div class="col-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checkInvoice" value="è«‹æ±‚æ›¸">
              <label class="form-check-label" for="checkInvoice">è«‹æ±‚æ›¸</label>
            </div>
          </div>
          <div class="col-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checkReceipt" value="é ˜åæ›¸">
              <label class="form-check-label" for="checkReceipt">é ˜åæ›¸</label>
            </div>
          </div>
          <div class="col-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checkPamphlet" value="ãƒ‘ãƒ³ãƒ•">
              <label class="form-check-label" for="checkPamphlet">ãƒ‘ãƒ³ãƒ•</label>
            </div>
          </div>
          <div class="col-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checkRecipe" value="ãƒ¬ã‚·ãƒ”">
              <label class="form-check-label" for="checkRecipe">ãƒ¬ã‚·ãƒ”</label>
            </div>
          </div>
        </div>
      </div>
      
      <!-- é¸æŠæ¸ˆã¿å•†å“ã‚µãƒãƒª -->
      <div class="card-unified">
        <div class="text-muted" style="font-size: 0.85rem;">ğŸ“‹ é¸æŠå•†å“</div>
        <div id="step3ProductSummary" class="mt-1">-</div>
      </div>
      
      <!-- åˆè¨ˆ -->
      <div class="total-bar">
        <span class="label">åˆè¨ˆé‡‘é¡</span>
        <span class="amount" id="step3TotalAmount">Â¥0</span>
      </div>
      
      <div class="mt-4">
        <button class="btn-phone btn-phone-success" onclick="goToStep(4)">
          âœ“ ç¢ºèªç”»é¢ã¸
        </button>
        <button class="btn-phone btn-phone-outline" onclick="goToStep(2)">
          â† å•†å“é¸æŠã«æˆ»ã‚‹
        </button>
      </div>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒƒãƒ—4: ç¢ºèª -->
    <div class="step-container" id="step4">
      <h5 class="mb-3">âœ“ æ³¨æ–‡å†…å®¹ã‚’ç¢ºèª</h5>
      
      <div class="card-unified">
        <div class="mb-2">
          <div class="text-muted" style="font-size: 0.8rem;">ç™ºé€å…ƒ</div>
          <div class="fw-bold" id="confirmShippingFrom">-</div>
        </div>
        <div class="mb-2">
          <div class="text-muted" style="font-size: 0.8rem;">ç™ºé€å…ˆ</div>
          <div class="fw-bold" id="confirmShippingTo">-</div>
        </div>
        <div>
          <div class="text-muted" style="font-size: 0.8rem;">é¡§å®¢ï¼ˆä¾é ¼äººï¼‰</div>
          <div class="fw-bold" id="confirmCustomer">-</div>
        </div>
      </div>
      
      <div class="date-section">
        <div class="d-flex justify-content-between">
          <div>
            <div class="text-muted" style="font-size: 0.85rem;">ç™ºé€æ—¥</div>
            <div class="fw-bold" id="confirmShippingDate">-</div>
          </div>
          <div class="text-end">
            <div class="text-muted" style="font-size: 0.85rem;">ç´å“æ—¥</div>
            <div class="fw-bold" id="confirmDeliveryDate">-</div>
          </div>
        </div>
      </div>
      
      <!-- é…é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º -->
      <div class="card-unified" id="confirmDeliveryOptionsArea">
        <div class="text-muted mb-2" style="font-size: 0.85rem;">ğŸšš é…é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
        <div class="row g-2">
          <div class="col-6">
            <div class="text-muted" style="font-size: 0.75rem;">ç´å“æ–¹æ³•</div>
            <div class="fw-bold" id="confirmDeliveryMethod">-</div>
          </div>
          <div class="col-6">
            <div class="text-muted" style="font-size: 0.75rem;">é…é”æ™‚é–“å¸¯</div>
            <div class="fw-bold" id="confirmDeliveryTime">-</div>
          </div>
          <div class="col-6">
            <div class="text-muted" style="font-size: 0.75rem;">é€ã‚ŠçŠ¶ç¨®åˆ¥</div>
            <div class="fw-bold" id="confirmInvoiceType">-</div>
          </div>
          <div class="col-6">
            <div class="text-muted" style="font-size: 0.75rem;">ã‚¯ãƒ¼ãƒ«åŒºåˆ†</div>
            <div class="fw-bold" id="confirmCoolCls">-</div>
          </div>
          <div class="col-6">
            <div class="text-muted" style="font-size: 0.75rem;">è·æ‰±ã„1</div>
            <div class="fw-bold" id="confirmCargo1">-</div>
          </div>
          <div class="col-6">
            <div class="text-muted" style="font-size: 0.75rem;">è·æ‰±ã„2</div>
            <div class="fw-bold" id="confirmCargo2">-</div>
          </div>
          <div class="col-6" id="confirmCargo3Area" style="display: none;">
            <div class="text-muted" style="font-size: 0.75rem;">è·æ‰±ã„3</div>
            <div class="fw-bold" id="confirmCargo3">-</div>
          </div>
        </div>
      </div>
      
      <!-- å¸³ç¥¨ãƒ»åŒæ¢±ç‰©è¡¨ç¤º -->
      <div class="card-unified" id="confirmChecklistArea" style="display: none;">
        <div class="text-muted mb-1" style="font-size: 0.85rem;">ğŸ“‹ å¸³ç¥¨ãƒ»åŒæ¢±ç‰©</div>
        <div class="fw-bold" id="confirmChecklist">-</div>
      </div>
      
      <div id="confirmProductList">
        <!-- ç¢ºèªç”¨å•†å“ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
      
      <!-- ãƒ¡ãƒ¢è¡¨ç¤º -->
      <div id="confirmMemoArea" class="card-unified" style="display: none;">
        <div class="text-muted" style="font-size: 0.85rem;">ğŸ“ ãƒ¡ãƒ¢</div>
        <div id="confirmMemo" style="white-space: pre-wrap;"></div>
      </div>
      
      <!-- è­¦å‘Šè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="warningArea"></div>
      
      <!-- è¦ç¢ºèªãƒ•ãƒ©ã‚°è¡¨ç¤º -->
      <div id="confirmNeedsConfirmation" style="display: none;">
        <div class="alert alert-warning">
          <strong>âš ï¸ è¦ç¢ºèª</strong><br>
          æ–°è¦é¡§å®¢ã®ãŸã‚ã€å¾Œã‹ã‚‰è©³ç´°æƒ…å ±ã®å…¥åŠ›ãŒå¿…è¦ã§ã™
        </div>
      </div>
      
      <div class="total-bar">
        <span class="label">åˆè¨ˆé‡‘é¡</span>
        <span class="amount" id="confirmTotalAmount">Â¥0</span>
      </div>
      
      <div class="mt-4">
        <form id="orderForm" method="POST" action="<?= deployURL ?>">
          <input type="hidden" name="sessionId" value="<?= typeof sessionId !== 'undefined' ? sessionId : '' ?>">
          <!-- hidden fields will be added dynamically -->
          <input type="hidden" name="shippingSubmit" value="true">
          <button type="submit" class="btn-phone btn-phone-success" id="submitOrderBtn">
            ğŸ“¤ å—æ³¨ã™ã‚‹
          </button>
        </form>
        <button class="btn-phone btn-phone-outline" onclick="goToStep(3)">
          â† ä¿®æ­£ã™ã‚‹
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let shippingToList = [];
    let products = [];
    let masterData = null;
    let lastOrder = null;
    let isNewCustomerMode = false;
    
    // é¸æŠã•ã‚ŒãŸç™ºé€å…ˆãƒ»é¡§å®¢
    let selectedShippingTo = null;
    let selectedCustomer = null;
    let selectedCategory = null; // åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      showLoading('åˆæœŸåŒ–ä¸­...');
      
      // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(data) {
          if (!data) {
            showErrorToast('ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            hideLoading();
            return;
          }
          masterData = data;
          products = data.products || [];
          if (products.length === 0) {
            console.warn('å•†å“ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
          }
          setupDeliveryOptions();
          loadShippingToList();
        })
        .withFailureHandler(function(e) {
          console.error('ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          showErrorToast('ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || e));
          hideLoading();
        })
        .getMasterDataCached();
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’è¨­å®š
      setDefaultDates();
      
      // ã‚¯ãƒªãƒƒã‚¯ã§ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.suggest-input-wrapper')) {
          hideAllSuggestions();
        }
      });
    });
    
    function setDefaultDates() {
      const today = new Date();
      const shippingDate = new Date(today);
      shippingDate.setDate(shippingDate.getDate() + 2);
      const deliveryDate = new Date(shippingDate);
      deliveryDate.setDate(deliveryDate.getDate() + 1);
      
      document.getElementById('shippingDateInput').value = formatDate(shippingDate);
      document.getElementById('deliveryDateInput').value = formatDate(deliveryDate);
    }
    
    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }
    
    function updateDeliveryDate() {
      const shippingDate = new Date(document.getElementById('shippingDateInput').value);
      const deliveryDate = new Date(shippingDate);
      deliveryDate.setDate(deliveryDate.getDate() + 1);
      document.getElementById('deliveryDateInput').value = formatDate(deliveryDate);
    }
    
    // é…é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupDeliveryOptions() {
      if (!masterData) return;
      
      // ç™ºé€å…ƒï¼šä¼šç¤¾åã‚’è¡¨ç¤ºã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä¼šç¤¾æƒ…å ±ã‚’è¨­å®š
      google.script.run
        .withSuccessHandler(function(companyName) {
          document.getElementById('companyDisplayName').textContent = companyName || 'ä¼šç¤¾';
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä¼šç¤¾æƒ…å ±ã‚’è¨­å®š
          setShippingFromCompany();
        })
        .getCompanyDisplayName();
      
      // ç´å“æ–¹æ³•
      const deliveryMethodSelect = document.getElementById('deliveryMethodSelect');
      deliveryMethodSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      if (masterData.deliveryMethods) {
        masterData.deliveryMethods.forEach(function(item) {
          const option = document.createElement('option');
          option.value = item['ç´å“æ–¹æ³•'];
          option.textContent = item['ç´å“æ–¹æ³•'];
          deliveryMethodSelect.appendChild(option);
        });
      }
      
      // å…¨é¸æŠè‚¢ã®åˆæœŸHTMLã‚’ä¿å­˜ï¼ˆç´å“æ–¹æ³•ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿ç”¨ï¼‰
      saveOriginalOptions();
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ¤ãƒãƒˆã‚’é¸æŠ
      deliveryMethodSelect.value = 'ãƒ¤ãƒãƒˆ';
      onDeliveryMethodChange();
    }
    
    // å…ƒã®é¸æŠè‚¢ã‚’ä¿å­˜
    let originalDeliveryTimeOptions = '';
    let originalInvoiceTypeOptions = '';
    let originalCoolClsOptions = '';
    let originalCargo1Options = '';
    let originalCargo2Options = '';
    let originalCargo3Options = '';
    
    function saveOriginalOptions() {
      // é…é”æ™‚é–“å¸¯
      const deliveryTimeSelect = document.getElementById('deliveryTimeSelect');
      deliveryTimeSelect.innerHTML = '<option value="">æŒ‡å®šãªã—</option>';
      if (masterData.deliveryTimes) {
        masterData.deliveryTimes.forEach(function(item) {
          const option = document.createElement('option');
          option.value = item['æ™‚é–“æŒ‡å®šå€¤'] || '';
          option.textContent = item['æ™‚é–“æŒ‡å®š'] || 'æŒ‡å®šãªã—';
          option.dataset.val = item['ç´å“æ–¹æ³•'] || '';
          deliveryTimeSelect.appendChild(option);
        });
      }
      originalDeliveryTimeOptions = deliveryTimeSelect.innerHTML;
      
      // é€ã‚ŠçŠ¶ç¨®åˆ¥
      const invoiceTypeSelect = document.getElementById('invoiceTypeSelect');
      invoiceTypeSelect.innerHTML = '<option value="">æŒ‡å®šãªã—</option>';
      if (masterData.invoiceTypes) {
        masterData.invoiceTypes.forEach(function(item) {
          const option = document.createElement('option');
          option.value = item['ç¨®åˆ¥å€¤'] || '';
          option.textContent = item['ç¨®åˆ¥'] || 'æŒ‡å®šãªã—';
          option.dataset.val = item['ç´å“æ–¹æ³•'] || '';
          invoiceTypeSelect.appendChild(option);
        });
      }
      originalInvoiceTypeOptions = invoiceTypeSelect.innerHTML;
      
      // ã‚¯ãƒ¼ãƒ«åŒºåˆ†
      const coolClsSelect = document.getElementById('coolClsSelect');
      coolClsSelect.innerHTML = '<option value="">æŒ‡å®šãªã—</option>';
      if (masterData.coolClss) {
        masterData.coolClss.forEach(function(item) {
          const option = document.createElement('option');
          option.value = item['ç¨®åˆ¥å€¤'] || item['åŒºåˆ†å€¤'] || '';
          option.textContent = item['ç¨®åˆ¥'] || item['åŒºåˆ†'] || 'æŒ‡å®šãªã—';
          option.dataset.val = item['ç´å“æ–¹æ³•'] || '';
          coolClsSelect.appendChild(option);
        });
      }
      originalCoolClsOptions = coolClsSelect.innerHTML;
      
      // è·æ‰±ã„ï¼‘
      const cargo1Select = document.getElementById('cargo1Select');
      cargo1Select.innerHTML = '<option value="">æŒ‡å®šãªã—</option>';
      if (masterData.cargos) {
        masterData.cargos.forEach(function(item) {
          const option = document.createElement('option');
          option.value = item['ç¨®åˆ¥å€¤'] || '';
          option.textContent = item['ç¨®åˆ¥'] || 'æŒ‡å®šãªã—';
          option.dataset.val = item['ç´å“æ–¹æ³•'] || '';
          cargo1Select.appendChild(option);
        });
      }
      originalCargo1Options = cargo1Select.innerHTML;
      
      // è·æ‰±ã„ï¼’
      const cargo2Select = document.getElementById('cargo2Select');
      cargo2Select.innerHTML = '<option value="">æŒ‡å®šãªã—</option>';
      if (masterData.cargos) {
        masterData.cargos.forEach(function(item) {
          const option = document.createElement('option');
          option.value = item['ç¨®åˆ¥å€¤'] || '';
          option.textContent = item['ç¨®åˆ¥'] || 'æŒ‡å®šãªã—';
          option.dataset.val = item['ç´å“æ–¹æ³•'] || '';
          cargo2Select.appendChild(option);
        });
      }
      originalCargo2Options = cargo2Select.innerHTML;

      // è·æ‰±ã„ï¼“
      const cargo3Select = document.getElementById('cargo3Select');
      cargo3Select.innerHTML = '<option value="">æŒ‡å®šãªã—</option>';
      if (masterData.cargos) {
        masterData.cargos.forEach(function(item) {
          const option = document.createElement('option');
          option.value = item['ç¨®åˆ¥å€¤'] || '';
          option.textContent = item['ç¨®åˆ¥'] || 'æŒ‡å®šãªã—';
          option.dataset.val = item['ç´å“æ–¹æ³•'] || '';
          cargo3Select.appendChild(option);
        });
      }
      originalCargo3Options = cargo3Select.innerHTML;
    }
    
    // ç™ºé€å…ƒæƒ…å ±ï¼ˆå†…éƒ¨ä¿æŒç”¨ï¼‰
    let currentShippingFrom = {
      name: '',
      zipcode: '',
      address: '',
      tel: ''
    };
    
    // ç™ºé€å…ƒæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹
    function displayShippingFromInfo() {
      const nameDiv = document.getElementById('shippingFromName');
      const detailDiv = document.getElementById('shippingFromDetail');
      
      if (currentShippingFrom.name) {
        nameDiv.textContent = currentShippingFrom.name;
        detailDiv.innerHTML = `
          <div>ã€’${currentShippingFrom.zipcode || '-'}</div>
          <div>${currentShippingFrom.address || '-'}</div>
          <div>TEL: ${currentShippingFrom.tel || '-'}</div>
        `;
      } else {
        nameDiv.textContent = 'ç™ºé€å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„';
        detailDiv.innerHTML = '';
      }
    }
    
    // ä¼šç¤¾æƒ…å ±ã‚’ç™ºé€å…ƒã«è¨­å®š
    function setShippingFromCompany() {
      const btn = document.getElementById('shippingFromCompanyBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'åæ˜ ä¸­...';
      
      google.script.run
        .withSuccessHandler(function(data) {
          const records = JSON.parse(data);
          if (records && records.length > 0) {
            currentShippingFrom = {
              name: records[0]['åå‰'] || '',
              zipcode: records[0]['éƒµä¾¿ç•ªå·'] || '',
              address: records[0]['ä½æ‰€'] || '',
              tel: records[0]['é›»è©±ç•ªå·'] || ''
            };
          }
          displayShippingFromInfo();
          btn.innerHTML = originalText;
        })
        .withFailureHandler(function(e) {
          showErrorToast('ä¼šç¤¾æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          btn.innerHTML = originalText;
        })
        .getCompanyRecordForShipping();
    }
    
    // é¡§å®¢æƒ…å ±ã‚’ç™ºé€å…ƒã«è¨­å®š
    function setShippingFromCustomer() {
      currentShippingFrom = {
        name: selectedCustomer.customerName || '',
        zipcode: selectedCustomer.customerZipcode || '',
        address: selectedCustomer.customerAddress || '',
        tel: selectedCustomer.customerTel || ''
      };
      displayShippingFromInfo();
    }
    
    // ç™ºé€å…ˆæƒ…å ±ã‚’ç™ºé€å…ƒã«è¨­å®š
    function setShippingFromShippingTo() {
      currentShippingFrom = {
        name: selectedShippingTo.shippingToName || '',
        zipcode: selectedShippingTo.shippingToZipcode || '',
        address: selectedShippingTo.shippingToAddress || '',
        tel: selectedShippingTo.shippingToTel || ''
      };
      displayShippingFromInfo();
    }
    
    // ç´å“æ–¹æ³•ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ã
    function onDeliveryMethodChange() {
      const selectedMethod = document.getElementById('deliveryMethodSelect').value;

      // é…é”æ™‚é–“å¸¯ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      filterSelectByDeliveryMethod('deliveryTimeSelect', originalDeliveryTimeOptions, selectedMethod);

      // é€ã‚ŠçŠ¶ç¨®åˆ¥ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      filterSelectByDeliveryMethod('invoiceTypeSelect', originalInvoiceTypeOptions, selectedMethod);

      // ã‚¯ãƒ¼ãƒ«åŒºåˆ†ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      filterSelectByDeliveryMethod('coolClsSelect', originalCoolClsOptions, selectedMethod);

      // è·æ‰±ã„ï¼‘ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      filterSelectByDeliveryMethod('cargo1Select', originalCargo1Options, selectedMethod);

      // è·æ‰±ã„ï¼’ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      filterSelectByDeliveryMethod('cargo2Select', originalCargo2Options, selectedMethod);

      // è·æ‰±ã„ï¼“ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      filterSelectByDeliveryMethod('cargo3Select', originalCargo3Options, selectedMethod);

      // ä½å·ã®å ´åˆã€è·æ‰±ã„ï¼“ã‚’è¡¨ç¤ºã—ã€è·æ‰±ã„ï¼‘ã‚’è‡ªå‹•è¨­å®š
      const cargo3Container = document.getElementById('cargo3Container');
      const cargo1Select = document.getElementById('cargo1Select');

      if (selectedMethod && selectedMethod.includes('ä½å·')) {
        cargo3Container.style.display = 'block';
        // è·æ‰±ã„ï¼‘ãŒæœªé¸æŠã®å ´åˆã€æŒ‡å®šæ—¥é…é”ã‚µãƒ¼ãƒ“ã‚¹ã‚’è‡ªå‹•è¨­å®š
        if (!cargo1Select.value) {
          cargo1Select.value = '005:æŒ‡å®šæ—¥é…é”ã‚µãƒ¼ãƒ“ã‚¹';
        }
      } else {
        cargo3Container.style.display = 'none';
        document.getElementById('cargo3Select').value = '';
      }

      // æ¡ä»¶ã«å¿œã˜ãŸè‡ªå‹•è¨­å®šã‚’å®Ÿè¡Œ
      updateCargoByConditions();
    }
    
    // ç´å“æ–¹æ³•ã«åŸºã¥ã„ã¦ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterSelectByDeliveryMethod(selectId, originalHtml, deliveryMethod) {
      const select = document.getElementById(selectId);
      select.innerHTML = originalHtml;

      // ç´å“æ–¹æ³•ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ã€ä¸€è‡´ã—ãªã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
      if (deliveryMethod) {
        Array.from(select.options).forEach(function(option, index) {
          // æœ€åˆã®ã€ŒæŒ‡å®šãªã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å¸¸ã«æ®‹ã™
          if (index === 0) return;

          const optionMethod = option.dataset.val;
          if (optionMethod && optionMethod !== deliveryMethod) {
            option.remove();
          }
        });

        // å†åº¦ãƒ«ãƒ¼ãƒ—ï¼ˆå‰Šé™¤ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãšã‚Œã‚‹ãŸã‚ï¼‰
        const toRemove = [];
        Array.from(select.options).forEach(function(option, index) {
          if (index === 0) return;
          const optionMethod = option.dataset.val;
          if (optionMethod && optionMethod !== deliveryMethod) {
            toRemove.push(option);
          }
        });
        toRemove.forEach(function(opt) { opt.remove(); });
      }
    }

    // æ¡ä»¶ã«å¿œã˜ã¦è·æ‰±ã„ã‚’è‡ªå‹•è¨­å®š
    function updateCargoByConditions() {
      const deliveryMethod = document.getElementById('deliveryMethodSelect').value;
      const invoiceType = document.getElementById('invoiceTypeSelect').value;
      const coolCls = document.getElementById('coolClsSelect').value;
      const cargo2Select = document.getElementById('cargo2Select');
      const cargo3Select = document.getElementById('cargo3Select');

      // ä½å·ã®å ´åˆã®ã¿å‡¦ç†
      if (deliveryMethod && deliveryMethod.includes('ä½å·')) {
        // ã‚¯ãƒ¼ãƒ«åŒºåˆ†ãŒå†·è”µ/å†·å‡ã®å ´åˆã€è©²å½“ã™ã‚‹ optionï¼ˆç¨®åˆ¥å€¤ã¯ã‚·ãƒ¼ãƒˆã§å¯å¤‰ã®ãŸã‚è¡¨ç¤ºã§åˆ¤å®šï¼‰ã‚’é¸æŠ
        if (coolCls && cargo2Select) {
          let targetLabel = null;
          if (coolCls.indexOf('å†·è”µ') !== -1) targetLabel = 'å†·è”µ';
          else if (coolCls.indexOf('å†·å‡') !== -1) targetLabel = 'å†·å‡';
          if (targetLabel) {
            for (let i = 0; i < cargo2Select.options.length; i++) {
              const opt = cargo2Select.options[i];
              const v = opt.value, t = opt.text;
              if (v && (t.indexOf(targetLabel) !== -1 || (v.split(':')[1] && v.split(':')[1].indexOf(targetLabel) !== -1))) {
                cargo2Select.value = v;
                break;
              }
            }
          }
        }

        // ç€æ‰•ã„ã®å ´åˆã€è·æ‰±ã„ï¼“ã«eã‚³ãƒ¬ã‚¯ãƒˆã‚’è‡ªå‹•è¨­å®š
        if (invoiceType && invoiceType.includes('ç€æ‰•')) {
          cargo3Select.value = '008:ï½…ã‚³ãƒ¬ã‚¯ãƒˆï¼ˆç¾é‡‘ï¼‰';
        }
      }
    }
    
    // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    function switchMode(mode) {
      isNewCustomerMode = (mode === 'new');
      
      document.querySelectorAll('.mode-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      if (mode === 'new') {
        document.querySelector('.mode-tab.new').classList.add('active');
        document.getElementById('existingMode').style.display = 'none';
        document.getElementById('newCustomerMode').style.display = 'block';
      } else {
        document.querySelector('.mode-tab.existing').classList.add('active');
        document.getElementById('existingMode').style.display = 'block';
        document.getElementById('newCustomerMode').style.display = 'none';
      }
    }
    
    // ç™ºé€å…ˆãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
    function loadShippingToList() {
      google.script.run
        .withSuccessHandler(function(data) {
          shippingToList = JSON.parse(data);
          hideLoading();
        })
        .withFailureHandler(function(e) {
          showErrorToast('ç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
          hideLoading();
        })
        .getShippingToListForPhoneOrder();
    }
    
    // ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’éè¡¨ç¤º
    function hideAllSuggestions() {
      document.querySelectorAll('.suggest-list').forEach(list => {
        list.classList.remove('show');
      });
    }
    
    // ç™ºé€å…ˆå…¥åŠ›æ™‚
    function onShippingToInput() {
      const query = document.getElementById('shippingToInput').value.toLowerCase();
      showShippingToSuggestions(query);
    }
    
    // ç™ºé€å…ˆã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º
    function showShippingToSuggestions(query = '') {
      const list = document.getElementById('shippingToSuggestList');
      
      let filtered = shippingToList;
      if (query) {
        filtered = shippingToList.filter(s => 
          s.shippingToName.toLowerCase().includes(query) ||
          (s.customerName && s.customerName.toLowerCase().includes(query))
        );
      }
      
      if (filtered.length === 0) {
        list.classList.remove('show');
        return;
      }
      
      let html = '';
      filtered.slice(0, 10).forEach((s, index) => {
        const badge = s.isNewCustomer ? '<span class="badge-new">æ–°è¦</span>' : '';
        const orderInfo = s.lastOrderDate ? `ğŸ“… æœ€çµ‚ç™ºé€: ${s.lastOrderDate}` : '';
        html += `
          <div class="suggest-item" onclick="selectShippingTo(${index}, '${escapeHtml(query)}')">
            <div class="name">${escapeHtml(s.shippingToName)}${badge}</div>
            <div class="info">${escapeHtml(s.customerName || '')} ${orderInfo}</div>
          </div>
        `;
      });
      
      list.innerHTML = html;
      list.classList.add('show');
    }
    
    // ç™ºé€å…ˆé¸æŠ
    function selectShippingTo(index, query) {
      let list = shippingToList;
      if (query) {
        list = shippingToList.filter(s => 
          s.shippingToName.toLowerCase().includes(query) ||
          (s.customerName && s.customerName.toLowerCase().includes(query))
        );
      }
      
      selectedShippingTo = list[index];
      
      // å…¥åŠ›æ¬„ã‚’æ›´æ–°
      document.getElementById('shippingToInput').value = selectedShippingTo.shippingToName;
      hideAllSuggestions();
      
      // é¸æŠæ¸ˆã¿è¡¨ç¤º
      document.getElementById('shippingToSelected').style.display = 'block';
      document.getElementById('shippingToSelectedName').textContent = selectedShippingTo.shippingToName;
      document.getElementById('shippingToSelectedInfo').textContent = 
        selectedShippingTo.lastOrderDate ? `æœ€çµ‚ç™ºé€æ—¥: ${selectedShippingTo.lastOrderDate}` : 'æ–°è¦';
      
      // é¡§å®¢ã‚’è‡ªå‹•å…¥åŠ›
      autoFillCustomer();
      
      updateNextButton();
    }
    
    // é¡§å®¢ã‚’è‡ªå‹•å…¥åŠ›
    function autoFillCustomer() {
      if (!selectedShippingTo) return;
      
      // ç™ºé€å…ˆã«ç´ã¥ãé¡§å®¢ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(data) {
          const customer = data ? JSON.parse(data) : null;
          if (customer && customer.customerName) {
            selectedCustomer = customer;
            document.getElementById('customerInput').value = customer.customerName;
            
            // é¸æŠæ¸ˆã¿è¡¨ç¤º
            document.getElementById('customerSelected').style.display = 'block';
            document.getElementById('customerSelectedName').textContent = customer.customerName;
            document.getElementById('customerSelectedInfo').textContent = customer.customerTel || '';
          } else if (selectedShippingTo.customerName) {
            // ç™ºé€å…ˆæƒ…å ±ã‹ã‚‰é¡§å®¢åã‚’è¨­å®š
            selectedCustomer = {
              customerName: selectedShippingTo.customerName,
              customerZipcode: selectedShippingTo.customerZipcode || '',
              customerAddress: selectedShippingTo.customerAddress || '',
              customerTel: selectedShippingTo.customerTel || ''
            };
            document.getElementById('customerInput').value = selectedShippingTo.customerName;
            document.getElementById('customerSelected').style.display = 'block';
            document.getElementById('customerSelectedName').textContent = selectedShippingTo.customerName;
            document.getElementById('customerSelectedInfo').textContent = '';
          }
          updateNextButton();
        })
        .withFailureHandler(function(e) {
          console.error('é¡§å®¢å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        })
        .getCustomerByShippingTo(selectedShippingTo.shippingToName);
    }
    
    // ç™ºé€å…ˆã‚¯ãƒªã‚¢
    function clearShippingTo() {
      selectedShippingTo = null;
      document.getElementById('shippingToInput').value = '';
      document.getElementById('shippingToSelected').style.display = 'none';
      updateNextButton();
    }
    
    // é¡§å®¢å…¥åŠ›æ™‚
    function onCustomerInput() {
      const query = document.getElementById('customerInput').value;
      if (query.length < 1) {
        hideAllSuggestions();
        return;
      }
      
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é¡§å®¢å€™è£œã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(data) {
          const customers = JSON.parse(data);
          showCustomerSuggestionsFromData(customers);
        })
        .withFailureHandler(function(e) {
          console.error('é¡§å®¢æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', e);
        })
        .getCustomerSuggestionsForPhoneOrder(query);
    }
    
    // é¡§å®¢ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º
    function showCustomerSuggestions() {
      const query = document.getElementById('customerInput').value;
      if (query.length >= 1) {
        onCustomerInput();
      }
    }
    
    function showCustomerSuggestionsFromData(customers) {
      const list = document.getElementById('customerSuggestList');
      
      if (customers.length === 0) {
        list.classList.remove('show');
        return;
      }
      
      let html = '';
      customers.forEach((c, index) => {
        html += `
          <div class="suggest-item" onclick="selectCustomerFromSuggest(${index})">
            <div class="name">${escapeHtml(c.customerName)}</div>
            <div class="info">${escapeHtml(c.customerTel || '')}</div>
          </div>
        `;
      });
      
      list.innerHTML = html;
      list.classList.add('show');
      
      // å€™è£œã‚’ä¸€æ™‚ä¿å­˜
      window._customerSuggestions = customers;
    }
    
    // é¡§å®¢é¸æŠ
    function selectCustomerFromSuggest(index) {
      const customers = window._customerSuggestions || [];
      selectedCustomer = customers[index];
      
      document.getElementById('customerInput').value = selectedCustomer.customerName;
      hideAllSuggestions();
      
      // é¸æŠæ¸ˆã¿è¡¨ç¤º
      document.getElementById('customerSelected').style.display = 'block';
      document.getElementById('customerSelectedName').textContent = selectedCustomer.customerName;
      document.getElementById('customerSelectedInfo').textContent = selectedCustomer.customerTel || '';
      
      updateNextButton();
    }
    
    // é¡§å®¢ã‚¯ãƒªã‚¢
    function clearCustomer() {
      selectedCustomer = null;
      document.getElementById('customerInput').value = '';
      document.getElementById('customerSelected').style.display = 'none';
      updateNextButton();
    }
    
    // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    function updateNextButton() {
      const btn = document.getElementById('nextBtn');
      btn.disabled = !(selectedShippingTo && selectedCustomer);
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—2ã¸é€²ã‚€ï¼ˆãƒªãƒ”ãƒ¼ã‚¿ãƒ¼ï¼‰
    function proceedToStep2() {
      if (!selectedShippingTo || !selectedCustomer) return;
      
      // ç™ºé€å…ˆãƒ»é¡§å®¢ã‚’è¡¨ç¤º
      document.getElementById('step2ShippingTo').textContent = 'ğŸ“¦ ' + selectedShippingTo.shippingToName;
      document.getElementById('step2Customer').textContent = 'ğŸ‘¤ ' + selectedCustomer.customerName;
      
      // éå»æ³¨æ–‡ã‚’å–å¾—
      showLoading('éå»ã®æ³¨æ–‡ã‚’å–å¾—ä¸­...');
      google.script.run
        .withSuccessHandler(function(data) {
          lastOrder = data ? JSON.parse(data) : null;
          setupProductList();
          goToStep(2);
          hideLoading();
        })
        .withFailureHandler(function(e) {
          console.error('éå»æ³¨æ–‡å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          lastOrder = null;
          setupProductList();
          goToStep(2);
          hideLoading();
        })
        .getRecentOrderForTemplate(selectedShippingTo.shippingToName);
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—2ã¸é€²ã‚€ï¼ˆæ–°è¦é¡§å®¢ï¼‰
    function proceedToStep2NewCustomer() {
      const shippingToName = document.getElementById('newShippingToName').value.trim();
      const shippingToCompany = document.getElementById('newShippingToCompany').value.trim();
      const phone = document.getElementById('newPhone').value.trim();
      
      if (!shippingToName) {
        showWarningToast('ç™ºé€å…ˆåï¼ˆæ°åï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (!phone) {
        showWarningToast('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // ç™ºé€å…ˆæƒ…å ±
      const shippingToZipcode = normalizeZipcode(document.getElementById('newShippingToZipcode').value);
      const shippingToAddress = document.getElementById('newShippingToAddress').value.trim();
      const shippingToTel = normalizePhone(phone);
      
      // é¡§å®¢æƒ…å ±ï¼ˆç•°ãªã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§åˆ¤å®šï¼‰
      const customerDifferent = document.getElementById('customerDifferent').checked;
      let customerName, customerCompany, customerZipcode, customerAddress, customerTel;
      
      if (customerDifferent) {
        customerName = document.getElementById('newCustomerName').value.trim() || shippingToName;
        customerCompany = document.getElementById('newCustomerCompany').value.trim() || shippingToCompany;
        customerZipcode = normalizeZipcode(document.getElementById('newCustomerZipcode').value);
        customerAddress = document.getElementById('newCustomerAddress').value.trim();
        customerTel = normalizePhone(document.getElementById('newCustomerPhone').value) || shippingToTel;
      } else {
        // ç™ºé€å…ˆã¨åŒã˜
        customerName = shippingToName;
        customerCompany = shippingToCompany;
        customerZipcode = shippingToZipcode;
        customerAddress = shippingToAddress;
        customerTel = shippingToTel;
      }
      
      selectedShippingTo = {
        shippingToName: shippingToName,
        shippingToCompany: shippingToCompany,
        shippingToTel: shippingToTel,
        shippingToZipcode: shippingToZipcode,
        shippingToAddress: shippingToAddress,
        isNewCustomer: true
      };
      
      selectedCustomer = {
        customerName: customerName,
        customerCompany: customerCompany,
        customerTel: customerTel,
        customerZipcode: customerZipcode,
        customerAddress: customerAddress
      };
      
      // ç™ºé€å…ˆãƒ»é¡§å®¢ã‚’è¡¨ç¤ºï¼ˆä¼šç¤¾åãŒã‚ã‚‹å ´åˆã¯ä½µè¨˜ï¼‰
      const shippingToDisplay = shippingToCompany ? shippingToCompany + ' / ' + shippingToName : shippingToName;
      const customerDisplay = customerCompany ? customerCompany + ' / ' + customerName : customerName;
      document.getElementById('step2ShippingTo').textContent = 'ğŸ“¦ ' + shippingToDisplay + ' ğŸ†•';
      document.getElementById('step2Customer').textContent = 'ğŸ‘¤ ' + customerDisplay;
      
      lastOrder = null;
      setupProductList();
      goToStep(2);
    }
    
    // é¡§å®¢æƒ…å ±å…¥åŠ›ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleCustomerFields() {
      const customerDifferent = document.getElementById('customerDifferent').checked;
      document.getElementById('customerFieldsArea').style.display = customerDifferent ? 'block' : 'none';
    }
    
    // é¸æŠæ¸ˆã¿å•†å“ãƒªã‚¹ãƒˆï¼ˆæœ€å¤§10å€‹ï¼‰
    let selectedProducts = [];
    
    // å•†å“ãƒªã‚¹ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupProductList() {
      // é¸æŠæ¸ˆã¿å•†å“ã‚’ãƒªã‚»ãƒƒãƒˆ
      selectedProducts = [];
      
      // ã€Œå‰å›ã¨åŒã˜ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤º
      const sameAsLastBtn = document.getElementById('sameAsLastBtn');
      if (lastOrder && lastOrder.items && lastOrder.items.length > 0) {
        sameAsLastBtn.style.display = 'block';
        sameAsLastBtn.innerHTML = `ğŸ”„ å‰å›ã¨åŒã˜æ³¨æ–‡<br><small style="font-size: 0.8rem;">(${lastOrder.shippingDate} - ${lastOrder.items.length}å“ç›®)</small>`;
        
        // éå»æ³¨æ–‡ã®å•†å“ã‚’é¸æŠæ¸ˆã¿ã«è¿½åŠ 
        lastOrder.items.forEach(function(item) {
          if (selectedProducts.length < 10) {
            selectedProducts.push({
              name: item.productName,
              price: item.price,
              quantity: item.quantity,
              category: item.productCategory || ''
            });
          }
        });
      } else {
        sameAsLastBtn.style.display = 'none';
      }
      
      // åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
      setupCategoryFilters();
      
      // é¸æŠæ¸ˆã¿å•†å“ã‚’è¡¨ç¤º
      renderSelectedProducts();
      
      // è¿½åŠ å¯èƒ½ãªå•†å“ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
      renderAddProductList();
      
      // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('productSearchInput').value = '';
      selectedCategory = null;
      
      updateTotal();
    }
    
    // é¸æŠæ¸ˆã¿å•†å“ã‚’è¡¨ç¤º
    function renderSelectedProducts() {
      const container = document.getElementById('selectedProductList');
      const noProductsMessage = document.getElementById('noProductsMessage');
      const countLabel = document.getElementById('selectedCount');
      
      countLabel.textContent = `(${selectedProducts.length}/10)`;
      
      if (selectedProducts.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3" id="noProductsMessage">å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
        return;
      }
      
      let html = '';
      selectedProducts.forEach(function(item, index) {
        const price = Number(item.price) || 0;
        const quantity = Number(item.quantity) || 1;
        const subtotal = price * quantity;
        
        html += `
          <div class="selected-product-card" data-index="${index}">
            <div class="product-header">
              <div class="product-name" style="font-weight: 600; flex: 1;">${escapeHtml(item.name)}</div>
              <button type="button" class="delete-btn" onclick="removeSelectedProduct(${index})">âœ•</button>
            </div>
            <div class="product-controls">
              <div style="display: flex; align-items: center; gap: 4px;">
                <span style="font-size: 0.8rem; color: #666;">Â¥</span>
                <input type="number" class="price-input" value="${price}" min="0" onchange="updateSelectedPrice(${index}, this.value)">
              </div>
              <div style="display: flex; align-items: center; gap: 4px;">
                <span style="font-size: 0.8rem; color: #666;">Ã—</span>
                <button type="button" class="qty-btn qty-btn-minus" onclick="changeSelectedQty(${index}, -1)">âˆ’</button>
                <input type="number" class="qty-input" value="${quantity}" min="1" onchange="updateSelectedQty(${index}, this.value)" style="width: 50px;">
                <button type="button" class="qty-btn qty-btn-plus" onclick="changeSelectedQty(${index}, 1)">+</button>
              </div>
              <div style="font-weight: 600; color: #28a745; min-width: 70px; text-align: right;">
                Â¥${subtotal.toLocaleString()}
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // é¸æŠæ¸ˆã¿å•†å“ã®ä¾¡æ ¼ã‚’æ›´æ–°
    function updateSelectedPrice(index, value) {
      const item = selectedProducts[index];
      if (!item) return;
      
      item.price = Math.max(0, parseInt(value) || 0);
      renderSelectedProducts();
      updateTotal();
    }
    
    // è¿½åŠ å¯èƒ½ãªå•†å“ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    function renderAddProductList() {
      const container = document.getElementById('productList');
      
      // æ—¢ã«é¸æŠæ¸ˆã¿ã®å•†å“åã‚’å–å¾—
      const selectedNames = new Set(selectedProducts.map(p => p.name));
      
      let html = '';
      products.forEach(function(p) {
        const isSelected = selectedNames.has(p['å•†å“å']);
        const isMaxReached = selectedProducts.length >= 10;
        const disabled = isSelected || isMaxReached;
        const price = Number(p['ä¾¡æ ¼ï¼ˆP)']) || 0;
        
        html += `
          <div class="add-product-card ${disabled ? 'disabled' : ''}" 
               data-product="${escapeHtml(p['å•†å“å'])}" 
               data-price="${price}" 
               data-category="${escapeHtml(p['åˆ†é¡'] || '')}"
               onclick="${disabled ? '' : 'addProduct(this)'}">
            <div>
              <div style="font-weight: 500;">
                ${p['åˆ†é¡'] ? `<span class="badge bg-secondary" style="font-size: 0.7rem;">${escapeHtml(p['åˆ†é¡'])}</span> ` : ''}${escapeHtml(p['å•†å“å'])}
              </div>
              <div style="font-size: 0.85rem; color: #666;">Â¥${price.toLocaleString()}</div>
            </div>
            <div class="add-btn">${isSelected ? 'âœ“' : '+'}</div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // å•†å“ã‚’è¿½åŠ 
    function addProduct(element) {
      if (selectedProducts.length >= 10) {
        showWarningToast('å•†å“ã¯æœ€å¤§10å€‹ã¾ã§ã§ã™');
        return;
      }
      
      const name = element.dataset.product;
      const price = parseInt(element.dataset.price) || 0;
      const category = element.dataset.category || '';
      
      // æ—¢ã«é¸æŠæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
      if (selectedProducts.some(p => p.name === name)) {
        return;
      }
      
      selectedProducts.push({
        name: name,
        price: price,
        quantity: 1,
        category: category
      });
      
      renderSelectedProducts();
      renderAddProductList();
      updateTotal();
    }
    
    // é¸æŠæ¸ˆã¿å•†å“ã®æ•°é‡å¤‰æ›´
    function changeSelectedQty(index, delta) {
      const item = selectedProducts[index];
      if (!item) return;
      
      item.quantity = Math.max(1, item.quantity + delta);
      renderSelectedProducts();
      updateTotal();
    }
    
    // é¸æŠæ¸ˆã¿å•†å“ã®æ•°é‡ã‚’ç›´æ¥æ›´æ–°
    function updateSelectedQty(index, value) {
      const item = selectedProducts[index];
      if (!item) return;
      
      item.quantity = Math.max(1, parseInt(value) || 1);
      renderSelectedProducts();
      updateTotal();
    }
    
    // é¸æŠæ¸ˆã¿å•†å“ã‚’å‰Šé™¤
    function removeSelectedProduct(index) {
      selectedProducts.splice(index, 1);
      renderSelectedProducts();
      renderAddProductList();
      updateTotal();
    }
    
    // åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
    function setupCategoryFilters() {
      const categories = new Set();
      products.forEach(function(p) {
        if (p['åˆ†é¡']) {
          categories.add(p['åˆ†é¡']);
        }
      });
      
      if (categories.size === 0) {
        document.getElementById('categoryFilterArea').innerHTML = '';
        return;
      }
      
      let html = '<div class="d-flex flex-wrap gap-1">';
      html += '<button type="button" class="btn btn-sm btn-primary category-filter-btn active" data-category="" onclick="filterByCategory(this, \'\')">ã™ã¹ã¦</button>';
      
      categories.forEach(function(cat) {
        html += `<button type="button" class="btn btn-sm btn-outline-secondary category-filter-btn" data-category="${escapeHtml(cat)}" onclick="filterByCategory(this, '${escapeHtml(cat)}')">${escapeHtml(cat)}</button>`;
      });
      
      html += '</div>';
      document.getElementById('categoryFilterArea').innerHTML = html;
    }
    
    // åˆ†é¡ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterByCategory(btn, category) {
      // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.category-filter-btn').forEach(function(b) {
        b.classList.remove('active', 'btn-primary');
        b.classList.add('btn-outline-secondary');
      });
      btn.classList.remove('btn-outline-secondary');
      btn.classList.add('active', 'btn-primary');
      
      selectedCategory = category || null;
      filterProducts();
    }
    
    // å•†å“ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆè¿½åŠ å¯èƒ½å•†å“ãƒªã‚¹ãƒˆã®ã¿ï¼‰
    function filterProducts() {
      const searchText = document.getElementById('productSearchInput').value.toLowerCase().trim();
      
      document.querySelectorAll('#productList .add-product-card').forEach(function(card) {
        const productName = (card.dataset.product || '').toLowerCase();
        const category = (card.dataset.category || '').toLowerCase();
        
        let matchSearch = true;
        let matchCategory = true;
        
        // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
        if (searchText) {
          matchSearch = productName.includes(searchText) || category.includes(searchText);
        }
        
        // åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (selectedCategory) {
          matchCategory = category === selectedCategory.toLowerCase();
        }
        
        card.style.display = (matchSearch && matchCategory) ? 'flex' : 'none';
      });
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
    }
    
    // éƒµä¾¿ç•ªå·ã‹ã‚‰ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»ã—ã¦æ•°å­—ã®ã¿ã«ã™ã‚‹
    function normalizeZipcode(zipcode) {
      return zipcode ? zipcode.replace(/[^0-9]/g, '') : '';
    }
    
    // é›»è©±ç•ªå·ã‹ã‚‰ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»ã—ã¦æ•°å­—ã®ã¿ã«ã™ã‚‹
    function normalizePhone(phone) {
      return phone ? phone.replace(/[^0-9]/g, '') : '';
    }
    
    // éƒµä¾¿ç•ªå·ã‹ã‚‰ä½æ‰€ã‚’æ¤œç´¢
    function searchAddressByZipcode(type) {
      let zipcodeInput, addressInput;
      
      if (type === 'customer') {
        zipcodeInput = document.getElementById('newCustomerZipcode');
        addressInput = document.getElementById('newCustomerAddress');
      } else {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç™ºé€å…ˆ
        zipcodeInput = document.getElementById('newShippingToZipcode');
        addressInput = document.getElementById('newShippingToAddress');
      }
      
      const zipcode = zipcodeInput.value.replace(/[^0-9]/g, '');
      
      if (!zipcode || zipcode.length !== 7) {
        showWarningToast('éƒµä¾¿ç•ªå·ã‚’7æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // zipcloud API ã‚’ä½¿ç”¨ï¼ˆç„¡æ–™ï¼‰
      const url = 'https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + zipcode;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.status === 200 && data.results && data.results.length > 0) {
            const result = data.results[0];
            const address = result.address1 + result.address2 + result.address3;
            addressInput.value = address;
          } else {
            showInfoToast('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
          }
        })
        .catch(error => {
          console.error('ä½æ‰€æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
          showErrorToast('ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
    }
    
    // åˆè¨ˆæ›´æ–°
    function updateTotal() {
      let total = 0;
      selectedProducts.forEach(function(item) {
        total += item.price * item.quantity;
      });
      document.getElementById('totalAmount').textContent = 'Â¥' + total.toLocaleString();
    }
    
    // å‰å›ã¨åŒã˜
    function applySameAsLast() {
      if (!lastOrder || !lastOrder.items) return;
      
      // é¸æŠæ¸ˆã¿å•†å“ã‚’ã‚¯ãƒªã‚¢
      selectedProducts = [];
      
      // å‰å›ã®å•†å“ã‚’è¿½åŠ 
      lastOrder.items.forEach(function(item) {
        if (selectedProducts.length < 10) {
          selectedProducts.push({
            name: item.productName,
            price: item.price,
            quantity: item.quantity,
            category: item.productCategory || ''
          });
        }
      });
      
      renderSelectedProducts();
      renderAddProductList();
      updateTotal();
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—é·ç§»
    function goToStep(step) {
      // ã‚¹ãƒ†ãƒƒãƒ—3ï¼ˆç™ºé€æƒ…å ±ï¼‰ã«ç§»å‹•æ™‚ã¯å•†å“ãƒã‚§ãƒƒã‚¯
      if (step === 3) {
        if (selectedProducts.length === 0) {
          showWarningToast('å•†å“ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        prepareStep3();
      }
      
      // ã‚¹ãƒ†ãƒƒãƒ—4ï¼ˆç¢ºèªç”»é¢ï¼‰ã«ç§»å‹•æ™‚ã¯ç¢ºèªå†…å®¹ã‚’è¡¨ç¤º
      if (step === 4) {
        prepareConfirmation();
      }
      
      // ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºã‚’æ›´æ–°
      for (let i = 1; i <= 4; i++) {
        const dot = document.getElementById('phase' + i);
        dot.classList.remove('active', 'completed');
        if (i < step) {
          dot.classList.add('completed');
        } else if (i === step) {
          dot.classList.add('active');
        }
      }
      
      // ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆ‡ã‚Šæ›¿ãˆ
      for (let i = 1; i <= 4; i++) {
        const container = document.getElementById('step' + i);
        container.classList.remove('active');
        if (i === step) {
          container.classList.add('active');
        }
      }
      
      // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      window.scrollTo(0, 0);
    }
    
    // ã‚¹ãƒ†ãƒƒãƒ—3ï¼ˆç™ºé€æƒ…å ±ï¼‰ã®æº–å‚™
    function prepareStep3() {
      // ç™ºé€å…ˆãƒ»é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º
      document.getElementById('step3ShippingTo').textContent = selectedShippingTo.shippingToName;
      document.getElementById('step3Customer').textContent = selectedCustomer.customerName;
      
      // å•†å“ã‚µãƒãƒªã‚’è¡¨ç¤º
      let productSummary = selectedProducts.map(function(item) {
        return item.name + ' x' + item.quantity;
      }).join('ã€');
      document.getElementById('step3ProductSummary').textContent = productSummary || '-';
      
      // åˆè¨ˆé‡‘é¡ã‚’è¡¨ç¤º
      let total = 0;
      selectedProducts.forEach(function(item) {
        total += item.price * item.quantity;
      });
      document.getElementById('step3TotalAmount').textContent = 'Â¥' + total.toLocaleString();
    }
    
    // ç¢ºèªç”»é¢ã®æº–å‚™
    function prepareConfirmation() {
      // ç™ºé€å…ƒæƒ…å ±
      document.getElementById('confirmShippingFrom').textContent = 
        currentShippingFrom.name || '-';
      
      // ç™ºé€å…ˆãƒ»é¡§å®¢æƒ…å ±
      document.getElementById('confirmShippingTo').textContent = selectedShippingTo.shippingToName;
      document.getElementById('confirmCustomer').textContent = selectedCustomer.customerName;
      
      // æ—¥ç¨‹
      document.getElementById('confirmShippingDate').textContent = document.getElementById('shippingDateInput').value;
      document.getElementById('confirmDeliveryDate').textContent = document.getElementById('deliveryDateInput').value;
      
      // é…é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º
      const deliveryMethodSelect = document.getElementById('deliveryMethodSelect');
      const deliveryTimeSelect = document.getElementById('deliveryTimeSelect');
      const invoiceTypeSelect = document.getElementById('invoiceTypeSelect');
      const coolClsSelect = document.getElementById('coolClsSelect');
      const cargo1Select = document.getElementById('cargo1Select');
      const cargo2Select = document.getElementById('cargo2Select');
      
      document.getElementById('confirmDeliveryMethod').textContent = 
        deliveryMethodSelect.options[deliveryMethodSelect.selectedIndex]?.text || '-';
      document.getElementById('confirmDeliveryTime').textContent = 
        deliveryTimeSelect.options[deliveryTimeSelect.selectedIndex]?.text || 'æŒ‡å®šãªã—';
      document.getElementById('confirmInvoiceType').textContent = 
        invoiceTypeSelect.options[invoiceTypeSelect.selectedIndex]?.text || 'æŒ‡å®šãªã—';
      document.getElementById('confirmCoolCls').textContent = 
        coolClsSelect.options[coolClsSelect.selectedIndex]?.text || 'æŒ‡å®šãªã—';
      document.getElementById('confirmCargo1').textContent =
        cargo1Select.options[cargo1Select.selectedIndex]?.text || 'æŒ‡å®šãªã—';
      document.getElementById('confirmCargo2').textContent =
        cargo2Select.options[cargo2Select.selectedIndex]?.text || 'æŒ‡å®šãªã—';

      // è·æ‰±ã„ï¼“ï¼ˆä½å·ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰
      const cargo3Select = document.getElementById('cargo3Select');
      const confirmCargo3Area = document.getElementById('confirmCargo3Area');
      if (deliveryMethodSelect.value && deliveryMethodSelect.value.includes('ä½å·') && cargo3Select.value) {
        document.getElementById('confirmCargo3').textContent =
          cargo3Select.options[cargo3Select.selectedIndex]?.text || 'æŒ‡å®šãªã—';
        confirmCargo3Area.style.display = 'block';
      } else {
        confirmCargo3Area.style.display = 'none';
      }
      
      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤º
      const checklistItems = [];
      if (document.getElementById('checkDeliverySlip').checked) checklistItems.push('ç´å“æ›¸');
      if (document.getElementById('checkInvoice').checked) checklistItems.push('è«‹æ±‚æ›¸');
      if (document.getElementById('checkReceipt').checked) checklistItems.push('é ˜åæ›¸');
      if (document.getElementById('checkPamphlet').checked) checklistItems.push('ãƒ‘ãƒ³ãƒ•');
      if (document.getElementById('checkRecipe').checked) checklistItems.push('ãƒ¬ã‚·ãƒ”');
      
      const confirmChecklistArea = document.getElementById('confirmChecklistArea');
      if (checklistItems.length > 0) {
        document.getElementById('confirmChecklist').textContent = checklistItems.join('ã€');
        confirmChecklistArea.style.display = 'block';
      } else {
        confirmChecklistArea.style.display = 'none';
      }
      
      // ãƒ¡ãƒ¢è¡¨ç¤º
      const memo = document.getElementById('orderMemoInput').value.trim();
      const confirmMemoArea = document.getElementById('confirmMemoArea');
      if (memo) {
        document.getElementById('confirmMemo').textContent = memo;
        confirmMemoArea.style.display = 'block';
      } else {
        confirmMemoArea.style.display = 'none';
      }
      
      // è¦ç¢ºèªãƒ•ãƒ©ã‚°
      const needsConfirmation = isNewCustomerMode && document.getElementById('needsConfirmation').checked;
      document.getElementById('confirmNeedsConfirmation').style.display = needsConfirmation ? 'block' : 'none';
      
      // å•†å“ãƒªã‚¹ãƒˆ
      let html = '';
      let total = 0;
      const orderItems = [];
      
      selectedProducts.forEach(function(item) {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        orderItems.push({ productName: item.name, quantity: item.quantity, price: item.price });
        
        html += `
          <div class="product-card">
            <div class="product-info">
              <div class="product-name">${escapeHtml(item.name)}</div>
              <div class="product-price">Â¥${item.price.toLocaleString()} Ã— ${item.quantity}</div>
            </div>
            <div class="fw-bold" style="color: #28a745;">Â¥${subtotal.toLocaleString()}</div>
          </div>
        `;
      });
      
      if (selectedProducts.length === 0) {
        html = '<div class="text-center text-muted py-3">å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
      }
      
      document.getElementById('confirmProductList').innerHTML = html;
      document.getElementById('confirmTotalAmount').textContent = 'Â¥' + total.toLocaleString();
      
      // éå»æ³¨æ–‡ã¨ã®æ¯”è¼ƒãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒ”ãƒ¼ã‚¿ãƒ¼ã®å ´åˆã®ã¿ï¼‰
      if (!isNewCustomerMode && orderItems.length > 0) {
        google.script.run
          .withSuccessHandler(function(result) {
            const checkResult = JSON.parse(result);
            renderWarnings(checkResult);
          })
          .withFailureHandler(function(e) {
            console.error('æ¯”è¼ƒãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', e);
          })
          .checkOrderAgainstHistory(selectedShippingTo.shippingToName, orderItems);
      } else {
        document.getElementById('warningArea').innerHTML = '';
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã®hidden fieldsã‚’è¨­å®š
      prepareOrderForm(orderItems, total);
    }
    
    // è­¦å‘Šè¡¨ç¤º
    function renderWarnings(checkResult) {
      const warningArea = document.getElementById('warningArea');
      
      if (!checkResult.hasWarnings) {
        warningArea.innerHTML = '';
        return;
      }
      
      let html = `
        <div class="alert alert-warning mt-3" role="alert">
          <div class="d-flex align-items-center mb-2">
            <span class="me-2" style="font-size: 1.5rem;">âš ï¸</span>
            <strong>ç¢ºèªãŒå¿…è¦ãªç‚¹ãŒã‚ã‚Šã¾ã™</strong>
          </div>
          <ul class="mb-0 ps-3">
      `;
      
      checkResult.warnings.forEach(function(w) {
        let className = 'text-warning';
        let icon = 'ğŸ“¦';
        
        if (w.type === 'quantity') {
          className = 'text-danger';
          icon = 'ğŸ“Š';
        } else if (w.type === 'new') {
          className = 'text-info';
          icon = 'ğŸ†•';
        }
        
        html += `<li class="${className}"><strong>${icon}</strong> ${w.message}</li>`;
      });
      
      html += `
          </ul>
        </div>
      `;
      
      warningArea.innerHTML = html;
    }
    
    // æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ã®æº–å‚™
    function prepareOrderForm(orderItems, total) {
      const form = document.getElementById('orderForm');
      
      // æ—¢å­˜ã®hidden fieldsã‚’ã‚¯ãƒªã‚¢
      const existingHiddens = form.querySelectorAll('input[type="hidden"]:not([name="shippingSubmit"])');
      existingHiddens.forEach(function(el) { el.remove(); });
      
      // ç™ºé€å…ˆæƒ…å ±
      addHiddenField(form, 'shippingToName', selectedShippingTo.shippingToName);
      addHiddenField(form, 'shippingToCompany', selectedShippingTo.shippingToCompany || '');
      addHiddenField(form, 'shippingToZipcode', selectedShippingTo.shippingToZipcode || '');
      addHiddenField(form, 'shippingToAddress', selectedShippingTo.shippingToAddress || '');
      addHiddenField(form, 'shippingToTel', selectedShippingTo.shippingToTel || '');
      
      // é¡§å®¢æƒ…å ±
      addHiddenField(form, 'customerName', selectedCustomer.customerName);
      addHiddenField(form, 'customerCompany', selectedCustomer.customerCompany || '');
      addHiddenField(form, 'customerZipcode', selectedCustomer.customerZipcode || '');
      addHiddenField(form, 'customerAddress', selectedCustomer.customerAddress || '');
      addHiddenField(form, 'customerTel', selectedCustomer.customerTel || '');
      
      // ç™ºé€å…ƒæƒ…å ±
      addHiddenField(form, 'shippingFromName', currentShippingFrom.name || '');
      addHiddenField(form, 'shippingFromZipcode', currentShippingFrom.zipcode || '');
      addHiddenField(form, 'shippingFromAddress', currentShippingFrom.address || '');
      addHiddenField(form, 'shippingFromTel', currentShippingFrom.tel || '');
      
      // æ—¥ç¨‹
      addHiddenField(form, 'shippingDate1', document.getElementById('shippingDateInput').value);
      addHiddenField(form, 'deliveryDate1', document.getElementById('deliveryDateInput').value);
      
      // å—ä»˜æ–¹æ³•
      addHiddenField(form, 'receiptWay', 'é›»è©±');
      addHiddenField(form, 'recipient', '');
      
      // ç´å“æ–¹æ³•ï¼ˆé¸æŠå€¤ã‚’ä½¿ç”¨ï¼‰
      const deliveryMethodSelect = document.getElementById('deliveryMethodSelect');
      const deliveryTimeSelect = document.getElementById('deliveryTimeSelect');
      const invoiceTypeSelect = document.getElementById('invoiceTypeSelect');
      const coolClsSelect = document.getElementById('coolClsSelect');
      const cargo1Select = document.getElementById('cargo1Select');
      const cargo2Select = document.getElementById('cargo2Select');
      
      const deliveryMethod = deliveryMethodSelect.value || 'ãƒ¤ãƒãƒˆ';
      
      // createOrderã§split(":")[1]ã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€ã€Œå€¤:è¡¨ç¤ºåã€ã®å½¢å¼ã§é€ä¿¡
      const deliveryTimeVal = deliveryTimeSelect.value || '';
      const deliveryTimeText = deliveryTimeSelect.options[deliveryTimeSelect.selectedIndex]?.text || '';
      const deliveryTime = deliveryTimeVal ? deliveryTimeVal + ':' + deliveryTimeText : '';
      
      const invoiceTypeVal = invoiceTypeSelect.value || '';
      const invoiceTypeText = invoiceTypeSelect.options[invoiceTypeSelect.selectedIndex]?.text || '';
      const invoiceType = invoiceTypeVal ? invoiceTypeVal + ':' + invoiceTypeText : '';
      
      const coolClsVal = coolClsSelect.value || '';
      const coolClsText = coolClsSelect.options[coolClsSelect.selectedIndex]?.text || '';
      const coolCls = coolClsVal ? coolClsVal + ':' + coolClsText : '';
      
      const cargo1Val = cargo1Select.value || '';
      const cargo1Text = cargo1Select.options[cargo1Select.selectedIndex]?.text || '';
      const cargo1 = cargo1Val ? cargo1Val + ':' + cargo1Text : '';
      
      const cargo2Val = cargo2Select.value || '';
      const cargo2Text = cargo2Select.options[cargo2Select.selectedIndex]?.text || '';
      const cargo2 = cargo2Val ? cargo2Val + ':' + cargo2Text : '';

      const cargo3Select = document.getElementById('cargo3Select');
      const cargo3Val = cargo3Select.value || '';
      const cargo3Text = cargo3Select.options[cargo3Select.selectedIndex]?.text || '';
      const cargo3 = cargo3Val ? cargo3Val + ':' + cargo3Text : '';

      addHiddenField(form, 'deliveryMethod', deliveryMethod);
      addHiddenField(form, 'deliveryTime', deliveryTime);
      
      // å•†å“æƒ…å ±
      let rowNum = 0;
      let sendProduct = 'é£Ÿå“'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      
      orderItems.forEach(function(item) {
        rowNum++;
        let bunrui = '';
        let abbreviation = '';
        for (let i = 0; i < products.length; i++) {
          if (products[i]['å•†å“å'] === item.productName) {
            bunrui = products[i]['å•†å“åˆ†é¡'] || '';
            abbreviation = products[i]['ç•¥ç§°'] || products[i]['å•†å“å'] || '';
            break;
          }
        }
        
        // æœ€åˆã®å•†å“ã®ç•¥ç§°ã‚’å“åã¨ã—ã¦ä½¿ç”¨
        if (rowNum === 1 && abbreviation) {
          sendProduct = abbreviation;
        }
        
        addHiddenField(form, 'bunrui' + rowNum, bunrui);
        addHiddenField(form, 'product' + rowNum, item.productName);
        addHiddenField(form, 'price' + rowNum, item.price);
        addHiddenField(form, 'quantity' + rowNum, item.quantity);
      });
      
      // ç™ºé€æƒ…å ±
      addHiddenField(form, 'sendProduct', sendProduct);
      addHiddenField(form, 'invoiceType', invoiceType);
      addHiddenField(form, 'coolCls', coolCls);
      addHiddenField(form, 'cargo1', cargo1);
      addHiddenField(form, 'cargo2', cargo2);
      addHiddenField(form, 'cargo3', cargo3);
      
      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸé …ç›®ã®ã¿é€ä¿¡ï¼‰
      const checklistItems = [];
      if (document.getElementById('checkDeliverySlip').checked) checklistItems.push('ç´å“æ›¸');
      if (document.getElementById('checkInvoice').checked) checklistItems.push('è«‹æ±‚æ›¸');
      if (document.getElementById('checkReceipt').checked) checklistItems.push('é ˜åæ›¸');
      if (document.getElementById('checkPamphlet').checked) checklistItems.push('ãƒ‘ãƒ³ãƒ•');
      if (document.getElementById('checkRecipe').checked) checklistItems.push('ãƒ¬ã‚·ãƒ”');
      
      checklistItems.forEach(function(item) {
        addHiddenField(form, 'checklist', item);
      });
      
      // ãƒ¡ãƒ¢æ¬„
      let memoText = document.getElementById('orderMemoInput').value.trim();
      
      // è¦ç¢ºèªãƒ•ãƒ©ã‚°ï¼ˆãƒ¡ãƒ¢ã«è¿½è¨˜ï¼‰
      if (isNewCustomerMode && document.getElementById('needsConfirmation').checked) {
        const flagText = 'ã€è¦ç¢ºèªã€‘é›»è©±å—æ³¨ï¼ˆæ–°è¦é¡§å®¢ï¼‰- è©³ç´°æƒ…å ±ã®å…¥åŠ›ãŒå¿…è¦ã§ã™';
        memoText = memoText ? flagText + '\n' + memoText : flagText;
      }
      
      if (memoText) {
        addHiddenField(form, 'memo', memoText);
      }
      
      // æ–°è¦é¡§å®¢ãƒ•ãƒ©ã‚°ï¼ˆãƒã‚¹ã‚¿ç™»éŒ²ç”¨ï¼‰
      if (isNewCustomerMode) {
        addHiddenField(form, 'isNewCustomer', 'true');
      }
    }
    
    function addHiddenField(form, name, value) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      form.appendChild(input);
    }
  </script>
  
  <?!= HtmlService.createHtmlOutputFromFile('keyCheck').getContent(); ?>
</body>

</html>
