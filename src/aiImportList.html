<!-- 
  AIå–è¾¼ä¸€è¦§ - ä»®å—æ³¨ç®¡ç†ç”»é¢
  
  æ©Ÿèƒ½:
  - LINE BotçµŒç”±ã§å–ã‚Šè¾¼ã¾ã‚ŒãŸä»®å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€è¦§è¡¨ç¤º
  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šæœªå‡¦ç† / å´ä¸‹
  - ã€Œå—æ³¨å‡¦ç†ã¸ã€ã§å—æ³¨ç”»é¢ã¸é·ç§» â†’ å—æ³¨å®Œäº†ã§ä»®å—æ³¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
  - ã€Œå´ä¸‹ã€ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  - å´ä¸‹ãƒ‡ãƒ¼ã‚¿ï¼šå‰Šé™¤ or å†ç™»éŒ²
  - æœªå‡¦ç†ä»¶æ•°ãƒãƒƒã‚¸è¡¨ç¤º
-->

<!DOCTYPE html>
<html lang="ja">
<head>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIå–è¾¼ä¸€è¦§</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <style>
    body {
      background-color: var(--bg-body);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      border: none;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow);
    }

    .card-header {
      background: var(--gradient-purple);
      color: white;
      border-radius: var(--radius-md) var(--radius-md) 0 0 !important;
      padding: var(--space-4) var(--space-5);
    }

    .card-header h1 {
      font-size: 1.25rem;
      margin: 0;
      font-weight: 600;
    }

    /* æœªå‡¦ç†ä»¶æ•°ãƒãƒƒã‚¸ */
    .pending-badge {
      background: var(--status-error);
      color: white;
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: 0.875rem;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* ã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .summary-section {
      padding: 16px 20px;
      background: #fff;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .summary-card {
      flex: 1;
      min-width: 120px;
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius);
      text-align: center;
    }

    .summary-card.pending {
      background: linear-gradient(135deg, var(--status-warning-light) 0%, #ffeaa7 100%);
      border: 1px solid var(--status-warning);
    }

    .summary-card.processed {
      background: linear-gradient(135deg, var(--status-success-light) 0%, #c3e6cb 100%);
      border: 1px solid var(--status-success);
    }

    .summary-card.rejected {
      background: linear-gradient(135deg, var(--status-error-light) 0%, #f5c6cb 100%);
      border: 1px solid var(--status-error);
    }

    .summary-card .count {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .summary-card .label {
      font-size: 0.75rem;
      color: #666;
    }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .filter-section {
      padding: 12px 20px;
      background: #fff;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .table-section {
      padding: 16px 20px;
      background: #fff;
    }

    /* ã‚«ãƒ¼ãƒ‰å½¢å¼ã®ä¸€è¦§ - .card-unifiedã‚’ä½¿ç”¨ */
    .card-unified {
      margin-bottom: 16px;
      position: relative;
    }

    .card-unified.pending {
      border-left: 4px solid var(--status-warning);
    }

    .card-unified.processed {
      border-left: 4px solid var(--status-success);
      opacity: 0.7;
    }

    .card-unified.rejected {
      border-left: 4px solid var(--status-error);
      opacity: 0.5;
    }

    .card-unified-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }

    .import-card-id {
      font-size: 0.75rem;
      color: #666;
      font-family: monospace;
    }

    .import-card-time {
      font-size: 0.8rem;
      color: #888;
    }

    .import-card-status {
      padding: var(--space-1) 10px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-pending {
      background: var(--status-warning-light);
      color: #856404;
    }

    .status-processed {
      background: var(--status-success-light);
      color: #155724;
    }

    .status-rejected {
      background: var(--status-error-light);
      color: #721c24;
    }

    .import-card-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 576px) {
      .import-card-body {
        grid-template-columns: 1fr;
      }
    }

    .import-card-info {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .import-card-icon {
      color: var(--primary-color);
      flex-shrink: 0;
      width: 20px;
    }

    .import-card-label {
      font-size: 0.7rem;
      color: #999;
      margin-bottom: 2px;
    }

    .import-card-value {
      font-size: 0.875rem;
      color: #333;
      word-break: break-word;
    }

    /* å•†å“ãƒªã‚¹ãƒˆ */
    .import-card-items {
      grid-column: 1 / -1;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 8px;
    }

    .import-card-items-header {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .import-card-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      padding: 4px 0;
      border-bottom: 1px dashed #e0e0e0;
    }

    .import-card-item:last-child {
      border-bottom: none;
    }

    .import-card-item-name {
      color: #333;
    }

    .import-card-item-qty {
      color: #666;
      font-weight: 500;
    }

    /* ä¿¡é ¼åº¦ãƒãƒƒã‚¸ */
    .confidence-badge {
      padding: 2px var(--space-2);
      border-radius: var(--radius-md);
      font-size: 0.7rem;
      font-weight: 500;
    }

    .confidence-high {
      background: var(--status-success-light);
      color: #155724;
    }

    .confidence-medium {
      background: var(--status-warning-light);
      color: #856404;
    }

    .confidence-low {
      background: var(--status-error-light);
      color: #721c24;
    }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .import-card-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }

    .btn-process {
      flex: 2;
      background: var(--gradient-purple);
      border: none;
      color: white;
      padding: 10px var(--space-4);
      border-radius: var(--radius);
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-process:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      color: white;
    }

    .btn-reject {
      flex: 1;
      background: white;
      border: 2px solid var(--status-error);
      color: var(--status-error);
      padding: 10px var(--space-4);
      border-radius: var(--radius);
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-reject:hover {
      background: var(--status-error);
      color: white;
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-state {
      padding: 60px 20px;
      text-align: center;
      color: #666;
    }

    .empty-state i {
      font-size: 4rem;
      color: #ccc;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      margin-bottom: 8px;
      color: #333;
    }

    .empty-state p {
      font-size: 0.9rem;
    }

    /* ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-header.reject-header {
      background: var(--status-error);
      color: white;
    }

    /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .detail-section {
      border-bottom: 1px solid #e9ecef;
      padding: 12px 0;
    }

    .detail-section:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 4px;
    }

    .detail-value {
      font-size: 0.9rem;
      color: #333;
    }

    .original-text {
      background: var(--gray-100);
      border-radius: var(--radius);
      padding: var(--space-3);
      font-size: 0.85rem;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 576px) {
      .main-container {
        padding: 8px;
      }

      .summary-section {
        padding: 12px;
      }

      .filter-section {
        padding: 10px 12px;
      }

      .table-section {
        padding: 12px;
      }

      .import-card {
        padding: 12px;
      }

      .import-card-actions {
        flex-direction: column;
      }

      .btn-process, .btn-reject {
        flex: none;
      }
    }
  </style>
</head>
<body>

<div class="main-container">
  <div class="card">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <h1><i class="bi bi-robot me-2"></i>AIå–è¾¼ä¸€è¦§</h1>
        <span class="pending-badge" id="pendingBadge">æœªå‡¦ç†: 0ä»¶</span>
      </div>
      <form method="POST" action="<?= deployURL ?>" style="margin: 0;">
        <button type="submit" formnovalidate class="btn btn-outline-light btn-sm" name="mainTop" value="true">
          <i class="bi bi-house"></i> ãƒ›ãƒ¼ãƒ 
        </button>
      </form>
    </div>

    <!-- ã‚µãƒãƒªãƒ¼ -->
    <div class="summary-section">
      <div class="summary-card pending">
        <div class="count" id="pendingCount">0</div>
        <div class="label">æœªå‡¦ç†</div>
      </div>
      <div class="summary-card rejected">
        <div class="count" id="rejectedCount">0</div>
        <div class="label">å´ä¸‹</div>
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="filter-section">
      <span class="text-muted" style="font-size: 0.875rem;">è¡¨ç¤ºï¼š</span>
      <div class="btn-group btn-group-sm" role="group">
        <input type="radio" class="btn-check" name="statusFilter" id="filterPending" value="pending" checked>
        <label class="btn btn-outline-warning" for="filterPending">ğŸŸ¡ æœªå‡¦ç†ã®ã¿</label>
        <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all">
        <label class="btn btn-outline-secondary" for="filterAll">ã™ã¹ã¦</label>
      </div>
      <button type="button" class="btn btn-outline-primary btn-sm ms-auto" onclick="loadImportData()">
        <i class="bi bi-arrow-clockwise me-1"></i>æ›´æ–°
      </button>
    </div>

    <!-- ä¸€è¦§ -->
    <div class="table-section position-relative">

      <div id="importListContainer">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>

      <div class="empty-state" id="emptyState" style="display: none;">
        <i class="bi bi-inbox-fill"></i>
        <h3>æœªå‡¦ç†ã®å–è¾¼ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</h3>
        <p>FAX/ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>
    </div>
  </div>
</div>

<!-- å´ä¸‹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="rejectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header reject-header">
        <h5 class="modal-title"><i class="bi bi-x-circle me-2"></i>å´ä¸‹ç¢ºèª</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>ã“ã®å–è¾¼ãƒ‡ãƒ¼ã‚¿ã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ</p>
        <p class="text-muted mb-0" style="font-size: 0.875rem;">
          <strong>é¡§å®¢ï¼š</strong><span id="rejectCustomerName"></span><br>
          <strong>å•†å“ï¼š</strong><span id="rejectItemsSummary"></span>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-danger" id="confirmRejectBtn">å´ä¸‹ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background: var(--gradient-purple); color: white;">
        <h5 class="modal-title"><i class="bi bi-file-text me-2"></i>å–è¾¼è©³ç´°</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="detailModalBody">
        <!-- å‹•çš„ã«ç”Ÿæˆ -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
        <button type="button" class="btn btn-danger" id="detailRejectBtn">å´ä¸‹</button>
        <button type="button" class="btn btn-process" id="detailProcessBtn">
          <i class="bi bi-arrow-right-circle me-1"></i>å—æ³¨å‡¦ç†ã¸
        </button>
      </div>
    </div>
  </div>
</div>

<!-- å—æ³¨ç”»é¢é·ç§»ç”¨ãƒ•ã‚©ãƒ¼ãƒ  -->
<form id="processForm" method="POST" action="<?= deployURL ?>" style="display: none;">
  <input type="hidden" name="shipping" value="true">
  <input type="hidden" name="tempOrderId" id="tempOrderIdInput" value="">
</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let importData = [];
  let currentRejectId = null;
  let currentDetailData = null;

  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    loadImportData();
  });

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  function setupEventListeners() {
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´
    document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
      radio.addEventListener('change', renderImportList);
    });

    // å´ä¸‹ç¢ºèªãƒœã‚¿ãƒ³
    document.getElementById('confirmRejectBtn').addEventListener('click', function() {
      if (currentRejectId) {
        rejectImport(currentRejectId);
      }
    });
  }

  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  function loadImportData() {
    showLoading('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
    document.getElementById('emptyState').style.display = 'none';

    google.script.run
      .withSuccessHandler(function(result) {
        hideLoading();
        try {
          importData = JSON.parse(result) || [];
          updateSummary();
          renderImportList();
        } catch (e) {
          console.error('ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
          importData = [];
          renderImportList();
        }
      })
      .withFailureHandler(function(error) {
        hideLoading();
        showErrorToast('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .getAIImportList();
  }

  // ã‚µãƒãƒªãƒ¼æ›´æ–°
  function updateSummary() {
    const pending = importData.filter(d => d.status === 'æœªå‡¦ç†').length;
    const rejected = importData.filter(d => d.status === 'å´ä¸‹').length;

    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('rejectedCount').textContent = rejected;

    const badge = document.getElementById('pendingBadge');
    badge.textContent = 'æœªå‡¦ç†: ' + pending + 'ä»¶';
    badge.style.display = pending > 0 ? 'inline-block' : 'none';
  }

  // ä¸€è¦§æç”»
  function renderImportList() {
    const container = document.getElementById('importListContainer');
    const filter = document.querySelector('input[name="statusFilter"]:checked').value;
    
    let filteredData = importData;
    if (filter === 'pending') {
      filteredData = importData.filter(d => d.status === 'æœªå‡¦ç†');
    }

    if (filteredData.length === 0) {
      container.innerHTML = '';
      document.getElementById('emptyState').style.display = 'block';
      return;
    }

    document.getElementById('emptyState').style.display = 'none';

    container.innerHTML = filteredData.map(item => {
      const statusClass = item.status === 'æœªå‡¦ç†' ? 'pending' : 
                          item.status === 'å‡¦ç†æ¸ˆã¿' ? 'processed' : 'rejected';
      const statusBadgeClass = item.status === 'æœªå‡¦ç†' ? 'status-pending' : 
                               item.status === 'å‡¦ç†æ¸ˆã¿' ? 'status-processed' : 'status-rejected';
      
      const confidenceClass = item.confidence === 'é«˜' ? 'confidence-high' :
                              item.confidence === 'ä¸­' ? 'confidence-medium' : 'confidence-low';
      const confidenceText = item.confidence === 'é«˜' ? 'âœ… é«˜' :
                             item.confidence === 'ä¸­' ? 'âš ï¸ ä¸­' : 'â“ ä½';

      // å•†å“ãƒªã‚¹ãƒˆï¼ˆæœ€å¤§3ä»¶è¡¨ç¤ºï¼‰
      const items = item.items || [];
      const displayItems = items.slice(0, 3);
      const moreCount = items.length - 3;

      return `
        <div class="card-unified ${statusClass}" onclick="showDetail('${escapeHtml(item.tempOrderId)}')">
          <div class="card-unified-header">
            <div>
              <div class="import-card-id">${escapeHtml(item.tempOrderId)}</div>
              <div class="import-card-time">
                <i class="bi bi-clock me-1"></i>${formatDateTime(item.createdAt)}
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="confidence-badge ${confidenceClass}">${confidenceText}</span>
              <span class="import-card-status ${statusBadgeClass}">${item.status}</span>
            </div>
          </div>

          <div class="import-card-body">
            <div class="import-card-info">
              <i class="bi bi-person import-card-icon"></i>
              <div>
                <div class="import-card-label">é¡§å®¢</div>
                <div class="import-card-value">${escapeHtml(item.customerName) || 'ä¸æ˜'}</div>
              </div>
            </div>
            <div class="import-card-info">
              <i class="bi bi-geo-alt import-card-icon"></i>
              <div>
                <div class="import-card-label">ç™ºé€å…ˆ</div>
                <div class="import-card-value">${escapeHtml(item.shippingTo) || 'åŒä¸Š'}</div>
              </div>
            </div>

            <div class="import-card-items">
              <div class="import-card-items-header">
                <i class="bi bi-box-seam"></i>å•†å“ï¼ˆ${items.length}ç‚¹ï¼‰
              </div>
              ${displayItems.map(i => `
                <div class="import-card-item">
                  <span class="import-card-item-name">${escapeHtml(i.productName || i.originalText)}</span>
                  <span class="import-card-item-qty">${i.quantity || ''}${i.unit || ''}</span>
                </div>
              `).join('')}
              ${moreCount > 0 ? `<div class="import-card-item text-muted">...ä»–${moreCount}ç‚¹</div>` : ''}
            </div>
          </div>

          ${item.status === 'æœªå‡¦ç†' ? `
            <div class="import-card-actions" onclick="event.stopPropagation();">
              <button type="button" class="btn btn-process" onclick="processImport('${escapeHtml(item.tempOrderId)}')">
                <i class="bi bi-arrow-right-circle me-1"></i>å—æ³¨å‡¦ç†ã¸
              </button>
              <button type="button" class="btn btn-reject" onclick="showRejectModal('${escapeHtml(item.tempOrderId)}', '${escapeHtml(item.customerName)}', '${escapeHtml(getItemsSummary(items))}')">
                <i class="bi bi-x-circle me-1"></i>å´ä¸‹
              </button>
            </div>
          ` : ''}
          ${item.status === 'å´ä¸‹' ? `
            <div class="import-card-actions" onclick="event.stopPropagation();">
              <button type="button" class="btn btn-secondary" onclick="reactivateImport('${escapeHtml(item.tempOrderId)}')">
                <i class="bi bi-arrow-counterclockwise me-1"></i>å†ç™»éŒ²
              </button>
              <button type="button" class="btn btn-danger" onclick="deleteImport('${escapeHtml(item.tempOrderId)}')">
                <i class="bi bi-trash me-1"></i>å‰Šé™¤
              </button>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return '-';
    return (d.getMonth() + 1) + '/' + d.getDate() + ' ' + 
           String(d.getHours()).padStart(2, '0') + ':' + 
           String(d.getMinutes()).padStart(2, '0');
  }

  // å•†å“ã‚µãƒãƒªãƒ¼å–å¾—
  function getItemsSummary(items) {
    if (!items || items.length === 0) return 'ãªã—';
    const first = items[0].productName || items[0].originalText || '';
    if (items.length === 1) return first;
    return first + ' ä»–' + (items.length - 1) + 'ç‚¹';
  }

  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;');
  }

  // å—æ³¨å‡¦ç†ã¸é·ç§»
  function processImport(tempOrderId) {
    document.getElementById('tempOrderIdInput').value = tempOrderId;
    document.getElementById('processForm').submit();
  }

  // å´ä¸‹ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  function showRejectModal(tempOrderId, customerName, itemsSummary) {
    currentRejectId = tempOrderId;
    document.getElementById('rejectCustomerName').textContent = customerName || 'ä¸æ˜';
    document.getElementById('rejectItemsSummary').textContent = itemsSummary || 'ãªã—';
    new bootstrap.Modal(document.getElementById('rejectModal')).show();
  }

  // å´ä¸‹å‡¦ç†
  function rejectImport(tempOrderId) {
    bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          const item = importData.find(d => d.tempOrderId === tempOrderId);
          if (item) {
            item.status = 'å´ä¸‹';
          }
          updateSummary();
          renderImportList();
        } else {
          showErrorToast('å´ä¸‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || ''));
        }
      })
      .withFailureHandler(function(error) {
        showErrorToast('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .rejectTempOrder(tempOrderId);
  }

  // ä»®å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤
  function deleteImport(tempOrderId) {
    if (!confirm('ã“ã®ä»®å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå‰Šé™¤å¾Œã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚')) {
      return;
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤
          const index = importData.findIndex(d => d.tempOrderId === tempOrderId);
          if (index !== -1) {
            importData.splice(index, 1);
          }
          updateSummary();
          renderImportList();
          showSuccessToast('å‰Šé™¤ã—ã¾ã—ãŸ');
        } else {
          showErrorToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || ''));
        }
      })
      .withFailureHandler(function(error) {
        showErrorToast('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .deleteTempOrderData(tempOrderId);
  }

  // å´ä¸‹ãƒ‡ãƒ¼ã‚¿ã‚’å†ç™»éŒ²ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œæœªå‡¦ç†ã€ã«æˆ»ã™ï¼‰
  function reactivateImport(tempOrderId) {
    if (!confirm('ã“ã®ä»®å—æ³¨ã‚’å†ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œæœªå‡¦ç†ã€ã«æˆ»ã‚Šã¾ã™ã€‚')) {
      return;
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
          const item = importData.find(d => d.tempOrderId === tempOrderId);
          if (item) {
            item.status = 'æœªå‡¦ç†';
          }
          updateSummary();
          renderImportList();
          showSuccessToast('å†ç™»éŒ²ã—ã¾ã—ãŸ');
        } else {
          showErrorToast('å†ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || ''));
        }
      })
      .withFailureHandler(function(error) {
        showErrorToast('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .reactivateTempOrder(tempOrderId);
  }

  // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  function showDetail(tempOrderId) {
    const item = importData.find(d => d.tempOrderId === tempOrderId);
    if (!item) return;

    currentDetailData = item;
    const body = document.getElementById('detailModalBody');

    const items = item.items || [];
    
    body.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <div class="detail-section">
            <div class="detail-label">å–è¾¼ID</div>
            <div class="detail-value">${escapeHtml(item.tempOrderId)}</div>
          </div>
          <div class="detail-section">
            <div class="detail-label">å–è¾¼æ—¥æ™‚</div>
            <div class="detail-value">${formatDateTime(item.createdAt)}</div>
          </div>
          <div class="detail-section">
            <div class="detail-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
            <div class="detail-value">
              <span class="import-card-status ${item.status === 'æœªå‡¦ç†' ? 'status-pending' : 'status-rejected'}">${item.status}</span>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-section">
            <div class="detail-label">é¡§å®¢å</div>
            <div class="detail-value">${escapeHtml(item.customerName) || 'ä¸æ˜'}</div>
          </div>
          <div class="detail-section">
            <div class="detail-label">ç™ºé€å…ˆ</div>
            <div class="detail-value">${escapeHtml(item.shippingTo) || 'åŒä¸Š'}</div>
          </div>
          <div class="detail-section">
            <div class="detail-label">è§£æä¿¡é ¼åº¦</div>
            <div class="detail-value">
              <span class="confidence-badge ${item.confidence === 'é«˜' ? 'confidence-high' : item.confidence === 'ä¸­' ? 'confidence-medium' : 'confidence-low'}">
                ${item.confidence === 'é«˜' ? 'âœ… é«˜' : item.confidence === 'ä¸­' ? 'âš ï¸ ä¸­' : 'â“ ä½'}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <div class="detail-label">å•†å“ï¼ˆ${items.length}ç‚¹ï¼‰</div>
        <div class="import-card-items" style="margin-top: 8px;">
          ${items.map(i => `
            <div class="import-card-item">
              <span class="import-card-item-name">${escapeHtml(i.productName || i.originalText)}</span>
              <span class="import-card-item-qty">${i.quantity || ''}${i.unit || ''}</span>
            </div>
          `).join('')}
        </div>
      </div>

      <div class="detail-section">
        <div class="detail-label">åŸæ–‡ãƒ†ã‚­ã‚¹ãƒˆ</div>
        <div class="original-text">${escapeHtml(item.originalText) || '(ãªã—)'}</div>
      </div>
    `;

    // ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
    const rejectBtn = document.getElementById('detailRejectBtn');
    const processBtn = document.getElementById('detailProcessBtn');
    
    if (item.status === 'æœªå‡¦ç†') {
      rejectBtn.style.display = '';
      processBtn.style.display = '';
      processBtn.onclick = () => {
        bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
        processImport(item.tempOrderId);
      };
      rejectBtn.onclick = () => {
        bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();
        showRejectModal(item.tempOrderId, item.customerName, getItemsSummary(items));
      };
    } else {
      rejectBtn.style.display = 'none';
      processBtn.style.display = 'none';
    }

    new bootstrap.Modal(document.getElementById('detailModal')).show();
  }
</script>

</body>
</html>
