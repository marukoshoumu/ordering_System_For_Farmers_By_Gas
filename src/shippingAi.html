<!-- 
  shipping.html ã‹ã‚‰åˆ†é›¢ã—ãŸAIè§£æé–¢é€£ã®JavaScript
  - AIå…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆæ©Ÿèƒ½
  - é¡§å®¢/ç™ºé€å…ˆãƒã‚¹ã‚¿ç…§åˆ
  - å•†å“ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
-->
<script>
    // ===== AIè§£æ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
    let aiAnalysisResult = null;
    let useShippingToMaster = false;
    let useCustomerMaster = false;
    let selectedFile = null;
    let selectedFileBase64 = null;
    let currentTab = 'text';
    let productMaster = {};
    let categoryList = [];
    let productPrices = {};
    let itemEdits = {};

    // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿
    let manualCustomerSelection = null;
    let manualShippingToSelection = null;

    const AI_SESSION_KEY = 'aiSessionData';
    const AI_EXCLUDE_CATEGORIES = ['é€æ–™', 'æ‰‹æ•°æ–™', 'è¿½åŠ æ–™é‡‘'];
    const AI_EXCLUDE_PRODUCTS = ['é€æ–™', 'ã‚¯ãƒ¼ãƒ«ä¾¿è¿½åŠ ', 'ä»£å¼•æ‰‹æ•°æ–™', 'æ¢±åŒ…æ–™'];

    /**
     * æ‰‹å‹•é¸æŠå¾Œã«AIãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
     */
    function updateManualSelectionDisplay() {
      if (!aiAnalysisResult) return;
      if (aiAnalysisResult.customer) {
        displayCustomer(aiAnalysisResult.customer);
      }
      if (aiAnalysisResult.shippingTo) {
        displayShippingTo(aiAnalysisResult.shippingTo);
      }
    }

    /**
     * éƒµä¾¿ç•ªå·ã®ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»
     */
    function sanitizeZipcode(zip) {
      if (!zip) return '';
      return String(zip).replace(/[-ãƒ¼âˆ’â€]/g, '');
    }

    /**
     * é›»è©±ç•ªå·ãƒ»FAXç•ªå·ã®ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»
     */
    function sanitizeTel(tel) {
      if (!tel) return '';
      return String(tel).replace(/[-ãƒ¼âˆ’â€]/g, '');
    }

    /**
     * ä½æ‰€æ–‡å­—åˆ—ã‚’éƒ½é“åºœçœŒï¼‹å¸‚åŒºç”ºæ‘(ä½æ‰€1)ã¨ç•ªåœ°ä»¥é™(ä½æ‰€2)ã«åˆ†å‰²
     */
    function splitAddressString(fullAddress) {
      if (!fullAddress) {
        return { address1: '', address2: '' };
      }
      const addr = String(fullAddress).trim();
      const patterns = [
        /(.*?[éƒ½é“åºœçœŒ].*?[å¸‚åŒºç”ºæ‘éƒ¡])/,
        /(.*?[å¸‚åŒºç”ºæ‘])/,
        /(.*?éƒ¡.*?[ç”ºæ‘])/
      ];
      for (const pattern of patterns) {
        const match = addr.match(pattern);
        if (match) {
          const address1 = match[1];
          const address2 = addr.substring(address1.length).trim();
          return { address1, address2 };
        }
      }
      const halfIndex = Math.floor(addr.length / 2);
      return {
        address1: addr.substring(0, halfIndex),
        address2: addr.substring(halfIndex)
      };
    }

    /**
     * AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ‘ãƒãƒ«ã®é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
     *
     * AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
     * ãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸéš›ã«å•†å“ãƒã‚¹ã‚¿ãŒæœªèª­ã¿è¾¼ã¿ã®å ´åˆã¯è‡ªå‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. ãƒ‘ãƒãƒ«ã®open/closeã‚¯ãƒ©ã‚¹ã‚’ãƒˆã‚°ãƒ«
     * 2. ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œé–‹ãã€â†”ã€Œé–‰ã˜ã‚‹ã€ã§åˆ‡ã‚Šæ›¿ãˆ
     * 3. ãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸéš›ã«categoryListãŒç©ºãªã‚‰å•†å“ãƒã‚¹ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
     *
     * @returns {void}
     * @see loadProductMaster() - å•†å“ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†
     */
    function toggleAIAssistant() {
      const body = document.getElementById('aiAssistantBody');
      const btn = document.getElementById('aiToggleBtn');
      body.classList.toggle('open');
      btn.textContent = body.classList.contains('open') ? 'é–‰ã˜ã‚‹' : 'é–‹ã';
      if (body.classList.contains('open') && categoryList.length === 0) {
        loadProductMaster();
      }
    }

    /**
     * AIå–è¾¼ä¸€è¦§ã‹ã‚‰é·ç§»ã—ãŸå ´åˆã«è‡ªå‹•ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ã¦è§£æçµæœã‚’è¡¨ç¤º
     */
    function openAIModalWithResult(analysisData) {
      const body = document.getElementById('aiAssistantBody');
      const btn = document.getElementById('aiToggleBtn');
      if (!body.classList.contains('open')) {
        body.classList.add('open');
        btn.textContent = 'é–‰ã˜ã‚‹';
      }
      if (categoryList.length === 0) {
        loadProductMaster();
      }
      google.script.run
        .withSuccessHandler(function(enhancedResultJson) {
          try {
            const enhancedData = JSON.parse(enhancedResultJson);
            aiAnalysisResult = enhancedData;
            showAIAnalyzedIndicator(new Date().toISOString());
            displayAnalysisResult(enhancedData);
            console.log('AIå–è¾¼ä¸€è¦§ã‹ã‚‰ã®è§£æçµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆãƒã‚¹ã‚¿ç…§åˆæ¸ˆã¿ï¼‰');
          } catch (e) {
            console.error('å¼·åŒ–ã•ã‚ŒãŸè§£æçµæœã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
            aiAnalysisResult = analysisData;
            displayAnalysisResult(analysisData);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ãƒã‚¹ã‚¿ç…§åˆã‚¨ãƒ©ãƒ¼:', error);
          aiAnalysisResult = analysisData;
          showAIAnalyzedIndicator(new Date().toISOString());
          displayAnalysisResult(analysisData);
        })
        .enhanceAnalysisResultFromTempOrder(JSON.stringify(analysisData));
    }

    /**
     * æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
     */
    function setupNewRegistrationButtons(analysisData) {
      const existingCustomerBtns = document.getElementById('customerActionButtons');
      if (existingCustomerBtns) existingCustomerBtns.remove();
      const existingShippingBtns = document.getElementById('shippingToActionButtons');
      if (existingShippingBtns) existingShippingBtns.remove();

      if (analysisData.customer) {
        const isNew = analysisData.customer.isNewCustomer;
        const isPartial = analysisData.customer.masterMatch === 'partial';
        if (isNew || isPartial) {
          const customerSection = document.querySelector('#aiResultCustomerRaw').parentElement;
          const btnContainer = document.createElement('div');
          btnContainer.id = 'customerActionButtons';
          btnContainer.className = 'mt-2';
          btnContainer.style.display = 'flex';
          btnContainer.style.gap = '8px';

          const newBtn = document.createElement('button');
          newBtn.type = 'button';
          newBtn.className = 'btn btn-sm btn-primary';
          newBtn.textContent = 'ğŸ“ æ–°è¦ç™»éŒ²';
          newBtn.onclick = function() { openNewCustomerFormWithAI(analysisData.customer); };
          btnContainer.appendChild(newBtn);

          const searchBtn = document.createElement('button');
          searchBtn.type = 'button';
          searchBtn.className = 'btn btn-sm btn-primary';
          searchBtn.textContent = 'ğŸ” é¡§å®¢ã‚’æ¤œç´¢';
          searchBtn.onclick = function() { $('.customerSearchBtn_open').click(); };
          btnContainer.appendChild(searchBtn);

          customerSection.appendChild(btnContainer);
        }
      }

      if (analysisData.shippingTo) {
        const isNew = analysisData.shippingTo.isNewShippingTo;
        const isPartial = analysisData.shippingTo.masterMatch === 'partial';
        if (isNew || isPartial) {
          const shippingSection = document.querySelector('#aiResultShippingToRaw').parentElement;
          const btnContainer = document.createElement('div');
          btnContainer.id = 'shippingToActionButtons';
          btnContainer.className = 'mt-2';
          btnContainer.style.display = 'flex';
          btnContainer.style.gap = '8px';

          const newBtn = document.createElement('button');
          newBtn.type = 'button';
          newBtn.className = 'btn btn-sm btn-primary';
          newBtn.textContent = 'ğŸ“ æ–°è¦ç™»éŒ²';
          newBtn.onclick = function() { openNewShippingToFormWithAI(analysisData.shippingTo); };
          btnContainer.appendChild(newBtn);

          const searchBtn = document.createElement('button');
          searchBtn.type = 'button';
          searchBtn.className = 'btn btn-sm btn-primary';
          searchBtn.textContent = 'ğŸ” ç™ºé€å…ˆã‚’æ¤œç´¢';
          searchBtn.onclick = function() { $('.shippingToSearchBtn_open').click(); };
          btnContainer.appendChild(searchBtn);

          shippingSection.appendChild(btnContainer);
        }
      }
    }

    /**
     * é¡§å®¢æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦AIè§£æå€¤ã‚’äº‹å‰å…¥åŠ›
     *
     * AIè§£æçµæœã‹ã‚‰é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã€æ–°è¦ç™»éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã«è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã€‚
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å†…å®¹ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ã¦ç™»éŒ²ã§ãã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
     * 2. AIè§£æãƒ‡ãƒ¼ã‚¿ï¼ˆrawå€¤å„ªå…ˆï¼‰ã‚’å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
     *    - ä¼šç¤¾å â†’ é¡§å®¢åï¼ˆè¡¨ç¤ºåã«ã‚‚åŒã˜å€¤ï¼‰
     *    - æ‹…å½“è€…å â†’ è­˜åˆ¥å
     *    - éƒµä¾¿ç•ªå· â†’ ãƒã‚¤ãƒ•ãƒ³é™¤å»ã—ã¦è¨­å®š
     *    - ä½æ‰€ â†’ splitAddressString()ã§ä½æ‰€1/ä½æ‰€2ã«åˆ†å‰²
     *    - é›»è©±ç•ªå·/FAX â†’ ãƒã‚¤ãƒ•ãƒ³é™¤å»ã—ã¦è¨­å®š
     * 3. jQuery UIãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãï¼ˆç™»éŒ²/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ä»˜ãï¼‰
     *
     * ãƒ‡ãƒ¼ã‚¿å„ªå…ˆé †ä½:
     * - rawå€¤ï¼ˆAIèª­ã¿å–ã‚Šï¼‰> æ­£è¦åŒ–æ¸ˆã¿å€¤
     *
     * @param {Object} customerData - é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆAIè§£æçµæœï¼‰
     * @returns {void}
     * @see clearCustomerForm() - ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢å‡¦ç†
     * @see sanitizeZipcode() - éƒµä¾¿ç•ªå·æ­£è¦åŒ–
     * @see sanitizeTel() - é›»è©±ç•ªå·æ­£è¦åŒ–
     * @see splitAddressString() - ä½æ‰€åˆ†å‰²å‡¦ç†
     * @see addCustomer() - é¡§å®¢ç™»éŒ²å‡¦ç†
     */
    function openNewCustomerFormWithAI(customerData) {
      console.log('é¡§å®¢ãƒ‡ãƒ¼ã‚¿:', customerData);
      clearCustomerForm();

      const companyName = customerData.rawCompanyName || customerData.companyName || '';
      const personName = customerData.rawPersonName || customerData.personName || '';
      const zipcode = customerData.rawZipcode || customerData.zipcode || '';
      const address = customerData.rawAddress || customerData.address || '';
      const tel = customerData.rawTel || customerData.tel || '';
      const fax = customerData.rawFax || customerData.fax || '';

      if (companyName) {
        document.getElementById('customerNameDg').value = companyName;
        document.getElementById('customerShowNameDg').value = companyName;
      }
      if (personName) {
        document.getElementById('customerIdentDg').value = personName;
      }
      if (zipcode) {
        document.getElementById('customerZipcodeDg').value = sanitizeZipcode(zipcode);
      }
      if (address) {
        const splitAddress = splitAddressString(address);
        document.getElementById('customerAddress1Dg').value = splitAddress.address1;
        document.getElementById('customerAddress2Dg').value = splitAddress.address2;
      }
      if (tel) {
        document.getElementById('customerTelDg').value = sanitizeTel(tel);
      }
      if (fax) {
        document.getElementById('customerFaxDg').value = sanitizeTel(fax);
      }

      const dialog = $('.customer_dg');
      if (!dialog.hasClass('ui-dialog-content')) {
        dialog.dialog({
          title: "é¡§å®¢æ–°è¦ç™»éŒ²",
          height: 500,
          modal: true,
          buttons: {
            "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function() { $(this).dialog("close"); },
            "ç™»éŒ²": function() { addCustomer(); }
          }
        });
      }
      dialog.dialog('open');
    }

    /**
     * ç™ºé€å…ˆæ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦AIè§£æå€¤ã‚’äº‹å‰å…¥åŠ›
     *
     * AIè§£æçµæœã‹ã‚‰ç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã€æ–°è¦ç™»éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã«è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã€‚
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å†…å®¹ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ã¦ç™»éŒ²ã§ãã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. ç™ºé€å…ˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
     * 2. AIè§£æãƒ‡ãƒ¼ã‚¿ï¼ˆrawå€¤å„ªå…ˆï¼‰ã‚’å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
     *    - ä¼šç¤¾å â†’ ç™ºé€å…ˆå
     *    - å®›å â†’ è­˜åˆ¥å
     *    - éƒµä¾¿ç•ªå· â†’ ãƒã‚¤ãƒ•ãƒ³é™¤å»ã—ã¦è¨­å®š
     *    - ä½æ‰€ â†’ splitAddressString()ã§ä½æ‰€1/ä½æ‰€2ã«åˆ†å‰²
     *    - é›»è©±ç•ªå· â†’ ãƒã‚¤ãƒ•ãƒ³é™¤å»ã—ã¦è¨­å®š
     * 3. jQuery UIãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãï¼ˆç™»éŒ²/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ä»˜ãï¼‰
     *
     * ãƒ‡ãƒ¼ã‚¿å„ªå…ˆé †ä½:
     * - rawå€¤ï¼ˆAIèª­ã¿å–ã‚Šï¼‰> æ­£è¦åŒ–æ¸ˆã¿å€¤
     *
     * @param {Object} shippingToData - ç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆAIè§£æçµæœï¼‰
     * @returns {void}
     * @see clearShippingToForm() - ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢å‡¦ç†
     * @see sanitizeZipcode() - éƒµä¾¿ç•ªå·æ­£è¦åŒ–
     * @see sanitizeTel() - é›»è©±ç•ªå·æ­£è¦åŒ–
     * @see splitAddressString() - ä½æ‰€åˆ†å‰²å‡¦ç†
     * @see addShippingTo() - ç™ºé€å…ˆç™»éŒ²å‡¦ç†
     */
    function openNewShippingToFormWithAI(shippingToData) {
      console.log('ç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿:', shippingToData);
      clearShippingToForm();

      const companyName = shippingToData.rawCompanyName || shippingToData.companyName || '';
      const personName = shippingToData.rawPersonName || shippingToData.personName || '';
      const zipcode = shippingToData.rawZipcode || shippingToData.zipcode || '';
      const address = shippingToData.rawAddress || shippingToData.address || '';
      const tel = shippingToData.rawTel || shippingToData.tel || '';

      if (companyName) {
        document.getElementById('shippingToNameDg').value = companyName;
      }
      if (personName) {
        document.getElementById('shippingToIdentDg').value = personName;
      }
      if (zipcode) {
        document.getElementById('shippingToZipcodeDg').value = sanitizeZipcode(zipcode);
      }
      if (address) {
        const splitAddress = splitAddressString(address);
        document.getElementById('shippingToAddress1Dg').value = splitAddress.address1;
        document.getElementById('shippingToAddress2Dg').value = splitAddress.address2;
      }
      if (tel) {
        document.getElementById('shippingToTelDg').value = sanitizeTel(tel);
      }

      const dialog = $('.shippingTo_dg');
      if (!dialog.hasClass('ui-dialog-content')) {
        dialog.dialog({
          title: "ç™ºé€å…ˆæ–°è¦ç™»éŒ²",
          height: 500,
          modal: true,
          buttons: {
            "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function() { $(this).dialog("close"); },
            "ç™»éŒ²": function() { addShippingTo(); }
          }
        });
      }
      dialog.dialog('open');
    }

    /**
     * é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
     */
    function clearCustomerForm() {
      document.getElementById('customerNameDg').value = '';
      document.getElementById('customerShowNameDg').value = '';
      document.getElementById('customerFuriganaDg').value = '';
      document.getElementById('customerDepDg').value = '';
      document.getElementById('customerPostDg').value = '';
      document.getElementById('customerIdentDg').value = '';
      document.getElementById('customerZipcodeDg').value = '';
      document.getElementById('customerAddress1Dg').value = '';
      document.getElementById('customerAddress2Dg').value = '';
      document.getElementById('customerTelDg').value = '';
      document.getElementById('customerPhoneDg').value = '';
      document.getElementById('customerFaxDg').value = '';
      document.getElementById('customerMailDg').value = '';
      document.getElementById('customerMemoDg').value = '';
    }

    /**
     * ç™ºé€å…ˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
     */
    function clearShippingToForm() {
      document.getElementById('shippingToNameDg').value = '';
      document.getElementById('shippingToDepDg').value = '';
      document.getElementById('shippingToIdentDg').value = '';
      document.getElementById('shippingToZipcodeDg').value = '';
      document.getElementById('shippingToAddress1Dg').value = '';
      document.getElementById('shippingToAddress2Dg').value = '';
      document.getElementById('shippingToTelDg').value = '';
      document.getElementById('shippingToMailDg').value = '';
      document.getElementById('shippingToMemoDg').value = '';
    }

    /**
     * å•†å“ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ»ä¾¡æ ¼ä»˜ãï¼‰
     *
     * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰å•†å“ãƒã‚¹ã‚¿ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«å–å¾—ã—ã€
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ã—ã¾ã™ã€‚å•†å“é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã¨ä¾¡æ ¼è‡ªå‹•å…¥åŠ›ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
     *
     * å–å¾—ãƒ‡ãƒ¼ã‚¿:
     * - productsByCategory: ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®å•†å“ãƒªã‚¹ãƒˆ { "é‡èœ": ["ãƒˆãƒãƒˆ", "ã‚­ãƒ¥ã‚¦ãƒª"], ... }
     * - productPrices: å•†å“åã¨ä¾¡æ ¼ã®ãƒãƒƒãƒ— { "ãƒˆãƒãƒˆ": 500, ... }
     *
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¸ã®ä¿å­˜:
     * - productMaster: ã‚«ãƒ†ã‚´ãƒªåˆ¥å•†å“ãƒªã‚¹ãƒˆ
     * - productPrices: å•†å“ä¾¡æ ¼ãƒãƒƒãƒ—
     * - categoryList: ã‚«ãƒ†ã‚´ãƒªåé…åˆ—
     *
     * å‘¼ã³å‡ºã—ã‚¿ã‚¤ãƒŸãƒ³ã‚°:
     * - AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ‘ãƒãƒ«ã‚’åˆã‚ã¦é–‹ã„ãŸæ™‚ï¼ˆtoggleAIAssistantï¼‰
     * - AIå–è¾¼ä¸€è¦§ã‹ã‚‰é·ç§»ã—ãŸæ™‚ï¼ˆopenAIModalWithResultï¼‰
     *
     * @returns {void}
     * @see getProductMasterForUI() - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å–å¾—é–¢æ•°
     * @see toggleAIAssistant() - ãƒ‘ãƒãƒ«é–‹é–‰å‡¦ç†
     */
    function loadProductMaster() {
      google.script.run
        .withSuccessHandler(function(data) {
          productMaster = data.productsByCategory || {};
          productPrices = data.productPrices || {};
          categoryList = Object.keys(productMaster);
        })
        .withFailureHandler(function(error) {
          console.error('å•†å“ãƒã‚¹ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getProductMasterForUI();
    }
    
    /**
     * AIã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆ30åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
     *
     * sessionStorageã‹ã‚‰AIè§£æçµæœã‚’èª­ã¿è¾¼ã¿ã€æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
     * 30åˆ†ä»¥å†…ã®ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚Œã°è§£ææ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. sessionStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
     * 2. ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ä½•ã‚‚ã›ãšçµ‚äº†
     * 3. ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€è§£ææ™‚åˆ»ã¨ã®å·®åˆ†ã‚’è¨ˆç®—
     * 4. 30åˆ†ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦çµ‚äº†
     * 5. 30åˆ†ä»¥å†…ã§ã‚ã‚Œã°è§£ææ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
     *
     * ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:
     * - ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç ´æãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
     *
     * @returns {void}
     * @see saveAISessionData() - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜å‡¦ç†
     * @see showAIAnalyzedIndicator() - ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤ºå‡¦ç†
     */
    function loadAISessionData() {
      const saved = sessionStorage.getItem(AI_SESSION_KEY);
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        const diffMinutes = (new Date() - new Date(data.analyzedAt)) / 1000 / 60;
        if (diffMinutes > 30) {
          sessionStorage.removeItem(AI_SESSION_KEY);
          return;
        }
        showAIAnalyzedIndicator(data.analyzedAt);
      } catch (e) {
        sessionStorage.removeItem(AI_SESSION_KEY);
      }
    }
    
    /**
     * AIã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆ30åˆ†é–“æœ‰åŠ¹ï¼‰
     *
     * ç¾åœ¨ã®AIè§£æçµæœã¨å•†å“ç·¨é›†å†…å®¹ã‚’sessionStorageã«ä¿å­˜ã—ã¾ã™ã€‚
     * 30åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã€ãƒšãƒ¼ã‚¸æ›´æ–°æ™‚ã«è§£ææ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚
     *
     * ä¿å­˜å†…å®¹:
     * - analyzedAt: è§£æå®Ÿè¡Œæ™‚åˆ»ï¼ˆISO 8601å½¢å¼ï¼‰
     * - analysisResult: AIè§£æã®å®Œå…¨ãªçµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * - items: å•†å“ç·¨é›†å†…å®¹ï¼ˆåŸæ–‡ãƒ†ã‚­ã‚¹ãƒˆã€å•†å“åã€ä¾¡æ ¼ã€æ•°é‡ãªã©ï¼‰
     * - totalAmount: åˆè¨ˆé‡‘é¡ï¼ˆé™¤å¤–ã‚«ãƒ†ã‚´ãƒªãƒ»å•†å“ã‚’é™¤ãï¼‰
     *
     * é™¤å¤–ãƒ«ãƒ¼ãƒ«:
     * - ã‚«ãƒ†ã‚´ãƒª: é€æ–™ã€æ‰‹æ•°æ–™ã€è¿½åŠ æ–™é‡‘
     * - å•†å“: é€æ–™ã€ã‚¯ãƒ¼ãƒ«ä¾¿è¿½åŠ ã€ä»£å¼•æ‰‹æ•°æ–™ã€æ¢±åŒ…æ–™
     *
     * @returns {void}
     * @see loadAISessionData() - ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿å‡¦ç†
     * @see AI_SESSION_KEY - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼å®šæ•°
     * @see AI_EXCLUDE_CATEGORIES - é™¤å¤–ã‚«ãƒ†ã‚´ãƒªå®šç¾©
     * @see AI_EXCLUDE_PRODUCTS - é™¤å¤–å•†å“å®šç¾©
     */
    function saveAISessionData() {
      if (!aiAnalysisResult) return;
      const sessionData = {
        analyzedAt: new Date().toISOString(),
        analysisResult: aiAnalysisResult,
        items: [],
        totalAmount: 0
      };
      Object.keys(itemEdits).forEach(index => {
        const edit = itemEdits[index];
        if (edit.productName) {
          const amount = (edit.price || 0) * (edit.quantity || 0);
          if (!AI_EXCLUDE_CATEGORIES.includes(edit.category) && !AI_EXCLUDE_PRODUCTS.includes(edit.productName)) {
            sessionData.totalAmount += amount;
          }
          sessionData.items.push({
            originalText: edit.originalText,
            productName: edit.productName,
            category: edit.category,
            price: edit.price,
            quantity: edit.quantity
          });
        }
      });
      sessionStorage.setItem(AI_SESSION_KEY, JSON.stringify(sessionData));
    }
    
    /**
     * AIè§£ææ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è¡¨ç¤º
     */
    function showAIAnalyzedIndicator(analyzedAt) {
      const indicator = document.getElementById('aiAnalyzedIndicator');
      const timeEl = document.getElementById('aiAnalyzedTime');
      if (indicator && analyzedAt) {
        const time = new Date(analyzedAt);
        timeEl.textContent = 'ï¼ˆ' + time.getHours() + ':' + String(time.getMinutes()).padStart(2,'0') + ' è§£æï¼‰';
        indicator.classList.add('show');
      }
    }
    
    /**
     * AIã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªã‚¢
     */
    function clearAISession() {
      sessionStorage.removeItem(AI_SESSION_KEY);
    }
    
    /**
     * ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
     */
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.ai-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.ai-tab-content').forEach(content => content.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
     */
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = function(e) {
        selectedFileBase64 = e.target.result.split(',')[1];
        showFilePreview(file);
      };
      reader.readAsDataURL(file);
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
     */
    function showFilePreview(file) {
      const preview = document.getElementById('filePreview');
      const icon = file.type.includes('pdf') ? 'ğŸ“„' : 'ğŸ–¼ï¸';
      const size = (file.size / 1024).toFixed(1) + ' KB';
      preview.innerHTML = '<div class="file-preview"><span class="file-icon">' + icon + '</span><div class="file-info"><div class="file-name">' + file.name + '</div><div class="file-size">' + size + '</div></div><button type="button" class="remove-btn" onclick="removeFile()">Ã—</button></div>';
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
     */
    function removeFile() {
      selectedFile = null;
      selectedFileBase64 = null;
      document.getElementById('orderFile').value = '';
      document.getElementById('filePreview').innerHTML = '';
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
     */
    function setupFileDragDrop() {
      const uploadArea = document.getElementById('fileUploadArea');
      if (!uploadArea) return;
      uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
      uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
          document.getElementById('orderFile').files = e.dataTransfer.files;
          handleFileSelect({ target: { files: [file] } });
        }
      });
    }
    
    /**
     * AIè§£æã‚’å®Ÿè¡Œï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰
     *
     * ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆFAX/ç”»åƒï¼‰ã‚’Gemini APIã§è§£æã—ã€
     * é¡§å®¢ãƒ»ç™ºé€å…ˆãƒ»å•†å“æƒ…å ±ã‚’è‡ªå‹•æŠ½å‡ºã—ã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. å‰å›ã®è§£æçµæœã‚’ã‚¯ãƒªã‚¢
     * 2. currentTabã«å¿œã˜ã¦ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«è§£æã‚’å®Ÿè¡Œ
     * 3. ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ï¼ˆanalyzeOrderText/analyzeOrderFileBase64ï¼‰ã‚’å‘¼ã³å‡ºã—
     * 4. æˆåŠŸæ™‚: handleAnalysisSuccess()ã€å¤±æ•—æ™‚: handleAnalysisError()
     *
     * @returns {void}
     */
    function analyzeWithAI() {
      const btn = document.getElementById('aiAnalyzeBtn');
      btn.classList.add('loading');
      btn.disabled = true;

      // å‰ã®è§£æçµæœã‚’ã‚¯ãƒªã‚¢ï¼ˆUIã‚¹ãƒ†ãƒ¼ãƒˆã®ãƒªã‚»ãƒƒãƒˆï¼‰
      resetAnalysisState();

      if (currentTab === 'text') {
        const text = document.getElementById('aiInputText').value.trim();
        if (!text) { showWarningToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); btn.classList.remove('loading'); btn.disabled = false; return; }
        google.script.run.withSuccessHandler(handleAnalysisSuccess).withFailureHandler(handleAnalysisError).analyzeOrderText(text);
      } else {
        if (!selectedFile || !selectedFileBase64) { showWarningToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); btn.classList.remove('loading'); btn.disabled = false; return; }
        google.script.run.withSuccessHandler(handleAnalysisSuccess).withFailureHandler(handleAnalysisError).analyzeOrderFileBase64(selectedFileBase64, selectedFile.type, selectedFile.name);
      }
    }
    
    /**
     * AIè§£æã‚¹ãƒ†ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ–°è¦è§£æå‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
     *
     * æ¬¡ã®è§£æå®Ÿè¡Œå‰ã«ã€å‰å›ã®è§£æçµæœã¨UIçŠ¶æ…‹ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚
     * analyzeWithAI()ã®å†’é ­ã§å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
     *
     * ã‚¯ãƒªã‚¢å¯¾è±¡:
     * - aiAnalysisResult: è§£æçµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * - useShippingToMaster/useCustomerMaster: ãƒã‚¹ã‚¿ä½¿ç”¨ãƒ•ãƒ©ã‚°
     * - itemEdits: å•†å“ç·¨é›†å†…å®¹
     * - manualShippingToSelection/manualCustomerSelection: æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿
     * - ç™ºé€å…ˆ/é¡§å®¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®UIï¼ˆãƒãƒƒã‚¸ã€ãƒã‚¹ã‚¿è¡¨ç¤ºã€æ‰‹å‹•é¸æŠè¡¨ç¤ºã€ã‚½ãƒ¼ã‚¹é¸æŠãƒœã‚¿ãƒ³ï¼‰
     * - é¡§å®¢æ¨å®šå€™è£œã‚¨ãƒªã‚¢
     *
     * ä¿æŒã•ã‚Œã‚‹ã‚‚ã®:
     * - å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ#aiInputTextï¼‰
     * - é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆselectedFileï¼‰
     *
     * @returns {void}
     * @see analyzeWithAI() - ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
     */
    function resetAnalysisState() {
      aiAnalysisResult = null;
      useShippingToMaster = false;
      useCustomerMaster = false;
      itemEdits = {};
      manualShippingToSelection = null;
      manualCustomerSelection = null;
      
      // UIã‚‚ã‚¯ãƒªã‚¢ï¼ˆä½†ã—å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒï¼‰
      document.getElementById('aiResultArea').classList.remove('show');
      
      // ç™ºé€å…ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('shippingToMatchBadge').innerHTML = '';
      document.getElementById('aiResultShippingToRaw').innerHTML = '';
      document.getElementById('aiResultShippingToMaster').style.display = 'none';
      document.getElementById('aiResultShippingToManual').style.display = 'none';
      document.getElementById('shippingToSourceSelect').style.display = 'none';
      
      // é¡§å®¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('customerMatchBadge').innerHTML = '';
      document.getElementById('aiResultCustomerRaw').innerHTML = '';
      document.getElementById('aiResultCustomerMaster').style.display = 'none';
      document.getElementById('aiResultCustomerManual').style.display = 'none';
      document.getElementById('customerSourceSelect').style.display = 'none';
      
      // é¡§å®¢æ¨å®šå€™è£œã‚’ã‚¯ãƒªã‚¢
      const suggestionDiv = document.getElementById('customerSuggestionArea');
      if (suggestionDiv) suggestionDiv.style.display = 'none';
    }
    
    /**
     * AIè§£ææˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
     *
     * Gemini APIã‹ã‚‰ã®è§£æçµæœã‚’å—ã‘å–ã‚Šã€ãƒ‘ãƒ¼ã‚¹å¾Œã«ç”»é¢è¡¨ç¤ºã—ã¾ã™ã€‚
     * analyzeWithAI()ã®withSuccessHandlerã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤ï¼ˆãƒœã‚¿ãƒ³å†æœ‰åŠ¹åŒ–ï¼‰
     * 2. è§£æçµæœJSONã‚’ãƒ‘ãƒ¼ã‚¹
     * 3. success=falseã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
     * 4. success=trueã®å ´åˆã¯displayAnalysisResult()ã§è¡¨ç¤º
     *
     * ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:
     * - JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
     * - APIå´ã®ã‚¨ãƒ©ãƒ¼ï¼ˆsuccess=falseï¼‰ã‚‚ã‚­ãƒ£ãƒƒãƒã—ã¦è¡¨ç¤º
     *
     * @param {string} result - JSONæ–‡å­—åˆ—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰ã®è¿”å´å€¤ï¼‰
     * @returns {void}
     * @see analyzeWithAI() - ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
     * @see displayAnalysisResult() - çµæœè¡¨ç¤ºå‡¦ç†
     */
    function handleAnalysisSuccess(result) {
      const btn = document.getElementById('aiAnalyzeBtn');
      btn.classList.remove('loading');
      btn.disabled = false;
      try {
        aiAnalysisResult = JSON.parse(result);
        if (!aiAnalysisResult.success) { showError(aiAnalysisResult.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
        displayAnalysisResult(aiAnalysisResult);
      } catch (e) {
        showError('è§£æçµæœã®å‡¦ç†ã«å¤±æ•—: ' + e.message);
      }
    }
    
    /**
     * AIè§£æã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
     *
     * Gemini APIå‘¼ã³å‡ºã—ã‚„ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã«å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
     * analyzeWithAI()ã®withFailureHandlerã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤ï¼ˆãƒœã‚¿ãƒ³å†æœ‰åŠ¹åŒ–ï¼‰
     * 2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’showError()ã§è¡¨ç¤º
     *
     * ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡:
     * - Google Apps Scriptå®Ÿè¡Œã‚¨ãƒ©ãƒ¼
     * - Gemini APIã‚¨ãƒ©ãƒ¼ï¼ˆAPIåˆ¶é™ã€èªè¨¼å¤±æ•—ãªã©ï¼‰
     * - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
     * - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
     *
     * @param {Error} error - ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @returns {void}
     * @see analyzeWithAI() - ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
     * @see showError() - ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°
     */
    function handleAnalysisError(error) {
      const btn = document.getElementById('aiAnalyzeBtn');
      btn.classList.remove('loading');
      btn.disabled = false;
      showError('è§£æã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
    
    /**
     * AIè§£æçµæœã‚’ç”»é¢ã«è¡¨ç¤ºï¼ˆãƒ¡ã‚¤ãƒ³è¡¨ç¤ºé–¢æ•°ï¼‰
     *
     * Gemini APIã‹ã‚‰ã®è§£æçµæœã‚’å—ã‘å–ã‚Šã€UIå…¨ä½“ã‚’æ›´æ–°ã—ã¾ã™ã€‚
     * é¡§å®¢ã€ç™ºé€å…ˆã€å•†å“ã€æ—¥ä»˜ãªã©ã™ã¹ã¦ã®è§£ææƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     *
     * è¡¨ç¤ºå†…å®¹:
     * - å…¨ä½“ä¿¡é ¼åº¦ãƒãƒƒã‚¸ï¼ˆé«˜/ä¸­/ä½ï¼‰
     * - ã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ±ï¼ˆæ–°è¦é¡§å®¢/ç™ºé€å…ˆãªã©ï¼‰
     * - ç™ºé€æ—¥ã€é…é€å¸Œæœ›æ—¥ã€é…é€æ™‚é–“
     * - ç™ºé€å…ˆæƒ…å ±ï¼ˆdisplayShippingToï¼‰
     * - é¡§å®¢æƒ…å ±ï¼ˆdisplayCustomerï¼‰
     * - é¡§å®¢æ¨å®šå€™è£œï¼ˆdisplayCustomerSuggestionã€Phase 4ï¼‰
     * - å•†å“ãƒªã‚¹ãƒˆï¼ˆç·¨é›†å¯èƒ½ã€displayItemsEditableï¼‰
     * - ãƒ¡ãƒ¢æƒ…å ±
     * - å­¦ç¿’ã‚µãƒãƒª
     * - æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³
     *
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°:
     * - itemEdits ã‚’ã‚¯ãƒªã‚¢ï¼ˆå•†å“ç·¨é›†çŠ¶æ…‹ã®åˆæœŸåŒ–ï¼‰
     *
     * @param {Object} result - AIè§£æçµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @returns {void}
     * @see displayShippingTo() - ç™ºé€å…ˆè¡¨ç¤ºå‡¦ç†
     * @see displayCustomer() - é¡§å®¢è¡¨ç¤ºå‡¦ç†
     * @see displayCustomerSuggestion() - é¡§å®¢æ¨å®šå€™è£œè¡¨ç¤ºï¼ˆPhase 4ï¼‰
     * @see displayItemsEditable() - å•†å“ãƒªã‚¹ãƒˆè¡¨ç¤ºå‡¦ç†
     */
    function displayAnalysisResult(result) {
      document.getElementById('aiResultArea').classList.add('show');
      itemEdits = {};
      setConfidenceBadge('overallConfidence', result.overallConfidence);
      displayAlerts(result.alerts || []);
      document.getElementById('aiResultShippingDate').textContent = result.shippingDate || 'æŒ‡å®šãªã—';
      document.getElementById('aiResultDeliveryDate').textContent = result.deliveryDate || 'æŒ‡å®šãªã—';
      document.getElementById('aiResultDeliveryTime').textContent = result.deliveryTime || 'æŒ‡å®šãªã—';
      displayShippingTo(result.shippingTo);
      displayCustomer(result.customer);
      
      // ğŸ¤– é¡§å®¢æ¨å®šå€™è£œã‚’è¡¨ç¤ºï¼ˆé¡§å®¢ãŒnullã§ã‚‚è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ã“ã“ã§å‘¼ã³å‡ºã—ï¼‰
      displayCustomerSuggestion();
      
      displayItemsEditable(result.items, result.unknownItems);
      if (result.memo) {
        document.getElementById('memoSection').style.display = 'block';
        document.getElementById('aiResultMemo').textContent = result.memo;
      } else {
        document.getElementById('memoSection').style.display = 'none';
      }
      document.getElementById('aiError').style.display = 'none';
      updateLearnSummary();
      setupNewRegistrationButtons(result);
    }
    
    /**
     * ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
     */
    function displayAlerts(alerts) {
      const container = document.getElementById('aiAlerts');
      container.innerHTML = alerts.map(a => '<div class="ai-alert-item ' + (a.includes('æ–°è¦') || a.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') ? 'ai-alert-warning' : 'ai-alert-info') + '">' + a + '</div>').join('');
    }
    
    /**
     * ç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
     *
     * AIè§£æã•ã‚ŒãŸç™ºé€å…ˆæƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * ãƒã‚¹ã‚¿ãƒãƒƒãƒãƒ³ã‚°çŠ¶æ³ã«å¿œã˜ã¦ãƒãƒƒã‚¸ã¨é¸æŠè‚¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     *
     * è¡¨ç¤ºå†…å®¹:
     * - ãƒãƒƒãƒãƒ³ã‚°çŠ¶æ…‹ãƒãƒƒã‚¸ï¼ˆæ–°è¦/ä¸€è‡´/éƒ¨åˆ†ä¸€è‡´/ä¾é ¼å…ˆã‹ã‚‰è¨­å®šï¼‰
     * - AIèª­ã¿å–ã‚Šå€¤ï¼ˆrawå€¤: ä¼šç¤¾åã€å®›åã€éƒµä¾¿ç•ªå·ã€ä½æ‰€ã€é›»è©±ç•ªå·ï¼‰
     * - ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒãƒƒãƒã—ãŸå ´åˆï¼‰
     * - æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ï¼ˆæ¤œç´¢ã¾ãŸã¯æ–°è¦ç™»éŒ²ã—ãŸå ´åˆï¼‰
     * - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠãƒœã‚¿ãƒ³ï¼ˆèª­ã¿å–ã‚Š/ãƒã‚¹ã‚¿/æ‰‹å‹•é¸æŠï¼‰
     *
     * ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å„ªå…ˆé †ä½:
     * - æ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ > AIèª­ã¿å–ã‚Š
     *
     * ãƒãƒƒãƒãƒ³ã‚°çŠ¶æ…‹:
     * - exact: å®Œå…¨ä¸€è‡´ï¼ˆâœ…ï¼‰
     * - partial: éƒ¨åˆ†ä¸€è‡´ï¼ˆâš ï¸ï¼‰
     * - new: æ–°è¦
     * - fallback: ä¾é ¼å…ˆã‹ã‚‰è¨­å®šï¼ˆğŸ“ï¼‰
     *
     * @param {Object|null} st - ç™ºé€å…ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆnullã®å ´åˆã¯ç©ºè¡¨ç¤ºï¼‰
     * @returns {void}
     * @see selectSource() - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠå‡¦ç†
     */
    function displayShippingTo(st) {
      const badge = document.getElementById('shippingToMatchBadge');
      const masterDiv = document.getElementById('aiResultShippingToMaster');
      const manualDiv = document.getElementById('aiResultShippingToManual');
      const selectDiv = document.getElementById('shippingToSourceSelect');
      
      // ç™ºé€å…ˆãŒnullã®å ´åˆã¯ç©ºè¡¨ç¤ºã«ã—ã¦ãƒªã‚¿ãƒ¼ãƒ³
      if (!st) {
        badge.innerHTML = '';
        document.getElementById('aiResultShippingToRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>-</div><div class="row"><span class="label">å®›åï¼š</span>-</div><div class="row"><span class="label">ã€’ï¼š</span>-</div><div class="row"><span class="label">ä½æ‰€ï¼š</span>-</div><div class="row"><span class="label">TELï¼š</span>-</div>';
        masterDiv.style.display = 'none';
        manualDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useShippingToMaster = false;
        return;
      }
      
      if (st.isNewShippingTo) {
        badge.innerHTML = '<span class="new-badge">æ–°è¦</span>';
      } else if (st.isCustomerFallback) {
        badge.innerHTML = '<span class="master-match-badge master-match-partial">ğŸ“ ä¾é ¼å…ˆã‹ã‚‰è¨­å®š</span>';
      } else if (st.masterMatch === 'exact') {
        badge.innerHTML = '<span class="master-match-badge master-match-exact">âœ… ä¸€è‡´</span>';
      } else if (st.masterMatch === 'partial') {
        badge.innerHTML = '<span class="master-match-badge master-match-partial">âš ï¸ éƒ¨åˆ†ä¸€è‡´</span>';
      } else {
        badge.innerHTML = '';
      }
      document.getElementById('aiResultShippingToRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>' + (st.rawCompanyName || '-') + '</div><div class="row"><span class="label">å®›åï¼š</span>' + (st.rawPersonName || '-') + '</div><div class="row"><span class="label">ã€’ï¼š</span>' + (st.rawZipcode || '-') + '</div><div class="row"><span class="label">ä½æ‰€ï¼š</span>' + (st.rawAddress || '-') + '</div><div class="row"><span class="label">TELï¼š</span>' + (st.rawTel || '-') + '</div>';

      if (manualShippingToSelection) {
        manualDiv.style.display = 'block';
        const sourceType = manualShippingToSelection.source === 'manual_registration' ? 'æ–°è¦ç™»éŒ²' : 'æ¤œç´¢';
        manualDiv.innerHTML = '<strong>âœ‹ æ‰‹å‹•é¸æŠï¼ˆ' + sourceType + 'ï¼‰</strong><br>' +
          [manualShippingToSelection.companyName, manualShippingToSelection.personName].filter(Boolean).join(' ') +
          '<br>TEL: ' + (manualShippingToSelection.tel || '-') +
          '<br>ã€’' + (manualShippingToSelection.zipcode || '-') + ' ' + (manualShippingToSelection.address || '-');
      } else {
        manualDiv.style.display = 'none';
      }

      if (st.masterData) {
        masterDiv.style.display = 'block';
        masterDiv.innerHTML = '<strong>ğŸ“ ãƒã‚¹ã‚¿ï¼ˆ' + st.matchedBy + 'ï¼‰</strong><br>' + (st.masterData.companyName || '') + ' ' + (st.masterData.personName || '') + '<br>ã€’' + (st.masterData.zipcode || '') + ' ' + (st.masterData.address || '') + '<br>TEL: ' + (st.masterData.tel || '-');
        selectDiv.style.display = 'flex';

        if (manualShippingToSelection) {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
          useShippingToMaster = false;
        } else {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>';
          useShippingToMaster = true;
        }
      } else if (manualShippingToSelection) {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'flex';
        selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
          '<button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
        useShippingToMaster = false;
      } else {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useShippingToMaster = false;
      }
    }
    
    /**
     * é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
     *
     * AIè§£æã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * ãƒã‚¹ã‚¿ãƒãƒƒãƒãƒ³ã‚°çŠ¶æ³ã«å¿œã˜ã¦ãƒãƒƒã‚¸ã¨é¸æŠè‚¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     *
     * è¡¨ç¤ºå†…å®¹:
     * - ãƒãƒƒãƒãƒ³ã‚°çŠ¶æ…‹ãƒãƒƒã‚¸ï¼ˆæ–°è¦/ä¸€è‡´/éƒ¨åˆ†ä¸€è‡´ï¼‰
     * - AIèª­ã¿å–ã‚Šå€¤ï¼ˆrawå€¤: ä¼šç¤¾åã€æ‹…å½“è€…ã€é›»è©±ç•ªå·ã€FAXç•ªå·ï¼‰
     * - ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒãƒƒãƒã—ãŸå ´åˆï¼‰
     * - æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ï¼ˆæ¤œç´¢/æ–°è¦ç™»éŒ²/AIæ¨å®šã—ãŸå ´åˆï¼‰
     * - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠãƒœã‚¿ãƒ³ï¼ˆèª­ã¿å–ã‚Š/ãƒã‚¹ã‚¿/æ‰‹å‹•é¸æŠï¼‰
     * - FAXç•ªå·ç™»éŒ²ä¿ƒé€²ï¼ˆdisplayFaxRegistrationPromptï¼‰
     *
     * æ‰‹å‹•é¸æŠã®ã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—:
     * - manual_registration: æ–°è¦ç™»éŒ²
     * - ai_suggestion: AIæ¨å®šï¼ˆPhase 4ï¼‰
     * - manual: æ¤œç´¢
     *
     * é¡§å®¢åè¡¨ç¤ºå½¢å¼:
     * - å—æ³¨ç”»é¢ã§ã¯å¸¸ã«ã€Œä¼šç¤¾åã€€æ°åã€å½¢å¼ï¼ˆdisplayNameã¯ä½¿ç”¨ã—ãªã„ï¼‰
     *
     * @param {Object|null} cust - é¡§å®¢ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆnullã®å ´åˆã¯ç©ºè¡¨ç¤ºï¼‰
     * @returns {void}
     * @see displayFaxRegistrationPrompt() - FAXç™»éŒ²ä¿ƒé€²è¡¨ç¤º
     * @see selectSource() - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠå‡¦ç†
     */
    function displayCustomer(cust) {
      const badge = document.getElementById('customerMatchBadge');
      const masterDiv = document.getElementById('aiResultCustomerMaster');
      const manualDiv = document.getElementById('aiResultCustomerManual');
      const selectDiv = document.getElementById('customerSourceSelect');
      
      // é¡§å®¢ãŒnullã®å ´åˆã¯ç©ºè¡¨ç¤ºã«ã—ã¦ãƒªã‚¿ãƒ¼ãƒ³
      if (!cust) {
        badge.innerHTML = '';
        document.getElementById('aiResultCustomerRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>-</div>' +
          '<div class="row"><span class="label">æ‹…å½“ï¼š</span>-</div>' +
          '<div class="row"><span class="label">TELï¼š</span>-</div>';
        masterDiv.style.display = 'none';
        manualDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useCustomerMaster = false;
        return;
      }
      
      if (cust.isNewCustomer) {
        badge.innerHTML = '<span class="new-badge">æ–°è¦</span>';
      } else if (cust.masterMatch === 'exact') {
        badge.innerHTML = '<span class="master-match-badge master-match-exact">âœ… ä¸€è‡´</span>';
      } else if (cust.masterMatch === 'partial') {
        badge.innerHTML = '<span class="master-match-badge master-match-partial">âš ï¸ éƒ¨åˆ†ä¸€è‡´</span>';
      } else {
        badge.innerHTML = '';
      }
      // FAXç•ªå·ã‚‚è¡¨ç¤ºã«è¿½åŠ 
      let rawHtml = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>' + (cust.rawCompanyName || '-') + '</div>' +
        '<div class="row"><span class="label">æ‹…å½“ï¼š</span>' + (cust.rawPersonName || '-') + '</div>' +
        '<div class="row"><span class="label">TELï¼š</span>' + (cust.rawTel || '-') + '</div>';
      if (cust.rawFax) {
        rawHtml += '<div class="row"><span class="label">FAXï¼š</span>' + cust.rawFax + '</div>';
      }
      document.getElementById('aiResultCustomerRaw').innerHTML = rawHtml;

      if (manualCustomerSelection) {
        manualDiv.style.display = 'block';
        const sourceType = manualCustomerSelection.source === 'manual_registration' ? 'æ–°è¦ç™»éŒ²' :
                           manualCustomerSelection.source === 'ai_suggestion' ? 'AIæ¨å®š' : 'æ¤œç´¢';
        // å—æ³¨ç”»é¢ã§ã¯å¸¸ã«ã€Œä¼šç¤¾å æ°åã€å½¢å¼ã§è¡¨ç¤ºï¼ˆdisplayNameã¯ä½¿ã‚ãªã„ï¼‰
        const customerName = [manualCustomerSelection.companyName, manualCustomerSelection.personName]
          .filter(Boolean).join('ã€€');
        manualDiv.innerHTML = '<strong>âœ‹ æ‰‹å‹•é¸æŠï¼ˆ' + sourceType + 'ï¼‰</strong><br>' +
          customerName +
          '<br>TEL: ' + (manualCustomerSelection.tel || '-') +
          '<br>ã€’' + (manualCustomerSelection.zipcode || '-') + ' ' + (manualCustomerSelection.address || '-');
      } else {
        manualDiv.style.display = 'none';
      }

      if (cust.masterData) {
        masterDiv.style.display = 'block';
        masterDiv.innerHTML = '<strong>ğŸ“ ãƒã‚¹ã‚¿ï¼ˆ' + cust.matchedBy + 'ï¼‰</strong><br>' + (cust.masterData.displayName || cust.masterData.companyName || '') + '<br>TEL: ' + (cust.masterData.tel || '-');
        selectDiv.style.display = 'flex';

        if (manualCustomerSelection) {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
          useCustomerMaster = false;
        } else {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>';
          useCustomerMaster = true;
        }
      } else if (manualCustomerSelection) {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'flex';
        selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
          '<button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
        useCustomerMaster = false;
      } else {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useCustomerMaster = false;
      }

      // ğŸ“  FAXç•ªå·ç™»éŒ²ä¿ƒé€²ã®è¡¨ç¤º
      displayFaxRegistrationPrompt(cust);
      
      // ğŸ¤– AIæ¨å®šå€™è£œã®è¡¨ç¤ºã¯ displayAnalysisResult() ã§å‘¼ã³å‡ºã™ãŸã‚ã€ã“ã“ã§ã¯ä¸è¦
    }

    /**
     * FAXç•ªå·ç™»éŒ²ä¿ƒé€²UIã‚’è¡¨ç¤º
     *
     * AIè§£æã§FAXç•ªå·ã‚’æ¤œå‡ºã—ã€ãƒãƒƒãƒã—ãŸé¡§å®¢ãƒã‚¹ã‚¿ã«FAXç•ªå·ãŒæœªç™»éŒ²ã®å ´åˆã€
     * ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§FAXç•ªå·ã‚’ç™»éŒ²ã§ãã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     *
     * è¡¨ç¤ºæ¡ä»¶ï¼ˆã™ã¹ã¦æº€ãŸã™å¿…è¦ã‚ã‚Šï¼‰:
     * - AIè§£æçµæœã«FAXç•ªå·ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼ˆ10æ¡ä»¥ä¸Šï¼‰
     * - é¡§å®¢ãƒã‚¹ã‚¿ã¨ãƒãƒƒãƒã—ã¦ã„ã‚‹ï¼ˆexact ã¾ãŸã¯ partialï¼‰
     * - ãƒãƒƒãƒã—ãŸé¡§å®¢ãƒã‚¹ã‚¿ã«FAXç•ªå·ãŒæœªç™»éŒ²
     *
     * ã¾ãŸã¯:
     * - æ‰‹å‹•é¸æŠã—ãŸé¡§å®¢ã«FAXç•ªå·ãŒæœªç™»éŒ²
     * - AIè§£æçµæœã«FAXç•ªå·ãŒå«ã¾ã‚Œã¦ã„ã‚‹
     *
     * è¡¨ç¤ºå†…å®¹:
     * - FAXç•ªå·ï¼ˆAIãŒèª­ã¿å–ã£ãŸå€¤ï¼‰
     * - é¡§å®¢åï¼ˆãƒã‚¹ã‚¿ã®è¡¨ç¤ºåï¼‰
     * - èª¬æ˜æ–‡ï¼ˆç™»éŒ²ä¿ƒé€²ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
     * - ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆregisterCustomerFaxå‘¼ã³å‡ºã—ï¼‰
     *
     * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:
     * - escapeHtml()ã§XSSå¯¾ç­–æ¸ˆã¿
     *
     * @param {Object} cust - é¡§å®¢ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @returns {void}
     * @see registerCustomerFax() - FAXç•ªå·ç™»éŒ²å‡¦ç†
     * @see escapeHtml() - HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
     */
    function displayFaxRegistrationPrompt(cust) {
      const promptDiv = document.getElementById('faxRegistrationPrompt');
      if (!promptDiv) return;

      // æ¡ä»¶ãƒã‚§ãƒƒã‚¯
      const hasRawFax = cust.rawFax && sanitizeTel(cust.rawFax).length >= 10;
      const hasCustomerMatch = cust.masterMatch === 'exact' || cust.masterMatch === 'partial';
      const hasMasterData = cust.masterData;
      const masterHasNoFax = hasMasterData && !cust.masterData.fax;

      // æ‰‹å‹•é¸æŠæ™‚ã‚‚å¯¾å¿œ
      let targetCustomer = null;
      if (manualCustomerSelection && !manualCustomerSelection.fax && hasRawFax) {
        targetCustomer = manualCustomerSelection;
      } else if (hasRawFax && hasCustomerMatch && masterHasNoFax) {
        targetCustomer = cust.masterData;
      }

      if (!targetCustomer) {
        promptDiv.style.display = 'none';
        return;
      }

      // è¡¨ç¤º
      promptDiv.style.display = 'block';
      const customerName = targetCustomer.displayName || 
        [targetCustomer.companyName, targetCustomer.personName].filter(Boolean).join('ã€€');
      
      promptDiv.innerHTML = 
        '<div class="fax-header">ğŸ“  FAXç•ªå·ã®ç™»éŒ²</div>' +
        '<div class="fax-number">' + escapeHtml(cust.rawFax) + '</div>' +
        '<div class="fax-description">' +
          'ã€Œ' + escapeHtml(customerName) + 'ã€ã®ãƒã‚¹ã‚¿ã«FAXç•ªå·ãŒæœªç™»éŒ²ã§ã™ã€‚<br>' +
          'ã“ã®ç•ªå·ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€æ¬¡å›ã‹ã‚‰è‡ªå‹•ã§ãƒãƒƒãƒãƒ³ã‚°ã§ãã¾ã™ã€‚' +
        '</div>' +
        '<button type="button" class="btn-register-fax" onclick="registerCustomerFax()">' +
          'âœ… ã“ã®é¡§å®¢ã«FAXç•ªå·ã‚’ç™»éŒ²' +
        '</button>';
    }

    /**
     * é¡§å®¢ãƒã‚¹ã‚¿ã«FAXç•ªå·ã‚’ç™»éŒ²
     *
     * AIè§£æã§æ¤œå‡ºã•ã‚ŒãŸFAXç•ªå·ã‚’æ—¢å­˜ã®é¡§å®¢ãƒã‚¹ã‚¿ã«è¿½åŠ ç™»éŒ²ã—ã¾ã™ã€‚
     * ç™»éŒ²æˆåŠŸå¾Œã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’éè¡¨ç¤ºã«ã—ã€ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. AIè§£æçµæœã‹ã‚‰FAXç•ªå·ã‚’å–å¾—
     * 2. ç™»éŒ²å¯¾è±¡é¡§å®¢ã‚’ç‰¹å®šï¼ˆæ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼‰
     * 3. ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
     * 4. ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ï¼ˆupdateCustomerFaxï¼‰ã‚’å‘¼ã³å‡ºã—
     * 5. æˆåŠŸæ™‚: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆéè¡¨ç¤ºã€ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã€æˆåŠŸãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
     * 6. å¤±æ•—æ™‚: ãƒœã‚¿ãƒ³å†æœ‰åŠ¹åŒ–ã€ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
     *
     * ç™»éŒ²å¯¾è±¡é¡§å®¢ã®ç‰¹å®š:
     * - manualCustomerSelection ãŒå­˜åœ¨ã™ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
     * - ãªã‘ã‚Œã° cust.masterData ã‚’ä½¿ç”¨
     *
     * ãƒ‡ãƒ¼ã‚¿æ›´æ–°:
     * - aiAnalysisResult.customer.masterData.fax ã‚’æ›´æ–°
     * - manualCustomerSelection.fax ã‚’æ›´æ–°ï¼ˆè©²å½“æ™‚ï¼‰
     *
     * @returns {void}
     * @see displayFaxRegistrationPrompt() - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºå‡¦ç†
     * @see updateCustomerFax() - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰FAXæ›´æ–°é–¢æ•°
     */
    function registerCustomerFax() {
      const cust = aiAnalysisResult?.customer;
      if (!cust || !cust.rawFax) {
        showWarningToast('FAXç•ªå·ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      // ç™»éŒ²å¯¾è±¡ã®é¡§å®¢ã‚’ç‰¹å®š
      let targetCustomer = null;
      if (manualCustomerSelection) {
        targetCustomer = manualCustomerSelection;
      } else if (cust.masterData) {
        targetCustomer = cust.masterData;
      }

      if (!targetCustomer) {
        showWarningToast('ç™»éŒ²å¯¾è±¡ã®é¡§å®¢ãŒç‰¹å®šã§ãã¾ã›ã‚“');
        return;
      }

      const customerDisplayName = targetCustomer.displayName || '';
      const customerCompanyName = targetCustomer.companyName || '';
      const customerPersonName = targetCustomer.personName || '';
      const faxNumber = cust.rawFax;

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const btn = document.querySelector('.btn-register-fax');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'ç™»éŒ²ä¸­...';
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccessToast('FAXç•ªå·ã‚’ç™»éŒ²ã—ã¾ã—ãŸ: ' + result.faxNumber);
            // ç™»éŒ²æˆåŠŸã—ãŸã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’éè¡¨ç¤ºã«
            const promptDiv = document.getElementById('faxRegistrationPrompt');
            if (promptDiv) {
              promptDiv.style.display = 'none';
            }
            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            if (cust.masterData) {
              cust.masterData.fax = result.faxNumber;
            }
            if (manualCustomerSelection) {
              manualCustomerSelection.fax = result.faxNumber;
            }
          } else {
            showWarningToast('ç™»éŒ²å¤±æ•—: ' + result.error);
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'âœ… ã“ã®é¡§å®¢ã«FAXç•ªå·ã‚’ç™»éŒ²';
            }
          }
        })
        .withFailureHandler(function(error) {
          showWarningToast('ã‚¨ãƒ©ãƒ¼: ' + error.message);
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'âœ… ã“ã®é¡§å®¢ã«FAXç•ªå·ã‚’ç™»éŒ²';
          }
        })
        .updateCustomerFax(customerDisplayName, customerCompanyName, customerPersonName, faxNumber);
    }

    /**
     * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
     */
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    /**
     * AIé¡§å®¢æ¨å®šå€™è£œã‚’è¡¨ç¤ºï¼ˆPhase 4ï¼‰
     *
     * AIè‡ªå‹•å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹é¡§å®¢æ¨å®šçµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * ç™ºé€å…ˆåã‹ã‚‰éå»ã®å—æ³¨å±¥æ­´ã¨å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«é¡§å®¢ã‚’æ¨å®šã—ã€
     * 1ã‚¯ãƒªãƒƒã‚¯ã§é©ç”¨ã§ãã‚‹å€™è£œã‚’æç¤ºã—ã¾ã™ã€‚
     *
     * è¡¨ç¤ºå†…å®¹:
     * - ä¸»è¦å€™è£œï¼ˆé¡§å®¢åã€ä¿¡é ¼åº¦ã€é©ç”¨ãƒœã‚¿ãƒ³ï¼‰
     * - ä»£æ›¿å€™è£œãƒªã‚¹ãƒˆï¼ˆconfidence 40%ä»¥ä¸Šï¼‰
     * - æ¨å®šæ ¹æ‹ ï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’/å—æ³¨å±¥æ­´ï¼‰
     *
     * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:
     * - XSSå¯¾ç­–ã®ãŸã‚ã€createElement() + textContent ã§å®‰å…¨ã«ç”Ÿæˆ
     *
     * ä¿¡é ¼åº¦ã®åŸºæº–:
     * - 80%ä»¥ä¸Š: ã€Œæ¨å¥¨å€™è£œã€ã¨ã—ã¦è¡¨ç¤º
     * - 40-79%: ã€Œå€™è£œã€ã¨ã—ã¦è¡¨ç¤º
     * - 40%æœªæº€: è¡¨ç¤ºã—ãªã„
     *
     * @returns {void}
     * @see applyCustomerSuggestion() - å€™è£œé©ç”¨å‡¦ç†
     * @see estimateCustomerFromShippingTo() - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¨å®šãƒ­ã‚¸ãƒƒã‚¯
     */
    function displayCustomerSuggestion() {
      const suggestionDiv = document.getElementById('aiResultCustomerSuggestion');

      // æ¨å®šçµæœãŒãªã„å ´åˆã¯éè¡¨ç¤º
      if (!aiAnalysisResult || !aiAnalysisResult.customerEstimation || !aiAnalysisResult.customerEstimation.customer) {
        suggestionDiv.style.display = 'none';
        return;
      }

      const estimation = aiAnalysisResult.customerEstimation;
      const confidence = estimation.confidence || 0;
      const isHighConfidence = confidence >= 80;

      // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
      suggestionDiv.innerHTML = '';
      suggestionDiv.style.display = 'block';

      // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
      const header = document.createElement('div');
      header.className = 'ai-suggestion-header';
      const headerText = document.createElement('strong');
      headerText.textContent = isHighConfidence ? 'ğŸ¤– æ¨å¥¨å€™è£œï¼ˆè‡ªå‹•å­¦ç¿’ï¼‰' : 'ğŸ¤– å€™è£œï¼ˆè‡ªå‹•å­¦ç¿’ï¼‰';
      header.appendChild(headerText);
      suggestionDiv.appendChild(header);

      // ä¸»è¦å€™è£œã‚¨ãƒªã‚¢
      const primaryDiv = document.createElement('div');
      primaryDiv.className = 'ai-suggestion-primary';

      // é¡§å®¢å
      const nameDiv = document.createElement('div');
      nameDiv.className = 'suggestion-customer-name';
      nameDiv.textContent = estimation.customer;
      primaryDiv.appendChild(nameDiv);

      // ä¿¡é ¼åº¦ã¨ã‚½ãƒ¼ã‚¹
      const confidenceDiv = document.createElement('div');
      confidenceDiv.className = 'suggestion-confidence';
      let confidenceText = 'ä¿¡é ¼åº¦: ' + confidence + '%';
      if (estimation.sources && estimation.sources.length > 0) {
        const sourceLabels = {
          'mapping': 'ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’',
          'order_history': 'å—æ³¨å±¥æ­´'
        };
        const sourceText = estimation.sources.map(function(s) {
          return sourceLabels[s] || s;
        }).join(', ');
        confidenceText += ' (' + sourceText + ')';
      }
      confidenceDiv.textContent = confidenceText;
      primaryDiv.appendChild(confidenceDiv);

      // é©ç”¨ãƒœã‚¿ãƒ³
      const applyBtn = document.createElement('button');
      applyBtn.type = 'button';
      applyBtn.className = 'btn-apply-suggestion';
      applyBtn.textContent = 'âœ… ã“ã®å€™è£œã‚’é©ç”¨';
      applyBtn.onclick = function() {
        applyCustomerSuggestion(estimation.customer);
      };
      primaryDiv.appendChild(applyBtn);

      suggestionDiv.appendChild(primaryDiv);

      // ä»£æ›¿å€™è£œï¼ˆã‚ã‚Œã°ï¼‰
      if (estimation.alternatives && estimation.alternatives.length > 0) {
        const altDiv = document.createElement('div');
        altDiv.className = 'ai-suggestion-alternatives';

        const altLabel = document.createElement('div');
        altLabel.className = 'alternatives-label';
        altLabel.textContent = 'ä»–ã®å€™è£œ:';
        altDiv.appendChild(altLabel);

        const altList = document.createElement('ul');
        altList.className = 'alternatives-list';

        estimation.alternatives.forEach(function(alt) {
          const li = document.createElement('li');

          const nameSpan = document.createElement('span');
          nameSpan.className = 'alt-customer-name';
          nameSpan.textContent = alt.customer;
          li.appendChild(nameSpan);

          const confSpan = document.createElement('span');
          confSpan.className = 'alt-confidence';
          confSpan.textContent = ' (' + alt.confidence + '%) ';
          li.appendChild(confSpan);

          const altBtn = document.createElement('button');
          altBtn.type = 'button';
          altBtn.className = 'btn-apply-alt';
          altBtn.textContent = 'é©ç”¨';
          altBtn.onclick = function() {
            applyCustomerSuggestion(alt.customer);
          };
          li.appendChild(altBtn);

          altList.appendChild(li);
        });

        altDiv.appendChild(altList);
        suggestionDiv.appendChild(altDiv);
      }
    }

    /**
     * AIé¡§å®¢æ¨å®šå€™è£œã‚’é©ç”¨ï¼ˆ1ã‚¯ãƒªãƒƒã‚¯é©ç”¨æ©Ÿèƒ½ã€Phase 4ï¼‰
     *
     * è¡¨ç¤ºã•ã‚ŒãŸæ¨å®šå€™è£œã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€é¡§å®¢æƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. é¡§å®¢ãƒã‚¹ã‚¿ã‹ã‚‰è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆgetCustomerByDisplayNameï¼‰
     * 2. manualCustomerSelectionã«ä¿å­˜ï¼ˆsourceã¯'ai_suggestion'ï¼‰
     * 3. ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›ï¼ˆé¡§å®¢åã€éƒµä¾¿ç•ªå·ã€ä½æ‰€ã€é›»è©±ç•ªå·ï¼‰
     * 4. AIè§£æçµæœè¡¨ç¤ºã‚’æ›´æ–°
     *
     * ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è­˜åˆ¥:
     * - source: 'ai_suggestion' ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€AIæ¨å®šç”±æ¥ã§ã‚ã‚‹ã“ã¨ã‚’è¨˜éŒ²
     *
     * @param {string} customerName - é©ç”¨ã™ã‚‹é¡§å®¢åï¼ˆè¡¨ç¤ºåã€ä¼šç¤¾åã€ã¾ãŸã¯ä¼šç¤¾å+æ°åï¼‰
     * @returns {void}
     * @see getCustomerByDisplayName() - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é¡§å®¢æ¤œç´¢é–¢æ•°
     * @see displayCustomerSuggestion() - å€™è£œè¡¨ç¤ºå‡¦ç†
     */
    function applyCustomerSuggestion(customerName) {
      if (!customerName) {
        showToast('é¡§å®¢åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      showLoading('é¡§å®¢æƒ…å ±ã‚’å–å¾—ä¸­...');

      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰é¡§å®¢æƒ…å ±ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(customerData) {
          hideLoading();

          if (!customerData) {
            showToast('é¡§å®¢æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: ' + customerName, 'error');
            return;
          }

          // manualCustomerSelectionã«ä¿å­˜
          manualCustomerSelection = {
            displayName: customerData.displayName || customerName,
            companyName: customerData.companyName || '',
            personName: customerData.personName || '',
            zipcode: customerData.zipcode || '',
            address: customerData.address || '',
            tel: customerData.tel || '',
            fax: customerData.fax || '',
            email: customerData.email || '',
            source: 'ai_suggestion' // ã‚½ãƒ¼ã‚¹ã‚’è­˜åˆ¥
          };

          console.log('AIå€™è£œã‹ã‚‰é¸æŠã—ãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜:', manualCustomerSelection);

          // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’å…¥åŠ›
          const companyName = customerData.companyName || '';
          const personName = customerData.personName || '';

          if (companyName) {
            document.querySelector('input[id="customerName"]').value = companyName + 'ã€€' + personName;
          } else {
            document.querySelector('input[id="customerName"]').value = personName;
          }

          document.querySelector('input[id="customerZipcode"]').value = customerData.zipcode || '';
          document.querySelector('input[id="customerAddress"]').value = customerData.address || '';
          document.querySelector('input[id="customerTel"]').value = customerData.tel || '';

          // AIè§£æçµæœã®è¡¨ç¤ºã‚’æ›´æ–°
          if (aiAnalysisResult && aiAnalysisResult.customer) {
            displayCustomer(aiAnalysisResult.customer);
          }

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          showToast('é¡§å®¢æƒ…å ±ã‚’é©ç”¨ã—ã¾ã—ãŸ: ' + customerName, 'success');

          // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’é–‰ã˜ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          // toggleAIAssistant();
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('é¡§å®¢æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
          showToast('é¡§å®¢æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .getCustomerByDisplayName(customerName);
    }

    /**
     * ç·¨é›†å¯èƒ½ãªå•†å“ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
     *
     * AIè§£æã§æŠ½å‡ºã•ã‚ŒãŸå•†å“ã‚’ç·¨é›†å¯èƒ½ãªã‚«ãƒ¼ãƒ‰å½¢å¼ã§è¡¨ç¤ºã—ã¾ã™ã€‚
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚«ãƒ†ã‚´ãƒªã€å•†å“åã€è¦æ ¼ã€ä¾¡æ ¼ã€æ•°é‡ã‚’ä¿®æ­£ã§ãã€
     * ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§å­¦ç¿’å¯¾è±¡ã‚’é¸æŠã§ãã¾ã™ã€‚
     *
     * è¡¨ç¤ºå†…å®¹ï¼ˆå•†å“ã‚«ãƒ¼ãƒ‰ã”ã¨ï¼‰:
     * - åŸæ–‡ãƒ†ã‚­ã‚¹ãƒˆï¼ˆAIèª­ã¿å–ã‚Šå…ƒï¼‰
     * - ä¿¡é ¼åº¦ãƒãƒƒã‚¸ï¼ˆé«˜/ä¸­/ä½ï¼‰ã¾ãŸã¯å­¦ç¿’æ¸ˆã¿ãƒãƒƒã‚¸
     * - åˆ†é¡ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼ˆå¤‰æ›´æ™‚ã«å•†å“ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹ï¼‰
     * - å•†å“ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‹ä»–ã‚«ãƒ†ã‚´ãƒªï¼‰
     * - è¦æ ¼å…¥åŠ›æ¬„
     * - ä¾¡æ ¼å…¥åŠ›æ¬„ï¼ˆä¾¡æ ¼ãƒãƒƒã‚¸: AIèª­ã¿å–ã‚Š/ãƒã‚¹ã‚¿ï¼‰
     * - æ•°é‡ï¼‹å˜ä½ï¼ˆã‚±ãƒ¼ã‚¹/æœ¬/è¢‹/kg/å€‹ï¼‰
     * - å­¦ç¿’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆæœªå­¦ç¿’å•†å“ã®ã¿ã€lowä¿¡é ¼åº¦ã¯é™¤å¤–ï¼‰
     *
     * ä¾¡æ ¼è‡ªå‹•å…¥åŠ›:
     * - AIèª­ã¿å–ã‚Šä¾¡æ ¼ãŒã‚ã‚‹å ´åˆ: ãã®ã¾ã¾ä½¿ç”¨ï¼ˆãƒãƒƒã‚¸: é¡§å®¢æŒ‡å®šï¼‰
     * - ãªã„å ´åˆã€å•†å“ãƒã‚¹ã‚¿ã«ä¾¡æ ¼ãŒã‚ã‚‹å ´åˆ: ãƒã‚¹ã‚¿ä¾¡æ ¼ã‚’ä½¿ç”¨ï¼ˆãƒãƒƒã‚¸: ãƒã‚¹ã‚¿ï¼‰
     *
     * å­¦ç¿’æ¸ˆã¿åˆ¤å®š:
     * - mappingMatch.found && matchType === 'exact' â†’ å­¦ç¿’æ¸ˆã¿ãƒãƒƒã‚¸è¡¨ç¤º
     * - å­¦ç¿’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯éè¡¨ç¤º
     *
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°:
     * - itemEdits: å„å•†å“ã®ç·¨é›†å†…å®¹ã‚’ä¿å­˜
     *
     * @param {Array} items - å•†å“é…åˆ—ï¼ˆAIè§£æçµæœï¼‰
     * @param {Array} unknownItems - æœªèªè­˜å•†å“é…åˆ—ï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰
     * @returns {void}
     * @see onCategoryChange() - ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
     * @see onProductChange() - å•†å“å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
     * @see toggleLearn() - å­¦ç¿’ãƒã‚§ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆ
     * @see buildProductOptions() - å•†å“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
     */
    function displayItemsEditable(items, unknownItems) {
      const container = document.getElementById('aiResultItems');
      container.innerHTML = '';
      if (!items || items.length === 0) {
        container.innerHTML = '<p style="color:#999;">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
        return;
      }
      items.forEach((item, index) => {
        const mappingMatch = item.mappingMatch || {};
        const isLearned = mappingMatch.found && mappingMatch.matchType === 'exact';
        const canLearn = !isLearned && item.originalText;
        
        let price = 0;
        let priceSource = 'none';
        if (item.price && item.price > 0) {
          price = item.price;
          priceSource = item.priceSource || 'ai';
        } else if (item.productName && productPrices[item.productName]) {
          price = productPrices[item.productName];
          priceSource = 'master';
        }
        
        itemEdits[index] = {
          category: item.category || '',
          productName: item.productName || '',
          spec: item.spec || '',
          quantity: item.quantity || '',
          unit: item.unit || 'ã‚±ãƒ¼ã‚¹',
          price: price,
          priceSource: priceSource,
          learn: canLearn && item.confidence !== 'low',
          originalText: item.originalText || '',
          originalProductName: item.productName || ''
        };
        
        const cardClass = isLearned ? 'learned' : '';
        let categoryOptions = '<option value="">é¸æŠ...</option>';
        categoryList.forEach(cat => {
          categoryOptions += '<option value="' + cat + '" ' + (cat === item.category ? 'selected' : '') + '>' + cat + '</option>';
        });
        let productOptions = buildProductOptions(item.category, item.productName);
        
        let badgeHtml = '';
        if (isLearned) {
          badgeHtml = '<span class="mapping-badge">ğŸ“š å­¦ç¿’æ¸ˆã¿ï¼ˆ' + mappingMatch.usageCount + 'å›ä½¿ç”¨ï¼‰</span>';
        } else {
          badgeHtml = '<span class="confidence-badge confidence-' + item.confidence + '">' + getConfidenceLabel(item.confidence) + '</span>';
        }
        
        let priceBadgeHtml = '';
        if (priceSource === 'ai') {
          priceBadgeHtml = '<span class="price-badge ai">é¡§å®¢æŒ‡å®š</span>';
        } else if (priceSource === 'master') {
          priceBadgeHtml = '<span class="price-badge master">ãƒã‚¹ã‚¿</span>';
        }
        
        let learnHtml = '';
        if (canLearn) {
          const checked = itemEdits[index].learn ? 'checked' : '';
          learnHtml = '<div class="item-learn-row ' + (itemEdits[index].learn ? 'will-learn' : '') + '" id="learnRow_' + index + '"><input type="checkbox" id="learn_' + index + '" ' + checked + ' onchange="toggleLearn(' + index + ')"><label for="learn_' + index + '">ã“ã®å¯¾å¿œã‚’è¨˜æ†¶ã™ã‚‹</label><span class="learn-preview" id="learnPreview_' + index + '" style="' + (itemEdits[index].learn ? '' : 'display:none') + '">â†’ ' + (item.productName || 'æœªé¸æŠ') + '</span></div>';
        }
        
        container.innerHTML += '<div class="item-card ' + cardClass + '" id="itemCard_' + index + '"><div class="item-card-header"><span class="item-original-text">ğŸ“ ' + (item.originalText || '(åŸæ–‡ãªã—)') + '</span>' + badgeHtml + '</div><div class="item-card-body"><div class="item-edit-row"><label>åˆ†é¡:</label><select id="category_' + index + '" onchange="onCategoryChange(' + index + ')">' + categoryOptions + '</select></div><div class="item-edit-row"><label>å•†å“:</label><select id="product_' + index + '" onchange="onProductChange(' + index + ')">' + productOptions + '</select></div><div class="item-edit-row"><label>è¦æ ¼:</label><input type="text" id="spec_' + index + '" value="' + (item.spec || '') + '" onchange="onSpecChange(' + index + ')"></div><div class="item-edit-row"><label>ä¾¡æ ¼:</label><div class="price-group"><input type="number" id="price_' + index + '" value="' + price + '" onchange="onPriceChange(' + index + ')"><span class="unit">å††</span>' + priceBadgeHtml + '</div></div><div class="item-edit-row"><label>æ•°é‡:</label><div class="quantity-group"><input type="number" id="quantity_' + index + '" value="' + (item.quantity || '') + '" step="0.1" onchange="onQuantityChange(' + index + ')"><select id="unit_' + index + '" onchange="onUnitChange(' + index + ')"><option value="ã‚±ãƒ¼ã‚¹" ' + (item.unit === 'ã‚±ãƒ¼ã‚¹' ? 'selected' : '') + '>ã‚±ãƒ¼ã‚¹</option><option value="æœ¬" ' + (item.unit === 'æœ¬' ? 'selected' : '') + '>æœ¬</option><option value="è¢‹" ' + (item.unit === 'è¢‹' ? 'selected' : '') + '>è¢‹</option><option value="kg" ' + (item.unit === 'kg' ? 'selected' : '') + '>kg</option><option value="å€‹" ' + (item.unit === 'å€‹' ? 'selected' : '') + '>å€‹</option></select></div></div>' + learnHtml + '</div></div>';
      });
    }
    
    /**
     * å•†å“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
     */
    function buildProductOptions(category, selectedProduct) {
      let options = '<option value="">é¸æŠ...</option>';
      if (category && productMaster[category]) {
        productMaster[category].forEach(prod => {
          options += '<option value="' + prod + '" ' + (prod === selectedProduct ? 'selected' : '') + '>' + prod + '</option>';
        });
      }
      categoryList.forEach(cat => {
        if (cat !== category && productMaster[cat]) {
          options += '<optgroup label="â”€â”€ ' + cat + ' â”€â”€">';
          productMaster[cat].forEach(prod => {
            options += '<option value="' + prod + '" ' + (prod === selectedProduct ? 'selected' : '') + '>' + prod + '</option>';
          });
          options += '</optgroup>';
        }
      });
      return options;
    }
    
    /**
     * ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
     */
    function onCategoryChange(index) {
      const category = document.getElementById('category_' + index).value;
      itemEdits[index].category = category;
      const productSelect = document.getElementById('product_' + index);
      productSelect.innerHTML = buildProductOptions(category, '');
      itemEdits[index].productName = '';
      itemEdits[index].price = 0;
      document.getElementById('price_' + index).value = 0;
      checkModified(index);
      updateLearnSummary();
    }
    
    /**
     * å•†å“å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
     */
    function onProductChange(index) {
      const productName = document.getElementById('product_' + index).value;
      itemEdits[index].productName = productName;
      if (productName && productPrices[productName] && itemEdits[index].priceSource !== 'ai') {
        itemEdits[index].price = productPrices[productName];
        itemEdits[index].priceSource = 'master';
        document.getElementById('price_' + index).value = productPrices[productName];
      }
      const preview = document.getElementById('learnPreview_' + index);
      if (preview) preview.textContent = 'â†’ ' + (productName || 'æœªé¸æŠ');
      checkModified(index);
      updateLearnSummary();
    }
    
    function onSpecChange(index) {
      itemEdits[index].spec = document.getElementById('spec_' + index).value;
      checkModified(index);
    }
    
    function onPriceChange(index) {
      itemEdits[index].price = Number(document.getElementById('price_' + index).value) || 0;
      itemEdits[index].priceSource = 'manual';
      checkModified(index);
    }
    
    function onQuantityChange(index) {
      itemEdits[index].quantity = document.getElementById('quantity_' + index).value;
      checkModified(index);
    }
    
    function onUnitChange(index) {
      itemEdits[index].unit = document.getElementById('unit_' + index).value;
      checkModified(index);
    }
    
    /**
     * å­¦ç¿’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ‡ã‚Šæ›¿ãˆ
     */
    function toggleLearn(index) {
      const checked = document.getElementById('learn_' + index).checked;
      itemEdits[index].learn = checked;
      const row = document.getElementById('learnRow_' + index);
      const preview = document.getElementById('learnPreview_' + index);
      if (checked) { row.classList.add('will-learn'); preview.style.display = ''; }
      else { row.classList.remove('will-learn'); preview.style.display = 'none'; }
      updateLearnSummary();
    }
    
    /**
     * å¤‰æ›´ãƒã‚§ãƒƒã‚¯
     */
    function checkModified(index) {
      const card = document.getElementById('itemCard_' + index);
      const edit = itemEdits[index];
      if (edit.productName !== edit.originalProductName) { card.classList.add('modified'); }
      else { card.classList.remove('modified'); }
    }
    
    /**
     * å­¦ç¿’ã‚µãƒãƒªæ›´æ–°
     */
    function updateLearnSummary() {
      const summaryDiv = document.getElementById('learnSummary');
      const itemsDiv = document.getElementById('learnSummaryItems');
      const learnList = [];
      Object.keys(itemEdits).forEach(index => {
        const edit = itemEdits[index];
        if (edit.learn && edit.originalText && edit.productName) {
          learnList.push({ originalText: edit.originalText, productName: edit.productName, isModified: edit.productName !== edit.originalProductName });
        }
      });
      if (learnList.length === 0) { summaryDiv.style.display = 'none'; return; }
      summaryDiv.style.display = 'block';
      itemsDiv.innerHTML = learnList.map(l => '<div class="learn-summary-item"><span class="original">ã€Œ' + l.originalText + 'ã€</span><span class="arrow">â†’</span><span class="product">' + l.productName + '</span>' + (l.isModified ? '<span class="modified-badge">ä¿®æ­£æ¸ˆ</span>' : '') + '</div>').join('');
    }
    
    /**
     * ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ
     */
    function selectSource(type, source) {
      if (type === 'shippingTo') {
        useShippingToMaster = (source === 'master');
      } else {
        useCustomerMaster = (source === 'master');
      }
      const btns = document.querySelectorAll('#' + type + 'SourceSelect .source-select-btn');
      btns.forEach(btn => {
        btn.classList.remove('selected');
      });
      btns.forEach(btn => {
        const btnText = btn.textContent.trim();
        if ((source === 'raw' && btnText.includes('èª­ã¿å–ã‚Š')) ||
            (source === 'master' && btnText.includes('ãƒã‚¹ã‚¿')) ||
            (source === 'manual' && btnText.includes('æ‰‹å‹•é¸æŠ'))) {
          btn.classList.add('selected');
        }
      });
      console.log('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ:', type, source);
    }
    
    /**
     * ä¿¡é ¼åº¦ãƒãƒƒã‚¸è¨­å®š
     */
    function setConfidenceBadge(id, conf) {
      const el = document.getElementById(id);
      if (!el) return;
      el.className = 'confidence-badge confidence-' + (conf || 'low');
      el.textContent = getConfidenceLabel(conf);
    }
    
    /**
     * ä¿¡é ¼åº¦ãƒ©ãƒ™ãƒ«å–å¾—
     */
    function getConfidenceLabel(conf) {
      return { high: 'âœ… é«˜', medium: 'âš ï¸ ä¸­', low: 'â“ ä½' }[conf] || 'â“';
    }
    
    /**
     * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
     */
    function showError(msg) {
      document.getElementById('aiResultArea').classList.add('show');
      document.getElementById('aiError').style.display = 'block';
      document.getElementById('aiError').textContent = msg;
    }
    
    /**
     * AIè§£æçµæœã‚¯ãƒªã‚¢
     */
    function clearAIResult() {
      aiAnalysisResult = null;
      useShippingToMaster = useCustomerMaster = false;
      itemEdits = {};
      document.getElementById('aiResultArea').classList.remove('show');
      document.getElementById('aiInputText').value = '';
      removeFile();
    }
    
    /**
     * AIè§£æçµæœã‚’å—æ³¨ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼ˆæœ€é‡è¦é–¢æ•°ï¼‰
     *
     * AIè§£æçµæœã¨å•†å“ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’å†…å®¹ã‚’å—æ³¨ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨ã—ã¾ã™ã€‚
     * ã“ã‚Œã¯ã€Œãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã€ãƒœã‚¿ãƒ³ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†é–¢æ•°ã§ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. å•†å“ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®è¨˜éŒ²ï¼ˆlearn=trueã®å•†å“ï¼‰
     *    - ç™ºé€å…ˆåå„ªå…ˆã§ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆç™ºé€å…ˆå â†’ å•†å“åï¼‰
     *    - å¾Œæ–¹äº’æ›ã®ãŸã‚é¡§å®¢åã‚‚è¨˜éŒ²
     * 2. æ—¥ä»˜æƒ…å ±ã®åæ˜ ï¼ˆç™ºé€æ—¥ã€é…é€å¸Œæœ›æ—¥ï¼‰
     * 3. ç™ºé€å…ˆæƒ…å ±ã®åæ˜ ï¼ˆå„ªå…ˆé †ä½: æ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ > AIèª­ã¿å–ã‚Šï¼‰
     * 4. é¡§å®¢æƒ…å ±ã®åæ˜ ï¼ˆå„ªå…ˆé †ä½: æ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ > AIèª­ã¿å–ã‚Šï¼‰
     * 5. å•†å“æƒ…å ±ã®åæ˜ ï¼ˆæœ€å¤§10è¡Œã€åˆ†é¡ãƒ»å•†å“ãƒ»ä¾¡æ ¼ãƒ»æ•°é‡ï¼‰
     * 6. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
     * 7. è§£ææ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è¡¨ç¤º
     * 8. æˆåŠŸãƒˆãƒ¼ã‚¹ãƒˆã®è¡¨ç¤ºï¼ˆå­¦ç¿’ä»¶æ•°å«ã‚€ï¼‰
     * 9. AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
     *
     * ãƒ‡ãƒ¼ã‚¿é©ç”¨ã®å„ªå…ˆé †ä½:
     * - æ‰‹å‹•é¸æŠï¼ˆæ¤œç´¢/æ–°è¦ç™»éŒ²/AIæ¨å®šï¼‰: æœ€å„ªå…ˆ
     * - ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆè‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°ï¼‰: ä¸­å„ªå…ˆ
     * - AIèª­ã¿å–ã‚Šï¼ˆrawå€¤ï¼‰: æœ€ä½å„ªå…ˆ
     *
     * ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’:
     * - Phase 5å®Ÿè£…: ç™ºé€å…ˆåå„ªå…ˆãƒãƒƒãƒ”ãƒ³ã‚°
     * - åŸæ–‡ãƒ†ã‚­ã‚¹ãƒˆ â†’ å•†å“å ã®å¯¾å¿œã‚’å­¦ç¿’
     * - æ¬¡å›ã‹ã‚‰åŒã˜åŸæ–‡ãŒè‡ªå‹•èªè­˜ã•ã‚Œã‚‹
     *
     * é¡§å®¢åè¡¨ç¤ºå½¢å¼:
     * - å—æ³¨ç”»é¢ã§ã¯å¸¸ã«ã€Œä¼šç¤¾åã€€æ°åã€å½¢å¼ï¼ˆdisplayNameã¯ä½¿ç”¨ã—ãªã„ï¼‰
     *
     * @returns {void}
     * @see registerProductMappingBulk() - ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ä¸€æ‹¬å­¦ç¿’é–¢æ•°
     * @see saveAISessionData() - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜
     * @see showAIAnalyzedIndicator() - ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
     * @see toggleAIAssistant() - ãƒ‘ãƒãƒ«é–‰ã˜ã‚‹
     */
    function applyAIResult() {
      if (!aiAnalysisResult) { showWarningToast('è§£æçµæœãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      
      // ç™ºé€å…ˆåã‚’å„ªå…ˆçš„ã«å–å¾—ï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’ç”¨ï¼‰
      const shippingToName = aiAnalysisResult.shippingTo?.masterData?.companyName || 
                             aiAnalysisResult.shippingTo?.rawCompanyName || '';
      const customerName = aiAnalysisResult.customer?.rawCompanyName || '';
      
      const mappingsToLearn = [];
      Object.keys(itemEdits).forEach(index => {
        const edit = itemEdits[index];
        if (edit.learn && edit.originalText && edit.productName) {
          mappingsToLearn.push({ 
            originalText: edit.originalText, 
            productName: edit.productName, 
            shippingToName: shippingToName,  // ç™ºé€å…ˆåå„ªå…ˆ
            customerName: customerName,       // å¾Œæ–¹äº’æ›
            spec: edit.spec || '' 
          });
        }
      });
      
      if (mappingsToLearn.length > 0) {
        google.script.run.withSuccessHandler(function(results) { console.log('ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’çµæœ:', results); }).withFailureHandler(function(error) { console.error('ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’ã‚¨ãƒ©ãƒ¼:', error); }).registerProductMappingBulk(mappingsToLearn);
      }
      
      if (aiAnalysisResult.shippingDate) { setFormValue('shippingDate', aiAnalysisResult.shippingDate); }
      if (aiAnalysisResult.deliveryDate) { setFormValue('deliveryDate', aiAnalysisResult.deliveryDate); }

      // ç™ºé€å…ˆã®é©ç”¨ï¼ˆå„ªå…ˆé †ä½: æ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ > AIèª­ã¿å–ã‚Šï¼‰
      if (manualShippingToSelection) {
        console.log('æ‰‹å‹•é¸æŠã—ãŸç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨:', manualShippingToSelection);
        const name = [manualShippingToSelection.companyName, manualShippingToSelection.personName].filter(Boolean).join('ã€€');
        setFormValue('shippingToName', name);
        setFormValue('shippingToZipcode', manualShippingToSelection.zipcode || '');
        setFormValue('shippingToAddress', manualShippingToSelection.address || '');
        setFormValue('shippingToTel', manualShippingToSelection.tel || '');
      } else {
        const st = aiAnalysisResult.shippingTo;
        if (st) {
          const data = useShippingToMaster && st.masterData ? st.masterData : st;
          setFormValue('shippingToName', useShippingToMaster ? [data.companyName, data.personName].filter(Boolean).join('ã€€') : [st.rawCompanyName, st.rawPersonName].filter(Boolean).join('ã€€'));
          setFormValue('shippingToZipcode', (useShippingToMaster ? data.zipcode : st.rawZipcode) || '');
          setFormValue('shippingToAddress', (useShippingToMaster ? data.address : st.rawAddress) || '');
          setFormValue('shippingToTel', (useShippingToMaster ? data.tel : st.rawTel) || '');
        }
      }

      // é¡§å®¢ã®é©ç”¨ï¼ˆå„ªå…ˆé †ä½: æ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ > AIèª­ã¿å–ã‚Šï¼‰
      if (manualCustomerSelection) {
        console.log('æ‰‹å‹•é¸æŠã—ãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨:', manualCustomerSelection);
        // å—æ³¨ç”»é¢ã§ã¯å¸¸ã«ã€Œä¼šç¤¾å æ°åã€å½¢å¼ã§è¡¨ç¤ºï¼ˆdisplayNameã¯ä½¿ã‚ãªã„ï¼‰
        const name = [manualCustomerSelection.companyName, manualCustomerSelection.personName]
          .filter(Boolean).join('ã€€');
        setFormValue('customerName', name);
        setFormValue('customerZipcode', manualCustomerSelection.zipcode || '');
        setFormValue('customerAddress', manualCustomerSelection.address || '');
        setFormValue('customerTel', manualCustomerSelection.tel || '');
      } else {
        const cust = aiAnalysisResult.customer;
        if (cust) {
          const data = useCustomerMaster && cust.masterData ? cust.masterData : cust;
          setFormValue('customerName', useCustomerMaster ? (data.displayName || [data.companyName, data.personName].filter(Boolean).join('ã€€')) : [cust.rawCompanyName, cust.rawPersonName].filter(Boolean).join('ã€€'));
          setFormValue('customerZipcode', (useCustomerMaster ? data.zipcode : cust.rawZipcode) || '');
          setFormValue('customerAddress', (useCustomerMaster ? data.address : cust.rawAddress) || '');
          setFormValue('customerTel', (useCustomerMaster ? data.tel : cust.rawTel) || '');
        }
      }
      
      Object.keys(itemEdits).forEach((index, i) => {
        const row = i + 1;
        if (row > 10) return;
        const edit = itemEdits[index];
        if (edit.category) {
          const bunrui = document.getElementById('bunrui' + row);
          if (bunrui) { bunrui.value = edit.category; if (typeof bunruiChange === 'function') bunruiChange(row); }
        }
        if (edit.productName) {
          setTimeout(() => {
            const prod = document.getElementById('product' + row);
            if (prod) {
              for (let j = 0; j < prod.options.length; j++) {
                if (prod.options[j].value === edit.productName) {
                  prod.selectedIndex = j;
                  if (typeof productChange === 'function') productChange(row);
                  break;
                }
              }
            }
          }, 100 * i);
        }
        if (edit.price) {
          setTimeout(() => {
            const priceEl = document.getElementById('price' + row);
            if (priceEl) priceEl.value = edit.price;
          }, 100 * i + 30);
        }
        if (edit.quantity) {
          setTimeout(() => {
            const qty = document.getElementById('quantity' + row);
            if (qty) qty.value = edit.quantity;
          }, 100 * i + 50);
        }
      });
      
      saveAISessionData();
      showAIAnalyzedIndicator(new Date().toISOString());
      
      let message = 'ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã—ã¾ã—ãŸã€‚';
      if (mappingsToLearn.length > 0) { message += '\n\nğŸ“š ' + mappingsToLearn.length + 'ä»¶ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å­¦ç¿’ã—ã¾ã—ãŸã€‚'; }
      if (aiAnalysisResult.alerts?.length) { message += '\n\nâš ï¸ ' + aiAnalysisResult.alerts.join('\n'); }
      showInfoToast(message);
      toggleAIAssistant();
    }
    
    /**
     * ãƒ•ã‚©ãƒ¼ãƒ å€¤è¨­å®šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
     */
    function setFormValue(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value;
    }
</script>
