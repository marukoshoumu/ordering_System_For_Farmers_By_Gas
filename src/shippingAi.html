<!-- 
  shipping.html ã‹ã‚‰åˆ†é›¢ã—ãŸAIè§£æé–¢é€£ã®JavaScript
  - AIå…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆæ©Ÿèƒ½
  - é¡§å®¢/ç™ºé€å…ˆãƒã‚¹ã‚¿ç…§åˆ
  - å•†å“ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
-->
<script>
    // ===== AIè§£æ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
    let aiAnalysisResult = null;
    let useShippingToMaster = false;
    let useCustomerMaster = false;
    let selectedFile = null;
    let selectedFileBase64 = null;
    let currentTab = 'text';
    let productMaster = {};
    let categoryList = [];
    let productPrices = {};
    let itemEdits = {};

    // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿
    let manualCustomerSelection = null;
    let manualShippingToSelection = null;

    const AI_SESSION_KEY = 'aiSessionData';
    const AI_EXCLUDE_CATEGORIES = ['é€æ–™', 'æ‰‹æ•°æ–™', 'è¿½åŠ æ–™é‡‘'];
    const AI_EXCLUDE_PRODUCTS = ['é€æ–™', 'ã‚¯ãƒ¼ãƒ«ä¾¿è¿½åŠ ', 'ä»£å¼•æ‰‹æ•°æ–™', 'æ¢±åŒ…æ–™'];

    /**
     * æ‰‹å‹•é¸æŠå¾Œã«AIãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
     */
    function updateManualSelectionDisplay() {
      if (!aiAnalysisResult) return;
      if (aiAnalysisResult.customer) {
        displayCustomer(aiAnalysisResult.customer);
      }
      if (aiAnalysisResult.shippingTo) {
        displayShippingTo(aiAnalysisResult.shippingTo);
      }
    }

    /**
     * éƒµä¾¿ç•ªå·ã®ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»
     */
    function sanitizeZipcode(zip) {
      if (!zip) return '';
      return String(zip).replace(/[-ãƒ¼âˆ’â€]/g, '');
    }

    /**
     * é›»è©±ç•ªå·ãƒ»FAXç•ªå·ã®ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»
     */
    function sanitizeTel(tel) {
      if (!tel) return '';
      return String(tel).replace(/[-ãƒ¼âˆ’â€]/g, '');
    }

    /**
     * ä½æ‰€æ–‡å­—åˆ—ã‚’éƒ½é“åºœçœŒï¼‹å¸‚åŒºç”ºæ‘(ä½æ‰€1)ã¨ç•ªåœ°ä»¥é™(ä½æ‰€2)ã«åˆ†å‰²
     */
    function splitAddressString(fullAddress) {
      if (!fullAddress) {
        return { address1: '', address2: '' };
      }
      const addr = String(fullAddress).trim();
      const patterns = [
        /(.*?[éƒ½é“åºœçœŒ].*?[å¸‚åŒºç”ºæ‘éƒ¡])/,
        /(.*?[å¸‚åŒºç”ºæ‘])/,
        /(.*?éƒ¡.*?[ç”ºæ‘])/
      ];
      for (const pattern of patterns) {
        const match = addr.match(pattern);
        if (match) {
          const address1 = match[1];
          const address2 = addr.substring(address1.length).trim();
          return { address1, address2 };
        }
      }
      const halfIndex = Math.floor(addr.length / 2);
      return {
        address1: addr.substring(0, halfIndex),
        address2: addr.substring(halfIndex)
      };
    }

    /**
     * AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®é–‹é–‰
     */
    function toggleAIAssistant() {
      const body = document.getElementById('aiAssistantBody');
      const btn = document.getElementById('aiToggleBtn');
      body.classList.toggle('open');
      btn.textContent = body.classList.contains('open') ? 'é–‰ã˜ã‚‹' : 'é–‹ã';
      if (body.classList.contains('open') && categoryList.length === 0) {
        loadProductMaster();
      }
    }

    /**
     * AIå–è¾¼ä¸€è¦§ã‹ã‚‰é·ç§»ã—ãŸå ´åˆã«è‡ªå‹•ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ã¦è§£æçµæœã‚’è¡¨ç¤º
     */
    function openAIModalWithResult(analysisData) {
      const body = document.getElementById('aiAssistantBody');
      const btn = document.getElementById('aiToggleBtn');
      if (!body.classList.contains('open')) {
        body.classList.add('open');
        btn.textContent = 'é–‰ã˜ã‚‹';
      }
      if (categoryList.length === 0) {
        loadProductMaster();
      }
      google.script.run
        .withSuccessHandler(function(enhancedResultJson) {
          try {
            const enhancedData = JSON.parse(enhancedResultJson);
            aiAnalysisResult = enhancedData;
            showAIAnalyzedIndicator(new Date().toISOString());
            displayAnalysisResult(enhancedData);
            console.log('AIå–è¾¼ä¸€è¦§ã‹ã‚‰ã®è§£æçµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆãƒã‚¹ã‚¿ç…§åˆæ¸ˆã¿ï¼‰');
          } catch (e) {
            console.error('å¼·åŒ–ã•ã‚ŒãŸè§£æçµæœã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
            aiAnalysisResult = analysisData;
            displayAnalysisResult(analysisData);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ãƒã‚¹ã‚¿ç…§åˆã‚¨ãƒ©ãƒ¼:', error);
          aiAnalysisResult = analysisData;
          showAIAnalyzedIndicator(new Date().toISOString());
          displayAnalysisResult(analysisData);
        })
        .enhanceAnalysisResultFromTempOrder(JSON.stringify(analysisData));
    }

    /**
     * æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
     */
    function setupNewRegistrationButtons(analysisData) {
      const existingCustomerBtns = document.getElementById('customerActionButtons');
      if (existingCustomerBtns) existingCustomerBtns.remove();
      const existingShippingBtns = document.getElementById('shippingToActionButtons');
      if (existingShippingBtns) existingShippingBtns.remove();

      if (analysisData.customer) {
        const isNew = analysisData.customer.isNewCustomer;
        const isPartial = analysisData.customer.masterMatch === 'partial';
        if (isNew || isPartial) {
          const customerSection = document.querySelector('#aiResultCustomerRaw').parentElement;
          const btnContainer = document.createElement('div');
          btnContainer.id = 'customerActionButtons';
          btnContainer.className = 'mt-2';
          btnContainer.style.display = 'flex';
          btnContainer.style.gap = '8px';

          const newBtn = document.createElement('button');
          newBtn.type = 'button';
          newBtn.className = 'btn btn-sm btn-primary';
          newBtn.textContent = 'ğŸ“ æ–°è¦ç™»éŒ²';
          newBtn.onclick = function() { openNewCustomerFormWithAI(analysisData.customer); };
          btnContainer.appendChild(newBtn);

          const searchBtn = document.createElement('button');
          searchBtn.type = 'button';
          searchBtn.className = 'btn btn-sm btn-primary';
          searchBtn.textContent = 'ğŸ” é¡§å®¢ã‚’æ¤œç´¢';
          searchBtn.onclick = function() { $('.customerSearchBtn_open').click(); };
          btnContainer.appendChild(searchBtn);

          customerSection.appendChild(btnContainer);
        }
      }

      if (analysisData.shippingTo) {
        const isNew = analysisData.shippingTo.isNewShippingTo;
        const isPartial = analysisData.shippingTo.masterMatch === 'partial';
        if (isNew || isPartial) {
          const shippingSection = document.querySelector('#aiResultShippingToRaw').parentElement;
          const btnContainer = document.createElement('div');
          btnContainer.id = 'shippingToActionButtons';
          btnContainer.className = 'mt-2';
          btnContainer.style.display = 'flex';
          btnContainer.style.gap = '8px';

          const newBtn = document.createElement('button');
          newBtn.type = 'button';
          newBtn.className = 'btn btn-sm btn-primary';
          newBtn.textContent = 'ğŸ“ æ–°è¦ç™»éŒ²';
          newBtn.onclick = function() { openNewShippingToFormWithAI(analysisData.shippingTo); };
          btnContainer.appendChild(newBtn);

          const searchBtn = document.createElement('button');
          searchBtn.type = 'button';
          searchBtn.className = 'btn btn-sm btn-primary';
          searchBtn.textContent = 'ğŸ” ç™ºé€å…ˆã‚’æ¤œç´¢';
          searchBtn.onclick = function() { $('.shippingToSearchBtn_open').click(); };
          btnContainer.appendChild(searchBtn);

          shippingSection.appendChild(btnContainer);
        }
      }
    }

    /**
     * é¡§å®¢æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦AIè§£æå€¤ã‚’åæ˜ 
     */
    function openNewCustomerFormWithAI(customerData) {
      console.log('é¡§å®¢ãƒ‡ãƒ¼ã‚¿:', customerData);
      clearCustomerForm();

      const companyName = customerData.rawCompanyName || customerData.companyName || '';
      const personName = customerData.rawPersonName || customerData.personName || '';
      const zipcode = customerData.rawZipcode || customerData.zipcode || '';
      const address = customerData.rawAddress || customerData.address || '';
      const tel = customerData.rawTel || customerData.tel || '';
      const fax = customerData.rawFax || customerData.fax || '';

      if (companyName) {
        document.getElementById('customerNameDg').value = companyName;
        document.getElementById('customerShowNameDg').value = companyName;
      }
      if (personName) {
        document.getElementById('customerIdentDg').value = personName;
      }
      if (zipcode) {
        document.getElementById('customerZipcodeDg').value = sanitizeZipcode(zipcode);
      }
      if (address) {
        const splitAddress = splitAddressString(address);
        document.getElementById('customerAddress1Dg').value = splitAddress.address1;
        document.getElementById('customerAddress2Dg').value = splitAddress.address2;
      }
      if (tel) {
        document.getElementById('customerTelDg').value = sanitizeTel(tel);
      }
      if (fax) {
        document.getElementById('customerFaxDg').value = sanitizeTel(fax);
      }

      const dialog = $('.customer_dg');
      if (!dialog.hasClass('ui-dialog-content')) {
        dialog.dialog({
          title: "é¡§å®¢æ–°è¦ç™»éŒ²",
          height: 500,
          modal: true,
          buttons: {
            "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function() { $(this).dialog("close"); },
            "ç™»éŒ²": function() { addCustomer(); }
          }
        });
      }
      dialog.dialog('open');
    }

    /**
     * ç™ºé€å…ˆæ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦AIè§£æå€¤ã‚’åæ˜ 
     */
    function openNewShippingToFormWithAI(shippingToData) {
      console.log('ç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿:', shippingToData);
      clearShippingToForm();

      const companyName = shippingToData.rawCompanyName || shippingToData.companyName || '';
      const personName = shippingToData.rawPersonName || shippingToData.personName || '';
      const zipcode = shippingToData.rawZipcode || shippingToData.zipcode || '';
      const address = shippingToData.rawAddress || shippingToData.address || '';
      const tel = shippingToData.rawTel || shippingToData.tel || '';

      if (companyName) {
        document.getElementById('shippingToNameDg').value = companyName;
      }
      if (personName) {
        document.getElementById('shippingToIdentDg').value = personName;
      }
      if (zipcode) {
        document.getElementById('shippingToZipcodeDg').value = sanitizeZipcode(zipcode);
      }
      if (address) {
        const splitAddress = splitAddressString(address);
        document.getElementById('shippingToAddress1Dg').value = splitAddress.address1;
        document.getElementById('shippingToAddress2Dg').value = splitAddress.address2;
      }
      if (tel) {
        document.getElementById('shippingToTelDg').value = sanitizeTel(tel);
      }

      const dialog = $('.shippingTo_dg');
      if (!dialog.hasClass('ui-dialog-content')) {
        dialog.dialog({
          title: "ç™ºé€å…ˆæ–°è¦ç™»éŒ²",
          height: 500,
          modal: true,
          buttons: {
            "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function() { $(this).dialog("close"); },
            "ç™»éŒ²": function() { addShippingTo(); }
          }
        });
      }
      dialog.dialog('open');
    }

    /**
     * é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
     */
    function clearCustomerForm() {
      document.getElementById('customerNameDg').value = '';
      document.getElementById('customerShowNameDg').value = '';
      document.getElementById('customerFuriganaDg').value = '';
      document.getElementById('customerDepDg').value = '';
      document.getElementById('customerPostDg').value = '';
      document.getElementById('customerIdentDg').value = '';
      document.getElementById('customerZipcodeDg').value = '';
      document.getElementById('customerAddress1Dg').value = '';
      document.getElementById('customerAddress2Dg').value = '';
      document.getElementById('customerTelDg').value = '';
      document.getElementById('customerPhoneDg').value = '';
      document.getElementById('customerFaxDg').value = '';
      document.getElementById('customerMailDg').value = '';
      document.getElementById('customerMemoDg').value = '';
    }

    /**
     * ç™ºé€å…ˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
     */
    function clearShippingToForm() {
      document.getElementById('shippingToNameDg').value = '';
      document.getElementById('shippingToDepDg').value = '';
      document.getElementById('shippingToIdentDg').value = '';
      document.getElementById('shippingToZipcodeDg').value = '';
      document.getElementById('shippingToAddress1Dg').value = '';
      document.getElementById('shippingToAddress2Dg').value = '';
      document.getElementById('shippingToTelDg').value = '';
      document.getElementById('shippingToMailDg').value = '';
      document.getElementById('shippingToMemoDg').value = '';
    }

    /**
     * å•†å“ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿
     */
    function loadProductMaster() {
      google.script.run
        .withSuccessHandler(function(data) {
          productMaster = data.productsByCategory || {};
          productPrices = data.productPrices || {};
          categoryList = Object.keys(productMaster);
        })
        .withFailureHandler(function(error) {
          console.error('å•†å“ãƒã‚¹ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getProductMasterForUI();
    }
    
    /**
     * AIã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
     */
    function loadAISessionData() {
      const saved = sessionStorage.getItem(AI_SESSION_KEY);
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        const diffMinutes = (new Date() - new Date(data.analyzedAt)) / 1000 / 60;
        if (diffMinutes > 30) {
          sessionStorage.removeItem(AI_SESSION_KEY);
          return;
        }
        showAIAnalyzedIndicator(data.analyzedAt);
      } catch (e) {
        sessionStorage.removeItem(AI_SESSION_KEY);
      }
    }
    
    /**
     * AIã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
     */
    function saveAISessionData() {
      if (!aiAnalysisResult) return;
      const sessionData = {
        analyzedAt: new Date().toISOString(),
        analysisResult: aiAnalysisResult,
        items: [],
        totalAmount: 0
      };
      Object.keys(itemEdits).forEach(index => {
        const edit = itemEdits[index];
        if (edit.productName) {
          const amount = (edit.price || 0) * (edit.quantity || 0);
          if (!AI_EXCLUDE_CATEGORIES.includes(edit.category) && !AI_EXCLUDE_PRODUCTS.includes(edit.productName)) {
            sessionData.totalAmount += amount;
          }
          sessionData.items.push({
            originalText: edit.originalText,
            productName: edit.productName,
            category: edit.category,
            price: edit.price,
            quantity: edit.quantity
          });
        }
      });
      sessionStorage.setItem(AI_SESSION_KEY, JSON.stringify(sessionData));
    }
    
    /**
     * AIè§£ææ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®è¡¨ç¤º
     */
    function showAIAnalyzedIndicator(analyzedAt) {
      const indicator = document.getElementById('aiAnalyzedIndicator');
      const timeEl = document.getElementById('aiAnalyzedTime');
      if (indicator && analyzedAt) {
        const time = new Date(analyzedAt);
        timeEl.textContent = 'ï¼ˆ' + time.getHours() + ':' + String(time.getMinutes()).padStart(2,'0') + ' è§£æï¼‰';
        indicator.classList.add('show');
      }
    }
    
    /**
     * AIã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªã‚¢
     */
    function clearAISession() {
      sessionStorage.removeItem(AI_SESSION_KEY);
    }
    
    /**
     * ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
     */
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.ai-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.ai-tab-content').forEach(content => content.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
     */
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = function(e) {
        selectedFileBase64 = e.target.result.split(',')[1];
        showFilePreview(file);
      };
      reader.readAsDataURL(file);
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
     */
    function showFilePreview(file) {
      const preview = document.getElementById('filePreview');
      const icon = file.type.includes('pdf') ? 'ğŸ“„' : 'ğŸ–¼ï¸';
      const size = (file.size / 1024).toFixed(1) + ' KB';
      preview.innerHTML = '<div class="file-preview"><span class="file-icon">' + icon + '</span><div class="file-info"><div class="file-name">' + file.name + '</div><div class="file-size">' + size + '</div></div><button type="button" class="remove-btn" onclick="removeFile()">Ã—</button></div>';
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
     */
    function removeFile() {
      selectedFile = null;
      selectedFileBase64 = null;
      document.getElementById('orderFile').value = '';
      document.getElementById('filePreview').innerHTML = '';
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
     */
    function setupFileDragDrop() {
      const uploadArea = document.getElementById('fileUploadArea');
      if (!uploadArea) return;
      uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
      uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
          document.getElementById('orderFile').files = e.dataTransfer.files;
          handleFileSelect({ target: { files: [file] } });
        }
      });
    }
    
    /**
     * AIè§£æå®Ÿè¡Œ
     */
    function analyzeWithAI() {
      const btn = document.getElementById('aiAnalyzeBtn');
      btn.classList.add('loading');
      btn.disabled = true;
      
      // å‰ã®è§£æçµæœã‚’ã‚¯ãƒªã‚¢ï¼ˆUIã‚¹ãƒ†ãƒ¼ãƒˆã®ãƒªã‚»ãƒƒãƒˆï¼‰
      resetAnalysisState();
      
      if (currentTab === 'text') {
        const text = document.getElementById('aiInputText').value.trim();
        if (!text) { showWarningToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); btn.classList.remove('loading'); btn.disabled = false; return; }
        google.script.run.withSuccessHandler(handleAnalysisSuccess).withFailureHandler(handleAnalysisError).analyzeOrderText(text);
      } else {
        if (!selectedFile || !selectedFileBase64) { showWarningToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); btn.classList.remove('loading'); btn.disabled = false; return; }
        google.script.run.withSuccessHandler(handleAnalysisSuccess).withFailureHandler(handleAnalysisError).analyzeOrderFileBase64(selectedFileBase64, selectedFile.type, selectedFile.name);
      }
    }
    
    /**
     * è§£æã‚¹ãƒ†ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
     */
    function resetAnalysisState() {
      aiAnalysisResult = null;
      useShippingToMaster = false;
      useCustomerMaster = false;
      itemEdits = {};
      manualShippingToSelection = null;
      manualCustomerSelection = null;
      
      // UIã‚‚ã‚¯ãƒªã‚¢ï¼ˆä½†ã—å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒï¼‰
      document.getElementById('aiResultArea').classList.remove('show');
      
      // ç™ºé€å…ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('shippingToMatchBadge').innerHTML = '';
      document.getElementById('aiResultShippingToRaw').innerHTML = '';
      document.getElementById('aiResultShippingToMaster').style.display = 'none';
      document.getElementById('aiResultShippingToManual').style.display = 'none';
      document.getElementById('shippingToSourceSelect').style.display = 'none';
      
      // é¡§å®¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('customerMatchBadge').innerHTML = '';
      document.getElementById('aiResultCustomerRaw').innerHTML = '';
      document.getElementById('aiResultCustomerMaster').style.display = 'none';
      document.getElementById('aiResultCustomerManual').style.display = 'none';
      document.getElementById('customerSourceSelect').style.display = 'none';
      
      // é¡§å®¢æ¨å®šå€™è£œã‚’ã‚¯ãƒªã‚¢
      const suggestionDiv = document.getElementById('customerSuggestionArea');
      if (suggestionDiv) suggestionDiv.style.display = 'none';
    }
    
    /**
     * AIè§£ææˆåŠŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
     */
    function handleAnalysisSuccess(result) {
      const btn = document.getElementById('aiAnalyzeBtn');
      btn.classList.remove('loading');
      btn.disabled = false;
      try {
        aiAnalysisResult = JSON.parse(result);
        if (!aiAnalysisResult.success) { showError(aiAnalysisResult.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
        displayAnalysisResult(aiAnalysisResult);
      } catch (e) {
        showError('è§£æçµæœã®å‡¦ç†ã«å¤±æ•—: ' + e.message);
      }
    }
    
    /**
     * AIè§£æã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
     */
    function handleAnalysisError(error) {
      const btn = document.getElementById('aiAnalyzeBtn');
      btn.classList.remove('loading');
      btn.disabled = false;
      showError('è§£æã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
    
    /**
     * è§£æçµæœã®è¡¨ç¤º
     */
    function displayAnalysisResult(result) {
      document.getElementById('aiResultArea').classList.add('show');
      itemEdits = {};
      setConfidenceBadge('overallConfidence', result.overallConfidence);
      displayAlerts(result.alerts || []);
      document.getElementById('aiResultShippingDate').textContent = result.shippingDate || 'æŒ‡å®šãªã—';
      document.getElementById('aiResultDeliveryDate').textContent = result.deliveryDate || 'æŒ‡å®šãªã—';
      document.getElementById('aiResultDeliveryTime').textContent = result.deliveryTime || 'æŒ‡å®šãªã—';
      displayShippingTo(result.shippingTo);
      displayCustomer(result.customer);
      
      // ğŸ¤– é¡§å®¢æ¨å®šå€™è£œã‚’è¡¨ç¤ºï¼ˆé¡§å®¢ãŒnullã§ã‚‚è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ã“ã“ã§å‘¼ã³å‡ºã—ï¼‰
      displayCustomerSuggestion();
      
      displayItemsEditable(result.items, result.unknownItems);
      if (result.memo) {
        document.getElementById('memoSection').style.display = 'block';
        document.getElementById('aiResultMemo').textContent = result.memo;
      } else {
        document.getElementById('memoSection').style.display = 'none';
      }
      document.getElementById('aiError').style.display = 'none';
      updateLearnSummary();
      setupNewRegistrationButtons(result);
    }
    
    /**
     * ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
     */
    function displayAlerts(alerts) {
      const container = document.getElementById('aiAlerts');
      container.innerHTML = alerts.map(a => '<div class="ai-alert-item ' + (a.includes('æ–°è¦') || a.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') ? 'ai-alert-warning' : 'ai-alert-info') + '">' + a + '</div>').join('');
    }
    
    /**
     * ç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
     */
    function displayShippingTo(st) {
      const badge = document.getElementById('shippingToMatchBadge');
      const masterDiv = document.getElementById('aiResultShippingToMaster');
      const manualDiv = document.getElementById('aiResultShippingToManual');
      const selectDiv = document.getElementById('shippingToSourceSelect');
      
      // ç™ºé€å…ˆãŒnullã®å ´åˆã¯ç©ºè¡¨ç¤ºã«ã—ã¦ãƒªã‚¿ãƒ¼ãƒ³
      if (!st) {
        badge.innerHTML = '';
        document.getElementById('aiResultShippingToRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>-</div><div class="row"><span class="label">å®›åï¼š</span>-</div><div class="row"><span class="label">ã€’ï¼š</span>-</div><div class="row"><span class="label">ä½æ‰€ï¼š</span>-</div><div class="row"><span class="label">TELï¼š</span>-</div>';
        masterDiv.style.display = 'none';
        manualDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useShippingToMaster = false;
        return;
      }
      
      if (st.isNewShippingTo) {
        badge.innerHTML = '<span class="new-badge">æ–°è¦</span>';
      } else if (st.isCustomerFallback) {
        badge.innerHTML = '<span class="master-match-badge master-match-partial">ğŸ“ ä¾é ¼å…ˆã‹ã‚‰è¨­å®š</span>';
      } else if (st.masterMatch === 'exact') {
        badge.innerHTML = '<span class="master-match-badge master-match-exact">âœ… ä¸€è‡´</span>';
      } else if (st.masterMatch === 'partial') {
        badge.innerHTML = '<span class="master-match-badge master-match-partial">âš ï¸ éƒ¨åˆ†ä¸€è‡´</span>';
      } else {
        badge.innerHTML = '';
      }
      document.getElementById('aiResultShippingToRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>' + (st.rawCompanyName || '-') + '</div><div class="row"><span class="label">å®›åï¼š</span>' + (st.rawPersonName || '-') + '</div><div class="row"><span class="label">ã€’ï¼š</span>' + (st.rawZipcode || '-') + '</div><div class="row"><span class="label">ä½æ‰€ï¼š</span>' + (st.rawAddress || '-') + '</div><div class="row"><span class="label">TELï¼š</span>' + (st.rawTel || '-') + '</div>';

      if (manualShippingToSelection) {
        manualDiv.style.display = 'block';
        const sourceType = manualShippingToSelection.source === 'manual_registration' ? 'æ–°è¦ç™»éŒ²' : 'æ¤œç´¢';
        manualDiv.innerHTML = '<strong>âœ‹ æ‰‹å‹•é¸æŠï¼ˆ' + sourceType + 'ï¼‰</strong><br>' +
          [manualShippingToSelection.companyName, manualShippingToSelection.personName].filter(Boolean).join(' ') +
          '<br>TEL: ' + (manualShippingToSelection.tel || '-') +
          '<br>ã€’' + (manualShippingToSelection.zipcode || '-') + ' ' + (manualShippingToSelection.address || '-');
      } else {
        manualDiv.style.display = 'none';
      }

      if (st.masterData) {
        masterDiv.style.display = 'block';
        masterDiv.innerHTML = '<strong>ğŸ“ ãƒã‚¹ã‚¿ï¼ˆ' + st.matchedBy + 'ï¼‰</strong><br>' + (st.masterData.companyName || '') + ' ' + (st.masterData.personName || '') + '<br>ã€’' + (st.masterData.zipcode || '') + ' ' + (st.masterData.address || '') + '<br>TEL: ' + (st.masterData.tel || '-');
        selectDiv.style.display = 'flex';

        if (manualShippingToSelection) {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
          useShippingToMaster = false;
        } else {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>';
          useShippingToMaster = true;
        }
      } else if (manualShippingToSelection) {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'flex';
        selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
          '<button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
        useShippingToMaster = false;
      } else {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useShippingToMaster = false;
      }
    }
    
    /**
     * é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
     */
    function displayCustomer(cust) {
      const badge = document.getElementById('customerMatchBadge');
      const masterDiv = document.getElementById('aiResultCustomerMaster');
      const manualDiv = document.getElementById('aiResultCustomerManual');
      const selectDiv = document.getElementById('customerSourceSelect');
      
      // é¡§å®¢ãŒnullã®å ´åˆã¯ç©ºè¡¨ç¤ºã«ã—ã¦ãƒªã‚¿ãƒ¼ãƒ³
      if (!cust) {
        badge.innerHTML = '';
        document.getElementById('aiResultCustomerRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>-</div>' +
          '<div class="row"><span class="label">æ‹…å½“ï¼š</span>-</div>' +
          '<div class="row"><span class="label">TELï¼š</span>-</div>';
        masterDiv.style.display = 'none';
        manualDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useCustomerMaster = false;
        return;
      }
      
      if (cust.isNewCustomer) {
        badge.innerHTML = '<span class="new-badge">æ–°è¦</span>';
      } else if (cust.masterMatch === 'exact') {
        badge.innerHTML = '<span class="master-match-badge master-match-exact">âœ… ä¸€è‡´</span>';
      } else if (cust.masterMatch === 'partial') {
        badge.innerHTML = '<span class="master-match-badge master-match-partial">âš ï¸ éƒ¨åˆ†ä¸€è‡´</span>';
      } else {
        badge.innerHTML = '';
      }
      // FAXç•ªå·ã‚‚è¡¨ç¤ºã«è¿½åŠ 
      let rawHtml = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>' + (cust.rawCompanyName || '-') + '</div>' +
        '<div class="row"><span class="label">æ‹…å½“ï¼š</span>' + (cust.rawPersonName || '-') + '</div>' +
        '<div class="row"><span class="label">TELï¼š</span>' + (cust.rawTel || '-') + '</div>';
      if (cust.rawFax) {
        rawHtml += '<div class="row"><span class="label">FAXï¼š</span>' + cust.rawFax + '</div>';
      }
      document.getElementById('aiResultCustomerRaw').innerHTML = rawHtml;

      if (manualCustomerSelection) {
        manualDiv.style.display = 'block';
        const sourceType = manualCustomerSelection.source === 'manual_registration' ? 'æ–°è¦ç™»éŒ²' :
                           manualCustomerSelection.source === 'ai_suggestion' ? 'AIæ¨å®š' : 'æ¤œç´¢';
        // å—æ³¨ç”»é¢ã§ã¯å¸¸ã«ã€Œä¼šç¤¾å æ°åã€å½¢å¼ã§è¡¨ç¤ºï¼ˆdisplayNameã¯ä½¿ã‚ãªã„ï¼‰
        const customerName = [manualCustomerSelection.companyName, manualCustomerSelection.personName]
          .filter(Boolean).join('ã€€');
        manualDiv.innerHTML = '<strong>âœ‹ æ‰‹å‹•é¸æŠï¼ˆ' + sourceType + 'ï¼‰</strong><br>' +
          customerName +
          '<br>TEL: ' + (manualCustomerSelection.tel || '-') +
          '<br>ã€’' + (manualCustomerSelection.zipcode || '-') + ' ' + (manualCustomerSelection.address || '-');
      } else {
        manualDiv.style.display = 'none';
      }

      if (cust.masterData) {
        masterDiv.style.display = 'block';
        masterDiv.innerHTML = '<strong>ğŸ“ ãƒã‚¹ã‚¿ï¼ˆ' + cust.matchedBy + 'ï¼‰</strong><br>' + (cust.masterData.displayName || cust.masterData.companyName || '') + '<br>TEL: ' + (cust.masterData.tel || '-');
        selectDiv.style.display = 'flex';

        if (manualCustomerSelection) {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
          useCustomerMaster = false;
        } else {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>';
          useCustomerMaster = true;
        }
      } else if (manualCustomerSelection) {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'flex';
        selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
          '<button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
        useCustomerMaster = false;
      } else {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useCustomerMaster = false;
      }

      // ğŸ“  FAXç•ªå·ç™»éŒ²ä¿ƒé€²ã®è¡¨ç¤º
      displayFaxRegistrationPrompt(cust);
      
      // ğŸ¤– AIæ¨å®šå€™è£œã®è¡¨ç¤ºã¯ displayAnalysisResult() ã§å‘¼ã³å‡ºã™ãŸã‚ã€ã“ã“ã§ã¯ä¸è¦
    }

    /**
     * FAXç•ªå·ç™»éŒ²ä¿ƒé€²ã‚’è¡¨ç¤º
     * - AIãŒFAXç•ªå·ã‚’æ¤œå‡ºã—ãŸ
     * - ãƒã‚¹ã‚¿ã«é¡§å®¢ãŒãƒãƒƒãƒã—ãŸï¼ˆexact ã¾ãŸã¯ partialï¼‰
     * - ãƒã‚¹ã‚¿ã®é¡§å®¢ã«ã¯FAXç•ªå·ãŒæœªç™»éŒ²
     */
    function displayFaxRegistrationPrompt(cust) {
      const promptDiv = document.getElementById('faxRegistrationPrompt');
      if (!promptDiv) return;

      // æ¡ä»¶ãƒã‚§ãƒƒã‚¯
      const hasRawFax = cust.rawFax && sanitizeTel(cust.rawFax).length >= 10;
      const hasCustomerMatch = cust.masterMatch === 'exact' || cust.masterMatch === 'partial';
      const hasMasterData = cust.masterData;
      const masterHasNoFax = hasMasterData && !cust.masterData.fax;

      // æ‰‹å‹•é¸æŠæ™‚ã‚‚å¯¾å¿œ
      let targetCustomer = null;
      if (manualCustomerSelection && !manualCustomerSelection.fax && hasRawFax) {
        targetCustomer = manualCustomerSelection;
      } else if (hasRawFax && hasCustomerMatch && masterHasNoFax) {
        targetCustomer = cust.masterData;
      }

      if (!targetCustomer) {
        promptDiv.style.display = 'none';
        return;
      }

      // è¡¨ç¤º
      promptDiv.style.display = 'block';
      const customerName = targetCustomer.displayName || 
        [targetCustomer.companyName, targetCustomer.personName].filter(Boolean).join('ã€€');
      
      promptDiv.innerHTML = 
        '<div class="fax-header">ğŸ“  FAXç•ªå·ã®ç™»éŒ²</div>' +
        '<div class="fax-number">' + escapeHtml(cust.rawFax) + '</div>' +
        '<div class="fax-description">' +
          'ã€Œ' + escapeHtml(customerName) + 'ã€ã®ãƒã‚¹ã‚¿ã«FAXç•ªå·ãŒæœªç™»éŒ²ã§ã™ã€‚<br>' +
          'ã“ã®ç•ªå·ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€æ¬¡å›ã‹ã‚‰è‡ªå‹•ã§ãƒãƒƒãƒãƒ³ã‚°ã§ãã¾ã™ã€‚' +
        '</div>' +
        '<button type="button" class="btn-register-fax" onclick="registerCustomerFax()">' +
          'âœ… ã“ã®é¡§å®¢ã«FAXç•ªå·ã‚’ç™»éŒ²' +
        '</button>';
    }

    /**
     * é¡§å®¢ãƒã‚¹ã‚¿ã«FAXç•ªå·ã‚’ç™»éŒ²
     */
    function registerCustomerFax() {
      const cust = aiAnalysisResult?.customer;
      if (!cust || !cust.rawFax) {
        showWarningToast('FAXç•ªå·ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      // ç™»éŒ²å¯¾è±¡ã®é¡§å®¢ã‚’ç‰¹å®š
      let targetCustomer = null;
      if (manualCustomerSelection) {
        targetCustomer = manualCustomerSelection;
      } else if (cust.masterData) {
        targetCustomer = cust.masterData;
      }

      if (!targetCustomer) {
        showWarningToast('ç™»éŒ²å¯¾è±¡ã®é¡§å®¢ãŒç‰¹å®šã§ãã¾ã›ã‚“');
        return;
      }

      const customerDisplayName = targetCustomer.displayName || '';
      const customerCompanyName = targetCustomer.companyName || '';
      const customerPersonName = targetCustomer.personName || '';
      const faxNumber = cust.rawFax;

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const btn = document.querySelector('.btn-register-fax');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'ç™»éŒ²ä¸­...';
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showSuccessToast('FAXç•ªå·ã‚’ç™»éŒ²ã—ã¾ã—ãŸ: ' + result.faxNumber);
            // ç™»éŒ²æˆåŠŸã—ãŸã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’éè¡¨ç¤ºã«
            const promptDiv = document.getElementById('faxRegistrationPrompt');
            if (promptDiv) {
              promptDiv.style.display = 'none';
            }
            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            if (cust.masterData) {
              cust.masterData.fax = result.faxNumber;
            }
            if (manualCustomerSelection) {
              manualCustomerSelection.fax = result.faxNumber;
            }
          } else {
            showWarningToast('ç™»éŒ²å¤±æ•—: ' + result.error);
            if (btn) {
              btn.disabled = false;
              btn.textContent = 'âœ… ã“ã®é¡§å®¢ã«FAXç•ªå·ã‚’ç™»éŒ²';
            }
          }
        })
        .withFailureHandler(function(error) {
          showWarningToast('ã‚¨ãƒ©ãƒ¼: ' + error.message);
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'âœ… ã“ã®é¡§å®¢ã«FAXç•ªå·ã‚’ç™»éŒ²';
          }
        })
        .updateCustomerFax(customerDisplayName, customerCompanyName, customerPersonName, faxNumber);
    }

    /**
     * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
     */
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    /**
     * é¡§å®¢æ¨å®šå€™è£œã‚’è¡¨ç¤ºï¼ˆXSSå®‰å…¨ãªå®Ÿè£…ï¼‰
     */
    function displayCustomerSuggestion() {
      const suggestionDiv = document.getElementById('aiResultCustomerSuggestion');

      // æ¨å®šçµæœãŒãªã„å ´åˆã¯éè¡¨ç¤º
      if (!aiAnalysisResult || !aiAnalysisResult.customerEstimation || !aiAnalysisResult.customerEstimation.customer) {
        suggestionDiv.style.display = 'none';
        return;
      }

      const estimation = aiAnalysisResult.customerEstimation;
      const confidence = estimation.confidence || 0;
      const isHighConfidence = confidence >= 80;

      // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
      suggestionDiv.innerHTML = '';
      suggestionDiv.style.display = 'block';

      // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
      const header = document.createElement('div');
      header.className = 'ai-suggestion-header';
      const headerText = document.createElement('strong');
      headerText.textContent = isHighConfidence ? 'ğŸ¤– æ¨å¥¨å€™è£œï¼ˆè‡ªå‹•å­¦ç¿’ï¼‰' : 'ğŸ¤– å€™è£œï¼ˆè‡ªå‹•å­¦ç¿’ï¼‰';
      header.appendChild(headerText);
      suggestionDiv.appendChild(header);

      // ä¸»è¦å€™è£œã‚¨ãƒªã‚¢
      const primaryDiv = document.createElement('div');
      primaryDiv.className = 'ai-suggestion-primary';

      // é¡§å®¢å
      const nameDiv = document.createElement('div');
      nameDiv.className = 'suggestion-customer-name';
      nameDiv.textContent = estimation.customer;
      primaryDiv.appendChild(nameDiv);

      // ä¿¡é ¼åº¦ã¨ã‚½ãƒ¼ã‚¹
      const confidenceDiv = document.createElement('div');
      confidenceDiv.className = 'suggestion-confidence';
      let confidenceText = 'ä¿¡é ¼åº¦: ' + confidence + '%';
      if (estimation.sources && estimation.sources.length > 0) {
        const sourceLabels = {
          'mapping': 'ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’',
          'order_history': 'å—æ³¨å±¥æ­´'
        };
        const sourceText = estimation.sources.map(function(s) {
          return sourceLabels[s] || s;
        }).join(', ');
        confidenceText += ' (' + sourceText + ')';
      }
      confidenceDiv.textContent = confidenceText;
      primaryDiv.appendChild(confidenceDiv);

      // é©ç”¨ãƒœã‚¿ãƒ³
      const applyBtn = document.createElement('button');
      applyBtn.type = 'button';
      applyBtn.className = 'btn-apply-suggestion';
      applyBtn.textContent = 'âœ… ã“ã®å€™è£œã‚’é©ç”¨';
      applyBtn.onclick = function() {
        applyCustomerSuggestion(estimation.customer);
      };
      primaryDiv.appendChild(applyBtn);

      suggestionDiv.appendChild(primaryDiv);

      // ä»£æ›¿å€™è£œï¼ˆã‚ã‚Œã°ï¼‰
      if (estimation.alternatives && estimation.alternatives.length > 0) {
        const altDiv = document.createElement('div');
        altDiv.className = 'ai-suggestion-alternatives';

        const altLabel = document.createElement('div');
        altLabel.className = 'alternatives-label';
        altLabel.textContent = 'ä»–ã®å€™è£œ:';
        altDiv.appendChild(altLabel);

        const altList = document.createElement('ul');
        altList.className = 'alternatives-list';

        estimation.alternatives.forEach(function(alt) {
          const li = document.createElement('li');

          const nameSpan = document.createElement('span');
          nameSpan.className = 'alt-customer-name';
          nameSpan.textContent = alt.customer;
          li.appendChild(nameSpan);

          const confSpan = document.createElement('span');
          confSpan.className = 'alt-confidence';
          confSpan.textContent = ' (' + alt.confidence + '%) ';
          li.appendChild(confSpan);

          const altBtn = document.createElement('button');
          altBtn.type = 'button';
          altBtn.className = 'btn-apply-alt';
          altBtn.textContent = 'é©ç”¨';
          altBtn.onclick = function() {
            applyCustomerSuggestion(alt.customer);
          };
          li.appendChild(altBtn);

          altList.appendChild(li);
        });

        altDiv.appendChild(altList);
        suggestionDiv.appendChild(altDiv);
      }
    }

    /**
     * é¡§å®¢æ¨å®šå€™è£œã‚’é©ç”¨ï¼ˆ1ã‚¯ãƒªãƒƒã‚¯é©ç”¨æ©Ÿèƒ½ï¼‰
     * @param {string} customerName - é©ç”¨ã™ã‚‹é¡§å®¢å
     */
    function applyCustomerSuggestion(customerName) {
      if (!customerName) {
        showToast('é¡§å®¢åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        return;
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      showLoading('é¡§å®¢æƒ…å ±ã‚’å–å¾—ä¸­...');

      // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰é¡§å®¢æƒ…å ±ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(customerData) {
          hideLoading();

          if (!customerData) {
            showToast('é¡§å®¢æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: ' + customerName, 'error');
            return;
          }

          // manualCustomerSelectionã«ä¿å­˜
          manualCustomerSelection = {
            displayName: customerData.displayName || customerName,
            companyName: customerData.companyName || '',
            personName: customerData.personName || '',
            zipcode: customerData.zipcode || '',
            address: customerData.address || '',
            tel: customerData.tel || '',
            fax: customerData.fax || '',
            email: customerData.email || '',
            source: 'ai_suggestion' // ã‚½ãƒ¼ã‚¹ã‚’è­˜åˆ¥
          };

          console.log('AIå€™è£œã‹ã‚‰é¸æŠã—ãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜:', manualCustomerSelection);

          // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’å…¥åŠ›
          const companyName = customerData.companyName || '';
          const personName = customerData.personName || '';

          if (companyName) {
            document.querySelector('input[id="customerName"]').value = companyName + 'ã€€' + personName;
          } else {
            document.querySelector('input[id="customerName"]').value = personName;
          }

          document.querySelector('input[id="customerZipcode"]').value = customerData.zipcode || '';
          document.querySelector('input[id="customerAddress"]').value = customerData.address || '';
          document.querySelector('input[id="customerTel"]').value = customerData.tel || '';

          // AIè§£æçµæœã®è¡¨ç¤ºã‚’æ›´æ–°
          if (aiAnalysisResult && aiAnalysisResult.customer) {
            displayCustomer(aiAnalysisResult.customer);
          }

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          showToast('é¡§å®¢æƒ…å ±ã‚’é©ç”¨ã—ã¾ã—ãŸ: ' + customerName, 'success');

          // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’é–‰ã˜ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          // toggleAIAssistant();
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('é¡§å®¢æƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
          showToast('é¡§å®¢æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        })
        .getCustomerByDisplayName(customerName);
    }

    /**
     * ç·¨é›†å¯èƒ½ãªå•†å“ãƒªã‚¹ãƒˆè¡¨ç¤º
     */
    function displayItemsEditable(items, unknownItems) {
      const container = document.getElementById('aiResultItems');
      container.innerHTML = '';
      if (!items || items.length === 0) {
        container.innerHTML = '<p style="color:#999;">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
        return;
      }
      items.forEach((item, index) => {
        const mappingMatch = item.mappingMatch || {};
        const isLearned = mappingMatch.found && mappingMatch.matchType === 'exact';
        const canLearn = !isLearned && item.originalText;
        
        let price = 0;
        let priceSource = 'none';
        if (item.price && item.price > 0) {
          price = item.price;
          priceSource = item.priceSource || 'ai';
        } else if (item.productName && productPrices[item.productName]) {
          price = productPrices[item.productName];
          priceSource = 'master';
        }
        
        itemEdits[index] = {
          category: item.category || '',
          productName: item.productName || '',
          spec: item.spec || '',
          quantity: item.quantity || '',
          unit: item.unit || 'ã‚±ãƒ¼ã‚¹',
          price: price,
          priceSource: priceSource,
          learn: canLearn && item.confidence !== 'low',
          originalText: item.originalText || '',
          originalProductName: item.productName || ''
        };
        
        const cardClass = isLearned ? 'learned' : '';
        let categoryOptions = '<option value="">é¸æŠ...</option>';
        categoryList.forEach(cat => {
          categoryOptions += '<option value="' + cat + '" ' + (cat === item.category ? 'selected' : '') + '>' + cat + '</option>';
        });
        let productOptions = buildProductOptions(item.category, item.productName);
        
        let badgeHtml = '';
        if (isLearned) {
          badgeHtml = '<span class="mapping-badge">ğŸ“š å­¦ç¿’æ¸ˆã¿ï¼ˆ' + mappingMatch.usageCount + 'å›ä½¿ç”¨ï¼‰</span>';
        } else {
          badgeHtml = '<span class="confidence-badge confidence-' + item.confidence + '">' + getConfidenceLabel(item.confidence) + '</span>';
        }
        
        let priceBadgeHtml = '';
        if (priceSource === 'ai') {
          priceBadgeHtml = '<span class="price-badge ai">é¡§å®¢æŒ‡å®š</span>';
        } else if (priceSource === 'master') {
          priceBadgeHtml = '<span class="price-badge master">ãƒã‚¹ã‚¿</span>';
        }
        
        let learnHtml = '';
        if (canLearn) {
          const checked = itemEdits[index].learn ? 'checked' : '';
          learnHtml = '<div class="item-learn-row ' + (itemEdits[index].learn ? 'will-learn' : '') + '" id="learnRow_' + index + '"><input type="checkbox" id="learn_' + index + '" ' + checked + ' onchange="toggleLearn(' + index + ')"><label for="learn_' + index + '">ã“ã®å¯¾å¿œã‚’è¨˜æ†¶ã™ã‚‹</label><span class="learn-preview" id="learnPreview_' + index + '" style="' + (itemEdits[index].learn ? '' : 'display:none') + '">â†’ ' + (item.productName || 'æœªé¸æŠ') + '</span></div>';
        }
        
        container.innerHTML += '<div class="item-card ' + cardClass + '" id="itemCard_' + index + '"><div class="item-card-header"><span class="item-original-text">ğŸ“ ' + (item.originalText || '(åŸæ–‡ãªã—)') + '</span>' + badgeHtml + '</div><div class="item-card-body"><div class="item-edit-row"><label>åˆ†é¡:</label><select id="category_' + index + '" onchange="onCategoryChange(' + index + ')">' + categoryOptions + '</select></div><div class="item-edit-row"><label>å•†å“:</label><select id="product_' + index + '" onchange="onProductChange(' + index + ')">' + productOptions + '</select></div><div class="item-edit-row"><label>è¦æ ¼:</label><input type="text" id="spec_' + index + '" value="' + (item.spec || '') + '" onchange="onSpecChange(' + index + ')"></div><div class="item-edit-row"><label>ä¾¡æ ¼:</label><div class="price-group"><input type="number" id="price_' + index + '" value="' + price + '" onchange="onPriceChange(' + index + ')"><span class="unit">å††</span>' + priceBadgeHtml + '</div></div><div class="item-edit-row"><label>æ•°é‡:</label><div class="quantity-group"><input type="number" id="quantity_' + index + '" value="' + (item.quantity || '') + '" step="0.1" onchange="onQuantityChange(' + index + ')"><select id="unit_' + index + '" onchange="onUnitChange(' + index + ')"><option value="ã‚±ãƒ¼ã‚¹" ' + (item.unit === 'ã‚±ãƒ¼ã‚¹' ? 'selected' : '') + '>ã‚±ãƒ¼ã‚¹</option><option value="æœ¬" ' + (item.unit === 'æœ¬' ? 'selected' : '') + '>æœ¬</option><option value="è¢‹" ' + (item.unit === 'è¢‹' ? 'selected' : '') + '>è¢‹</option><option value="kg" ' + (item.unit === 'kg' ? 'selected' : '') + '>kg</option><option value="å€‹" ' + (item.unit === 'å€‹' ? 'selected' : '') + '>å€‹</option></select></div></div>' + learnHtml + '</div></div>';
      });
    }
    
    /**
     * å•†å“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
     */
    function buildProductOptions(category, selectedProduct) {
      let options = '<option value="">é¸æŠ...</option>';
      if (category && productMaster[category]) {
        productMaster[category].forEach(prod => {
          options += '<option value="' + prod + '" ' + (prod === selectedProduct ? 'selected' : '') + '>' + prod + '</option>';
        });
      }
      categoryList.forEach(cat => {
        if (cat !== category && productMaster[cat]) {
          options += '<optgroup label="â”€â”€ ' + cat + ' â”€â”€">';
          productMaster[cat].forEach(prod => {
            options += '<option value="' + prod + '" ' + (prod === selectedProduct ? 'selected' : '') + '>' + prod + '</option>';
          });
          options += '</optgroup>';
        }
      });
      return options;
    }
    
    /**
     * ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
     */
    function onCategoryChange(index) {
      const category = document.getElementById('category_' + index).value;
      itemEdits[index].category = category;
      const productSelect = document.getElementById('product_' + index);
      productSelect.innerHTML = buildProductOptions(category, '');
      itemEdits[index].productName = '';
      itemEdits[index].price = 0;
      document.getElementById('price_' + index).value = 0;
      checkModified(index);
      updateLearnSummary();
    }
    
    /**
     * å•†å“å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
     */
    function onProductChange(index) {
      const productName = document.getElementById('product_' + index).value;
      itemEdits[index].productName = productName;
      if (productName && productPrices[productName] && itemEdits[index].priceSource !== 'ai') {
        itemEdits[index].price = productPrices[productName];
        itemEdits[index].priceSource = 'master';
        document.getElementById('price_' + index).value = productPrices[productName];
      }
      const preview = document.getElementById('learnPreview_' + index);
      if (preview) preview.textContent = 'â†’ ' + (productName || 'æœªé¸æŠ');
      checkModified(index);
      updateLearnSummary();
    }
    
    function onSpecChange(index) {
      itemEdits[index].spec = document.getElementById('spec_' + index).value;
      checkModified(index);
    }
    
    function onPriceChange(index) {
      itemEdits[index].price = Number(document.getElementById('price_' + index).value) || 0;
      itemEdits[index].priceSource = 'manual';
      checkModified(index);
    }
    
    function onQuantityChange(index) {
      itemEdits[index].quantity = document.getElementById('quantity_' + index).value;
      checkModified(index);
    }
    
    function onUnitChange(index) {
      itemEdits[index].unit = document.getElementById('unit_' + index).value;
      checkModified(index);
    }
    
    /**
     * å­¦ç¿’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ‡ã‚Šæ›¿ãˆ
     */
    function toggleLearn(index) {
      const checked = document.getElementById('learn_' + index).checked;
      itemEdits[index].learn = checked;
      const row = document.getElementById('learnRow_' + index);
      const preview = document.getElementById('learnPreview_' + index);
      if (checked) { row.classList.add('will-learn'); preview.style.display = ''; }
      else { row.classList.remove('will-learn'); preview.style.display = 'none'; }
      updateLearnSummary();
    }
    
    /**
     * å¤‰æ›´ãƒã‚§ãƒƒã‚¯
     */
    function checkModified(index) {
      const card = document.getElementById('itemCard_' + index);
      const edit = itemEdits[index];
      if (edit.productName !== edit.originalProductName) { card.classList.add('modified'); }
      else { card.classList.remove('modified'); }
    }
    
    /**
     * å­¦ç¿’ã‚µãƒãƒªæ›´æ–°
     */
    function updateLearnSummary() {
      const summaryDiv = document.getElementById('learnSummary');
      const itemsDiv = document.getElementById('learnSummaryItems');
      const learnList = [];
      Object.keys(itemEdits).forEach(index => {
        const edit = itemEdits[index];
        if (edit.learn && edit.originalText && edit.productName) {
          learnList.push({ originalText: edit.originalText, productName: edit.productName, isModified: edit.productName !== edit.originalProductName });
        }
      });
      if (learnList.length === 0) { summaryDiv.style.display = 'none'; return; }
      summaryDiv.style.display = 'block';
      itemsDiv.innerHTML = learnList.map(l => '<div class="learn-summary-item"><span class="original">ã€Œ' + l.originalText + 'ã€</span><span class="arrow">â†’</span><span class="product">' + l.productName + '</span>' + (l.isModified ? '<span class="modified-badge">ä¿®æ­£æ¸ˆ</span>' : '') + '</div>').join('');
    }
    
    /**
     * ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ
     */
    function selectSource(type, source) {
      if (type === 'shippingTo') {
        useShippingToMaster = (source === 'master');
      } else {
        useCustomerMaster = (source === 'master');
      }
      const btns = document.querySelectorAll('#' + type + 'SourceSelect .source-select-btn');
      btns.forEach(btn => {
        btn.classList.remove('selected');
      });
      btns.forEach(btn => {
        const btnText = btn.textContent.trim();
        if ((source === 'raw' && btnText.includes('èª­ã¿å–ã‚Š')) ||
            (source === 'master' && btnText.includes('ãƒã‚¹ã‚¿')) ||
            (source === 'manual' && btnText.includes('æ‰‹å‹•é¸æŠ'))) {
          btn.classList.add('selected');
        }
      });
      console.log('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ:', type, source);
    }
    
    /**
     * ä¿¡é ¼åº¦ãƒãƒƒã‚¸è¨­å®š
     */
    function setConfidenceBadge(id, conf) {
      const el = document.getElementById(id);
      if (!el) return;
      el.className = 'confidence-badge confidence-' + (conf || 'low');
      el.textContent = getConfidenceLabel(conf);
    }
    
    /**
     * ä¿¡é ¼åº¦ãƒ©ãƒ™ãƒ«å–å¾—
     */
    function getConfidenceLabel(conf) {
      return { high: 'âœ… é«˜', medium: 'âš ï¸ ä¸­', low: 'â“ ä½' }[conf] || 'â“';
    }
    
    /**
     * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
     */
    function showError(msg) {
      document.getElementById('aiResultArea').classList.add('show');
      document.getElementById('aiError').style.display = 'block';
      document.getElementById('aiError').textContent = msg;
    }
    
    /**
     * AIè§£æçµæœã‚¯ãƒªã‚¢
     */
    function clearAIResult() {
      aiAnalysisResult = null;
      useShippingToMaster = useCustomerMaster = false;
      itemEdits = {};
      document.getElementById('aiResultArea').classList.remove('show');
      document.getElementById('aiInputText').value = '';
      removeFile();
    }
    
    /**
     * AIè§£æçµæœã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
     */
    function applyAIResult() {
      if (!aiAnalysisResult) { showWarningToast('è§£æçµæœãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      
      // ç™ºé€å…ˆåã‚’å„ªå…ˆçš„ã«å–å¾—ï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’ç”¨ï¼‰
      const shippingToName = aiAnalysisResult.shippingTo?.masterData?.companyName || 
                             aiAnalysisResult.shippingTo?.rawCompanyName || '';
      const customerName = aiAnalysisResult.customer?.rawCompanyName || '';
      
      const mappingsToLearn = [];
      Object.keys(itemEdits).forEach(index => {
        const edit = itemEdits[index];
        if (edit.learn && edit.originalText && edit.productName) {
          mappingsToLearn.push({ 
            originalText: edit.originalText, 
            productName: edit.productName, 
            shippingToName: shippingToName,  // ç™ºé€å…ˆåå„ªå…ˆ
            customerName: customerName,       // å¾Œæ–¹äº’æ›
            spec: edit.spec || '' 
          });
        }
      });
      
      if (mappingsToLearn.length > 0) {
        google.script.run.withSuccessHandler(function(results) { console.log('ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’çµæœ:', results); }).withFailureHandler(function(error) { console.error('ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’ã‚¨ãƒ©ãƒ¼:', error); }).registerProductMappingBulk(mappingsToLearn);
      }
      
      if (aiAnalysisResult.shippingDate) { setFormValue('shippingDate', aiAnalysisResult.shippingDate); }
      if (aiAnalysisResult.deliveryDate) { setFormValue('deliveryDate', aiAnalysisResult.deliveryDate); }

      // ç™ºé€å…ˆã®é©ç”¨ï¼ˆå„ªå…ˆé †ä½: æ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ > AIèª­ã¿å–ã‚Šï¼‰
      if (manualShippingToSelection) {
        console.log('æ‰‹å‹•é¸æŠã—ãŸç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨:', manualShippingToSelection);
        const name = [manualShippingToSelection.companyName, manualShippingToSelection.personName].filter(Boolean).join('ã€€');
        setFormValue('shippingToName', name);
        setFormValue('shippingToZipcode', manualShippingToSelection.zipcode || '');
        setFormValue('shippingToAddress', manualShippingToSelection.address || '');
        setFormValue('shippingToTel', manualShippingToSelection.tel || '');
      } else {
        const st = aiAnalysisResult.shippingTo;
        if (st) {
          const data = useShippingToMaster && st.masterData ? st.masterData : st;
          setFormValue('shippingToName', useShippingToMaster ? [data.companyName, data.personName].filter(Boolean).join('ã€€') : [st.rawCompanyName, st.rawPersonName].filter(Boolean).join('ã€€'));
          setFormValue('shippingToZipcode', (useShippingToMaster ? data.zipcode : st.rawZipcode) || '');
          setFormValue('shippingToAddress', (useShippingToMaster ? data.address : st.rawAddress) || '');
          setFormValue('shippingToTel', (useShippingToMaster ? data.tel : st.rawTel) || '');
        }
      }

      // é¡§å®¢ã®é©ç”¨ï¼ˆå„ªå…ˆé †ä½: æ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ > AIèª­ã¿å–ã‚Šï¼‰
      if (manualCustomerSelection) {
        console.log('æ‰‹å‹•é¸æŠã—ãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨:', manualCustomerSelection);
        // å—æ³¨ç”»é¢ã§ã¯å¸¸ã«ã€Œä¼šç¤¾å æ°åã€å½¢å¼ã§è¡¨ç¤ºï¼ˆdisplayNameã¯ä½¿ã‚ãªã„ï¼‰
        const name = [manualCustomerSelection.companyName, manualCustomerSelection.personName]
          .filter(Boolean).join('ã€€');
        setFormValue('customerName', name);
        setFormValue('customerZipcode', manualCustomerSelection.zipcode || '');
        setFormValue('customerAddress', manualCustomerSelection.address || '');
        setFormValue('customerTel', manualCustomerSelection.tel || '');
      } else {
        const cust = aiAnalysisResult.customer;
        if (cust) {
          const data = useCustomerMaster && cust.masterData ? cust.masterData : cust;
          setFormValue('customerName', useCustomerMaster ? (data.displayName || [data.companyName, data.personName].filter(Boolean).join('ã€€')) : [cust.rawCompanyName, cust.rawPersonName].filter(Boolean).join('ã€€'));
          setFormValue('customerZipcode', (useCustomerMaster ? data.zipcode : cust.rawZipcode) || '');
          setFormValue('customerAddress', (useCustomerMaster ? data.address : cust.rawAddress) || '');
          setFormValue('customerTel', (useCustomerMaster ? data.tel : cust.rawTel) || '');
        }
      }
      
      Object.keys(itemEdits).forEach((index, i) => {
        const row = i + 1;
        if (row > 10) return;
        const edit = itemEdits[index];
        if (edit.category) {
          const bunrui = document.getElementById('bunrui' + row);
          if (bunrui) { bunrui.value = edit.category; if (typeof bunruiChange === 'function') bunruiChange(row); }
        }
        if (edit.productName) {
          setTimeout(() => {
            const prod = document.getElementById('product' + row);
            if (prod) {
              for (let j = 0; j < prod.options.length; j++) {
                if (prod.options[j].value === edit.productName) {
                  prod.selectedIndex = j;
                  if (typeof productChange === 'function') productChange(row);
                  break;
                }
              }
            }
          }, 100 * i);
        }
        if (edit.price) {
          setTimeout(() => {
            const priceEl = document.getElementById('price' + row);
            if (priceEl) priceEl.value = edit.price;
          }, 100 * i + 30);
        }
        if (edit.quantity) {
          setTimeout(() => {
            const qty = document.getElementById('quantity' + row);
            if (qty) qty.value = edit.quantity;
          }, 100 * i + 50);
        }
      });
      
      saveAISessionData();
      showAIAnalyzedIndicator(new Date().toISOString());
      
      let message = 'ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã—ã¾ã—ãŸã€‚';
      if (mappingsToLearn.length > 0) { message += '\n\nğŸ“š ' + mappingsToLearn.length + 'ä»¶ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å­¦ç¿’ã—ã¾ã—ãŸã€‚'; }
      if (aiAnalysisResult.alerts?.length) { message += '\n\nâš ï¸ ' + aiAnalysisResult.alerts.join('\n'); }
      showInfoToast(message);
      toggleAIAssistant();
    }
    
    /**
     * ãƒ•ã‚©ãƒ¼ãƒ å€¤è¨­å®šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
     */
    function setFormValue(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value;
    }
</script>
