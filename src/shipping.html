<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
</head>

<body>
  <div class="container">
    <form class="mb-5" method="POST" action="<?= deployURL ?>">
      <div class="mt-3">
        <button type="submit" formnovalidate class="btn btn-outline-secondary me-3" 
        name="mainTop" value="true"
        onclick="clearAISession()">ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹</button>
      </div>
      <h2 class="text-center m-4">å—æ³¨ç®¡ç†</h2>
      <!-- AIè§£ææ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ä¸Šéƒ¨ã«è¡¨ç¤ºï¼‰ -->
      <div class="ai-analyzed-indicator" id="aiAnalyzedIndicator">
        <span>ğŸ¤– AIè§£ææ¸ˆã¿</span>
        <span class="time" id="aiAnalyzedTime"></span>
      </div>

      <div class="ai-assistant-container">
        <div class="ai-assistant-header" onclick="toggleAIAssistant()">
          <h3>ğŸ¤– AIå…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆç¢ºèªãƒ»ä¿®æ­£ã—ã¦å­¦ç¿’ï¼‰</h3>
          <button type="button" class="ai-assistant-toggle" id="aiToggleBtn">é–‹ã</button>
        </div>
        
        <div class="ai-assistant-body" id="aiAssistantBody">
          <div class="ai-input-tabs">
            <button type="button" class="ai-tab-btn active" onclick="switchTab('text')">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ</button>
            <button type="button" class="ai-tab-btn" onclick="switchTab('file')">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«</button>
          </div>
          
          <div class="ai-tab-content active" id="textTab">
            <div class="ai-input-area">
              <textarea id="aiInputText" placeholder="ãƒ¡ãƒ¼ãƒ«ã€ãƒãƒ£ãƒƒãƒˆã€FAXã®å†…å®¹ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
            </div>
          </div>
          
          <div class="ai-tab-content" id="fileTab">
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('orderFile').click()">
              <input type="file" id="orderFile" accept=".pdf,image/*" onchange="handleFileSelect(event)">
              <div class="icon">ğŸ“„</div>
              <div class="text">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
              <div class="hint">PDFã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</div>
            </div>
            <div id="filePreview"></div>
          </div>
          
          <button type="button" class="ai-analyze-btn" id="aiAnalyzeBtn" onclick="analyzeWithAI()">
            <span class="spinner"></span>
            <span class="btn-text">ğŸ” AIã§è§£æã™ã‚‹</span>
          </button>
          
          <div class="ai-result-area" id="aiResultArea">
            <div class="ai-result-header">
              ğŸ“‹ è§£æçµæœ
              <span class="confidence-badge" id="overallConfidence"></span>
            </div>
            
            <div class="ai-result-body">
              <div class="ai-alerts" id="aiAlerts"></div>
              
              <div class="ai-result-section">
                <div class="ai-result-section-header">ğŸ“… æ—¥ç¨‹</div>
                <div class="ai-result-section-body">
                  <div class="raw-data-info">
                    <div class="row"><span class="label">ç™ºé€æ—¥ï¼š</span><span id="aiResultShippingDate">-</span></div>
                    <div class="row"><span class="label">ç´å“æ—¥ï¼š</span><span id="aiResultDeliveryDate">-</span></div>
                    <div class="row"><span class="label">æ™‚é–“æŒ‡å®šï¼š</span><span id="aiResultDeliveryTime">-</span></div>
                  </div>
                </div>
              </div>
              
              <div class="ai-result-section">
                <div class="ai-result-section-header">ğŸ“¦ ç™ºé€å…ˆ <span id="shippingToMatchBadge"></span></div>
                <div class="ai-result-section-body">
                  <div class="raw-data-info" id="aiResultShippingToRaw"></div>
                  <div class="master-data-info" id="aiResultShippingToMaster" style="display:none;"></div>
                  <div class="manual-select-info" id="aiResultShippingToManual" style="display:none;"></div>
                  <div class="source-select-group" id="shippingToSourceSelect" style="display:none;"></div>
                </div>
              </div>
              
              <div class="ai-result-section">
                <div class="ai-result-section-header">ğŸ‘¤ é¡§å®¢ <span id="customerMatchBadge"></span></div>
                <div class="ai-result-section-body">
                  <div class="raw-data-info" id="aiResultCustomerRaw"></div>
                  <div class="master-data-info" id="aiResultCustomerMaster" style="display:none;"></div>
                  <div class="manual-select-info" id="aiResultCustomerManual" style="display:none;"></div>
                  <div class="source-select-group" id="customerSourceSelect" style="display:none;"></div>
                </div>
              </div>
              
              <div class="ai-result-section">
                <div class="ai-result-section-header">ğŸ›’ å•†å“</div>
                <div class="ai-result-section-body" id="aiResultItems"></div>
              </div>
              
              <div class="learn-summary" id="learnSummary" style="display:none;">
                <div class="learn-summary-title">ğŸ“š å­¦ç¿’äºˆå®šã®ãƒãƒƒãƒ”ãƒ³ã‚°</div>
                <div id="learnSummaryItems"></div>
              </div>
              
              <div class="ai-result-section" id="memoSection" style="display:none;">
                <div class="ai-result-section-header">ğŸ“ å‚™è€ƒ</div>
                <div class="ai-result-section-body" id="aiResultMemo"></div>
              </div>
              
              <div class="ai-error" id="aiError" style="display:none;"></div>
              
              <div class="ai-action-buttons">
                <button type="button" class="ai-cancel-btn" onclick="clearAIResult()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="ai-apply-btn" onclick="applyAIResult()">âœ… ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼†å­¦ç¿’</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="ai-warning-modal-overlay" id="aiWarningModal">
        <div class="ai-warning-modal">
          <div class="ai-warning-modal-header">âš ï¸ å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
          <div class="ai-warning-modal-body" id="aiWarningBody"></div>
          <div class="ai-warning-modal-footer">
            <button type="button" class="ai-warning-modify-btn" onclick="closeWarningModal()">ä¿®æ­£ã™ã‚‹</button>
            <button type="button" class="ai-warning-proceed-btn" onclick="proceedWithWarnings()">ã“ã®ã¾ã¾é€²ã‚€</button>
          </div>
        </div>
      </div>
      <div class="customerSearch_dg">
        <div>
          <label for="customerSearchBunruiDg" class="text-left form-label">é¡§å®¢</label>
          <select class="form-select" id="customerSearchBunruiDg" name="customerSearchBunruiDg">
                        <option value="1">ä¼šç¤¾å</option>
                        <option value="2">æ°å</option>
                        <option value="3">è¡¨ç¤ºå</option>
                        <option value="4">ãƒ•ãƒªã‚¬ãƒŠ</option>
                    </select>
        </div>
        <div>
          <label for="customerSearchClassDg" class="text-left form-label">é¡§å®¢åˆ†é¡</label>
          <select class="form-select" id="customerSearchClassDg" name="customerSearchClassDg">
                        <option value=""></option>
                        <option value="1">ä¸€æ¬¡å¸ã—ãƒ»å¤§å£</option>
                        <option value="2">å°å£²åº—</option>
                        <option value="3">é£²é£Ÿåº—ãƒ»ãƒ›ãƒ†ãƒ«</option>
                        <option value="4">åœ°å…ƒé£²é£Ÿåº—</option>
                        <option value="5">é€šä¿¡è²©å£²</option>
                        <option value="6">ä¸€èˆ¬è²©å£²</option>
                        <option value="7">ãã®ä»–</option>
                        <option value="8">è·åŸŸ</option>
                    </select>
        </div>
        <div>
          <label for="customerSearchKeyDg" class="text-left form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" class="form-control" id="customerSearchKeyDg" name="customerSearchKeyDg">
        </div>
        <div id="resCustArea" class="mt-2 resTable">
        </div>
      </div>
      <div class="shippingToSearch_dg">
        <div>
          <label for="shippingToSearchBunruiDg" class="text-left form-label">ç™ºé€å…ˆ</label>
          <select class="form-select" id="shippingToSearchBunruiDg" name="shippingToSearchBunruiDg">
                        <option value="1">ä¼šç¤¾å</option>
                        <option value="2">æ°å</option>
                    </select>
        </div>
        <div>
          <label for="shippingToSearchKeyDg" class="text-left form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" class="form-control" id="shippingToSearchKeyDg" name="shippingToSearchKeyDg">
        </div>
        <div id="resShippingToArea" class="mt-2 resTable">
        </div>
      </div>
      <div class="customer_dg">
        <div>
          <label for="customerClassDg" class="text-left form-label">é¡§å®¢åˆ†é¡</label>
          <select class="form-select" id="customerClassDg" name="customerClassDg">
                        <option value="1">ä¸€æ¬¡å¸ã—ãƒ»å¤§å£</option>
                        <option value="2">å°å£²åº—</option>
                        <option value="3">é£²é£Ÿåº—ãƒ»ãƒ›ãƒ†ãƒ«</option>
                        <option value="4">åœ°å…ƒé£²é£Ÿåº—</option>
                        <option value="5">é€šä¿¡è²©å£²</option>
                        <option value="6">ä¸€èˆ¬è²©å£²</option>
                        <option value="7">ãã®ä»–</option>
                        <option value="8">è·åŸŸ</option>
                    </select>
        </div>
        <div>
          <label for="customerNameDg" class="text-left form-label">ä¼šç¤¾å</label>
          <input type="text" id="customerNameDg" name="customerNameDg">
        </div>
        <div>
          <label for="customerShowNameDg" class="text-left form-label">è¡¨ç¤ºå</label>
          <input type="text" id="customerShowNameDg" name="customerShowNameDg">
        </div>
        <div>
          <label for="customerFuriganaDg" class="text-left form-label">ãƒ•ãƒªã‚¬ãƒŠ</label>
          <input type="text" id="customerFuriganaDg" name="customerFuriganaDg">
        </div>
        <div>
          <label for="customerDepDg" class="text-left form-label">éƒ¨ç½²</label>
          <input type="text" id="customerDepDg" name="customerDepDg">
        </div>
        <div>
          <label for="customerPostDg" class="text-left form-label">å½¹è·</label>
          <input type="text" id="customerPostDg" name="customerPostDg">
        </div>
        <div>
          <label for="customerIdentDg" class="text-left form-label">æ°å</label>
          <input type="text" id="customerIdentDg" name="customerIdentDg">
        </div>
        <div>
          <label for="customerZipcodeDg" class="text-left form-label">éƒµä¾¿ç•ªå·</label>
          <input type="text" id="customerZipcodeDg" name="customerZipcodeDg" maxlength=7
                        onfocusout="getAddress()">
        </div>
        <div>
          <label for="customerAddress1Dg" class="text-left form-label">ä½æ‰€ï¼‘</label>
          <input type="text" id="customerAddress1Dg" name="customerAddress1Dg">
        </div>
        <div>
          <label for="customerAddress2Dg" class="text-left form-label">ä½æ‰€ï¼’</label>
          <input type="text" id="customerAddress2Dg" name="customerAddress2Dg">
        </div>
        <div>
          <label for="customerTelDg" class="text-left form-label">é›»è©±ç•ªå·</label>
          <input type="text" class="form-control" id="customerTelDg" name="customerTelDg" maxlength=11>
        </div>
        <div>
          <label for="customerPhoneDg" class="text-left form-label">æºå¸¯é›»è©±</label>
          <input type="text" class="form-control" id="customerPhoneDg" name="customerPhoneDg" maxlength=11>
        </div>
        <div>
          <label for="customerFaxDg" class="text-left form-label">ï¼¦ï¼¡ï¼¸</label>
          <input type="text" class="form-control" id="customerFaxDg" name="customerFaxDg" maxlength=11>
        </div>
        <div>
          <label for="customerMailDg" class="text-left form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" class="form-control" id="customerMailDg" name="customerMailDg">
        </div>
        <div class="mt-2 mb-2">
          <input type="checkbox" class="form-check-input" id="customerSameDg" name="customerSameDg">
          <label for="customerSameDg" class="form-check-label">ç™ºé€å…ˆåŒä¸Š</label>
        </div>
        <div>
          <label for="customerBillDg" class="text-left form-label">è«‹æ±‚æ›¸æœ‰ç„¡</label>
          <select class="form-select" id="customerBillDg" name="customerBillDg">
                        <option value=""></option>
                        <option value="æœ‰">æœ‰</option>
                    </select>
        </div>
        <div>
          <label for="customerDepositDateDg" class="text-left form-label">å…¥é‡‘æœŸæ—¥</label>
          <select class="form-select" id="customerDepositDateDg" name="customerDepositDateDg">
                        <option value="ç¿Œæœ«æ—¥">ç¿Œæœ«æ—¥</option>
                        <option value="ï¼’é€±é–“å¾Œ">ï¼’é€±é–“å¾Œ</option>
                        <option value="ç¿Œã€…ä¸­æ—¥">ç¿Œã€…ä¸­æ—¥</option>
                        <option value="ç¿Œã€…æœ«æ—¥">ç¿Œã€…æœ«æ—¥</option>
                    </select>
        </div>
        <div>
          <label for="customerMemoDg" class="text-left form-label">å‚™è€ƒ</label>
          <input type="text" class="form-control" id="customerMemoDg" name="customerMemoDg">
        </div>
      </div>
      <div class="shippingTo_dg">
        <div>
          <label for="shippingToNameDg" class="text-left form-label">ä¼šç¤¾å</label>
          <input type="text" id="shippingToNameDg" name="shippingToNameDg">
        </div>
        <div>
          <label for="shippingToDepDg" class="text-left form-label">éƒ¨ç½²</label>
          <input type="text" id="shippingToDepDg" name="shippingToDepDg">
        </div>
        <div>
          <label for="shippingToIdentDg" class="text-left form-label">æ°å</label>
          <input type="text" id="shippingToIdentDg" name="shippingToIdentDg">
        </div>
        <div>
          <label for="shippingToZipcodeDg" class="text-left form-label">éƒµä¾¿ç•ªå·</label>
          <input type="text" id="shippingToZipcodeDg" name="shippingToZipcodeDg" maxlength=7
                        onfocusout="getShippingToAddress()">
        </div>
        <div>
          <label for="shippingToAddress1Dg" class="text-left form-label">ä½æ‰€ï¼‘</label>
          <input type="text" id="shippingToAddress1Dg" name="shippingToAddress1Dg">
        </div>
        <div>
          <label for="shippingToAddress2Dg" class="text-left form-label">ä½æ‰€ï¼’</label>
          <input type="text" id="shippingToAddress2Dg" name="shippingToAddress2Dg">
        </div>
        <div>
          <label for="shippingToTelDg" class="text-left form-label">é›»è©±ç•ªå·</label>
          <input type="text" class="form-control" id="shippingToTelDg" name="shippingToTelDg" maxlength=11>
        </div>
        <div>
          <label for="shippingToMailDg" class="text-left form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" class="form-control" id="shippingToMailDg" name="shippingToMailDg">
        </div>
        <div>
          <label for="shippingToMemoDg" class="text-left form-label">å‚™è€ƒ</label>
          <input type="text" class="form-control" id="shippingToMemoDg" name="shippingToMemoDg">
        </div>
      </div>
      <div>
        <? output._ = shippingHTML ?>
      </div>
      <!-- ä»®å—æ³¨IDï¼ˆAIå–è¾¼ä¸€è¦§ã‹ã‚‰é·ç§»ã—ãŸå ´åˆã«è¨­å®šï¼‰ -->
      <? if (typeof tempOrderId !== 'undefined' && tempOrderId) { ?>
        <input type="hidden" name="tempOrderId" value="<?= tempOrderId ?>">
      <? } ?>
      
      <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆç™½èƒŒæ™¯ã§ç‹¬ç«‹ï¼‰ -->
      <div class="form-actions-area">
        <div class="text-center">
          <? if (isEditMode) { ?>
            <button type="submit" class="btn btn-warning" name="shippingComfirm" value="true" onclick="return validateBeforeSubmit()">ä¿®æ­£ç¢ºèª</button>
          <? } else { ?>
            <button type="submit" class="btn btn-primary" name="shippingComfirm" value="true" onclick="return validateBeforeSubmit()">å—æ³¨ç¢ºèª</button>
          <? } ?>
        </div>
        <div class="text-center mt-3">
          <button type="submit" formnovalidate class="btn btn-outline-secondary me-3" 
          name="mainTop" value="true"
          onclick="clearAISession()">ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹</button>
        </div>
      </div>
    </form>
  </div>
  <script>
    var oriproduct = $('select[id="product1"]').html();
    var oriquantity = $('select[id="quantity1"]').html();
    function bunruiChange(numVal) {
        var bunrui = 'bunrui' + numVal;
        var product = 'product' + numVal;
        var $product = $('select[id="' + product + '"]');
        var val1 = $('select[id="' + bunrui + '"]').val();
        $product.html(oriproduct).find('option').each(function () {
            var val2 = $(this).data('val');
            if (val1 && val1 != val2) {
                $(this).not(':first-child').remove();
            }
        })
    }
    function productChange(numVal) {
        var product = 'product' + numVal;
        var quantity = 'quantity' + numVal;
        var price = 'price' + numVal;
        var $quantity = $('select[id="' + quantity + '"]');
        var $price = $('input[id="' + price + '"]');
        var productVal = $('select[id="' + product + '"]').val();
        var val1 = Number($('[data-name="' + productVal + '"]').data('zaiko'));
        var val2 = Number($('[data-name="' + productVal + '"]').data('price'));
        var val3 = $('[data-name="' + productVal + '"]').data('abbreviation');
        $price.val(val2);
        $quantity.html(oriquantity).find('option').each(function (index) {
            if (val1 < index) {
                $(this).not(':first-child').remove();
            }
        })
        if (numVal == 1) {
            $('#sendProduct').val(val3);
        }
    }
    var orideliveryTime = $('select[id="deliveryTime"]').html();
    var oriinvoiceType = $('select[id="invoiceType"]').html();
    var oricoolCls = $('select[id="coolCls"]').html();
    var oricargo1 = $('select[id="cargo1"]').html();
    var oricargo2 = $('select[id="cargo2"]').html();
    function deliveryMethodChange() {
        var $deliveryMethod = $('select[id="deliveryMethod"]');
        var $deliveryTime = $('select[id="deliveryTime"]');
        var $invoiceType = $('select[id="invoiceType"]');
        var $coolCls = $('select[id="coolCls"]');
        var $cargo1 = $('select[id="cargo1"]');
        var $cargo2 = $('select[id="cargo2"]');
        var val1 = $deliveryMethod.val();
        $deliveryTime.html(orideliveryTime).find('option').each(function () {
            var val2 = $(this).data('val');
            if (val1 && val1 != val2) {
                $(this).not(':first-child').remove();
            }
        })
        $invoiceType.html(oriinvoiceType).find('option').each(function () {
            var val2 = $(this).data('val');
            if (val1 && val1 != val2) {
                $(this).remove();
            }
        })
        $coolCls.html(oricoolCls).find('option').each(function () {
            var val2 = $(this).data('val');
            if (val1 && val1 != val2) {
                $(this).remove();
            }
        })
        $cargo1.html(oricargo1).find('option').each(function () {
            var val2 = $(this).data('val');
            if (val1 && val1 != val2) {
                $(this).not(':first-child').remove();
            }
        })
        $cargo2.html(oricargo2).find('option').each(function () {
            var val2 = $(this).data('val');
            if (val1 && val1 != val2) {
                $(this).not(':first-child').remove();
            }
        })
    }
    function babaChange() {
        $('button[id="babaBtn"]').text('åæ˜ ä¸­..');
        google.script.run.withSuccessHandler(babaChengeSuccess).getCompanyRecordForShipping();
    }
    function babaChengeSuccess(datas) {
        var data = JSON.parse(datas);
        $('input[id="shippingFromName"]').val(data[0]['åå‰']);
        $('input[id="shippingFromZipcode"]').val(data[0]['éƒµä¾¿ç•ªå·']);
        $('input[id="shippingFromAddress"]').val(data[0]['ä½æ‰€']);
        $('input[id="shippingFromTel"]').val(data[0]['é›»è©±ç•ªå·']);
        var companyDisplayName = '<?= getCompanyDisplayName() ?>';
        $('button[id="babaBtn"]').text(companyDisplayName);
    }
    function custCopy() {
        $('input[id="shippingFromName"]').val($('input[id="customerName"]').val());
        $('input[id="shippingFromZipcode"]').val($('input[id="customerZipcode"]').val());
        $('input[id="shippingFromAddress"]').val($('input[id="customerAddress"]').val());
        $('input[id="shippingFromTel"]').val($('input[id="customerTel"]').val());
    }
    function sendCopy() {
        $('input[id="shippingFromName"]').val($('input[id="shippingToName"]').val());
        $('input[id="shippingFromZipcode"]').val($('input[id="shippingToZipcode"]').val());
        $('input[id="shippingFromAddress"]').val($('input[id="shippingToAddress"]').val());
        $('input[id="shippingFromTel"]').val($('input[id="shippingToTel"]').val());
    }
    function customerSame() {
        $('input[id="shippingToName"]').val($('input[id="customerName"]').val());
        $('input[id="shippingToZipcode"]').val($('input[id="customerZipcode"]').val());
        $('input[id="shippingToAddress"]').val($('input[id="customerAddress"]').val());
        $('input[id="shippingToTel"]').val($('input[id="customerTel"]').val());
    }
    $(function () {
        $(".customerInsertBtn_open").on("click", function () {
            $(".customer_dg").dialog({
                title: "é¡§å®¢æ–°è¦ç™»éŒ²",
                height: "500",
                modal: true,
                buttons: {
                    "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function () {
                        $(this).dialog("close");
                    },
                    "ç™»éŒ²": function () {
                        addCustomer();
                    },
                },
            });
        });
    });
    $(function () {
        $(".shippingToInsertBtn_open").on("click", function () {
            $(".shippingTo_dg").dialog({
                title: "ç™ºé€å…ˆæ–°è¦ç™»éŒ²",
                height: "500",
                modal: true,
                buttons: {
                    "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function () {
                        $(this).dialog("close");
                    },
                    "ç™»éŒ²": function () {
                        addShippingTo();
                    },
                },
            });
        });
    });
    function addCustomer() {
        if (!$('input[id="customerNameDg"]').val() && !$('input[id="customerIdentDg"]').val()) {
            showWarningToast('ä¼šç¤¾åã¾ãŸã¯æ°åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        if (!$('input[id="customerZipcodeDg"]').val()) {
            showWarningToast('éƒµä¾¿ç•ªå·ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        if (!$('input[id="customerZipcodeDg"]').val().match(/[0-9]{7}/)) {
            showWarningToast('éƒµä¾¿ç•ªå·ã¯7æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚');
            return false;
        }
        if (!$('input[id="customerAddress1Dg"]').val()) {
            showWarningToast('ä½æ‰€ï¼‘ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        if (!$('input[id="customerTelDg"]').val()) {
            showWarningToast('é›»è©±ç•ªå·ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        if (!$('input[id="customerTelDg"]').val().match(/^0\d{9,10}$/)) {
            showWarningToast('é›»è©±ç•ªå·ã¯10~11æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚');
            return false;
        }
        if ($('input[id="customerPhoneDg"]').val()) {
            if (!$('input[id="customerPhoneDg"]').val().match(/^0\d{9,10}$/)) {
                showWarningToast('æºå¸¯é›»è©±ã¯10~11æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚');
                return false;
            }
        }
        if ($('input[id="customerFaxDg"]').val()) {
            if (!$('input[id="customerFaxDg"]').val().match(/^0\d{9,10}$/)) {
                showWarningToast('ï¼¦ï¼¡ï¼¸ã¯10~11æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚');
                return false;
            }
        }
        if ($('input[id="customerMailDg"]').val()) {
            if (!$('input[id="customerMailDg"]').val().match(/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/)) {
                showWarningToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚');
                return false;
            }
        }
        var record = {};
        record['customerClassDg'] = $('select[id="customerClassDg"]').val();
        record['customerNameDg'] = $('input[id="customerNameDg"]').val();
        record['customerShowNameDg'] = $('input[id="customerShowNameDg"]').val();
        record['customerFuriganaDg'] = $('input[id="customerFuriganaDg"]').val();
        record['customerDepDg'] = $('input[id="customerDepDg"]').val();
        record['customerPostDg'] = $('input[id="customerPostDg"]').val();
        record['customerIdentDg'] = $('input[id="customerIdentDg"]').val();
        record['customerZipcodeDg'] = $('input[id="customerZipcodeDg"]').val();
        record['customerAddress1Dg'] = $('input[id="customerAddress1Dg"]').val();
        record['customerAddress2Dg'] = $('input[id="customerAddress2Dg"]').val();
        record['customerTelDg'] = $('input[id="customerTelDg"]').val();
        record['customerPhoneDg'] = $('input[id="customerPhoneDg"]').val();
        record['customerFaxDg'] = $('input[id="customerFaxDg"]').val();
        record['customerMailDg'] = $('input[id="customerMailDg"]').val();
        record['customerBillDg'] = $('select[id="customerBillDg"]').val();
        record['customerDepositDateDg'] = $('select[id="customerDepositDateDg"]').val();
        record['customerMemoDg'] = $('input[id="customerMemoDg"]').val();

        const checkAddFlg = window.confirm('é¡§å®¢æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
        if (checkAddFlg) {
            if ($('input[name=customerSameDg]').prop("checked")) {
                google.script.run.withSuccessHandler(dataAddSuccess).withFailureHandler(dataAddFail).addCustomerShippingTo(JSON.stringify(record));
            }
            else {
                google.script.run.withSuccessHandler(dataAddSuccess).withFailureHandler(dataAddFail).addCustomer(JSON.stringify(record));
            }
        }
    }
    function addShippingTo() {
        if (!$('input[id="shippingToNameDg"]').val() && !$('input[id="shippingToIdentDg"]').val()) {
            showWarningToast('ä¼šç¤¾åã¾ãŸã¯æ°åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        if (!$('input[id="shippingToZipcodeDg"]').val()) {
            showWarningToast('éƒµä¾¿ç•ªå·ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        if (!$('input[id="shippingToZipcodeDg"]').val().match(/[0-9]{7}/)) {
            showWarningToast('éƒµä¾¿ç•ªå·ã¯7æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚');
            return false;
        }
        if (!$('input[id="shippingToAddress1Dg"]').val()) {
            showWarningToast('ä½æ‰€ï¼‘ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        if (!$('input[id="shippingToTelDg"]').val()) {
            showWarningToast('é›»è©±ç•ªå·ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        if (!$('input[id="shippingToTelDg"]').val().match(/^0\d{9,10}$/)) {
            showWarningToast('é›»è©±ç•ªå·ã¯10~11æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚');
            return false;
        }
        if ($('input[id="shippingToMailDg"]').val()) {
            if (!$('input[id="shippingToMailDg"]').val().match(/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/)) {
                showWarningToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ä¸‹ã•ã„ã€‚');
                return false;
            }
        }
        var record = {};
        record['shippingToClassDg'] = $('select[id="shippingToClassDg"]').val();
        record['shippingToNameDg'] = $('input[id="shippingToNameDg"]').val();
        record['shippingToDepDg'] = $('input[id="shippingToDepDg"]').val();
        record['shippingToPostDg'] = $('input[id="shippingToPostDg"]').val();
        record['shippingToIdentDg'] = $('input[id="shippingToIdentDg"]').val();
        record['shippingToZipcodeDg'] = $('input[id="shippingToZipcodeDg"]').val();
        record['shippingToAddress1Dg'] = $('input[id="shippingToAddress1Dg"]').val();
        record['shippingToAddress2Dg'] = $('input[id="shippingToAddress2Dg"]').val();
        record['shippingToTelDg'] = $('input[id="shippingToTelDg"]').val();
        record['shippingToPhoneDg'] = $('input[id="shippingToPhoneDg"]').val();
        record['shippingToFaxDg'] = $('input[id="shippingToFaxDg"]').val();
        record['shippingToMailDg'] = $('input[id="shippingToMailDg"]').val();
        record['shippingToBillDg'] = $('select[id="shippingToBillDg"]').val();
        record['shippingToDepositDateDg'] = $('select[id="shippingToDepositDateDg"]').val();
        record['shippingToMemoDg'] = $('input[id="shippingToMemoDg"]').val();

        const checkAddFlg = window.confirm('ç™ºé€å…ˆæƒ…å ±ã‚’ç™»éŒ²ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
        if (checkAddFlg) {
            google.script.run.withSuccessHandler(dataAddSuccessShippingTo).withFailureHandler(dataAddFail).addShippingTo(JSON.stringify(record));
        }
    }
    function getAddress() {
        var postalCode = document.getElementById("customerZipcodeDg").value;
        var record = {};
        record['postalCode'] = postalCode;
        google.script.run.withSuccessHandler(dataPostSuccess).withFailureHandler(addFail).getAddressFromPostalCode(JSON.stringify(record));
    }

    function dataPostSuccess(data) {
        if (data) {
            var res = JSON.parse(data);
            $('input[id="customerAddress1Dg"]').val(res['address1'] + res['address2'] + res['address3']);
        }
    }
    function getShippingToAddress() {
        var postalCode = document.getElementById("shippingToZipcodeDg").value;
        var record = {};
        record['postalCode'] = postalCode;
        google.script.run.withSuccessHandler(dataPostSuccessShippingTo).withFailureHandler(addFail).getAddressFromPostalCode(JSON.stringify(record));
    }

    function dataPostSuccessShippingTo(data) {
        if (data) {
            var res = JSON.parse(data);
            $('input[id="shippingToAddress1Dg"]').val(res['address1'] + res['address2'] + res['address3']);
        }
    }

    function dataAddFail() {
        showInfoToast("è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
    }
    function addFail() {
        showErrorToast("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }

    function dataAddSuccess() {
        showSuccessToast("ç™»éŒ²ã—ã¾ã—ãŸã€‚");

        const companyName = $('input[id="customerNameDg"]').val();
        const personName = $('input[id="customerIdentDg"]').val();
        const zipcode = $('input[id="customerZipcodeDg"]').val();
        const address1 = $('input[id="customerAddress1Dg"]').val();
        const address2 = $('input[id="customerAddress2Dg"]').val();
        const tel = $('input[id="customerTelDg"]').val();

        // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        manualCustomerSelection = {
          companyName: companyName,
          personName: personName,
          displayName: companyName || personName,
          zipcode: zipcode,
          address: address1 + address2,
          address1: address1,
          address2: address2,
          tel: tel,
          source: 'manual_registration'
        };
        console.log('æ‰‹å‹•ç™»éŒ²ã—ãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜:', manualCustomerSelection);

        if (companyName) {
            $('input[id="customerName"]').val(companyName + "ã€€" + personName);
        }
        else {
            $('input[id="customerName"]').val(personName);
        }
        $('input[id="customerZipcode"]').val(zipcode);
        $('input[id="customerAddress"]').val(address1 + address2);
        $('input[id="customerTel"]').val(tel);

        // AIãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
        updateManualSelectionDisplay();

        if ($('input[name=customerSameDg]').prop("checked")) {
            if ($('input[id="customerNameDg"]').val()) {
                $('input[id="shippingToName"]').val($('input[id="customerNameDg"]').val() + "ã€€" + $('input[id="customerIdentDg"]').val());
            }
            else {
                $('input[id="shippingToName"]').val($('input[id="customerIdentDg"]').val());
            }
            $('input[id="shippingToZipcode"]').val($('input[id="customerZipcodeDg"]').val());
            $('input[id="shippingToAddress"]').val($('input[id="customerAddress1Dg"]').val() + $('input[id="customerAddress2Dg"]').val());
            $('input[id="shippingToTel"]').val($('input[id="customerTelDg"]').val());
        }
        $(".customer_dg").dialog("close");
    }
    function dataAddSuccessShippingTo() {
        showSuccessToast("ç™»éŒ²ã—ã¾ã—ãŸã€‚");

        const companyName = $('input[id="shippingToNameDg"]').val();
        const personName = $('input[id="shippingToIdentDg"]').val();
        const zipcode = $('input[id="shippingToZipcodeDg"]').val();
        const address1 = $('input[id="shippingToAddress1Dg"]').val();
        const address2 = $('input[id="shippingToAddress2Dg"]').val();
        const tel = $('input[id="shippingToTelDg"]').val();

        // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        manualShippingToSelection = {
          companyName: companyName,
          personName: personName,
          zipcode: zipcode,
          address: address1 + address2,
          address1: address1,
          address2: address2,
          tel: tel,
          source: 'manual_registration'
        };
        console.log('æ‰‹å‹•ç™»éŒ²ã—ãŸç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜:', manualShippingToSelection);

        if (companyName) {
            $('input[id="shippingToName"]').val(companyName + "ã€€" + personName);
        }
        else {
            $('input[id="shippingToName"]').val(personName);
        }
        $('input[id="shippingToZipcode"]').val(zipcode);
        $('input[id="shippingToAddress"]').val(address1 + address2);
        $('input[id="shippingToTel"]').val(tel);

        // AIãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
        updateManualSelectionDisplay();

        $(".shippingTo_dg").dialog("close");
    }
    $(function () {
        $(".customerSearchBtn_open").on("click", function () {
            $(".customerSearch_dg").dialog({
                title: "é¡§å®¢æ¤œç´¢",
                width: "400",
                height: "500",
                modal: true,
                buttons: {
                    "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function () {
                        $(this).dialog("close");
                    },
                    "æ¤œç´¢": function () {
                        customerSearch();
                    },
                },
            });
        });
    });
    function customerSearch() {
        if (!$('input[id="customerSearchKeyDg"]').val()) {
            showWarningToast('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        $("#resCustArea").html('<div class="inline-spinner"><div class="mini-spinner"></div><span>æ¤œç´¢ä¸­...</span></div>');
        var record = {};
        record['customerSearchBunruiDg'] = $('select[id="customerSearchBunruiDg"]').val();
        record['customerSearchClassDg'] = $('select[id="customerSearchClassDg"]').val();
        record['customerSearchKeyDg'] = $('input[id="customerSearchKeyDg"]').val();
        google.script.run.withSuccessHandler(dataSearchSuccess).withFailureHandler(dataAddFail).customerSearch(JSON.stringify(record));
    }

    function dataSearchSuccess(datas) {
        var res = JSON.parse(datas);
        if (res && res.length > 0) {
            var html = "<table>";
            html += "<tr><th></th><th>ä¼šç¤¾å</th><th>æ°å</th></tr>";
            for (let i = 0; i < res.length; i++) {
                var datVal = res[i]["ä¼šç¤¾å"] + "|" + res[i]["æ°å"] + "|" + res[i]["éƒµä¾¿ç•ªå·"] + "|" + res[i]["ä½æ‰€ï¼‘"] + res[i]["ä½æ‰€ï¼’"] + "|" + res[i]["TEL"];
                html += "<tr>";
                html += "<td><button type='button' id='nameCust" + i + "' data-val='" + datVal + "' onclick='applyName(" + i + ")'>é¸æŠ</button></td>";
                html += "<td><input style='width:120px;' type='text' id='cust" + i + "' value='" + res[i]["ä¼šç¤¾å"] + "'readonly ></td>";
                html += "<td><input style='width:120px;' type='text' id='ident" + i + "'value='" + res[i]["æ°å"] + "' readonly></td>";
                html += "</tr>";
            }
            html += "</table>";
            $("#resCustArea").html(html);
        }
        else {
            showInfoToast('è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            $("#resCustArea").html('');
        }
    }
    function applyName(num) {
        var nameVal = 'nameCust' + num;
        var dataVal = $('button[id="' + nameVal + '"]').data('val');
        var dataSp = dataVal.split('|');
        $(".customerSearch_dg").dialog("close");

        const companyName = dataSp[0];
        const personName = dataSp[1];
        const zipcode = dataSp[2];
        const address = dataSp[3];
        const tel = dataSp[4];

        // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        manualCustomerSelection = {
          companyName: companyName,
          personName: personName,
          displayName: companyName || personName,
          zipcode: zipcode,
          address: address,
          tel: tel,
          source: 'manual_search'
        };
        console.log('æ¤œç´¢ã‹ã‚‰é¸æŠã—ãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜:', manualCustomerSelection);

        if (companyName) {
            $('input[id="customerName"]').val(companyName + "ã€€" + personName);
        }
        else {
            $('input[id="customerName"]').val(personName);
        }
        $('input[id="customerZipcode"]').val(zipcode);
        $('input[id="customerAddress"]').val(address);
        $('input[id="customerTel"]').val(tel);

        // AIãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
        updateManualSelectionDisplay();
    }
    $(function () {
        $(".shippingToSearchBtn_open").on("click", function () {
            $(".shippingToSearch_dg").dialog({
                title: "ç™ºé€å…ˆæ¤œç´¢",
                width: "400",
                height: "500",
                modal: true,
                buttons: {
                    "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function () {
                        $(this).dialog("close");
                    },
                    "æ¤œç´¢": function () {
                        shippingToSearch();
                    },
                },
            });
        });
    });
    function shippingToSearch() {
        if (!$('input[id="shippingToSearchKeyDg"]').val()) {
            showWarningToast('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        $("#resShippingToArea").html('<div class="inline-spinner"><div class="mini-spinner"></div><span>æ¤œç´¢ä¸­...</span></div>');
        var record = {};
        record['shippingToSearchBunruiDg'] = $('select[id="shippingToSearchBunruiDg"]').val();
        record['shippingToSearchKeyDg'] = $('input[id="shippingToSearchKeyDg"]').val();
        google.script.run.withSuccessHandler(dataShippingToSearchSuccess).withFailureHandler(dataAddFail).shippingToSearch(JSON.stringify(record));
    }

    function dataShippingToSearchSuccess(datas) {
        var res = JSON.parse(datas);
        if (res && res.length > 0) {
            var html = "<table>";
            html += "<tr><th></th><th>ä¼šç¤¾å</th><th>æ°å</th></tr>";
            for (let i = 0; i < res.length; i++) {
                var datVal = res[i]["ä¼šç¤¾å"] + "|" + res[i]["æ°å"] + "|" + res[i]["éƒµä¾¿ç•ªå·"] + "|" + res[i]["ä½æ‰€ï¼‘"] + res[i]["ä½æ‰€ï¼’"] + "|" + res[i]["TEL"];
                html += "<tr>";
                html += "<td><button type='button' id='nameShipTo" + i + "' data-val='" + datVal + "' onclick='applyShippingToName(" + i + ")'>é¸æŠ</button></td>";
                html += "<td><input style='width:120px;' type='text' id='custShipTo" + i + "' value='" + res[i]["ä¼šç¤¾å"] + "'readonly ></td>";
                html += "<td><input style='width:120px;' type='text' id='identShipTo" + i + "'value='" + res[i]["æ°å"] + "' readonly></td>";
                html += "</tr>";
            }
            html += "</table>";
            $("#resShippingToArea").html(html);
        }
        else {
            showInfoToast('è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            $("#resShippingToArea").html('');
        }
    }
    function applyShippingToName(num) {
        var nameVal = 'nameShipTo' + num;
        var dataVal = $('button[id="' + nameVal + '"]').data('val');
        var dataSp = dataVal.split('|');
        $(".shippingToSearch_dg").dialog("close");

        const companyName = dataSp[0];
        const personName = dataSp[1];
        const zipcode = dataSp[2];
        const address = dataSp[3];
        const tel = dataSp[4];

        // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        manualShippingToSelection = {
          companyName: companyName,
          personName: personName,
          zipcode: zipcode,
          address: address,
          tel: tel,
          source: 'manual_search'
        };
        console.log('æ¤œç´¢ã‹ã‚‰é¸æŠã—ãŸç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜:', manualShippingToSelection);

        if (companyName) {
            $('input[id="shippingToName"]').val(companyName + "ã€€" + personName);
        }
        else {
            $('input[id="shippingToName"]').val(personName);
        }
        $('input[id="shippingToZipcode"]').val(zipcode);
        $('input[id="shippingToAddress"]').val(address);
        $('input[id="shippingToTel"]').val(tel);

        // AIãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
        updateManualSelectionDisplay();
    }
    function setProductSearch() {
        if (!$('input[id="shippingToName"]').val()) {
            showWarningToast('ç™ºé€å…ˆåãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        $("button[id='productSearch']").html('<span class="btn-spinner"></span> æ¤œç´¢ä¸­...');
        var shippingToName = $('input[id="shippingToName"]').val();
        google.script.run.withSuccessHandler(setDataList).withFailureHandler(dataAddFail).getLastData(shippingToName);

    }
    function setQuotationSearch() {
        if (!$('input[id="customerName"]').val()) {
            showWarningToast('é¡§å®¢åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
        }
        $("button[id='quotationSearch']").html('<span class="btn-spinner"></span> æ¤œç´¢ä¸­...');
        var customerName = $('input[id="customerName"]').val();
        google.script.run.withSuccessHandler(setQuotationDataList).withFailureHandler(dataAddFail).getQuotationData(customerName);

    }

    function setDataList(datas) {
        var res = JSON.parse(datas);
        if (res.length == 0) {
            showInfoToast('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
        else {
            $('input[id="shippingToName"]').val(res[0]['ç™ºé€å…ˆå']);
            $('input[id="shippingToZipcode"]').val(res[0]['ç™ºé€å…ˆéƒµä¾¿ç•ªå·']);
            $('input[id="shippingToAddress"]').val(res[0]['ç™ºé€å…ˆä½æ‰€']);
            $('input[id="shippingToTel"]').val(res[0]['ç™ºé€å…ˆé›»è©±ç•ªå·']);
            $('input[id="shippingFromName"]').val(res[0]['ç™ºé€å…ƒå']);
            $('input[id="customerName"]').val(res[0]['é¡§å®¢å']);
            $('input[id="customerZipcode"]').val(res[0]['é¡§å®¢éƒµä¾¿ç•ªå·']);
            $('input[id="customerAddress"]').val(res[0]['é¡§å®¢ä½æ‰€']);
            $('input[id="customerTel"]').val(res[0]['é¡§å®¢é›»è©±ç•ªå·']);
            $('input[id="shippingFromName"]').val(res[0]['ç™ºé€å…ƒå']);
            $('input[id="shippingFromZipcode"]').val(res[0]['ç™ºé€å…ƒéƒµä¾¿ç•ªå·']);
            $('input[id="shippingFromAddress"]').val(res[0]['ç™ºé€å…ƒä½æ‰€']);
            $('input[id="shippingFromTel"]').val(res[0]['ç™ºé€å…ƒé›»è©±ç•ªå·']);
            $('select[id="deliveryMethod"]').val(res[0]['ç´å“æ–¹æ³•']);
            deliveryMethodChange();
            $('select[id="deliveryTime"]').val(res[0]['é…é”æ™‚é–“å¸¯']);
            if (res[0]['ç´å“æ›¸'] == 'â—‹') {
                $('input[id="deliveryChk"]').prop('checked', true);
            }
            if (res[0]['è«‹æ±‚æ›¸'] == 'â—‹') {
                $('input[id="billChk"]').prop('checked', true);
            }
            if (res[0]['é ˜åæ›¸'] == 'â—‹') {
                $('input[id="receiptChk"]').prop('checked', true);
            }
            if (res[0]['ãƒ‘ãƒ³ãƒ•'] == 'â—‹') {
                $('input[id="pamphletChk"]').prop('checked', true);
            }
            if (res[0]['ãƒ¬ã‚·ãƒ”'] == 'â—‹') {
                $('input[id="recipeChk"]').prop('checked', true);
            }
            $('input[id="otherAttach"]').val(res[0]['ãã®ä»–æ·»ä»˜']);
            $('select[id="invoiceType"]').val(res[0]['é€ã‚ŠçŠ¶ç¨®åˆ¥']);
            $('select[id="coolCls"]').val(res[0]['ã‚¯ãƒ¼ãƒ«åŒºåˆ†']);
            $('select[id="cargo1"]').val(res[0]['è·æ‰±ã„ï¼‘']);
            $('select[id="cargo2"]').val(res[0]['è·æ‰±ã„ï¼’']);
            $('input[id="cashOnDelivery"]').val(res[0]['ä»£å¼•ç·é¡']);
            $('input[id="cashOnDeliTax"]').val(res[0]['ä»£å¼•å†…ç¨']);
            $('input[id="copiePrint"]').val(res[0]['ç™ºè¡Œæšæ•°']);
            $('textarea[id="csvmemo"]').val(res[0]['é€ã‚ŠçŠ¶å‚™è€ƒæ¬„'] || '');
            $('textarea[id="deliveryMemo"]').val(res[0]['ç´å“æ›¸å‚™è€ƒæ¬„'] || '');
            $('textarea[id="memo"]').val(res[0]['ãƒ¡ãƒ¢'] || '');
            for (let i = 0; i < 10; i++) {
                var num = (i + 1);
                var bunrui = 'bunrui' + num;
                var product = 'product' + num;
                var quantity = 'quantity' + num;
                var price = 'price' + num;
                if (res.length > i) {
                    var spData = res[i];
                    $('select[id="' + bunrui + '"]').val(spData['å•†å“åˆ†é¡']);
                    bunruiChange(num);
                    $('select[id="' + product + '"]').val(spData['å•†å“å']);
                    productChange(num);
                    $('select[id="' + quantity + '"]').val(spData['å—æ³¨æ•°']);
                    $('input[id="' + price + '"]').val(spData['è²©å£²ä¾¡æ ¼']);
                }
                else {
                    $('select[id="' + bunrui + '"]').val('');
                    bunruiChange(num);
                    $('select[id="' + product + '"]').val('');
                    productChange(num);
                    $('select[id="' + quantity + '"]').val('');
                    $('input[id="' + price + '"]').val('');
                }
            }
            showSuccessToast('å‰å›ã®å•†å“æƒ…å ±ã‚’åæ˜ ã—ã¾ã—ãŸã€‚');
        }
        $("button[id='productSearch']").text('å‰å›å•†å“åæ˜ ');
    }
    function setQuotationDataList(datas) {
        var res = JSON.parse(datas);
        for (let i = 0; i < 10; i++) {
            var num = (i + 1);
            var bunrui = 'bunrui' + num;
            var product = 'product' + num;
            var quantity = 'quantity' + num;
            var price = 'price' + num;
            if (res.length > i) {
                var spData = res[i];
                $('select[id="' + bunrui + '"]').val(spData['å•†å“åˆ†é¡']);
                bunruiChange(num);
                $('select[id="' + product + '"]').val(spData['å•†å“å']);
                productChange(num);
                $('input[id="' + price + '"]').val(spData['å˜ä¾¡ï¼ˆå¤–ç¨ï¼‰']);
            }
            else {
                $('select[id="' + bunrui + '"]').val('');
                bunruiChange(num);
                $('select[id="' + product + '"]').val('');
                productChange(num);
                $('select[id="' + quantity + '"]').val('');
                $('input[id="' + price + '"]').val('');
            }
        }
        if (res.length == 0) {
            showInfoToast('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
        else {
            showSuccessToast('è¦‹ç©æ›¸æƒ…å ±ã‚’åæ˜ ã—ã¾ã—ãŸã€‚');
        }
        $("button[id='quotationSearch']").text('è¦‹ç©æ›¸åæ˜ ');
    }
    // AIè§£æ
    // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
    let aiAnalysisResult = null;
    let useShippingToMaster = false;
    let useCustomerMaster = false;
    let selectedFile = null;
    let selectedFileBase64 = null;
    let currentTab = 'text';
    let productMaster = {};
    let categoryList = [];
    let productPrices = {};
    let itemEdits = {};

    // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿
    let manualCustomerSelection = null;
    let manualShippingToSelection = null;

    const AI_SESSION_KEY = 'aiSessionData';
    const AI_EXCLUDE_CATEGORIES = ['é€æ–™', 'æ‰‹æ•°æ–™', 'è¿½åŠ æ–™é‡‘'];
    const AI_EXCLUDE_PRODUCTS = ['é€æ–™', 'ã‚¯ãƒ¼ãƒ«ä¾¿è¿½åŠ ', 'ä»£å¼•æ‰‹æ•°æ–™', 'æ¢±åŒ…æ–™'];

    /**
     * æ‰‹å‹•é¸æŠå¾Œã«AIãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
     */
    function updateManualSelectionDisplay() {
      if (!aiAnalysisResult) return;

      // é¡§å®¢ã¨ç™ºé€å…ˆã®è¡¨ç¤ºã‚’æ›´æ–°
      if (aiAnalysisResult.customer) {
        displayCustomer(aiAnalysisResult.customer);
      }
      if (aiAnalysisResult.shippingTo) {
        displayShippingTo(aiAnalysisResult.shippingTo);
      }
    }

    /**
     * éƒµä¾¿ç•ªå·ã®ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»
     */
    function sanitizeZipcode(zip) {
      if (!zip) return '';
      return String(zip).replace(/[-ãƒ¼âˆ’â€]/g, '');
    }

    /**
     * é›»è©±ç•ªå·ãƒ»FAXç•ªå·ã®ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»
     */
    function sanitizeTel(tel) {
      if (!tel) return '';
      return String(tel).replace(/[-ãƒ¼âˆ’â€]/g, '');
    }

    /**
     * ä½æ‰€æ–‡å­—åˆ—ã‚’éƒ½é“åºœçœŒï¼‹å¸‚åŒºç”ºæ‘(ä½æ‰€1)ã¨ç•ªåœ°ä»¥é™(ä½æ‰€2)ã«åˆ†å‰²
     */
    function splitAddressString(fullAddress) {
      if (!fullAddress) {
        return { address1: '', address2: '' };
      }

      const addr = String(fullAddress).trim();

      // å¸‚åŒºç”ºæ‘ã®åŒºåˆ‡ã‚Šãƒ‘ã‚¿ãƒ¼ãƒ³
      const patterns = [
        /(.*?[éƒ½é“åºœçœŒ].*?[å¸‚åŒºç”ºæ‘éƒ¡])/,  // éƒ½é“åºœçœŒ + å¸‚åŒºç”ºæ‘
        /(.*?[å¸‚åŒºç”ºæ‘])/,                  // å¸‚åŒºç”ºæ‘ã®ã¿
        /(.*?éƒ¡.*?[ç”ºæ‘])/                  // éƒ¡ + ç”ºæ‘
      ];

      for (const pattern of patterns) {
        const match = addr.match(pattern);
        if (match) {
          const address1 = match[1];
          const address2 = addr.substring(address1.length).trim();
          return { address1, address2 };
        }
      }

      // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã—ãªã„å ´åˆã¯ä¸­é–“ã§åˆ†å‰²
      const halfIndex = Math.floor(addr.length / 2);
      return {
        address1: addr.substring(0, halfIndex),
        address2: addr.substring(halfIndex)
      };
    }

    document.addEventListener('DOMContentLoaded', function() {
      loadAISessionData();
      setupFileDragDrop();

      // AIå–è¾¼ä¸€è¦§ã‹ã‚‰é·ç§»ã—ãŸå ´åˆã€è‡ªå‹•ã§AIãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      var shouldAutoOpen = <?= typeof autoOpenAI !== 'undefined' ? autoOpenAI : false ?>;
      var preloadedAnalysis = <?= typeof aiAnalysisResult !== 'undefined' ? aiAnalysisResult : '""' ?>;

      if (shouldAutoOpen && preloadedAnalysis && preloadedAnalysis !== '""') {
        setTimeout(function() {
          try {
            var analysisData = typeof preloadedAnalysis === 'string' ? JSON.parse(preloadedAnalysis) : preloadedAnalysis;
            openAIModalWithResult(analysisData);
          } catch (e) {
            console.error('AIè§£æçµæœã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
          }
        }, 500);
      }
    });
    
    function toggleAIAssistant() {
      const body = document.getElementById('aiAssistantBody');
      const btn = document.getElementById('aiToggleBtn');
      body.classList.toggle('open');
      btn.textContent = body.classList.contains('open') ? 'é–‰ã˜ã‚‹' : 'é–‹ã';
      if (body.classList.contains('open') && categoryList.length === 0) {
        loadProductMaster();
      }
    }

    /**
     * AIå–è¾¼ä¸€è¦§ã‹ã‚‰é·ç§»ã—ãŸå ´åˆã«è‡ªå‹•ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ã¦è§£æçµæœã‚’è¡¨ç¤º
     */
    function openAIModalWithResult(analysisData) {
      // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’é–‹ã
      const body = document.getElementById('aiAssistantBody');
      const btn = document.getElementById('aiToggleBtn');
      if (!body.classList.contains('open')) {
        body.classList.add('open');
        btn.textContent = 'é–‰ã˜ã‚‹';
      }

      // å•†å“ãƒã‚¹ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
      if (categoryList.length === 0) {
        loadProductMaster();
      }

      // é¡§å®¢ãƒ»ç™ºé€å…ˆãƒã‚¹ã‚¿ã¨ç…§åˆã—ã¦è§£æçµæœã‚’å¼·åŒ–
      google.script.run
        .withSuccessHandler(function(enhancedResultJson) {
          try {
            const enhancedData = JSON.parse(enhancedResultJson);

            // è§£æçµæœã‚’è¨­å®š
            aiAnalysisResult = enhancedData;

            // è§£ææ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
            showAIAnalyzedIndicator(new Date().toISOString());

            // è§£æçµæœã‚’è¡¨ç¤ºï¼ˆå†…éƒ¨ã§setupNewRegistrationButtons()ãŒå‘¼ã°ã‚Œã‚‹ï¼‰
            displayAnalysisResult(enhancedData);

            console.log('AIå–è¾¼ä¸€è¦§ã‹ã‚‰ã®è§£æçµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆãƒã‚¹ã‚¿ç…§åˆæ¸ˆã¿ï¼‰');
          } catch (e) {
            console.error('å¼·åŒ–ã•ã‚ŒãŸè§£æçµæœã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…ƒã®ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤º
            aiAnalysisResult = analysisData;
            displayAnalysisResult(analysisData);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ãƒã‚¹ã‚¿ç…§åˆã‚¨ãƒ©ãƒ¼:', error);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…ƒã®ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤º
          aiAnalysisResult = analysisData;
          showAIAnalyzedIndicator(new Date().toISOString());
          displayAnalysisResult(analysisData);
        })
        .enhanceAnalysisResultFromTempOrder(JSON.stringify(analysisData));
    }

    /**
     * æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
     * æ–°è¦ã¾ãŸã¯éƒ¨åˆ†ä¸€è‡´ã®å ´åˆã«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
     */
    function setupNewRegistrationButtons(analysisData) {
      // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
      const existingCustomerBtns = document.getElementById('customerActionButtons');
      if (existingCustomerBtns) existingCustomerBtns.remove();

      const existingShippingBtns = document.getElementById('shippingToActionButtons');
      if (existingShippingBtns) existingShippingBtns.remove();

      // é¡§å®¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆæ–°è¦ã¾ãŸã¯éƒ¨åˆ†ä¸€è‡´ã®å ´åˆï¼‰
      if (analysisData.customer) {
        const isNew = analysisData.customer.isNewCustomer;
        const isPartial = analysisData.customer.masterMatch === 'partial';

        if (isNew || isPartial) {
          const customerSection = document.querySelector('#aiResultCustomerRaw').parentElement;
          const btnContainer = document.createElement('div');
          btnContainer.id = 'customerActionButtons';
          btnContainer.className = 'mt-2';
          btnContainer.style.display = 'flex';
          btnContainer.style.gap = '8px';

          // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³
          const newBtn = document.createElement('button');
          newBtn.type = 'button';
          newBtn.className = 'btn btn-sm btn-primary';
          newBtn.textContent = 'ğŸ“ æ–°è¦ç™»éŒ²';
          newBtn.onclick = function() { openNewCustomerFormWithAI(analysisData.customer); };
          btnContainer.appendChild(newBtn);

          // æ¤œç´¢ãƒœã‚¿ãƒ³
          const searchBtn = document.createElement('button');
          searchBtn.type = 'button';
          searchBtn.className = 'btn btn-sm btn-primary';
          searchBtn.textContent = 'ğŸ” é¡§å®¢ã‚’æ¤œç´¢';
          searchBtn.onclick = function() { $('.customerSearchBtn_open').click(); };
          btnContainer.appendChild(searchBtn);

          customerSection.appendChild(btnContainer);
        }
      }

      // ç™ºé€å…ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆæ–°è¦ã¾ãŸã¯éƒ¨åˆ†ä¸€è‡´ã®å ´åˆï¼‰
      if (analysisData.shippingTo) {
        const isNew = analysisData.shippingTo.isNewShippingTo;
        const isPartial = analysisData.shippingTo.masterMatch === 'partial';

        if (isNew || isPartial) {
          const shippingSection = document.querySelector('#aiResultShippingToRaw').parentElement;
          const btnContainer = document.createElement('div');
          btnContainer.id = 'shippingToActionButtons';
          btnContainer.className = 'mt-2';
          btnContainer.style.display = 'flex';
          btnContainer.style.gap = '8px';

          // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³
          const newBtn = document.createElement('button');
          newBtn.type = 'button';
          newBtn.className = 'btn btn-sm btn-primary';
          newBtn.textContent = 'ğŸ“ æ–°è¦ç™»éŒ²';
          newBtn.onclick = function() { openNewShippingToFormWithAI(analysisData.shippingTo); };
          btnContainer.appendChild(newBtn);

          // æ¤œç´¢ãƒœã‚¿ãƒ³
          const searchBtn = document.createElement('button');
          searchBtn.type = 'button';
          searchBtn.className = 'btn btn-sm btn-primary';
          searchBtn.textContent = 'ğŸ” ç™ºé€å…ˆã‚’æ¤œç´¢';
          searchBtn.onclick = function() { $('.shippingToSearchBtn_open').click(); };
          btnContainer.appendChild(searchBtn);

          shippingSection.appendChild(btnContainer);
        }
      }
    }

    /**
     * é¡§å®¢æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦AIè§£æå€¤ã‚’åæ˜ 
     */
    function openNewCustomerFormWithAI(customerData) {
      console.log('é¡§å®¢ãƒ‡ãƒ¼ã‚¿:', customerData);

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      clearCustomerForm();

      // AIè§£æå€¤ã‚’åæ˜ ï¼ˆrawXXX or XXX ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¯¾å¿œï¼‰
      const companyName = customerData.rawCompanyName || customerData.companyName || '';
      const personName = customerData.rawPersonName || customerData.personName || '';
      const zipcode = customerData.rawZipcode || customerData.zipcode || '';
      const address = customerData.rawAddress || customerData.address || '';
      const tel = customerData.rawTel || customerData.tel || '';
      const fax = customerData.rawFax || customerData.fax || '';

      if (companyName) {
        document.getElementById('customerNameDg').value = companyName;
        document.getElementById('customerShowNameDg').value = companyName;
      }
      if (personName) {
        document.getElementById('customerIdentDg').value = personName;
      }
      if (zipcode) {
        // ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»ã—ã¦åæ˜ 
        document.getElementById('customerZipcodeDg').value = sanitizeZipcode(zipcode);
      }
      if (address) {
        // ä½æ‰€ã‚’éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ã§åˆ†å‰²
        const splitAddress = splitAddressString(address);
        document.getElementById('customerAddress1Dg').value = splitAddress.address1;
        document.getElementById('customerAddress2Dg').value = splitAddress.address2;
      }
      if (tel) {
        // ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»ã—ã¦åæ˜ 
        document.getElementById('customerTelDg').value = sanitizeTel(tel);
      }
      if (fax) {
        // ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»ã—ã¦åæ˜ 
        document.getElementById('customerFaxDg').value = sanitizeTel(fax);
      }

      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’åˆæœŸåŒ–ã—ã¦é–‹ã
      const dialog = $('.customer_dg');
      if (!dialog.hasClass('ui-dialog-content')) {
        // åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–
        dialog.dialog({
          title: "é¡§å®¢æ–°è¦ç™»éŒ²",
          height: 500,
          modal: true,
          buttons: {
            "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function() { $(this).dialog("close"); },
            "ç™»éŒ²": function() { addCustomer(); }
          }
        });
      }
      dialog.dialog('open');
    }

    /**
     * ç™ºé€å…ˆæ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã„ã¦AIè§£æå€¤ã‚’åæ˜ 
     */
    function openNewShippingToFormWithAI(shippingToData) {
      console.log('ç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿:', shippingToData);

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      clearShippingToForm();

      // AIè§£æå€¤ã‚’åæ˜ ï¼ˆrawXXX or XXX ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¯¾å¿œï¼‰
      const companyName = shippingToData.rawCompanyName || shippingToData.companyName || '';
      const personName = shippingToData.rawPersonName || shippingToData.personName || '';
      const zipcode = shippingToData.rawZipcode || shippingToData.zipcode || '';
      const address = shippingToData.rawAddress || shippingToData.address || '';
      const tel = shippingToData.rawTel || shippingToData.tel || '';

      if (companyName) {
        document.getElementById('shippingToNameDg').value = companyName;
      }
      if (personName) {
        document.getElementById('shippingToIdentDg').value = personName;
      }
      if (zipcode) {
        // ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»ã—ã¦åæ˜ 
        document.getElementById('shippingToZipcodeDg').value = sanitizeZipcode(zipcode);
      }
      if (address) {
        // ä½æ‰€ã‚’éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ã§åˆ†å‰²
        const splitAddress = splitAddressString(address);
        document.getElementById('shippingToAddress1Dg').value = splitAddress.address1;
        document.getElementById('shippingToAddress2Dg').value = splitAddress.address2;
      }
      if (tel) {
        // ãƒã‚¤ãƒ•ãƒ³ã‚’é™¤å»ã—ã¦åæ˜ 
        document.getElementById('shippingToTelDg').value = sanitizeTel(tel);
      }

      // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’åˆæœŸåŒ–ã—ã¦é–‹ã
      const dialog = $('.shippingTo_dg');
      if (!dialog.hasClass('ui-dialog-content')) {
        // åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–
        dialog.dialog({
          title: "ç™ºé€å…ˆæ–°è¦ç™»éŒ²",
          height: 500,
          modal: true,
          buttons: {
            "ã‚­ãƒ£ãƒ³ã‚»ãƒ«": function() { $(this).dialog("close"); },
            "ç™»éŒ²": function() { addShippingTo(); }
          }
        });
      }
      dialog.dialog('open');
    }

    /**
     * é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
     */
    function clearCustomerForm() {
      document.getElementById('customerNameDg').value = '';
      document.getElementById('customerShowNameDg').value = '';
      document.getElementById('customerFuriganaDg').value = '';
      document.getElementById('customerDepDg').value = '';
      document.getElementById('customerPostDg').value = '';
      document.getElementById('customerIdentDg').value = '';
      document.getElementById('customerZipcodeDg').value = '';
      document.getElementById('customerAddress1Dg').value = '';
      document.getElementById('customerAddress2Dg').value = '';
      document.getElementById('customerTelDg').value = '';
      document.getElementById('customerPhoneDg').value = '';
      document.getElementById('customerFaxDg').value = '';
      document.getElementById('customerMailDg').value = '';
      document.getElementById('customerMemoDg').value = '';
    }

    /**
     * ç™ºé€å…ˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
     */
    function clearShippingToForm() {
      document.getElementById('shippingToNameDg').value = '';
      document.getElementById('shippingToDepDg').value = '';
      document.getElementById('shippingToIdentDg').value = '';
      document.getElementById('shippingToZipcodeDg').value = '';
      document.getElementById('shippingToAddress1Dg').value = '';
      document.getElementById('shippingToAddress2Dg').value = '';
      document.getElementById('shippingToTelDg').value = '';
      document.getElementById('shippingToMailDg').value = '';
      document.getElementById('shippingToMemoDg').value = '';
    }

    function loadProductMaster() {
      google.script.run
        .withSuccessHandler(function(data) {
          productMaster = data.productsByCategory || {};
          productPrices = data.productPrices || {};
          categoryList = Object.keys(productMaster);
        })
        .withFailureHandler(function(error) {
          console.error('å•†å“ãƒã‚¹ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getProductMasterForUI();
    }
    
    function loadAISessionData() {
      const saved = sessionStorage.getItem(AI_SESSION_KEY);
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        const diffMinutes = (new Date() - new Date(data.analyzedAt)) / 1000 / 60;
        if (diffMinutes > 30) {
          sessionStorage.removeItem(AI_SESSION_KEY);
          return;
        }
        showAIAnalyzedIndicator(data.analyzedAt);
      } catch (e) {
        sessionStorage.removeItem(AI_SESSION_KEY);
      }
    }
    
    function saveAISessionData() {
      if (!aiAnalysisResult) return;
      const sessionData = {
        analyzedAt: new Date().toISOString(),
        analysisResult: aiAnalysisResult,
        items: [],
        totalAmount: 0
      };
      Object.keys(itemEdits).forEach(index => {
        const edit = itemEdits[index];
        if (edit.productName) {
          const amount = (edit.price || 0) * (edit.quantity || 0);
          if (!AI_EXCLUDE_CATEGORIES.includes(edit.category) && !AI_EXCLUDE_PRODUCTS.includes(edit.productName)) {
            sessionData.totalAmount += amount;
          }
          sessionData.items.push({
            originalText: edit.originalText,
            productName: edit.productName,
            category: edit.category,
            price: edit.price,
            quantity: edit.quantity
          });
        }
      });
      sessionStorage.setItem(AI_SESSION_KEY, JSON.stringify(sessionData));
    }
    
    function showAIAnalyzedIndicator(analyzedAt) {
      const indicator = document.getElementById('aiAnalyzedIndicator');
      const timeEl = document.getElementById('aiAnalyzedTime');
      if (indicator && analyzedAt) {
        const time = new Date(analyzedAt);
        timeEl.textContent = 'ï¼ˆ' + time.getHours() + ':' + String(time.getMinutes()).padStart(2,'0') + ' è§£æï¼‰';
        indicator.classList.add('show');
      }
    }
    
    function clearAISession() {
      sessionStorage.removeItem(AI_SESSION_KEY);
    }
    
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.ai-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.ai-tab-content').forEach(content => content.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }
    
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = function(e) {
        selectedFileBase64 = e.target.result.split(',')[1];
        showFilePreview(file);
      };
      reader.readAsDataURL(file);
    }
    
    function showFilePreview(file) {
      const preview = document.getElementById('filePreview');
      const icon = file.type.includes('pdf') ? 'ğŸ“„' : 'ğŸ–¼ï¸';
      const size = (file.size / 1024).toFixed(1) + ' KB';
      preview.innerHTML = '<div class="file-preview"><span class="file-icon">' + icon + '</span><div class="file-info"><div class="file-name">' + file.name + '</div><div class="file-size">' + size + '</div></div><button type="button" class="remove-btn" onclick="removeFile()">Ã—</button></div>';
    }
    
    function removeFile() {
      selectedFile = null;
      selectedFileBase64 = null;
      document.getElementById('orderFile').value = '';
      document.getElementById('filePreview').innerHTML = '';
    }
    
    function setupFileDragDrop() {
      const uploadArea = document.getElementById('fileUploadArea');
      if (!uploadArea) return;
      uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
      uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
          document.getElementById('orderFile').files = e.dataTransfer.files;
          handleFileSelect({ target: { files: [file] } });
        }
      });
    }
    
    function analyzeWithAI() {
      const btn = document.getElementById('aiAnalyzeBtn');
      btn.classList.add('loading');
      btn.disabled = true;
      if (currentTab === 'text') {
        const text = document.getElementById('aiInputText').value.trim();
        if (!text) { showWarningToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); btn.classList.remove('loading'); btn.disabled = false; return; }
        google.script.run.withSuccessHandler(handleAnalysisSuccess).withFailureHandler(handleAnalysisError).analyzeOrderText(text);
      } else {
        if (!selectedFile || !selectedFileBase64) { showWarningToast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); btn.classList.remove('loading'); btn.disabled = false; return; }
        google.script.run.withSuccessHandler(handleAnalysisSuccess).withFailureHandler(handleAnalysisError).analyzeOrderFileBase64(selectedFileBase64, selectedFile.type, selectedFile.name);
      }
    }
    
    function handleAnalysisSuccess(result) {
      const btn = document.getElementById('aiAnalyzeBtn');
      btn.classList.remove('loading');
      btn.disabled = false;
      try {
        aiAnalysisResult = JSON.parse(result);
        if (!aiAnalysisResult.success) { showError(aiAnalysisResult.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
        displayAnalysisResult(aiAnalysisResult);
      } catch (e) {
        showError('è§£æçµæœã®å‡¦ç†ã«å¤±æ•—: ' + e.message);
      }
    }
    
    function handleAnalysisError(error) {
      const btn = document.getElementById('aiAnalyzeBtn');
      btn.classList.remove('loading');
      btn.disabled = false;
      showError('è§£æã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
    
    function displayAnalysisResult(result) {
      document.getElementById('aiResultArea').classList.add('show');
      itemEdits = {};
      setConfidenceBadge('overallConfidence', result.overallConfidence);
      displayAlerts(result.alerts || []);
      document.getElementById('aiResultShippingDate').textContent = result.shippingDate || 'æŒ‡å®šãªã—';
      document.getElementById('aiResultDeliveryDate').textContent = result.deliveryDate || 'æŒ‡å®šãªã—';
      document.getElementById('aiResultDeliveryTime').textContent = result.deliveryTime || 'æŒ‡å®šãªã—';
      displayShippingTo(result.shippingTo);
      displayCustomer(result.customer);
      displayItemsEditable(result.items, result.unknownItems);
      if (result.memo) {
        document.getElementById('memoSection').style.display = 'block';
        document.getElementById('aiResultMemo').textContent = result.memo;
      } else {
        document.getElementById('memoSection').style.display = 'none';
      }
      document.getElementById('aiError').style.display = 'none';
      updateLearnSummary();

      // æ–°è¦ç™»éŒ²ãƒ»æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’è¨­å®šï¼ˆé€šå¸¸ã®AIè§£æã§ã‚‚è¡¨ç¤ºï¼‰
      setupNewRegistrationButtons(result);
    }
    
    function displayAlerts(alerts) {
      const container = document.getElementById('aiAlerts');
      container.innerHTML = alerts.map(a => '<div class="ai-alert-item ' + (a.includes('æ–°è¦') || a.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“') ? 'ai-alert-warning' : 'ai-alert-info') + '">' + a + '</div>').join('');
    }
    
    function displayShippingTo(st) {
      if (!st) return;
      const badge = document.getElementById('shippingToMatchBadge');
      if (st.isNewShippingTo) {
        badge.innerHTML = '<span class="new-badge">æ–°è¦</span>';
      } else if (st.masterMatch === 'exact') {
        badge.innerHTML = '<span class="master-match-badge master-match-exact">âœ… ä¸€è‡´</span>';
      } else if (st.masterMatch === 'partial') {
        badge.innerHTML = '<span class="master-match-badge master-match-partial">âš ï¸ éƒ¨åˆ†ä¸€è‡´</span>';
      } else {
        badge.innerHTML = '';
      }
      document.getElementById('aiResultShippingToRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>' + (st.rawCompanyName || '-') + '</div><div class="row"><span class="label">å®›åï¼š</span>' + (st.rawPersonName || '-') + '</div><div class="row"><span class="label">ã€’ï¼š</span>' + (st.rawZipcode || '-') + '</div><div class="row"><span class="label">ä½æ‰€ï¼š</span>' + (st.rawAddress || '-') + '</div><div class="row"><span class="label">TELï¼š</span>' + (st.rawTel || '-') + '</div>';

      const masterDiv = document.getElementById('aiResultShippingToMaster');
      const manualDiv = document.getElementById('aiResultShippingToManual');
      const selectDiv = document.getElementById('shippingToSourceSelect');

      // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã«è¡¨ç¤º
      if (manualShippingToSelection) {
        manualDiv.style.display = 'block';
        const sourceType = manualShippingToSelection.source === 'manual_registration' ? 'æ–°è¦ç™»éŒ²' : 'æ¤œç´¢';
        manualDiv.innerHTML = '<strong>âœ‹ æ‰‹å‹•é¸æŠï¼ˆ' + sourceType + 'ï¼‰</strong><br>' +
          [manualShippingToSelection.companyName, manualShippingToSelection.personName].filter(Boolean).join(' ') +
          '<br>TEL: ' + (manualShippingToSelection.tel || '-') +
          '<br>ã€’' + (manualShippingToSelection.zipcode || '-') + ' ' + (manualShippingToSelection.address || '-');
      } else {
        manualDiv.style.display = 'none';
      }

      if (st.masterData) {
        masterDiv.style.display = 'block';
        masterDiv.innerHTML = '<strong>ğŸ“ ãƒã‚¹ã‚¿ï¼ˆ' + st.matchedBy + 'ï¼‰</strong><br>' + (st.masterData.companyName || '') + ' ' + (st.masterData.personName || '') + '<br>ã€’' + (st.masterData.zipcode || '') + ' ' + (st.masterData.address || '') + '<br>TEL: ' + (st.masterData.tel || '-');
        selectDiv.style.display = 'flex';

        // æ‰‹å‹•é¸æŠãŒã‚ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’3ã¤è¡¨ç¤º
        if (manualShippingToSelection) {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
          useShippingToMaster = false;
        } else {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>';
          useShippingToMaster = true;
        }
      } else if (manualShippingToSelection) {
        // ãƒã‚¹ã‚¿ãªã—ã€æ‰‹å‹•é¸æŠã‚ã‚Š
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'flex';
        selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'shippingTo\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
          '<button type="button" class="source-select-btn selected" onclick="selectSource(\'shippingTo\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
        useShippingToMaster = false;
      } else {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useShippingToMaster = false;
      }
    }
    
    function displayCustomer(cust) {
      if (!cust) return;
      const badge = document.getElementById('customerMatchBadge');
      if (cust.isNewCustomer) {
        badge.innerHTML = '<span class="new-badge">æ–°è¦</span>';
      } else if (cust.masterMatch === 'exact') {
        badge.innerHTML = '<span class="master-match-badge master-match-exact">âœ… ä¸€è‡´</span>';
      } else if (cust.masterMatch === 'partial') {
        badge.innerHTML = '<span class="master-match-badge master-match-partial">âš ï¸ éƒ¨åˆ†ä¸€è‡´</span>';
      } else {
        badge.innerHTML = '';
      }
      document.getElementById('aiResultCustomerRaw').innerHTML = '<div class="row"><span class="label">ä¼šç¤¾åï¼š</span>' + (cust.rawCompanyName || '-') + '</div><div class="row"><span class="label">æ‹…å½“ï¼š</span>' + (cust.rawPersonName || '-') + '</div><div class="row"><span class="label">TELï¼š</span>' + (cust.rawTel || '-') + '</div>';

      const masterDiv = document.getElementById('aiResultCustomerMaster');
      const manualDiv = document.getElementById('aiResultCustomerManual');
      const selectDiv = document.getElementById('customerSourceSelect');

      // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã«è¡¨ç¤º
      if (manualCustomerSelection) {
        manualDiv.style.display = 'block';
        const sourceType = manualCustomerSelection.source === 'manual_registration' ? 'æ–°è¦ç™»éŒ²' : 'æ¤œç´¢';
        manualDiv.innerHTML = '<strong>âœ‹ æ‰‹å‹•é¸æŠï¼ˆ' + sourceType + 'ï¼‰</strong><br>' +
          (manualCustomerSelection.displayName || [manualCustomerSelection.companyName, manualCustomerSelection.personName].filter(Boolean).join(' ')) +
          '<br>TEL: ' + (manualCustomerSelection.tel || '-') +
          '<br>ã€’' + (manualCustomerSelection.zipcode || '-') + ' ' + (manualCustomerSelection.address || '-');
      } else {
        manualDiv.style.display = 'none';
      }

      if (cust.masterData) {
        masterDiv.style.display = 'block';
        masterDiv.innerHTML = '<strong>ğŸ“ ãƒã‚¹ã‚¿ï¼ˆ' + cust.matchedBy + 'ï¼‰</strong><br>' + (cust.masterData.displayName || cust.masterData.companyName || '') + '<br>TEL: ' + (cust.masterData.tel || '-');
        selectDiv.style.display = 'flex';

        // æ‰‹å‹•é¸æŠãŒã‚ã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’3ã¤è¡¨ç¤º
        if (manualCustomerSelection) {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
          useCustomerMaster = false;
        } else {
          selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
            '<button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'master\')">ğŸ“ ãƒã‚¹ã‚¿</button>';
          useCustomerMaster = true;
        }
      } else if (manualCustomerSelection) {
        // ãƒã‚¹ã‚¿ãªã—ã€æ‰‹å‹•é¸æŠã‚ã‚Š
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'flex';
        selectDiv.innerHTML = '<button type="button" class="source-select-btn" onclick="selectSource(\'customer\',\'raw\')">ğŸ“ èª­ã¿å–ã‚Š</button>' +
          '<button type="button" class="source-select-btn selected" onclick="selectSource(\'customer\',\'manual\')">âœ‹ æ‰‹å‹•é¸æŠ</button>';
        useCustomerMaster = false;
      } else {
        masterDiv.style.display = 'none';
        selectDiv.style.display = 'none';
        useCustomerMaster = false;
      }
    }
    
    function displayItemsEditable(items, unknownItems) {
      const container = document.getElementById('aiResultItems');
      container.innerHTML = '';
      if (!items || items.length === 0) {
        container.innerHTML = '<p style="color:#999;">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
        return;
      }
      items.forEach((item, index) => {
        const mappingMatch = item.mappingMatch || {};
        const isLearned = mappingMatch.found && mappingMatch.matchType === 'exact';
        const canLearn = !isLearned && item.originalText;
        
        let price = 0;
        let priceSource = 'none';
        if (item.price && item.price > 0) {
          price = item.price;
          priceSource = item.priceSource || 'ai';
        } else if (item.productName && productPrices[item.productName]) {
          price = productPrices[item.productName];
          priceSource = 'master';
        }
        
        itemEdits[index] = {
          category: item.category || '',
          productName: item.productName || '',
          spec: item.spec || '',
          quantity: item.quantity || '',
          unit: item.unit || 'ã‚±ãƒ¼ã‚¹',
          price: price,
          priceSource: priceSource,
          learn: canLearn && item.confidence !== 'low',
          originalText: item.originalText || '',
          originalProductName: item.productName || ''
        };
        
        const cardClass = isLearned ? 'learned' : '';
        let categoryOptions = '<option value="">é¸æŠ...</option>';
        categoryList.forEach(cat => {
          categoryOptions += '<option value="' + cat + '" ' + (cat === item.category ? 'selected' : '') + '>' + cat + '</option>';
        });
        let productOptions = buildProductOptions(item.category, item.productName);
        
        let badgeHtml = '';
        if (isLearned) {
          badgeHtml = '<span class="mapping-badge">ğŸ“š å­¦ç¿’æ¸ˆã¿ï¼ˆ' + mappingMatch.usageCount + 'å›ä½¿ç”¨ï¼‰</span>';
        } else {
          badgeHtml = '<span class="confidence-badge confidence-' + item.confidence + '">' + getConfidenceLabel(item.confidence) + '</span>';
        }
        
        let priceBadgeHtml = '';
        if (priceSource === 'ai') {
          priceBadgeHtml = '<span class="price-badge ai">é¡§å®¢æŒ‡å®š</span>';
        } else if (priceSource === 'master') {
          priceBadgeHtml = '<span class="price-badge master">ãƒã‚¹ã‚¿</span>';
        }
        
        let learnHtml = '';
        if (canLearn) {
          const checked = itemEdits[index].learn ? 'checked' : '';
          learnHtml = '<div class="item-learn-row ' + (itemEdits[index].learn ? 'will-learn' : '') + '" id="learnRow_' + index + '"><input type="checkbox" id="learn_' + index + '" ' + checked + ' onchange="toggleLearn(' + index + ')"><label for="learn_' + index + '">ã“ã®å¯¾å¿œã‚’è¨˜æ†¶ã™ã‚‹</label><span class="learn-preview" id="learnPreview_' + index + '" style="' + (itemEdits[index].learn ? '' : 'display:none') + '">â†’ ' + (item.productName || 'æœªé¸æŠ') + '</span></div>';
        }
        
        container.innerHTML += '<div class="item-card ' + cardClass + '" id="itemCard_' + index + '"><div class="item-card-header"><span class="item-original-text">ğŸ“ ' + (item.originalText || '(åŸæ–‡ãªã—)') + '</span>' + badgeHtml + '</div><div class="item-card-body"><div class="item-edit-row"><label>åˆ†é¡:</label><select id="category_' + index + '" onchange="onCategoryChange(' + index + ')">' + categoryOptions + '</select></div><div class="item-edit-row"><label>å•†å“:</label><select id="product_' + index + '" onchange="onProductChange(' + index + ')">' + productOptions + '</select></div><div class="item-edit-row"><label>è¦æ ¼:</label><input type="text" id="spec_' + index + '" value="' + (item.spec || '') + '" onchange="onSpecChange(' + index + ')"></div><div class="item-edit-row"><label>ä¾¡æ ¼:</label><div class="price-group"><input type="number" id="price_' + index + '" value="' + price + '" onchange="onPriceChange(' + index + ')"><span class="unit">å††</span>' + priceBadgeHtml + '</div></div><div class="item-edit-row"><label>æ•°é‡:</label><div class="quantity-group"><input type="number" id="quantity_' + index + '" value="' + (item.quantity || '') + '" step="0.1" onchange="onQuantityChange(' + index + ')"><select id="unit_' + index + '" onchange="onUnitChange(' + index + ')"><option value="ã‚±ãƒ¼ã‚¹" ' + (item.unit === 'ã‚±ãƒ¼ã‚¹' ? 'selected' : '') + '>ã‚±ãƒ¼ã‚¹</option><option value="æœ¬" ' + (item.unit === 'æœ¬' ? 'selected' : '') + '>æœ¬</option><option value="è¢‹" ' + (item.unit === 'è¢‹' ? 'selected' : '') + '>è¢‹</option><option value="kg" ' + (item.unit === 'kg' ? 'selected' : '') + '>kg</option><option value="å€‹" ' + (item.unit === 'å€‹' ? 'selected' : '') + '>å€‹</option></select></div></div>' + learnHtml + '</div></div>';
      });
    }
    
    function buildProductOptions(category, selectedProduct) {
      let options = '<option value="">é¸æŠ...</option>';
      if (category && productMaster[category]) {
        productMaster[category].forEach(prod => {
          options += '<option value="' + prod + '" ' + (prod === selectedProduct ? 'selected' : '') + '>' + prod + '</option>';
        });
      }
      categoryList.forEach(cat => {
        if (cat !== category && productMaster[cat]) {
          options += '<optgroup label="â”€â”€ ' + cat + ' â”€â”€">';
          productMaster[cat].forEach(prod => {
            options += '<option value="' + prod + '" ' + (prod === selectedProduct ? 'selected' : '') + '>' + prod + '</option>';
          });
          options += '</optgroup>';
        }
      });
      return options;
    }
    
    function onCategoryChange(index) {
      const category = document.getElementById('category_' + index).value;
      itemEdits[index].category = category;
      const productSelect = document.getElementById('product_' + index);
      productSelect.innerHTML = buildProductOptions(category, '');
      itemEdits[index].productName = '';
      itemEdits[index].price = 0;
      document.getElementById('price_' + index).value = 0;
      checkModified(index);
      updateLearnSummary();
    }
    
    function onProductChange(index) {
      const productName = document.getElementById('product_' + index).value;
      itemEdits[index].productName = productName;
      if (productName && productPrices[productName] && itemEdits[index].priceSource !== 'ai') {
        itemEdits[index].price = productPrices[productName];
        itemEdits[index].priceSource = 'master';
        document.getElementById('price_' + index).value = productPrices[productName];
      }
      const preview = document.getElementById('learnPreview_' + index);
      if (preview) preview.textContent = 'â†’ ' + (productName || 'æœªé¸æŠ');
      checkModified(index);
      updateLearnSummary();
    }
    
    function onSpecChange(index) {
      itemEdits[index].spec = document.getElementById('spec_' + index).value;
      checkModified(index);
    }
    
    function onPriceChange(index) {
      itemEdits[index].price = Number(document.getElementById('price_' + index).value) || 0;
      itemEdits[index].priceSource = 'manual';
      checkModified(index);
    }
    
    function onQuantityChange(index) {
      itemEdits[index].quantity = document.getElementById('quantity_' + index).value;
      checkModified(index);
    }
    
    function onUnitChange(index) {
      itemEdits[index].unit = document.getElementById('unit_' + index).value;
      checkModified(index);
    }
    
    function toggleLearn(index) {
      const checked = document.getElementById('learn_' + index).checked;
      itemEdits[index].learn = checked;
      const row = document.getElementById('learnRow_' + index);
      const preview = document.getElementById('learnPreview_' + index);
      if (checked) { row.classList.add('will-learn'); preview.style.display = ''; }
      else { row.classList.remove('will-learn'); preview.style.display = 'none'; }
      updateLearnSummary();
    }
    
    function checkModified(index) {
      const card = document.getElementById('itemCard_' + index);
      const edit = itemEdits[index];
      if (edit.productName !== edit.originalProductName) { card.classList.add('modified'); }
      else { card.classList.remove('modified'); }
    }
    
    function updateLearnSummary() {
      const summaryDiv = document.getElementById('learnSummary');
      const itemsDiv = document.getElementById('learnSummaryItems');
      const learnList = [];
      Object.keys(itemEdits).forEach(index => {
        const edit = itemEdits[index];
        if (edit.learn && edit.originalText && edit.productName) {
          learnList.push({ originalText: edit.originalText, productName: edit.productName, isModified: edit.productName !== edit.originalProductName });
        }
      });
      if (learnList.length === 0) { summaryDiv.style.display = 'none'; return; }
      summaryDiv.style.display = 'block';
      itemsDiv.innerHTML = learnList.map(l => '<div class="learn-summary-item"><span class="original">ã€Œ' + l.originalText + 'ã€</span><span class="arrow">â†’</span><span class="product">' + l.productName + '</span>' + (l.isModified ? '<span class="modified-badge">ä¿®æ­£æ¸ˆ</span>' : '') + '</div>').join('');
    }
    
    function selectSource(type, source) {
      if (type === 'shippingTo') {
        useShippingToMaster = (source === 'master');
      } else {
        useCustomerMaster = (source === 'master');
      }

      // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
      const btns = document.querySelectorAll('#' + type + 'SourceSelect .source-select-btn');
      btns.forEach(btn => {
        btn.classList.remove('selected');
      });

      // é¸æŠã•ã‚ŒãŸã‚½ãƒ¼ã‚¹ã®ãƒœã‚¿ãƒ³ã«selectedã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      btns.forEach(btn => {
        const btnText = btn.textContent.trim();
        if ((source === 'raw' && btnText.includes('èª­ã¿å–ã‚Š')) ||
            (source === 'master' && btnText.includes('ãƒã‚¹ã‚¿')) ||
            (source === 'manual' && btnText.includes('æ‰‹å‹•é¸æŠ'))) {
          btn.classList.add('selected');
        }
      });

      console.log('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ:', type, source);
    }
    
    function setConfidenceBadge(id, conf) {
      const el = document.getElementById(id);
      if (!el) return;
      el.className = 'confidence-badge confidence-' + (conf || 'low');
      el.textContent = getConfidenceLabel(conf);
    }
    
    function getConfidenceLabel(conf) {
      return { high: 'âœ… é«˜', medium: 'âš ï¸ ä¸­', low: 'â“ ä½' }[conf] || 'â“';
    }
    
    function showError(msg) {
      document.getElementById('aiResultArea').classList.add('show');
      document.getElementById('aiError').style.display = 'block';
      document.getElementById('aiError').textContent = msg;
    }
    
    function clearAIResult() {
      aiAnalysisResult = null;
      useShippingToMaster = useCustomerMaster = false;
      itemEdits = {};
      document.getElementById('aiResultArea').classList.remove('show');
      document.getElementById('aiInputText').value = '';
      removeFile();
    }
    
    function applyAIResult() {
      if (!aiAnalysisResult) { showWarningToast('è§£æçµæœãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      
      const mappingsToLearn = [];
      const customerName = aiAnalysisResult.customer?.rawCompanyName || '';
      Object.keys(itemEdits).forEach(index => {
        const edit = itemEdits[index];
        if (edit.learn && edit.originalText && edit.productName) {
          mappingsToLearn.push({ originalText: edit.originalText, productName: edit.productName, customerName: customerName, spec: edit.spec || '' });
        }
      });
      
      if (mappingsToLearn.length > 0) {
        google.script.run.withSuccessHandler(function(results) { console.log('ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’çµæœ:', results); }).withFailureHandler(function(error) { console.error('ãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’ã‚¨ãƒ©ãƒ¼:', error); }).registerProductMappingBulk(mappingsToLearn);
      }
      
      if (aiAnalysisResult.shippingDate) { setFormValue('shippingDate', aiAnalysisResult.shippingDate); }
      if (aiAnalysisResult.deliveryDate) { setFormValue('deliveryDate', aiAnalysisResult.deliveryDate); }

      // ç™ºé€å…ˆã®é©ç”¨ï¼ˆå„ªå…ˆé †ä½: æ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ > AIèª­ã¿å–ã‚Šï¼‰
      if (manualShippingToSelection) {
        // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        console.log('æ‰‹å‹•é¸æŠã—ãŸç™ºé€å…ˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨:', manualShippingToSelection);
        const name = [manualShippingToSelection.companyName, manualShippingToSelection.personName].filter(Boolean).join('ã€€');
        setFormValue('shippingToName', name);
        setFormValue('shippingToZipcode', manualShippingToSelection.zipcode || '');
        setFormValue('shippingToAddress', manualShippingToSelection.address || '');
        setFormValue('shippingToTel', manualShippingToSelection.tel || '');
      } else {
        const st = aiAnalysisResult.shippingTo;
        if (st) {
          const data = useShippingToMaster && st.masterData ? st.masterData : st;
          setFormValue('shippingToName', useShippingToMaster ? [data.companyName, data.personName].filter(Boolean).join('ã€€') : [st.rawCompanyName, st.rawPersonName].filter(Boolean).join('ã€€'));
          setFormValue('shippingToZipcode', (useShippingToMaster ? data.zipcode : st.rawZipcode) || '');
          setFormValue('shippingToAddress', (useShippingToMaster ? data.address : st.rawAddress) || '');
          setFormValue('shippingToTel', (useShippingToMaster ? data.tel : st.rawTel) || '');
        }
      }

      // é¡§å®¢ã®é©ç”¨ï¼ˆå„ªå…ˆé †ä½: æ‰‹å‹•é¸æŠ > ãƒã‚¹ã‚¿ > AIèª­ã¿å–ã‚Šï¼‰
      if (manualCustomerSelection) {
        // æ‰‹å‹•é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        console.log('æ‰‹å‹•é¸æŠã—ãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨:', manualCustomerSelection);
        const name = manualCustomerSelection.displayName ||
                     [manualCustomerSelection.companyName, manualCustomerSelection.personName].filter(Boolean).join('ã€€');
        setFormValue('customerName', name);
        setFormValue('customerZipcode', manualCustomerSelection.zipcode || '');
        setFormValue('customerAddress', manualCustomerSelection.address || '');
        setFormValue('customerTel', manualCustomerSelection.tel || '');
      } else {
        const cust = aiAnalysisResult.customer;
        if (cust) {
          const data = useCustomerMaster && cust.masterData ? cust.masterData : cust;
          setFormValue('customerName', useCustomerMaster ? (data.displayName || [data.companyName, data.personName].filter(Boolean).join('ã€€')) : [cust.rawCompanyName, cust.rawPersonName].filter(Boolean).join('ã€€'));
          setFormValue('customerZipcode', (useCustomerMaster ? data.zipcode : cust.rawZipcode) || '');
          setFormValue('customerAddress', (useCustomerMaster ? data.address : cust.rawAddress) || '');
          setFormValue('customerTel', (useCustomerMaster ? data.tel : cust.rawTel) || '');
        }
      }
      
      Object.keys(itemEdits).forEach((index, i) => {
        const row = i + 1;
        if (row > 10) return;
        const edit = itemEdits[index];
        if (edit.category) {
          const bunrui = document.getElementById('bunrui' + row);
          if (bunrui) { bunrui.value = edit.category; if (typeof bunruiChange === 'function') bunruiChange(row); }
        }
        if (edit.productName) {
          setTimeout(() => {
            const prod = document.getElementById('product' + row);
            if (prod) {
              for (let j = 0; j < prod.options.length; j++) {
                if (prod.options[j].value === edit.productName) {
                  prod.selectedIndex = j;
                  if (typeof productChange === 'function') productChange(row);
                  break;
                }
              }
            }
          }, 100 * i);
        }
        if (edit.price) {
          setTimeout(() => {
            const priceEl = document.getElementById('price' + row);
            if (priceEl) priceEl.value = edit.price;
          }, 100 * i + 30);
        }
        if (edit.quantity) {
          setTimeout(() => {
            const qty = document.getElementById('quantity' + row);
            if (qty) qty.value = edit.quantity;
          }, 100 * i + 50);
        }
      });
      
      saveAISessionData();
      showAIAnalyzedIndicator(new Date().toISOString());
      
      let message = 'ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã—ã¾ã—ãŸã€‚';
      if (mappingsToLearn.length > 0) { message += '\n\nğŸ“š ' + mappingsToLearn.length + 'ä»¶ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å­¦ç¿’ã—ã¾ã—ãŸã€‚'; }
      if (aiAnalysisResult.alerts?.length) { message += '\n\nâš ï¸ ' + aiAnalysisResult.alerts.join('\n'); }
      showInfoToast(message);
      toggleAIAssistant();
    }
    
    function setFormValue(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value;
    }
    
    function validateBeforeSubmit() {
      const warnings = performLocalCheck();
      if (warnings.length === 0) { return true; }
      showWarningModal(warnings);
      return false;
    }
    
    function performLocalCheck() {
      const warnings = [];
      const savedData = sessionStorage.getItem(AI_SESSION_KEY);
      if (!savedData) {
        warnings.push(...checkBasicValidation());
        return warnings;
      }
      const aiData = JSON.parse(savedData);
      const inputTotal = calculateInputTotal();
      if (aiData.totalAmount && Math.abs(aiData.totalAmount - inputTotal) > 1) {
        const diff = inputTotal - aiData.totalAmount;
        warnings.push({ type: 'critical', icon: 'ğŸ”´', title: 'åˆè¨ˆé‡‘é¡ãŒç•°ãªã‚Šã¾ã™', detail: 'AIè§£æ: Â¥' + aiData.totalAmount.toLocaleString() + ' â†’ å…¥åŠ›: Â¥' + inputTotal.toLocaleString() + 'ï¼ˆå·®é¡: ' + (diff >= 0 ? '+' : '') + 'Â¥' + diff.toLocaleString() + 'ï¼‰' });
      }
      if (aiData.items) {
        aiData.items.forEach(aiItem => {
          if (AI_EXCLUDE_CATEGORIES.includes(aiItem.category) || AI_EXCLUDE_PRODUCTS.includes(aiItem.productName)) return;
          const inputItem = findInputItem(aiItem.productName);
          if (!inputItem) {
            warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: aiItem.productName + ' ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“', detail: 'AIè§£æ: ' + aiItem.quantity + 'å€‹' });
          } else {
            if (inputItem.quantity != aiItem.quantity) {
              warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: aiItem.productName + ' ã®æ•°é‡ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™', detail: 'AIè§£æ: ' + aiItem.quantity + 'å€‹ â†’ å…¥åŠ›: ' + inputItem.quantity + 'å€‹' });
            }
            if (inputItem.price != aiItem.price) {
              warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: aiItem.productName + ' ã®ä¾¡æ ¼ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™', detail: 'AIè§£æ: Â¥' + (aiItem.price || 0).toLocaleString() + ' â†’ å…¥åŠ›: Â¥' + (inputItem.price || 0).toLocaleString() });
            }
          }
        });
      }
      warnings.push(...checkBasicValidation());
      return warnings;
    }
    
    function calculateInputTotal() {
      let total = 0;
      for (let i = 1; i <= 10; i++) {
        const product = document.getElementById('product' + i)?.value || '';
        const category = document.getElementById('bunrui' + i)?.value || '';
        const price = Number(document.getElementById('price' + i)?.value) || 0;
        const quantity = Number(document.getElementById('quantity' + i)?.value) || 0;
        if (AI_EXCLUDE_CATEGORIES.includes(category) || AI_EXCLUDE_PRODUCTS.includes(product)) continue;
        total += price * quantity;
      }
      return total;
    }
    
    function findInputItem(productName) {
      for (let i = 1; i <= 10; i++) {
        const product = document.getElementById('product' + i)?.value || '';
        if (product === productName) {
          return { productName: product, price: Number(document.getElementById('price' + i)?.value) || 0, quantity: Number(document.getElementById('quantity' + i)?.value) || 0 };
        }
      }
      return null;
    }
    
    function checkBasicValidation() {
      const warnings = [];
      const products = [];
      for (let i = 1; i <= 10; i++) {
        const product = document.getElementById('product' + i)?.value || '';
        if (product && products.includes(product)) {
          warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: product + ' ãŒé‡è¤‡ã—ã¦ã„ã¾ã™', detail: 'åŒã˜å•†å“ãŒè¤‡æ•°è¡Œã‚ã‚Šã¾ã™' });
        }
        if (product) products.push(product);
      }
      for (let i = 1; i <= 10; i++) {
        const product = document.getElementById('product' + i)?.value || '';
        const quantity = Number(document.getElementById('quantity' + i)?.value) || 0;
        if (product && quantity >= 100) {
          warnings.push({ type: 'info', icon: 'ğŸ’¡', title: product + ' ã®æ•°é‡ãŒå¤šã„ã§ã™', detail: quantity + 'å€‹ - å…¥åŠ›ãƒŸã‚¹ã§ã¯ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„' });
        }
      }
      return warnings;
    }
    
    function showWarningModal(warnings) {
      const body = document.getElementById('aiWarningBody');
      body.innerHTML = warnings.map(w => '<div class="ai-warning-item ' + w.type + '"><span class="icon">' + w.icon + '</span><div class="content"><div class="title">' + w.title + '</div><div class="detail">' + w.detail + '</div></div></div>').join('');
      document.getElementById('aiWarningModal').classList.add('show');
    }
    
    function closeWarningModal() {
      document.getElementById('aiWarningModal').classList.remove('show');
    }
    
    function proceedWithWarnings() {
      closeWarningModal();
      const form = document.querySelector('form');
      if (form) {
        const btn = document.querySelector('[name="shippingComfirm"]');
        if (btn) {
          btn.removeAttribute('onclick');
          btn.click();
        }
      }
    }
    // ============================================
    // è¤‡æ•°æ—¥ç¨‹ç™»éŒ²æ©Ÿèƒ½
    // ============================================

    // ç™ºé€æ—¥ç¨‹ã®è¿½åŠ 
    function addShippingDate() {
      const container = document.getElementById('shippingDateContainer');
      const rows = container.querySelectorAll('.shipping-date-row');
      const currentCount = rows.length;
      
      if (currentCount >= 10) {
        showWarningToast('æ—¥ç¨‹ã¯æœ€å¤§10ä»¶ã¾ã§ã§ã™');
        return;
      }
      
      const newRowNum = currentCount + 1;
      
      // å‰ã®è¡Œã®æ—¥ä»˜ã‚’å–å¾—ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
      const lastRow = rows[rows.length - 1];
      const lastShippingDate = lastRow.querySelector('input[name^="shippingDate"]').value;
      const lastDeliveryDate = lastRow.querySelector('input[name^="deliveryDate"]').value;
      
      // 1æ—¥å¾Œã®æ—¥ä»˜ã‚’è¨ˆç®—
      const nextShipping = new Date(lastShippingDate);
      nextShipping.setDate(nextShipping.getDate() + 1);
      const nextShippingStr = nextShipping.toISOString().split('T')[0];
      
      const nextDelivery = new Date(lastDeliveryDate);
      nextDelivery.setDate(nextDelivery.getDate() + 1);
      const nextDeliveryStr = nextDelivery.toISOString().split('T')[0];
      
      const newRow = document.createElement('div');
      newRow.className = 'shipping-date-row d-flex align-items-center gap-2 mb-2';
      newRow.dataset.row = newRowNum;
      newRow.innerHTML = `
        <span class="badge bg-secondary">#${newRowNum}</span>
        <label class="col-form-label">ç™ºé€æ—¥</label>
        <input type="date" class="form-control" style="width:160px;" name="shippingDate${newRowNum}" required value="${nextShippingStr}">
        <label class="col-form-label">ç´å“æ—¥</label>
        <input type="date" class="form-control" style="width:160px;" name="deliveryDate${newRowNum}" required value="${nextDeliveryStr}">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeShippingDate(this)">âœ•</button>
      `;
      
      container.appendChild(newRow);
      updateRemoveButtons();
    }

    // ç™ºé€æ—¥ç¨‹ã®å‰Šé™¤
    function removeShippingDate(btn) {
      const row = btn.closest('.shipping-date-row');
      row.remove();
      renumberShippingDates();
      updateRemoveButtons();
    }

    // ç•ªå·ã®æŒ¯ã‚Šç›´ã—
    function renumberShippingDates() {
      const container = document.getElementById('shippingDateContainer');
      const rows = container.querySelectorAll('.shipping-date-row');
      
      rows.forEach((row, index) => {
        const num = index + 1;
        row.dataset.row = num;
        row.querySelector('.badge').textContent = '#' + num;
        row.querySelector('input[name^="shippingDate"]').name = 'shippingDate' + num;
        row.querySelector('input[name^="deliveryDate"]').name = 'deliveryDate' + num;
      });
    }

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ¶å¾¡ï¼ˆ1ä»¶ã®ã¨ãã¯å‰Šé™¤ä¸å¯ï¼‰
    function updateRemoveButtons() {
      const container = document.getElementById('shippingDateContainer');
      const rows = container.querySelectorAll('.shipping-date-row');
      const buttons = container.querySelectorAll('.btn-outline-danger');
      
      buttons.forEach(btn => {
        btn.disabled = rows.length <= 1;
      });
    }
    // ============================================
    // shipping.html - å—æ³¨IDå–å¾—ãƒ»åæ˜ æ©Ÿèƒ½ JavaScriptï¼ˆä¿®æ­£ç‰ˆï¼‰
    // 
    // ä¿®æ­£: åæ˜ å‰ã«å•†å“è¡Œã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
    // ============================================

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let orderHistoryData = [];
    let selectedOrderId = null;

    /**
     * å—æ³¨IDå–å¾—ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    function getOrderHistory() {
      const shippingToName = document.getElementById('shippingToName').value.trim();
      
      if (!shippingToName) {
        showWarningToast('ç™ºé€å…ˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const btn = document.getElementById('getOrderHistoryBtn');
      const originalText = btn.textContent;
      btn.textContent = 'å–å¾—ä¸­...';
      btn.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(result) {
          btn.textContent = originalText;
          btn.disabled = false;
          
          const orders = JSON.parse(result);
          orderHistoryData = orders;
          
          if (orders.length === 0) {
            showInfoToast('éå»ã®å—æ³¨ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            document.getElementById('orderHistorySelect').style.display = 'none';
            document.getElementById('applyOrderHistoryBtn').style.display = 'none';
            return;
          }
          
          const select = document.getElementById('orderHistorySelect');
          select.innerHTML = '<option value="">ç™ºé€æ—¥ã‚’é¸æŠ...</option>';
          
          orders.forEach(function(order) {
            const option = document.createElement('option');
            option.value = order.orderId;
            let label = order.shippingDate || 'æ—¥ä»˜ãªã—';
            if (order.productSummary) {
              label += ' (' + order.productSummary + ')';
            }
            option.textContent = label;
            select.appendChild(option);
          });
          
          select.style.display = 'inline-block';
          document.getElementById('applyOrderHistoryBtn').style.display = 'inline-block';
        })
        .withFailureHandler(function(error) {
          btn.textContent = originalText;
          btn.disabled = false;
          showErrorToast('å—æ³¨å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getOrderHistoryByShippingTo(shippingToName);
    }

    /**
     * ç™ºé€æ—¥ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã®å‡¦ç†
     */
    function onOrderHistorySelect() {
      const select = document.getElementById('orderHistorySelect');
      selectedOrderId = select.value;
    }

    /**
     * åæ˜ ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    function applyOrderHistory() {
      if (!selectedOrderId) {
        showWarningToast('ç™ºé€æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const btn = document.getElementById('applyOrderHistoryBtn');
      const originalText = btn.textContent;
      btn.textContent = 'åæ˜ ä¸­...';
      btn.disabled = true;
      
      google.script.run
        .withSuccessHandler(function(result) {
          btn.textContent = originalText;
          btn.disabled = false;
          
          const data = JSON.parse(result);
          
          if (!data) {
            showErrorToast('å—æ³¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            return;
          }
          
          applyOrderDataToForm(data);
          
          showSuccessToast('å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã—ãŸï¼ˆç™ºé€æ—¥ãƒ»ç´å“æ—¥ãƒ»å€‹æ•°ã¯é™¤å¤–ï¼‰');
        })
        .withFailureHandler(function(error) {
          btn.textContent = originalText;
          btn.disabled = false;
          showErrorToast('å—æ³¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .getOrderDataForInherit(selectedOrderId);
    }

    /**
     * å•†å“è¡Œã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
     */
    function clearProductRows() {
      for (let rowNum = 1; rowNum <= 10; rowNum++) {
        const bunruiEl = document.getElementById('bunrui' + rowNum);
        if (bunruiEl) bunruiEl.selectedIndex = 0;
        
        const productEl = document.getElementById('product' + rowNum);
        if (productEl) productEl.selectedIndex = 0;
        
        const priceEl = document.getElementById('price' + rowNum);
        if (priceEl) priceEl.value = '';
        
        const quantityEl = document.getElementById('quantity' + rowNum);
        if (quantityEl) quantityEl.value = '';
      }
    }

    /**
     * å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
     */
    function applyOrderDataToForm(data) {
      // æœ€åˆã«å•†å“è¡Œã‚’ã‚¯ãƒªã‚¢
      clearProductRows();
      
      // ç™ºé€å…ˆæƒ…å ±ï¼ˆç™ºé€å…ˆåã¯å¤‰æ›´ã—ãªã„ï¼‰
      document.getElementById('shippingToZipcode').value = data.shippingToZipcode || '';
      document.getElementById('shippingToAddress').value = data.shippingToAddress || '';
      document.getElementById('shippingToTel').value = data.shippingToTel || '';
      
      // é¡§å®¢æƒ…å ±
      document.getElementById('customerName').value = data.customerName || '';
      document.getElementById('customerZipcode').value = data.customerZipcode || '';
      document.getElementById('customerAddress').value = data.customerAddress || '';
      document.getElementById('customerTel').value = data.customerTel || '';
      
      // ç™ºé€å…ƒæƒ…å ±
      document.getElementById('shippingFromName').value = data.shippingFromName || '';
      document.getElementById('shippingFromZipcode').value = data.shippingFromZipcode || '';
      document.getElementById('shippingFromAddress').value = data.shippingFromAddress || '';
      document.getElementById('shippingFromTel').value = data.shippingFromTel || '';
      
      // å—ä»˜æƒ…å ±
      if (data.receiptWay) {
        const receiptWayEl = document.getElementById('receiptWay');
        if (receiptWayEl) {
          for (let i = 0; i < receiptWayEl.options.length; i++) {
            if (receiptWayEl.options[i].value === data.receiptWay) {
              receiptWayEl.selectedIndex = i;
              break;
            }
          }
        }
      }
      
      if (data.recipient) {
        const recipientEl = document.getElementById('recipient');
        if (recipientEl) {
          for (let i = 0; i < recipientEl.options.length; i++) {
            if (recipientEl.options[i].value === data.recipient) {
              recipientEl.selectedIndex = i;
              break;
            }
          }
        }
      }
      
      // ç´å“æ–¹æ³•
      if (data.deliveryMethod) {
        const deliveryMethodEl = document.getElementById('deliveryMethod');
        if (deliveryMethodEl) {
          for (let i = 0; i < deliveryMethodEl.options.length; i++) {
            if (deliveryMethodEl.options[i].value === data.deliveryMethod) {
              deliveryMethodEl.selectedIndex = i;
              if (typeof deliveryMethodChange === 'function') {
                deliveryMethodChange();
              }
              break;
            }
          }
        }
      }
      
      // é…é”æ™‚é–“å¸¯
      if (data.deliveryTime) {
        setTimeout(function() {
          const deliveryTimeEl = document.getElementById('deliveryTime');
          if (deliveryTimeEl) {
            for (let i = 0; i < deliveryTimeEl.options.length; i++) {
              if (deliveryTimeEl.options[i].value === data.deliveryTime) {
                deliveryTimeEl.selectedIndex = i;
                break;
              }
            }
          }
        }, 100);
      }
      
      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
      if (data.checklist) {
        const deliveryChk = document.getElementById('deliveryChk');
        const billChk = document.getElementById('billChk');
        const receiptChk = document.getElementById('receiptChk');
        const pamphletChk = document.getElementById('pamphletChk');
        const recipeChk = document.getElementById('recipeChk');
        
        if (deliveryChk) deliveryChk.checked = data.checklist.deliverySlip || false;
        if (billChk) billChk.checked = data.checklist.bill || false;
        if (receiptChk) receiptChk.checked = data.checklist.receipt || false;
        if (pamphletChk) pamphletChk.checked = data.checklist.pamphlet || false;
        if (recipeChk) recipeChk.checked = data.checklist.recipe || false;
      }
      
      // ãã®ä»–æ·»ä»˜
      const otherAttachEl = document.getElementById('otherAttach');
      if (otherAttachEl) {
        otherAttachEl.value = data.otherAttach || '';
      }
      
      // å•†å“æƒ…å ±ï¼ˆå€‹æ•°ã¯ç©ºï¼‰
      if (data.items && data.items.length > 0) {
        data.items.forEach(function(item, index) {
          const rowNum = index + 1;
          if (rowNum > 10) return;
          
          const bunruiEl = document.getElementById('bunrui' + rowNum);
          if (bunruiEl && item.bunrui) {
            for (let i = 0; i < bunruiEl.options.length; i++) {
              if (bunruiEl.options[i].value === item.bunrui) {
                bunruiEl.selectedIndex = i;
                if (typeof bunruiChange === 'function') {
                  bunruiChange(rowNum);
                }
                break;
              }
            }
          }
          
          setTimeout(function() {
            const productEl = document.getElementById('product' + rowNum);
            if (productEl && item.product) {
              for (let i = 0; i < productEl.options.length; i++) {
                if (productEl.options[i].value === item.product) {
                  productEl.selectedIndex = i;
                  if (typeof productChange === 'function') {
                    productChange(rowNum);
                  }
                  break;
                }
              }
            }
            
            const priceEl = document.getElementById('price' + rowNum);
            if (priceEl && item.price) {
              priceEl.value = item.price;
            }
            
            const quantityEl = document.getElementById('quantity' + rowNum);
            if (quantityEl) {
              quantityEl.value = '';
            }
          }, 100 * rowNum);
        });
      }
      
      // ç™ºé€æƒ…å ±
      const sendProductEl = document.getElementById('sendProduct');
      if (sendProductEl) {
        sendProductEl.value = data.sendProduct || '';
      }
      
      // é€ã‚ŠçŠ¶ç¨®åˆ¥
      if (data.invoiceType) {
        setTimeout(function() {
          const invoiceTypeEl = document.getElementById('invoiceType');
          if (invoiceTypeEl) {
            for (let i = 0; i < invoiceTypeEl.options.length; i++) {
              if (invoiceTypeEl.options[i].value === data.invoiceType) {
                invoiceTypeEl.selectedIndex = i;
                break;
              }
            }
          }
        }, 150);
      }
      
      // ã‚¯ãƒ¼ãƒ«åŒºåˆ†
      if (data.coolCls) {
        setTimeout(function() {
          const coolClsEl = document.getElementById('coolCls');
          if (coolClsEl) {
            for (let i = 0; i < coolClsEl.options.length; i++) {
              if (coolClsEl.options[i].value === data.coolCls) {
                coolClsEl.selectedIndex = i;
                break;
              }
            }
          }
        }, 150);
      }
      
      // è·æ‰±ã„ï¼‘
      if (data.cargo1) {
        setTimeout(function() {
          const cargo1El = document.getElementById('cargo1');
          if (cargo1El) {
            for (let i = 0; i < cargo1El.options.length; i++) {
              if (cargo1El.options[i].value === data.cargo1) {
                cargo1El.selectedIndex = i;
                break;
              }
            }
          }
        }, 150);
      }
      
      // è·æ‰±ã„ï¼’
      if (data.cargo2) {
        setTimeout(function() {
          const cargo2El = document.getElementById('cargo2');
          if (cargo2El) {
            for (let i = 0; i < cargo2El.options.length; i++) {
              if (cargo2El.options[i].value === data.cargo2) {
                cargo2El.selectedIndex = i;
                break;
              }
            }
          }
        }, 150);
      }
      
      // ä»£å¼•ç·é¡ãƒ»ä»£å¼•å†…ç¨ãƒ»ç™ºè¡Œæšæ•°
      const cashOnDeliveryEl = document.getElementById('cashOnDelivery');
      if (cashOnDeliveryEl) {
        cashOnDeliveryEl.value = data.cashOnDelivery || '';
      }
      
      const cashOnDeliTaxEl = document.getElementById('cashOnDeliTax');
      if (cashOnDeliTaxEl) {
        cashOnDeliTaxEl.value = data.cashOnDeliTax || '';
      }
      
      const copiePrintEl = document.getElementById('copiePrint');
      if (copiePrintEl) {
        copiePrintEl.value = data.copiePrint || '';
      }
      
      // å‚™è€ƒæ¬„
      const csvmemoEl = document.getElementById('csvmemo');
      if (csvmemoEl) {
        csvmemoEl.value = data.csvmemo || '';
      }
      
      const deliveryMemoEl = document.getElementById('deliveryMemo');
      if (deliveryMemoEl) {
        deliveryMemoEl.value = data.deliveryMemo || '';
      }
      
      const memoEl = document.getElementById('memo');
      if (memoEl) {
        memoEl.value = data.memo || '';
      }
    }
  </script>
  <?!= HtmlService.createHtmlOutputFromFile('keyCheck').getContent(); ?>
</body>

</html>