<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <?!= HtmlService.createHtmlOutputFromFile('design-system').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('components').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('utilities').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
</head>

<body>
  <div id="gas-session-data" style="display:none;"
    data-auto-open="<?= typeof autoOpenAI !== 'undefined' ? autoOpenAI : false ?>"
    data-analysis="<?= typeof aiAnalysisResult !== 'undefined' ? aiAnalysisResult : '' ?>">
  </div>
  <div class="container">
    <form class="mb-5" method="POST" action="<?= deployURL ?>">
      <div class="mt-3">
        <style>
          .nav-btn {
            border: 2px solid !important;
            font-weight: 600 !important;
            transition: all 0.2s !important;
          }

          .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
          }
        </style>
        <button type="submit" formnovalidate class="btn btn-outline-secondary me-3 nav-btn" name="mainTop" value="true"
          onclick="clearAISession()">ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹</button>
        <button type="submit" formnovalidate class="btn btn-outline-primary me-3 nav-btn" name="orderListPage"
          value="true" onclick="clearAISession()">å—æ³¨ä¸€è¦§ã«æˆ»ã‚‹</button>

        <!-- æ¤œç´¢æ¡ä»¶å¼•ç¶™ç”¨ -->
        <input type="hidden" name="prevPeriod" value="<?= typeof prevPeriod !== 'undefined' ? prevPeriod : '' ?>">
        <input type="hidden" name="prevDateFrom" value="<?= typeof prevDateFrom !== 'undefined' ? prevDateFrom : '' ?>">
        <input type="hidden" name="prevDateTo" value="<?= typeof prevDateTo !== 'undefined' ? prevDateTo : '' ?>">
        <input type="hidden" name="prevDestination"
          value="<?= typeof prevDestination !== 'undefined' ? prevDestination : '' ?>">
        <input type="hidden" name="prevCustomer" value="<?= typeof prevCustomer !== 'undefined' ? prevCustomer : '' ?>">
        <input type="hidden" name="prevStatus" value="<?= typeof prevStatus !== 'undefined' ? prevStatus : '' ?>">
        <input type="hidden" name="prevIncludeOverdue" value="<?= typeof prevIncludeOverdue !== 'undefined' ? prevIncludeOverdue : '' ?>">
      </div>
      <h2 class="text-center m-4">å—æ³¨ç®¡ç†</h2>
      <!-- AIè§£ææ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ä¸Šéƒ¨ã«è¡¨ç¤ºï¼‰ -->
      <div class="ai-analyzed-indicator" id="aiAnalyzedIndicator">
        <span>ğŸ¤– AIè§£ææ¸ˆã¿</span>
        <span class="time" id="aiAnalyzedTime"></span>
      </div>

      <div class="ai-assistant-container">
        <div class="ai-assistant-header" onclick="toggleAIAssistant()">
          <h3>ğŸ¤– AIå…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆç¢ºèªãƒ»ä¿®æ­£ã—ã¦å­¦ç¿’ï¼‰</h3>
          <button type="button" class="ai-assistant-toggle" id="aiToggleBtn">é–‹ã</button>
        </div>

        <div class="ai-assistant-body" id="aiAssistantBody">
          <div class="ai-input-tabs">
            <button type="button" class="ai-tab-btn active" onclick="switchTab('text')">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ</button>
            <button type="button" class="ai-tab-btn" onclick="switchTab('file')">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«</button>
          </div>

          <div class="ai-tab-content active" id="textTab">
            <div class="ai-input-area">
              <textarea id="aiInputText" placeholder="ãƒ¡ãƒ¼ãƒ«ã€ãƒãƒ£ãƒƒãƒˆã€FAXã®å†…å®¹ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
            </div>
          </div>

          <div class="ai-tab-content" id="fileTab">
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('orderFile').click()">
              <input type="file" id="orderFile" accept=".pdf,image/*" onchange="handleFileSelect(event)">
              <div class="icon">ğŸ“„</div>
              <div class="text">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
              <div class="hint">PDFã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</div>
            </div>
            <div id="filePreview"></div>
          </div>

          <button type="button" class="ai-analyze-btn" id="aiAnalyzeBtn" onclick="analyzeWithAI()">
            <span class="spinner"></span>
            <span class="btn-text">ğŸ” AIã§è§£æã™ã‚‹</span>
          </button>

          <div class="ai-result-area" id="aiResultArea">
            <div class="ai-result-header">
              ğŸ“‹ è§£æçµæœ
              <span class="confidence-badge" id="overallConfidence"></span>
            </div>

            <div class="ai-result-body">
              <div class="ai-alerts" id="aiAlerts"></div>

              <div class="ai-result-section">
                <div class="ai-result-section-header">ğŸ“… æ—¥ç¨‹</div>
                <div class="ai-result-section-body">
                  <div class="raw-data-info">
                    <div class="row"><span class="label">ç™ºé€æ—¥ï¼š</span><span id="aiResultShippingDate">-</span></div>
                    <div class="row"><span class="label">ç´å“æ—¥ï¼š</span><span id="aiResultDeliveryDate">-</span></div>
                    <div class="row"><span class="label">æ™‚é–“æŒ‡å®šï¼š</span><span id="aiResultDeliveryTime">-</span></div>
                  </div>
                </div>
              </div>

              <div class="ai-result-section">
                <div class="ai-result-section-header">ğŸ“¦ ç™ºé€å…ˆ <span id="shippingToMatchBadge"></span></div>
                <div class="ai-result-section-body">
                  <div class="raw-data-info" id="aiResultShippingToRaw"></div>
                  <div class="master-data-info" id="aiResultShippingToMaster" style="display:none;"></div>
                  <div class="manual-select-info" id="aiResultShippingToManual" style="display:none;"></div>
                  <div class="source-select-group" id="shippingToSourceSelect" style="display:none;"></div>
                </div>
              </div>

              <div class="ai-result-section">
                <div class="ai-result-section-header">ğŸ‘¤ é¡§å®¢ <span id="customerMatchBadge"></span></div>
                <div class="ai-result-section-body">
                  <div class="raw-data-info" id="aiResultCustomerRaw"></div>
                  <div class="master-data-info" id="aiResultCustomerMaster" style="display:none;"></div>
                  <div class="manual-select-info" id="aiResultCustomerManual" style="display:none;"></div>
                  <!-- ğŸ“  FAXç•ªå·ç™»éŒ²ä¿ƒé€²ï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
                  <div class="fax-registration-prompt" id="faxRegistrationPrompt" style="display:none;"></div>
                  <!-- ğŸ¤– AIæ¨å®šå€™è£œï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
                  <div class="ai-suggestion-info" id="aiResultCustomerSuggestion" style="display:none;"></div>
                  <div class="source-select-group" id="customerSourceSelect" style="display:none;"></div>
                </div>
              </div>

              <div class="ai-result-section">
                <div class="ai-result-section-header">ğŸ›’ å•†å“</div>
                <div class="ai-result-section-body" id="aiResultItems"></div>
              </div>

              <div class="learn-summary" id="learnSummary" style="display:none;">
                <div class="learn-summary-title">ğŸ“š å­¦ç¿’äºˆå®šã®ãƒãƒƒãƒ”ãƒ³ã‚°</div>
                <div id="learnSummaryItems"></div>
              </div>

              <div class="ai-result-section" id="memoSection" style="display:none;">
                <div class="ai-result-section-header">ğŸ“ å‚™è€ƒ</div>
                <div class="ai-result-section-body" id="aiResultMemo"></div>
              </div>

              <div class="ai-error" id="aiError" style="display:none;"></div>

              <div class="ai-action-buttons">
                <button type="button" class="ai-cancel-btn" onclick="clearAIResult()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="ai-apply-btn" onclick="applyAIResult()">âœ… ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼†å­¦ç¿’</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="ai-warning-modal-overlay" id="aiWarningModal">
        <div class="ai-warning-modal">
          <div class="ai-warning-modal-header">âš ï¸ å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
          <div class="ai-warning-modal-body" id="aiWarningBody"></div>
          <div class="ai-warning-modal-footer">
            <button type="button" class="ai-warning-modify-btn" onclick="closeWarningModal()">ä¿®æ­£ã™ã‚‹</button>
            <button type="button" class="ai-warning-proceed-btn" onclick="proceedWithWarnings()">ã“ã®ã¾ã¾é€²ã‚€</button>
          </div>
        </div>
      </div>
      <div class="customerSearch_dg">
        <div>
          <label for="customerSearchBunruiDg" class="text-left form-label">é¡§å®¢</label>
          <select class="form-select" id="customerSearchBunruiDg" name="customerSearchBunruiDg">
            <option value="1">ä¼šç¤¾å</option>
            <option value="2">æ°å</option>
            <option value="3">è¡¨ç¤ºå</option>
            <option value="4">ãƒ•ãƒªã‚¬ãƒŠ</option>
          </select>
        </div>
        <div>
          <label for="customerSearchClassDg" class="text-left form-label">é¡§å®¢åˆ†é¡</label>
          <select class="form-select" id="customerSearchClassDg" name="customerSearchClassDg">
            <option value=""></option>
            <option value="1">ä¸€æ¬¡å¸ã—ãƒ»å¤§å£</option>
            <option value="2">å°å£²åº—</option>
            <option value="3">é£²é£Ÿåº—ãƒ»ãƒ›ãƒ†ãƒ«</option>
            <option value="4">åœ°å…ƒé£²é£Ÿåº—</option>
            <option value="5">é€šä¿¡è²©å£²</option>
            <option value="6">ä¸€èˆ¬è²©å£²</option>
            <option value="7">ãã®ä»–</option>
            <option value="8">è·åŸŸ</option>
          </select>
        </div>
        <div>
          <label for="customerSearchKeyDg" class="text-left form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" class="form-control" id="customerSearchKeyDg" name="customerSearchKeyDg">
        </div>
        <div id="resCustArea" class="mt-2 resTable">
        </div>
      </div>
      <div class="shippingToSearch_dg">
        <div>
          <label for="shippingToSearchBunruiDg" class="text-left form-label">ç™ºé€å…ˆ</label>
          <select class="form-select" id="shippingToSearchBunruiDg" name="shippingToSearchBunruiDg">
            <option value="1">ä¼šç¤¾å</option>
            <option value="2">æ°å</option>
          </select>
        </div>
        <div>
          <label for="shippingToSearchKeyDg" class="text-left form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" class="form-control" id="shippingToSearchKeyDg" name="shippingToSearchKeyDg">
        </div>
        <div id="resShippingToArea" class="mt-2 resTable">
        </div>
      </div>
      <div class="customer_dg">
        <div>
          <label for="customerClassDg" class="text-left form-label">é¡§å®¢åˆ†é¡</label>
          <select class="form-select" id="customerClassDg" name="customerClassDg">
            <option value="1">ä¸€æ¬¡å¸ã—ãƒ»å¤§å£</option>
            <option value="2">å°å£²åº—</option>
            <option value="3">é£²é£Ÿåº—ãƒ»ãƒ›ãƒ†ãƒ«</option>
            <option value="4">åœ°å…ƒé£²é£Ÿåº—</option>
            <option value="5">é€šä¿¡è²©å£²</option>
            <option value="6">ä¸€èˆ¬è²©å£²</option>
            <option value="7">ãã®ä»–</option>
            <option value="8">è·åŸŸ</option>
          </select>
        </div>
        <div>
          <label for="customerNameDg" class="text-left form-label">ä¼šç¤¾å</label>
          <input type="text" id="customerNameDg" name="customerNameDg">
        </div>
        <div>
          <label for="customerShowNameDg" class="text-left form-label">è¡¨ç¤ºå</label>
          <input type="text" id="customerShowNameDg" name="customerShowNameDg">
        </div>
        <div>
          <label for="customerFuriganaDg" class="text-left form-label">ãƒ•ãƒªã‚¬ãƒŠ</label>
          <input type="text" id="customerFuriganaDg" name="customerFuriganaDg">
        </div>
        <div>
          <label for="customerDepDg" class="text-left form-label">éƒ¨ç½²</label>
          <input type="text" id="customerDepDg" name="customerDepDg">
        </div>
        <div>
          <label for="customerPostDg" class="text-left form-label">å½¹è·</label>
          <input type="text" id="customerPostDg" name="customerPostDg">
        </div>
        <div>
          <label for="customerIdentDg" class="text-left form-label">æ°å</label>
          <input type="text" id="customerIdentDg" name="customerIdentDg">
        </div>
        <div>
          <label for="customerZipcodeDg" class="text-left form-label">éƒµä¾¿ç•ªå·</label>
          <input type="text" id="customerZipcodeDg" name="customerZipcodeDg" maxlength=7 onfocusout="getAddress()">
        </div>
        <div>
          <label for="customerAddress1Dg" class="text-left form-label">ä½æ‰€ï¼‘</label>
          <input type="text" id="customerAddress1Dg" name="customerAddress1Dg">
        </div>
        <div>
          <label for="customerAddress2Dg" class="text-left form-label">ä½æ‰€ï¼’</label>
          <input type="text" id="customerAddress2Dg" name="customerAddress2Dg">
        </div>
        <div>
          <label for="customerTelDg" class="text-left form-label">é›»è©±ç•ªå·</label>
          <input type="text" class="form-control" id="customerTelDg" name="customerTelDg" maxlength=11>
        </div>
        <div>
          <label for="customerPhoneDg" class="text-left form-label">æºå¸¯é›»è©±</label>
          <input type="text" class="form-control" id="customerPhoneDg" name="customerPhoneDg" maxlength=11>
        </div>
        <div>
          <label for="customerFaxDg" class="text-left form-label">ï¼¦ï¼¡ï¼¸</label>
          <input type="text" class="form-control" id="customerFaxDg" name="customerFaxDg" maxlength=11>
        </div>
        <div>
          <label for="customerMailDg" class="text-left form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" class="form-control" id="customerMailDg" name="customerMailDg">
        </div>
        <div class="mt-2 mb-2">
          <input type="checkbox" class="form-check-input" id="customerSameDg" name="customerSameDg">
          <label for="customerSameDg" class="form-check-label">ç™ºé€å…ˆåŒä¸Š</label>
        </div>
        <div>
          <label for="customerBillDg" class="text-left form-label">è«‹æ±‚æ›¸æœ‰ç„¡</label>
          <select class="form-select" id="customerBillDg" name="customerBillDg">
            <option value=""></option>
            <option value="æœ‰">æœ‰</option>
          </select>
        </div>
        <div>
          <label for="customerDepositDateDg" class="text-left form-label">å…¥é‡‘æœŸæ—¥</label>
          <select class="form-select" id="customerDepositDateDg" name="customerDepositDateDg">
            <option value="ç¿Œæœ«æ—¥">ç¿Œæœ«æ—¥</option>
            <option value="ï¼’é€±é–“å¾Œ">ï¼’é€±é–“å¾Œ</option>
            <option value="ç¿Œã€…ä¸­æ—¥">ç¿Œã€…ä¸­æ—¥</option>
            <option value="ç¿Œã€…æœ«æ—¥">ç¿Œã€…æœ«æ—¥</option>
          </select>
        </div>
        <div>
          <label for="customerTaxDisplayDg" class="text-left form-label">æ¶ˆè²»ç¨ã®è¡¨ç¤ºæ–¹æ³•</label>
          <select class="form-select" id="customerTaxDisplayDg" name="customerTaxDisplayDg">
            <option value="">ï¼ˆæœªè¨­å®šï¼‰</option>
            <option value="å†…ç¨">å†…ç¨</option>
            <option value="å¤–ç¨">å¤–ç¨</option>
          </select>
        </div>
        <div>
          <label for="customerMemoDg" class="text-left form-label">å‚™è€ƒ</label>
          <input type="text" class="form-control" id="customerMemoDg" name="customerMemoDg">
        </div>
      </div>
      <div class="shippingTo_dg">
        <div>
          <label for="shippingToNameDg" class="text-left form-label">ä¼šç¤¾å</label>
          <input type="text" id="shippingToNameDg" name="shippingToNameDg">
        </div>
        <div>
          <label for="shippingToDepDg" class="text-left form-label">éƒ¨ç½²</label>
          <input type="text" id="shippingToDepDg" name="shippingToDepDg">
        </div>
        <div>
          <label for="shippingToIdentDg" class="text-left form-label">æ°å</label>
          <input type="text" id="shippingToIdentDg" name="shippingToIdentDg">
        </div>
        <div>
          <label for="shippingToZipcodeDg" class="text-left form-label">éƒµä¾¿ç•ªå·</label>
          <input type="text" id="shippingToZipcodeDg" name="shippingToZipcodeDg" maxlength=7
            onfocusout="getShippingToAddress()">
        </div>
        <div>
          <label for="shippingToAddress1Dg" class="text-left form-label">ä½æ‰€ï¼‘</label>
          <input type="text" id="shippingToAddress1Dg" name="shippingToAddress1Dg">
        </div>
        <div>
          <label for="shippingToAddress2Dg" class="text-left form-label">ä½æ‰€ï¼’</label>
          <input type="text" id="shippingToAddress2Dg" name="shippingToAddress2Dg">
        </div>
        <div>
          <label for="shippingToTelDg" class="text-left form-label">é›»è©±ç•ªå·</label>
          <input type="text" class="form-control" id="shippingToTelDg" name="shippingToTelDg" maxlength=11>
        </div>
        <div>
          <label for="shippingToMailDg" class="text-left form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" class="form-control" id="shippingToMailDg" name="shippingToMailDg">
        </div>
        <div>
          <label for="shippingToMemoDg" class="text-left form-label">å‚™è€ƒ</label>
          <input type="text" class="form-control" id="shippingToMemoDg" name="shippingToMemoDg">
        </div>
      </div>
      <div>
        <? output._ = shippingHTML ?>
      </div>
      <!-- ä»®å—æ³¨IDï¼ˆAIå–è¾¼ä¸€è¦§ã‹ã‚‰é·ç§»ã—ãŸå ´åˆã«è¨­å®šï¼‰ -->
      <? if (typeof tempOrderId !== 'undefined' && tempOrderId) { ?>
      <input type="hidden" name="tempOrderId" value="<?= tempOrderId ?>">
      <? } ?>

      <!-- å®šæœŸä¾¿è¨­å®šï¼ˆæ–°è¦ç™»éŒ²æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <? if (!isEditMode) { ?>
      <div class="recurring-order-section mt-4 mb-4">
        <div class="card">
          <div class="card-header bg-info text-white py-2">
            <label class="form-check-label mb-0" style="cursor: pointer;">
              <input type="checkbox" class="form-check-input me-2" id="isRecurringOrder" name="isRecurringOrder" value="true" onchange="toggleRecurringOptions()">
              ğŸ”„ å®šæœŸä¾¿ã¨ã—ã¦ç™»éŒ²ã™ã‚‹
            </label>
          </div>
          <div class="card-body recurring-options" id="recurringOptions" style="display: none;">
            <div class="row align-items-center mb-2">
              <div class="col-auto">
                <label for="recurringType" class="form-label mb-0">å®šæœŸã‚¿ã‚¤ãƒ—:</label>
              </div>
              <div class="col-auto">
                <select class="form-select" id="recurringType" name="recurringType" onchange="onRecurringTypeChange()">
                  <option value="monthly">æ¯æœˆ</option>
                  <option value="weekly">æ¯é€±</option>
                  <option value="biweekly">2é€±ã”ã¨</option>
                  <option value="triweekly">3é€±ã”ã¨</option>
                  <option value="4week">4é€±ã”ã¨</option>
                  <option value="5week">5é€±ã”ã¨</option>
                  <option value="6week">6é€±ã”ã¨</option>
                  <option value="7week">7é€±ã”ã¨</option>
                  <option value="8week">8é€±ã”ã¨</option>
                  <option value="9week">9é€±ã”ã¨</option>
                  <option value="10week">10é€±ã”ã¨</option>
                  <option value="11week">11é€±ã”ã¨</option>
                  <option value="12week">12é€±ã”ã¨</option>
                  <option value="2month">2ãƒ¶æœˆã”ã¨</option>
                  <option value="3month">3ãƒ¶æœˆã”ã¨</option>
                </select>
              </div>
              <div class="col-auto" id="recurringSubOptions"></div>
              <div class="col">
                <small class="text-muted">â€» ã‚¿ã‚¤ãƒ—ãƒ»æ›œæ—¥ãƒ»æ—¥ä»˜ã‚’æŒ‡å®šã§ãã¾ã™</small>
              </div>
            </div>
            <div class="row align-items-center mb-2" id="recurringNextDateRow" style="display:none;">
              <div class="col-auto">
                <label for="recurringNextDate" class="form-label mb-0">æ¬¡å›ç™ºé€æ—¥:</label>
              </div>
              <div class="col-auto">
                <input type="date" class="form-control" id="recurringNextDate" name="recurringNextDate">
              </div>
            </div>
            <script>
            /**
             * åŸºæº–æ—¥ã¨å®šæœŸã‚¿ã‚¤ãƒ—ã‹ã‚‰æ¬¡å›ç™ºé€æ—¥ã‚’è¨ˆç®—
             */
            function calcNextRecurringDate(baseDate, type, subValue) {
              var d = new Date(baseDate);
              if (isNaN(d.getTime())) return null;

              if (type === 'weekly') {
                // æ¯é€±: ç™ºé€æ—¥ã‹ã‚‰æœ€ä½7æ—¥å¾Œã®æŒ‡å®šæ›œæ—¥
                var targetDay = Number(subValue) || 1;
                var currentDay = d.getDay() || 7;
                var diff = (targetDay - currentDay + 7) % 7;
                if (diff === 0) diff = 7;
                // æ¬¡å›ç™ºé€æ—¥ã¯å°‘ãªãã¨ã‚‚1é€±é–“å¾Œ
                if (diff < 7) diff += 7;
                d.setDate(d.getDate() + diff);
                return d;
              } else if (type === 'biweekly' || type === 'triweekly' || type.endsWith('week')) {
                var n = type === 'biweekly' ? 2 : type === 'triweekly' ? 3 : parseInt(type.replace('week', '')) || 2;
                var weekday = Number(subValue) || 1;
                var currentDay2 = d.getDay() || 7;
                var daysToAdd = (weekday - currentDay2 + 7) % 7;
                if (daysToAdd === 0) daysToAdd = 7 * n;
                else daysToAdd += 7 * (n - 1);
                d.setDate(d.getDate() + daysToAdd);
                return d;
              } else if (type === 'monthly') {
                if (subValue === 'first') {
                  d.setMonth(d.getMonth() + 1, 1);
                } else if (subValue === 'last') {
                  d.setMonth(d.getMonth() + 2, 0);
                } else {
                  var targetDayOfMonth = Number(subValue) || 1;
                  d.setMonth(d.getMonth() + 1);
                  var lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                  d.setDate(Math.min(targetDayOfMonth, lastDay));
                }
                return d;
              } else if (type === '2month' || type === '3month') {
                var months = parseInt(type.replace('month', '')) || 1;
                d.setMonth(d.getMonth() + months);
                return d;
              }
              return null;
            }

            function updateRecurringNextDate() {
              var shippingDateInput = document.querySelector('input[name="shippingDate1"]');
              if (!shippingDateInput || !shippingDateInput.value) return;
              var baseDate = new Date(shippingDateInput.value);
              var type = document.getElementById('recurringType').value;
              var subValue = null;
              if (type === 'weekly' || type.endsWith('week')) {
                var weekdaySelect = document.getElementById('recurringWeekday');
                if (weekdaySelect) subValue = weekdaySelect.value;
              } else if (type === 'monthly') {
                var monthDaySelect = document.getElementById('recurringMonthDay');
                if (monthDaySelect) subValue = monthDaySelect.value;
              }
              var nextDate = calcNextRecurringDate(baseDate, type, subValue);
              if (nextDate) {
                var year = nextDate.getFullYear();
                var month = String(nextDate.getMonth() + 1).padStart(2, '0');
                var day = String(nextDate.getDate()).padStart(2, '0');
                document.getElementById('recurringNextDate').value = year + '-' + month + '-' + day;
              }
            }

            function onRecurringTypeChange() {
              var type = document.getElementById('recurringType').value;
              var subOptions = document.getElementById('recurringSubOptions');
              subOptions.innerHTML = '';
              if (type === 'weekly' || type.endsWith('week')) {
                // æ›œæ—¥ã‚»ãƒ¬ã‚¯ãƒˆ
                var days = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];
                var select = document.createElement('select');
                select.className = 'form-select';
                select.id = 'recurringWeekday';
                select.name = 'recurringWeekday';
                days.forEach(function(day, idx) {
                  var opt = document.createElement('option');
                  opt.value = idx+1;
                  opt.text = 'æ¯é€±' + day + 'æ›œæ—¥';
                  select.appendChild(opt);
                });
                select.onchange = updateRecurringNextDate;
                subOptions.appendChild(select);
              } else if (type === 'monthly') {
                // æ—¥ä»˜ã‚»ãƒ¬ã‚¯ãƒˆ
                var select = document.createElement('select');
                select.className = 'form-select';
                select.id = 'recurringMonthDay';
                select.name = 'recurringMonthDay';
                for (var i=1; i<=31; i++) {
                  var opt = document.createElement('option');
                  opt.value = i;
                  opt.text = 'æ¯æœˆ' + i + 'æ—¥';
                  select.appendChild(opt);
                }
                var optFirst = document.createElement('option');
                optFirst.value = 'first';
                optFirst.text = 'æ¯æœˆåˆæ—¥';
                select.appendChild(optFirst);
                var optLast = document.createElement('option');
                optLast.value = 'last';
                optLast.text = 'æ¯æœˆæœ«æ—¥';
                select.appendChild(optLast);
                select.onchange = updateRecurringNextDate;
                subOptions.appendChild(select);
              }
              // æ¬¡å›ç™ºé€æ—¥å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
              document.getElementById('recurringNextDateRow').style.display = '';
              // å®šæœŸã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã«æ¬¡å›ç™ºé€æ—¥ã‚’è‡ªå‹•è¨ˆç®—
              updateRecurringNextDate();
            }
            // åˆæœŸåŒ–
            document.addEventListener('DOMContentLoaded', function() {
              if (document.getElementById('recurringType')) onRecurringTypeChange();
              // ç™ºé€æ—¥å¤‰æ›´æ™‚ã«æ¬¡å›ç™ºé€æ—¥ã‚’è‡ªå‹•è¨ˆç®—
              var shippingDateInput = document.querySelector('input[name="shippingDate1"]');
              if (shippingDateInput) {
                shippingDateInput.addEventListener('change', updateRecurringNextDate);
              }
            });
            </script>
          </div>
        </div>
      </div>
      <? } ?>

      <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆç™½èƒŒæ™¯ã§ç‹¬ç«‹ï¼‰ -->
      <div class="form-actions-area">
        <div class="text-center">
          <? if (isEditMode) { ?>
          <button type="submit" class="btn btn-warning" name="shippingComfirm" value="true"
            onclick="return validateBeforeSubmit()">ä¿®æ­£ç¢ºèª</button>
          <? } else { ?>
          <button type="submit" class="btn btn-primary" name="shippingComfirm" value="true"
            onclick="return validateBeforeSubmit()">å—æ³¨ç¢ºèª</button>
          <? } ?>
        </div>
        <div class="text-center mt-3">
          <button type="submit" formnovalidate class="btn btn-outline-secondary me-3" name="mainTop" value="true"
            onclick="clearAISession()">ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹</button>
        </div>
      </div>
    </form>
  </div>
  <script>
    // ========================================
    // æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    // ========================================
    var cachedCustomers = [];
    var cachedShippingTos = [];
    var masterDataLoaded = false;

    var oriproduct = $('select[id="product1"]').html();
    var oriquantity = $('select[id="quantity1"]').html();

    /**
     * åˆ†é¡ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‰å¤‰æ›´æ™‚ã«å•†å“ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
     *
     * å•†å“åˆ†é¡ãŒé¸æŠã•ã‚Œã‚‹ã¨ã€ãã®åˆ†é¡ã«å±ã™ã‚‹å•†å“ã®ã¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * å…ƒã®oripro duct HTMLã‚’å¾©å…ƒã—ã¦ã‹ã‚‰ã€é¸æŠã•ã‚ŒãŸåˆ†é¡ä»¥å¤–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
     *
     * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
     * 1. å•†å“ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’oriproductã§åˆæœŸåŒ–
     * 2. å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®data-valå±æ€§ã¨é¸æŠã•ã‚ŒãŸåˆ†é¡ã‚’æ¯”è¼ƒ
     * 3. ä¸€è‡´ã—ãªã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ï¼ˆæœ€åˆã®ç©ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¿æŒï¼‰
     *
     * @param {number} numVal - å•†å“è¡Œç•ªå·ï¼ˆ1-10ï¼‰
     * @returns {void}
     * @see productChange() - å•†å“é¸æŠæ™‚ã®å‡¦ç†
     */
    function bunruiChange(numVal) {
      var bunrui = 'bunrui' + numVal;
      var product = 'product' + numVal;
      var $product = $('select[id="' + product + '"]');
      var val1 = $('select[id="' + bunrui + '"]').val();
      $product.html(oriproduct).find('option').each(function () {
        var val2 = $(this).data('val');
        if (val1 && val1 != val2) {
          $(this).not(':first-child').remove();
        }
      })
    }
    /**
     * å•†å“é¸æŠæ™‚ã«ä¾¡æ ¼ã¨æ•°é‡ã‚’è‡ªå‹•è¨­å®š
     *
     * å•†å“ãŒé¸æŠã•ã‚Œã‚‹ã¨ã€ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¾¡æ ¼ã¨åœ¨åº«æ•°ã‚’å–å¾—ã—ã¦è‡ªå‹•åæ˜ ã—ã¾ã™ã€‚
     * æ•°é‡ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã¯åœ¨åº«æ•°ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚
     *
     * å‡¦ç†å†…å®¹:
     * 1. é¸æŠå•†å“ã®dataå±æ€§ã‹ã‚‰åœ¨åº«æ•°ãƒ»ä¾¡æ ¼ãƒ»ç•¥ç§°ã‚’å–å¾—
     * 2. ä¾¡æ ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•å…¥åŠ›
     * 3. æ•°é‡ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’åœ¨åº«æ•°ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
     * 4. 1è¡Œç›®ã®å ´åˆã¯ç™ºé€å“åã«ç•¥ç§°ã‚’è¨­å®š
     *
     * ãƒ‡ãƒ¼ã‚¿å±æ€§:
     * - data-zaiko: åœ¨åº«æ•°
     * - data-price: å˜ä¾¡
     * - data-abbreviation: ç•¥ç§°ï¼ˆç™ºé€å“åç”¨ï¼‰
     *
     * @param {number} numVal - å•†å“è¡Œç•ªå·ï¼ˆ1-10ï¼‰
     * @returns {void}
     * @see bunruiChange() - åˆ†é¡å¤‰æ›´æ™‚ã®å‡¦ç†
     */
    function productChange(numVal) {
      var product = 'product' + numVal;
      var quantity = 'quantity' + numVal;
      var price = 'price' + numVal;
      var $quantity = $('select[id="' + quantity + '"]');
      var $price = $('input[id="' + price + '"]');
      var productVal = $('select[id="' + product + '"]').val();
      var val1 = Number($('[data-name="' + productVal + '"]').data('zaiko'));
      var val2 = Number($('[data-name="' + productVal + '"]').data('price'));
      var val3 = $('[data-name="' + productVal + '"]').data('abbreviation');
      $price.val(val2);
      $quantity.html(oriquantity).find('option').each(function (index) {
        if (val1 < index) {
          $(this).not(':first-child').remove();
        }
      })
      if (numVal == 1) {
        $('#sendProduct').val(val3);
      }
    }

    /**
     * å•†å“è¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
     *
     * @param {number} rowNum - å•†å“è¡Œç•ªå·ï¼ˆ1-10ï¼‰
     * @returns {void}
     */
    function clearProductRow(rowNum) {
      var bunrui = 'bunrui' + rowNum;
      var product = 'product' + rowNum;
      var price = 'price' + rowNum;
      var quantity = 'quantity' + rowNum;

      // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      $('select[id="' + bunrui + '"]').val('');
      $('select[id="' + product + '"]').val('');
      $('input[id="' + price + '"]').val('');
      $('input[id="' + quantity + '"]').val('');

      // 1è¡Œç›®ã®å ´åˆã€ç™ºé€å“åã‚‚ã‚¯ãƒªã‚¢
      if (rowNum == 1) {
        $('#sendProduct').val('');
      }
    }

    /**
     * å®šæœŸä¾¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
     *
     * ã€Œå®šæœŸä¾¿ã¨ã—ã¦ç™»éŒ²ã™ã‚‹ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«å¿œã˜ã¦ã€
     * æ›´æ–°é–“éš”ã®é¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º/éè¡¨ç¤ºã«ã—ã¾ã™ã€‚
     *
     * @returns {void}
     */
    function toggleRecurringOptions() {
      var isChecked = $('#isRecurringOrder').is(':checked');
      if (isChecked) {
        $('#recurringOptions').slideDown(200);
      } else {
        $('#recurringOptions').slideUp(200);
      }
    }

    var orideliveryTime = $('select[id="deliveryTime"]').html();
    var oriinvoiceType = $('select[id="invoiceType"]').html();
    var oricoolCls = $('select[id="coolCls"]').html();
    var oricargo1 = $('select[id="cargo1"]').html();
    var oricargo2 = $('select[id="cargo2"]').html();
    var oricargo3 = $('select[id="cargo3"]').html();
    function deliveryMethodChange() {
      var $deliveryMethod = $('select[id="deliveryMethod"]');
      var $deliveryTime = $('select[id="deliveryTime"]');
      var $invoiceType = $('select[id="invoiceType"]');
      var $coolCls = $('select[id="coolCls"]');
      var $cargo1 = $('select[id="cargo1"]');
      var $cargo2 = $('select[id="cargo2"]');
      var $cargo3 = $('select[id="cargo3"]');
      var val1 = $deliveryMethod.val();
      $deliveryTime.html(orideliveryTime).find('option').each(function () {
        var val2 = $(this).data('val');
        if (val1 && val1 != val2) {
          $(this).not(':first-child').remove();
        }
      })
      $invoiceType.html(oriinvoiceType).find('option').each(function () {
        var val2 = $(this).data('val');
        if (val1 && val1 != val2) {
          $(this).remove();
        }
      })
      $coolCls.html(oricoolCls).find('option').each(function () {
        var val2 = $(this).data('val');
        if (val1 && val1 != val2) {
          $(this).remove();
        }
      })
      $cargo1.html(oricargo1).find('option').each(function () {
        var val2 = $(this).data('val');
        if (val1 && val1 != val2) {
          $(this).not(':first-child').remove();
        }
      })
      $cargo2.html(oricargo2).find('option').each(function () {
        var val2 = $(this).data('val');
        if (val1 && val1 != val2) {
          $(this).not(':first-child').remove();
        }
      })
      $cargo3.html(oricargo3).find('option').each(function () {
        var val2 = $(this).data('val');
        if (val1 && val1 != val2) {
          $(this).not(':first-child').remove();
        }
      })

      // ä½å·ã®å ´åˆã€è·æ‰±ã„ï¼“ã‚’è¡¨ç¤º
      if (val1 && val1.includes('ä½å·')) {
        $('#cargo3Container').show();
        // è·æ‰±ã„ï¼‘ã«ã€ŒæŒ‡å®šæ—¥é…é”ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚’è‡ªå‹•è¨­å®š
        if (!$cargo1.val()) {
          $cargo1.val('005:æŒ‡å®šæ—¥é…é”ã‚µãƒ¼ãƒ“ã‚¹');
        }
      } else {
        $('#cargo3Container').hide();
        $cargo3.val('');
      }

      // è‡ªå‹•è¨­å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—
      updateCargoByConditions();
    }

    /**
     * ç´å“æ–¹æ³•ãƒ»é€ã‚ŠçŠ¶ç¨®åˆ¥ãƒ»ã‚¯ãƒ¼ãƒ«åŒºåˆ†ã«å¿œã˜ã¦è·æ‰±ã„ã‚’è‡ªå‹•è¨­å®š
     *
     * ä½å·æ€¥ä¾¿é¸æŠæ™‚ã«ã€æ¡ä»¶ã«å¿œã˜ãŸè·æ‰±ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•è¨­å®šã—ã¾ã™ã€‚
     * å—æ³¨å®Œäº†ç”»é¢ã®ä¿®æ­£ã§è¿½åŠ ã•ã‚ŒãŸãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚
     *
     * è‡ªå‹•è¨­å®šãƒ«ãƒ¼ãƒ«:
     * 1. ã‚¯ãƒ¼ãƒ«åŒºåˆ†ãŒã€Œå†·è”µã€â†’ è·æ‰±ã„ï¼’ã«ã€Œå†·è”µã€ã‚’è‡ªå‹•è¨­å®š
     * 2. ã‚¯ãƒ¼ãƒ«åŒºåˆ†ãŒã€Œå†·å‡ã€â†’ è·æ‰±ã„ï¼’ã«ã€Œå†·å‡ã€ã‚’è‡ªå‹•è¨­å®š
     * 3. é€ã‚ŠçŠ¶ç¨®åˆ¥ãŒã€Œç€æ‰•ã€â†’ è·æ‰±ã„ï¼“ã«ã€Œeã‚³ãƒ¬ã‚¯ãƒˆï¼ˆç¾é‡‘ï¼‰ã€ã‚’è‡ªå‹•è¨­å®š
     *
     * é©ç”¨æ¡ä»¶:
     * - ç´å“æ–¹æ³•ã«ã€Œä½å·ã€ãŒå«ã¾ã‚Œã‚‹å ´åˆã®ã¿
     *
     * å‘¼ã³å‡ºã—å…ƒ:
     * - deliveryMethodChange() - ç´å“æ–¹æ³•å¤‰æ›´æ™‚
     * - ã‚¯ãƒ¼ãƒ«åŒºåˆ†ãƒ»é€ã‚ŠçŠ¶ç¨®åˆ¥å¤‰æ›´æ™‚ï¼ˆonChangeå±æ€§ï¼‰
     *
     * @returns {void}
     * @see deliveryMethodChange() - ç´å“æ–¹æ³•å¤‰æ›´å‡¦ç†
     */
    function updateCargoByConditions() {
      var deliveryMethod = $('select[id="deliveryMethod"]').val();
      var invoiceType = $('select[id="invoiceType"]').val();
      var coolCls = $('select[id="coolCls"]').val();

      // ä½å·ã®å ´åˆã®ã¿å‡¦ç†
      if (deliveryMethod && deliveryMethod.includes('ä½å·')) {
        // è·æ‰±ã„ï¼’ï¼šã‚¯ãƒ¼ãƒ«åŒºåˆ†ãŒå†·è”µ/å†·å‡ã®å ´åˆã€ã‚¯ãƒ¼ãƒ«ä¾¿ã‚’è‡ªå‹•è¨­å®š
        if (coolCls) {
          if (coolCls.includes('002:å†·è”µ')) {
            $('select[id="cargo2"]').val('001:å†·è”µ');
          } else if (coolCls.includes('003:å†·å‡')) {
            $('select[id="cargo2"]').val('002:å†·å‡');
          }
        }

        // è·æ‰±ã„ï¼“ï¼šé€ã‚ŠçŠ¶ç¨®åˆ¥ãŒç€æ‰•ã„ã®å ´åˆã€eã‚³ãƒ¬ã‚¯ãƒˆã‚’è‡ªå‹•è¨­å®š
        if (invoiceType && invoiceType.includes('ç€æ‰•')) {
          $('select[id="cargo3"]').val('008:ï½…ã‚³ãƒ¬ã‚¯ãƒˆï¼ˆç¾é‡‘ï¼‰');
        }
      }
    }
    function babaChange() {
      $('button[id="babaBtn"]').text('åæ˜ ä¸­..');
      google.script.run.withSuccessHandler(babaChengeSuccess).getCompanyRecordForShipping();
    }
    function babaChengeSuccess(datas) {
      var data = JSON.parse(datas);
      $('input[id="shippingFromName"]').val(data[0]['åå‰']);
      $('input[id="shippingFromZipcode"]').val(data[0]['éƒµä¾¿ç•ªå·']);
      $('input[id="shippingFromAddress"]').val(data[0]['ä½æ‰€']);
      $('input[id="shippingFromTel"]').val(data[0]['é›»è©±ç•ªå·']);
      var companyDisplayName = '<?= getCompanyDisplayName() ?>';
      $('button[id="babaBtn"]').text(companyDisplayName);
    }
    /**
     * ä¾é ¼å…ˆï¼ˆé¡§å®¢ï¼‰æƒ…å ±ã‚’ç™ºé€å…ƒã«ã‚³ãƒ”ãƒ¼
     *
     * ä¾é ¼å…ˆã®ä¼šç¤¾åãƒ»éƒµä¾¿ç•ªå·ãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã‚’ç™ºé€å…ƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
     * ã€Œä¾é ¼å…ˆã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
     *
     * ã‚³ãƒ”ãƒ¼å¯¾è±¡:
     * - ä¼šç¤¾å
     * - éƒµä¾¿ç•ªå·
     * - ä½æ‰€
     * - é›»è©±ç•ªå·
     *
     * @returns {void}
     * @see sendCopy() - ç™ºé€å…ˆã‚³ãƒ”ãƒ¼
     */
    function custCopy() {
      $('input[id="shippingFromName"]').val($('input[id="customerName"]').val());
      $('input[id="shippingFromZipcode"]').val($('input[id="customerZipcode"]').val());
      $('input[id="shippingFromAddress"]').val($('input[id="customerAddress"]').val());
      $('input[id="shippingFromTel"]').val($('input[id="customerTel"]').val());
    }

    /**
     * ç™ºé€å…ˆæƒ…å ±ã‚’ç™ºé€å…ƒã«ã‚³ãƒ”ãƒ¼
     *
     * ç™ºé€å…ˆã®ä¼šç¤¾åãƒ»éƒµä¾¿ç•ªå·ãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã‚’ç™ºé€å…ƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
     * ã€Œç™ºé€å…ˆã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
     *
     * ã‚³ãƒ”ãƒ¼å¯¾è±¡:
     * - ä¼šç¤¾å
     * - éƒµä¾¿ç•ªå·
     * - ä½æ‰€
     * - é›»è©±ç•ªå·
     *
     * @returns {void}
     * @see custCopy() - ä¾é ¼å…ˆã‚³ãƒ”ãƒ¼
     */
    function sendCopy() {
      $('input[id="shippingFromName"]').val($('input[id="shippingToName"]').val());
      $('input[id="shippingFromZipcode"]').val($('input[id="shippingToZipcode"]').val());
      $('input[id="shippingFromAddress"]').val($('input[id="shippingToAddress"]').val());
      $('input[id="shippingFromTel"]').val($('input[id="shippingToTel"]').val());
    }

    /**
     * ä¾é ¼å…ˆï¼ˆé¡§å®¢ï¼‰æƒ…å ±ã‚’ç™ºé€å…ˆã«ã‚³ãƒ”ãƒ¼
     *
     * ä¾é ¼å…ˆã®ä¼šç¤¾åãƒ»éƒµä¾¿ç•ªå·ãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã‚’ç™ºé€å…ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
     * ã€Œç™ºé€å…ˆåŒä¸Šã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚„ã€é¡§å®¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã€Œç™ºé€å…ˆåŒä¸Šã€ãƒã‚§ãƒƒã‚¯ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
     *
     * ã‚³ãƒ”ãƒ¼å¯¾è±¡:
     * - ä¼šç¤¾å
     * - éƒµä¾¿ç•ªå·
     * - ä½æ‰€
     * - é›»è©±ç•ªå·
     *
     * ä½¿ç”¨å ´é¢:
     * - é¡§å®¢ã¨ç™ºé€å…ˆãŒåŒä¸€ã®å ´åˆ
     *
     * @returns {void}
     * @see addCustomer() - é¡§å®¢æ–°è¦ç™»éŒ²ï¼ˆç™ºé€å…ˆåŒä¸Šãƒã‚§ãƒƒã‚¯ã‚ã‚Šï¼‰
     */
    function customerSame() {
      $('input[id="shippingToName"]').val($('input[id="customerName"]').val());
      $('input[id="shippingToZipcode"]').val($('input[id="customerZipcode"]').val());
      $('input[id="shippingToAddress"]').val($('input[id="customerAddress"]').val());
      $('input[id="shippingToTel"]').val($('input[id="customerTel"]').val());
    }
    // é¡§å®¢ãƒ»ç™ºé€å…ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã€æ¤œç´¢æ©Ÿèƒ½ã¯åˆ†å‰²ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•ï¼ˆshippingCustomerScript.html, shippingSearchScript.htmlï¼‰
    // é¡§å®¢ãƒ»ç™ºé€å…ˆæ¤œç´¢æ©Ÿèƒ½ã¯ shippingSearchScript.html ã«åˆ†é›¢æ¸ˆã¿
    function setProductSearch() {
      if (!$('input[id="shippingToName"]').val()) {
        showWarningToast('ç™ºé€å…ˆåãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        return false;
      }
      $("button[id='productSearch']").html('<span class="btn-spinner"></span> æ¤œç´¢ä¸­...');
      var shippingToName = $('input[id="shippingToName"]').val();
      google.script.run.withSuccessHandler(setDataList).withFailureHandler(dataAddFail).getLastData(shippingToName);

    }
    function setQuotationSearch() {
      if (!$('input[id="customerName"]').val()) {
        showWarningToast('é¡§å®¢åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        return false;
      }
      $("button[id='quotationSearch']").html('<span class="btn-spinner"></span> æ¤œç´¢ä¸­...');
      var customerName = $('input[id="customerName"]').val();
      google.script.run.withSuccessHandler(setQuotationDataList).withFailureHandler(dataAddFail).getQuotationData(customerName);

    }

    function setDataList(datas) {
      var res = JSON.parse(datas);
      if (res.length == 0) {
        showInfoToast('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
      else {
        $('input[id="shippingToName"]').val(res[0]['ç™ºé€å…ˆå']);
        $('input[id="shippingToZipcode"]').val(res[0]['ç™ºé€å…ˆéƒµä¾¿ç•ªå·']);
        $('input[id="shippingToAddress"]').val(res[0]['ç™ºé€å…ˆä½æ‰€']);
        $('input[id="shippingToTel"]').val(res[0]['ç™ºé€å…ˆé›»è©±ç•ªå·']);
        $('input[id="shippingFromName"]').val(res[0]['ç™ºé€å…ƒå']);
        $('input[id="customerName"]').val(res[0]['é¡§å®¢å']);
        $('input[id="customerZipcode"]').val(res[0]['é¡§å®¢éƒµä¾¿ç•ªå·']);
        $('input[id="customerAddress"]').val(res[0]['é¡§å®¢ä½æ‰€']);
        $('input[id="customerTel"]').val(res[0]['é¡§å®¢é›»è©±ç•ªå·']);
        $('input[id="shippingFromName"]').val(res[0]['ç™ºé€å…ƒå']);
        $('input[id="shippingFromZipcode"]').val(res[0]['ç™ºé€å…ƒéƒµä¾¿ç•ªå·']);
        $('input[id="shippingFromAddress"]').val(res[0]['ç™ºé€å…ƒä½æ‰€']);
        $('input[id="shippingFromTel"]').val(res[0]['ç™ºé€å…ƒé›»è©±ç•ªå·']);
        $('select[id="deliveryMethod"]').val(res[0]['ç´å“æ–¹æ³•']);
        deliveryMethodChange();
        $('select[id="deliveryTime"]').val(res[0]['é…é”æ™‚é–“å¸¯']);
        if (res[0]['ç´å“æ›¸'] == 'â—‹') {
          $('input[id="deliveryChk"]').prop('checked', true);
        }
        if (res[0]['è«‹æ±‚æ›¸'] == 'â—‹') {
          $('input[id="billChk"]').prop('checked', true);
        }
        if (res[0]['é ˜åæ›¸'] == 'â—‹') {
          $('input[id="receiptChk"]').prop('checked', true);
        }
        if (res[0]['ãƒ‘ãƒ³ãƒ•'] == 'â—‹') {
          $('input[id="pamphletChk"]').prop('checked', true);
        }
        if (res[0]['ãƒ¬ã‚·ãƒ”'] == 'â—‹') {
          $('input[id="recipeChk"]').prop('checked', true);
        }
        $('input[id="otherAttach"]').val(res[0]['ãã®ä»–æ·»ä»˜']);
        $('select[id="invoiceType"]').val(res[0]['é€ã‚ŠçŠ¶ç¨®åˆ¥']);
        $('select[id="coolCls"]').val(res[0]['ã‚¯ãƒ¼ãƒ«åŒºåˆ†']);
        $('select[id="cargo1"]').val(res[0]['è·æ‰±ã„ï¼‘']);
        $('select[id="cargo2"]').val(res[0]['è·æ‰±ã„ï¼’']);
        $('select[id="cargo3"]').val(res[0]['è·æ‰±ã„ï¼“']);
        $('input[id="cashOnDelivery"]').val(res[0]['ä»£å¼•ç·é¡']);
        $('input[id="cashOnDeliTax"]').val(res[0]['ä»£å¼•å†…ç¨']);
        $('input[id="copiePrint"]').val(res[0]['ç™ºè¡Œæšæ•°']);
        $('textarea[id="internalMemo"]').val(res[0]['ç¤¾å†…ãƒ¡ãƒ¢'] || '');
        $('textarea[id="csvmemo"]').val(res[0]['é€ã‚ŠçŠ¶å‚™è€ƒæ¬„'] || '');
        $('textarea[id="deliveryMemo"]').val(res[0]['ç´å“æ›¸å‚™è€ƒæ¬„'] || '');
        $('textarea[id="memo"]').val(res[0]['ãƒ¡ãƒ¢'] || '');
        for (let i = 0; i < 10; i++) {
          var num = (i + 1);
          var bunrui = 'bunrui' + num;
          var product = 'product' + num;
          var quantity = 'quantity' + num;
          var price = 'price' + num;
          if (res.length > i) {
            var spData = res[i];
            $('select[id="' + bunrui + '"]').val(spData['å•†å“åˆ†é¡']);
            bunruiChange(num);
            $('select[id="' + product + '"]').val(spData['å•†å“å']);
            productChange(num);
            $('select[id="' + quantity + '"]').val(spData['å—æ³¨æ•°']);
            $('input[id="' + price + '"]').val(spData['è²©å£²ä¾¡æ ¼']);
          }
          else {
            $('select[id="' + bunrui + '"]').val('');
            bunruiChange(num);
            $('select[id="' + product + '"]').val('');
            productChange(num);
            $('select[id="' + quantity + '"]').val('');
            $('input[id="' + price + '"]').val('');
          }
        }
        showSuccessToast('å‰å›ã®å•†å“æƒ…å ±ã‚’åæ˜ ã—ã¾ã—ãŸã€‚');
      }
      $("button[id='productSearch']").text('å‰å›å•†å“åæ˜ ');
    }
    function setQuotationDataList(datas) {
      var res = JSON.parse(datas);
      for (let i = 0; i < 10; i++) {
        var num = (i + 1);
        var bunrui = 'bunrui' + num;
        var product = 'product' + num;
        var quantity = 'quantity' + num;
        var price = 'price' + num;
        if (res.length > i) {
          var spData = res[i];
          $('select[id="' + bunrui + '"]').val(spData['å•†å“åˆ†é¡']);
          bunruiChange(num);
          $('select[id="' + product + '"]').val(spData['å•†å“å']);
          productChange(num);
          $('input[id="' + price + '"]').val(spData['å˜ä¾¡ï¼ˆå¤–ç¨ï¼‰']);
        }
        else {
          $('select[id="' + bunrui + '"]').val('');
          bunruiChange(num);
          $('select[id="' + product + '"]').val('');
          productChange(num);
          $('select[id="' + quantity + '"]').val('');
          $('input[id="' + price + '"]').val('');
        }
      }
      if (res.length == 0) {
        showInfoToast('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      }
      else {
        showSuccessToast('è¦‹ç©æ›¸æƒ…å ±ã‚’åæ˜ ã—ã¾ã—ãŸã€‚');
      }
      $("button[id='quotationSearch']").text('è¦‹ç©æ›¸åæ˜ ');
    }
  </script>

  <!-- åˆ†å‰²ã•ã‚ŒãŸJavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ -->
  <?!= HtmlService.createHtmlOutputFromFile('shippingCustomerScript').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('shippingSearchScript').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('shippingAi').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('shippingValidation').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('shippingMultiDate').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('shippingHistory').getContent(); ?>

  <script>
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function () {
      // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ­ãƒ¼ãƒ‰ï¼ˆæ¤œç´¢é«˜é€ŸåŒ–ï¼‰
      loadMasterDataForSearch();

      loadAISessionData();
      setupFileDragDrop();

      // AIå–è¾¼ä¸€è¦§ã‹ã‚‰é·ç§»ã—ãŸå ´åˆã€è‡ªå‹•ã§AIãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      var sessionDataEl = document.getElementById('gas-session-data');
      var shouldAutoOpen = sessionDataEl.dataset.autoOpen === 'true';
      var preloadedAnalysis = sessionDataEl.dataset.analysis;

      if (shouldAutoOpen && preloadedAnalysis && preloadedAnalysis !== '""') {
        setTimeout(function () {
          try {
            var analysisData = typeof preloadedAnalysis === 'string' ? JSON.parse(preloadedAnalysis) : preloadedAnalysis;
            openAIModalWithResult(analysisData);
          } catch (e) {
            console.error('AIè§£æçµæœã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
          }
        }, 500);
      }
    });
  </script>
  <?!= HtmlService.createHtmlOutputFromFile('keyCheck').getContent(); ?>
</body>


</html>