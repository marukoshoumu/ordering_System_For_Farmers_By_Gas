<!-- 
  shipping.html ã‹ã‚‰åˆ†é›¢ã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£ã®JavaScript
  - é€ä¿¡å‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  - ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒƒã‚¯
  - è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«
-->
<script>
    /**
     * é€ä¿¡å‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
     */
    function validateBeforeSubmit() {
      const warnings = performLocalCheck();
      if (warnings.length === 0) { return true; }
      showWarningModal(warnings);
      return false;
    }
    
    /**
     * ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
     */
    function performLocalCheck() {
      const warnings = [];
      const savedData = sessionStorage.getItem(AI_SESSION_KEY);
      if (!savedData) {
        warnings.push(...checkBasicValidation());
        return warnings;
      }
      const aiData = JSON.parse(savedData);
      const inputTotal = calculateInputTotal();
      if (aiData.totalAmount && Math.abs(aiData.totalAmount - inputTotal) > 1) {
        const diff = inputTotal - aiData.totalAmount;
        warnings.push({ type: 'critical', icon: 'ğŸ”´', title: 'åˆè¨ˆé‡‘é¡ãŒç•°ãªã‚Šã¾ã™', detail: 'AIè§£æ: Â¥' + aiData.totalAmount.toLocaleString() + ' â†’ å…¥åŠ›: Â¥' + inputTotal.toLocaleString() + 'ï¼ˆå·®é¡: ' + (diff >= 0 ? '+' : '') + 'Â¥' + diff.toLocaleString() + 'ï¼‰' });
      }
      if (aiData.items) {
        aiData.items.forEach(aiItem => {
          if (AI_EXCLUDE_CATEGORIES.includes(aiItem.category) || AI_EXCLUDE_PRODUCTS.includes(aiItem.productName)) return;
          const inputItem = findInputItem(aiItem.productName);
          if (!inputItem) {
            warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: aiItem.productName + ' ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“', detail: 'AIè§£æ: ' + aiItem.quantity + 'å€‹' });
          } else {
            if (inputItem.quantity != aiItem.quantity) {
              warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: aiItem.productName + ' ã®æ•°é‡ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™', detail: 'AIè§£æ: ' + aiItem.quantity + 'å€‹ â†’ å…¥åŠ›: ' + inputItem.quantity + 'å€‹' });
            }
            if (inputItem.price != aiItem.price) {
              warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: aiItem.productName + ' ã®ä¾¡æ ¼ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™', detail: 'AIè§£æ: Â¥' + (aiItem.price || 0).toLocaleString() + ' â†’ å…¥åŠ›: Â¥' + (inputItem.price || 0).toLocaleString() });
            }
          }
        });
      }
      warnings.push(...checkBasicValidation());
      return warnings;
    }
    
    /**
     * å…¥åŠ›åˆè¨ˆé‡‘é¡è¨ˆç®—
     */
    function calculateInputTotal() {
      let total = 0;
      for (let i = 1; i <= 10; i++) {
        const product = document.getElementById('product' + i)?.value || '';
        const category = document.getElementById('bunrui' + i)?.value || '';
        const price = Number(document.getElementById('price' + i)?.value) || 0;
        const quantity = Number(document.getElementById('quantity' + i)?.value) || 0;
        if (AI_EXCLUDE_CATEGORIES.includes(category) || AI_EXCLUDE_PRODUCTS.includes(product)) continue;
        total += price * quantity;
      }
      return total;
    }
    
    /**
     * å…¥åŠ›å•†å“æ¤œç´¢
     */
    function findInputItem(productName) {
      for (let i = 1; i <= 10; i++) {
        const product = document.getElementById('product' + i)?.value || '';
        if (product === productName) {
          return { productName: product, price: Number(document.getElementById('price' + i)?.value) || 0, quantity: Number(document.getElementById('quantity' + i)?.value) || 0 };
        }
      }
      return null;
    }
    
    /**
     * åŸºæœ¬ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
     */
    function checkBasicValidation() {
      const warnings = [];
      const products = [];
      for (let i = 1; i <= 10; i++) {
        const product = document.getElementById('product' + i)?.value || '';
        if (product && products.includes(product)) {
          warnings.push({ type: 'warning', icon: 'ğŸŸ¡', title: product + ' ãŒé‡è¤‡ã—ã¦ã„ã¾ã™', detail: 'åŒã˜å•†å“ãŒè¤‡æ•°è¡Œã‚ã‚Šã¾ã™' });
        }
        if (product) products.push(product);
      }
      for (let i = 1; i <= 10; i++) {
        const product = document.getElementById('product' + i)?.value || '';
        const quantity = Number(document.getElementById('quantity' + i)?.value) || 0;
        if (product && quantity >= 100) {
          warnings.push({ type: 'info', icon: 'ğŸ’¡', title: product + ' ã®æ•°é‡ãŒå¤šã„ã§ã™', detail: quantity + 'å€‹ - å…¥åŠ›ãƒŸã‚¹ã§ã¯ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„' });
        }
      }
      return warnings;
    }
    
    /**
     * è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
     */
    function showWarningModal(warnings) {
      const body = document.getElementById('aiWarningBody');
      body.innerHTML = warnings.map(w => '<div class="ai-warning-item ' + w.type + '"><span class="icon">' + w.icon + '</span><div class="content"><div class="title">' + w.title + '</div><div class="detail">' + w.detail + '</div></div></div>').join('');
      document.getElementById('aiWarningModal').classList.add('show');
    }
    
    /**
     * è­¦å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
     */
    function closeWarningModal() {
      document.getElementById('aiWarningModal').classList.remove('show');
    }
    
    /**
     * è­¦å‘Šã‚’ç¢ºèªã—ã¦ç¶šè¡Œ
     */
    function proceedWithWarnings() {
      closeWarningModal();
      const form = document.querySelector('form');
      if (form) {
        const btn = document.querySelector('[name="shippingComfirm"]');
        if (btn) {
          btn.removeAttribute('onclick');
          btn.click();
        }
      }
    }
</script>
