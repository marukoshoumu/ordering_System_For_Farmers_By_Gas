<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>配送伝票スキャナー</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #interactive.viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #interactive.viewport>video,
        #interactive.viewport>canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        canvas.drawingBuffer {
            position: absolute;
            left: 0;
            top: 0;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none;
            z-index: 10;
        }

        .scan-region {
            border: 2px solid #0d6efd;
            width: 80%;
            height: 30%;
            margin: auto;
            position: relative;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scan-region::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255, 0, 0, 0.5);
            box-shadow: 0 0 10px red;
            animation: scan 2s infinite ease-in-out;
        }

        @keyframes scan {

            0%,
            100% {
                transform: translateY(-50px);
            }

            50% {
                transform: translateY(50px);
            }
        }

        .controls {
            padding: 15px;
            background: rgba(0, 0, 0, 0.9);
            pointer-events: auto;
            text-align: center;
            z-index: 20;
        }

        .manual-input-area {
            position: absolute;
            top: 60px;
            /* .info height */
            left: 0;
            width: 100%;
            bottom: 100px;
            /* .controls area */
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 15;
            flex-direction: column;
            justify-content: center;
        }

        .manual-input-area.active {
            display: flex;
        }

        .info {
            height: 60px;
            padding: 0 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(13, 110, 253, 0.9);
            text-align: center;
            font-weight: bold;
            pointer-events: auto;
            z-index: 20;
        }

        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(25, 135, 84, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(220, 53, 69, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>

<body>

    <div class="info">
        <span id="targetName">受注を選択してください</span>
    </div>

    <div id="interactive" class="viewport">
        <div class="overlay">
            <div class="scan-region"></div>
        </div>
    </div>

    <!-- 手入力エリア -->
    <div id="manualInputArea" class="manual-input-area">
        <div class="p-4">
            <h3 class="text-center mb-4">送り状番号を入力</h3>
            <div class="input-group input-group-lg mb-4">
                <input type="tel" id="manualNo" class="form-control text-center" placeholder="123456789012"
                    maxlength="12">
            </div>
            <div class="d-grid gap-3">
                <button onclick="submitManual()" class="btn btn-primary py-3">決定</button>
                <button onclick="toggleManual(false)" class="btn btn-outline-light">スキャンに戻る</button>
            </div>
        </div>
    </div>

    <div class="controls">
        <div id="status" class="mb-3">伝票のバーコードを枠内に収めてください</div>
        <div class="d-flex gap-2 mb-2">
            <button id="ocrBtn" onclick="captureAndOcr()" class="btn btn-warning flex-grow-1 py-3 text-dark">
                <i class="bi bi-camera"></i> 番号を写真で読み取る
            </button>
        </div>
        <div class="d-flex gap-2">
            <button id="manualBtn" onclick="toggleManual(true)" class="btn btn-primary flex-grow-1 py-3">
                <i class="bi bi-keyboard"></i> 手入力
            </button>
            <button id="closeBtn" class="btn btn-outline-light py-3 px-4">取消</button>
        </div>
    </div>

    <!-- 成功・エラー時のオーバーレイ -->
    <div id="successOverlay" class="result-overlay">
        <h2 class="mb-3">スキャン成功！</h2>
        <div id="scannedNo" class="h1 mb-4"></div>
        <div class="spinner-border text-light mb-3" role="status"></div>
        <div>システム更新中...</div>
    </div>

    <div id="errorOverlay" class="error-overlay">
        <h2 class="mb-3">エラー</h2>
        <div id="errorMsg" class="mb-4"></div>
        <button onclick="retry()" class="btn btn-light px-5">再試行</button>
    </div>

    <!-- 音 -->
    <audio id="beepSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script>
        let selectedOrderId = '';
        let isProcessing = false;

        // 初期化
        window.onload = function () {
            // GASのテンプレートから変数を取得（doGetで設定されたもの）
            selectedOrderId = '<?= orderId ?>';
            const customerName = '<?= customerName ?>';

            if (customerName) {
                document.getElementById('targetName').innerText = customerName + " 様の伝票";
            }

            if (!selectedOrderId) {
                // URLパラメータからも一応取得（直接URLを叩いた場合など）
                const urlParams = new URLSearchParams(window.location.search);
                selectedOrderId = urlParams.get('orderId');
                const cName = urlParams.get('customerName');
                if (cName) document.getElementById('targetName').innerText = decodeURIComponent(cName) + " 様の伝票";
            }

            if (!selectedOrderId) {
                showError("受注IDが指定されていません。");
                return;
            }

            initScanner();
        };

        function initScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: "environment" // 背面カメラ
                    },
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "codabar_reader", // NW-7 (配送伝票で一般的)
                        "code_39_reader"
                    ],
                    multiple: false
                },
                locate: true
            }, function (err) {
                if (err) {
                    console.error(err);
                    showError("カメラの起動に失敗しました。カメラの使用を許可してください。");
                    return;
                }
                console.log("Initialization finished. Ready to start");
                Quagga.start();
                document.getElementById('status').innerText = "伝票のバーコードを枠内に収めてください";
            });

            Quagga.onDetected(onDetected);
        }

        function toggleManual(show) {
            const area = document.getElementById('manualInputArea');
            const status = document.getElementById('status');
            if (show) {
                area.classList.add('active');
                status.innerText = "番号を入力してください";
                document.getElementById('manualNo').focus();
            } else {
                area.classList.remove('active');
                status.innerText = "伝票のバーコードを枠内に収めてください";
            }
        }

        function submitManual() {
            const code = document.getElementById('manualNo').value.trim();
            if (code.length < 10) {
                alert("番号は10桁以上で入力してください。");
                return;
            }
            if (!/^[0-9-]+$/.test(code)) {
                alert("数字とハイフンのみ入力可能です。");
                return;
            }
            handleSuccess(code.replace(/-/g, ''));
        }

        function onDetected(data) {
            if (isProcessing) return;

            const code = data.codeResult.code;

            // 配送伝票の番号形式バリデーション（簡易版）
            if (code && (code.length >= 10 && code.length <= 12)) {
                // 日本の電話番号（0から始まる10桁/11桁）を誤検知しないための対策
                if ((code.length === 10 || code.length === 11) && code.startsWith('0')) {
                    return;
                }
                isProcessing = true;
                handleSuccess(code);
            }
        }

        async function captureAndOcr() {
            if (isProcessing) return;

            isProcessing = true;
            document.getElementById('status').innerText = "画像を解析中...";

            try {
                // 現在のビデオフレームをキャプチャ
                const video = document.querySelector('video');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // 画像をBase64に変換
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                const base64Data = dataUrl.split(',')[1];

                // GASサーバー側のOCR関数を呼び出す
                google.script.run
                    .withSuccessHandler(function (result) {
                        if (result.success && result.code) {
                            handleSuccess(result.code);
                        } else {
                            isProcessing = false;
                            alert("番号を認識できませんでした。数字が中央に来るように再度撮影するか、手入力をお試しください。\n(" + (result.message || "") + ")");
                            document.getElementById('status').innerText = "伝票のバーコードを枠内に収めてください";
                        }
                    })
                    .withFailureHandler(function (err) {
                        isProcessing = false;
                        alert("解析エラーが発生しました。");
                        document.getElementById('status').innerText = "伝票のバーコードを枠内に収めてください";
                    })
                    .recognizeTrackingNumber(base64Data);

            } catch (e) {
                isProcessing = false;
                alert("キャプチャに失敗しました。");
            }
        }

        function handleSuccess(code) {
            // 音を鳴らす
            document.getElementById('beepSound').play();

            // 成功 UI
            document.getElementById('scannedNo').innerText = code;
            document.getElementById('successOverlay').style.display = 'flex';

            // GASを呼び出して更新
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        setTimeout(() => {
                            // 親画面（受注一覧）の更新関数を呼び出す
                            if (window.opener && window.opener.onScanComplete) {
                                window.opener.onScanComplete();
                            }
                            // ウィンドウを閉じる
                            window.close();
                        }, 1500);
                    } else {
                        showError(result.message);
                    }
                })
                .withFailureHandler(function (err) {
                    showError("システムエラーが発生しました: " + err.toString());
                })
                .updateOrderTrackingStatus(selectedOrderId, code);
        }

        function showError(msg) {
            isProcessing = true; // スキャン停止用
            document.getElementById('errorMsg').innerText = msg;
            document.getElementById('errorOverlay').style.display = 'flex';
            document.getElementById('successOverlay').style.display = 'none';
        }

        function retry() {
            isProcessing = false;
            document.getElementById('errorOverlay').style.display = 'none';
            document.getElementById('successOverlay').style.display = 'none';
            // Quaggaは止まっていないのでそのまま継続可能
        }

        document.getElementById('closeBtn').addEventListener('click', function () {
            window.close();
        });
    </script>
</body>

</html>