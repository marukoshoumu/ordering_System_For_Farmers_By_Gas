<!-- 
  shipping.html から分離した複数日程登録機能のJavaScript
  - 発送日程の追加/削除
  - 番号振り直し
-->
<script>
    // ============================================
    // 複数日程登録機能
    // ============================================

    /**
     * 発送日程の追加
     */
    function addShippingDate() {
      const container = document.getElementById('shippingDateContainer');
      const rows = container.querySelectorAll('.shipping-date-row');
      const currentCount = rows.length;

      if (currentCount >= 10) {
        showWarningToast('日程は最大10件までです');
        return;
      }

      const newRowNum = currentCount + 1;

      // 前の行の日付を取得してデフォルト値を設定
      const lastRow = rows[rows.length - 1];
      const lastShippingInput = lastRow.querySelector('input[name^="shippingDate"]');
      const lastDeliveryInput = lastRow.querySelector('input[name^="deliveryDate"]');

      // NULL安全性チェック
      if (!lastShippingInput || !lastDeliveryInput) {
        console.error('前の行の日付フィールドが見つかりません');
        return;
      }

      const lastShippingDate = lastShippingInput.value;
      const lastDeliveryDate = lastDeliveryInput.value;

      // ローカルタイムゾーンで日付をフォーマットするヘルパー関数
      function formatLocalDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // 1日後の日付を計算
      const nextShipping = new Date(lastShippingDate);
      nextShipping.setDate(nextShipping.getDate() + 1);
      const nextShippingStr = formatLocalDate(nextShipping);

      const nextDelivery = new Date(lastDeliveryDate);
      nextDelivery.setDate(nextDelivery.getDate() + 1);
      const nextDeliveryStr = formatLocalDate(nextDelivery);

      // XSS対策: innerHTMLの代わりにDOM要素を個別に作成
      const newRow = document.createElement('div');
      newRow.className = 'shipping-date-row d-flex align-items-center gap-2 mb-2';
      newRow.dataset.row = newRowNum;

      // バッジ
      const badge = document.createElement('span');
      badge.className = 'badge bg-secondary';
      badge.textContent = '#' + newRowNum;
      newRow.appendChild(badge);

      // 発送日ラベル
      const shippingLabel = document.createElement('label');
      shippingLabel.className = 'col-form-label';
      shippingLabel.textContent = '発送日';
      newRow.appendChild(shippingLabel);

      // 発送日入力
      const shippingInput = document.createElement('input');
      shippingInput.type = 'date';
      shippingInput.className = 'form-control';
      shippingInput.style.width = '160px';
      shippingInput.name = 'shippingDate' + newRowNum;
      shippingInput.required = true;
      shippingInput.value = nextShippingStr;
      newRow.appendChild(shippingInput);

      // 納品日ラベル
      const deliveryLabel = document.createElement('label');
      deliveryLabel.className = 'col-form-label';
      deliveryLabel.textContent = '納品日';
      newRow.appendChild(deliveryLabel);

      // 納品日入力
      const deliveryInput = document.createElement('input');
      deliveryInput.type = 'date';
      deliveryInput.className = 'form-control';
      deliveryInput.style.width = '160px';
      deliveryInput.name = 'deliveryDate' + newRowNum;
      deliveryInput.required = true;
      deliveryInput.value = nextDeliveryStr;
      newRow.appendChild(deliveryInput);

      // 納品書テキストラベル
      const textLabel = document.createElement('label');
      textLabel.className = 'col-form-label';
      textLabel.textContent = '納品書テキスト';
      newRow.appendChild(textLabel);

      // 納品書テキスト入力
      const textInput = document.createElement('input');
      textInput.type = 'text';
      textInput.className = 'form-control';
      textInput.style.width = '300px';
      textInput.name = 'deliveryNoteText' + newRowNum;
      textInput.placeholder = '例: 月曜コース分の商品';
      textInput.value = '';
      newRow.appendChild(textInput);

      // 削除ボタン
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-outline-danger';
      removeBtn.textContent = '✕';
      removeBtn.onclick = function() { removeShippingDate(this); };
      newRow.appendChild(removeBtn);

      container.appendChild(newRow);
      updateRemoveButtons();
    }

    /**
     * 発送日程の削除
     */
    function removeShippingDate(btn) {
      const row = btn.closest('.shipping-date-row');
      row.remove();
      renumberShippingDates();
      updateRemoveButtons();
    }

    /**
     * 番号の振り直し
     */
    function renumberShippingDates() {
      const container = document.getElementById('shippingDateContainer');
      const rows = container.querySelectorAll('.shipping-date-row');

      rows.forEach((row, index) => {
        const num = index + 1;
        row.dataset.row = num;
        row.querySelector('.badge').textContent = '#' + num;
        row.querySelector('input[name^="shippingDate"]').name = 'shippingDate' + num;
        row.querySelector('input[name^="deliveryDate"]').name = 'deliveryDate' + num;
        const deliveryNoteTextInput = row.querySelector('input[name^="deliveryNoteText"]');
        if (deliveryNoteTextInput) {
          deliveryNoteTextInput.name = 'deliveryNoteText' + num;
        }
      });
    }

    /**
     * 削除ボタンの有効/無効制御（1件のときは削除不可）
     */
    function updateRemoveButtons() {
      const container = document.getElementById('shippingDateContainer');
      const rows = container.querySelectorAll('.shipping-date-row');
      const buttons = container.querySelectorAll('.btn-outline-danger');
      
      buttons.forEach(btn => {
        btn.disabled = rows.length <= 1;
      });
    }
</script>
